<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Kotoba">
<meta name="theme-color" content="#0a0c10">
<title>Kotoba Trainer Pro</title>
<style>
:root{
  --bg-deep:#0a0c10;--bg-panel:#10141c;--bg-card:#161b26;--bg-card2:#1c2333;
  --accent:#e8a838;--accent2:#f0c060;--accent-dim:#8a6020;
  --red:#c94040;--green:#3a9a5c;--blue:#3a72b0;--purple:#9c55d0;
  --text:#d4cfc4;--text-dim:#6e7a8a;--text-bright:#f0ebe0;
  --border:#2a3344;--scan:rgba(232,168,56,0.03);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Barlow Condensed','Arial Narrow',Arial,sans-serif;background:var(--bg-deep);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,var(--scan) 2px,var(--scan) 4px);pointer-events:none;z-index:9999;}
body::after{content:'';position:fixed;inset:0;background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);background-size:40px 40px;opacity:0.18;pointer-events:none;z-index:0;}
#app{position:relative;z-index:1;min-height:100vh;}
.container{max-width:680px;margin:0 auto;padding:20px 16px 60px;animation:screenIn 0.22s ease;}
@keyframes screenIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

.ark-header{display:flex;align-items:center;gap:12px;padding:14px 0 20px;border-bottom:1px solid var(--border);margin-bottom:20px;position:relative;}
.ark-header::after{content:'';position:absolute;bottom:-1px;left:0;width:80px;height:2px;background:var(--accent);}
.ark-title{font-family:'Rajdhani','Arial Narrow',Arial,sans-serif;font-size:22px;font-weight:700;color:var(--text-bright);letter-spacing:3px;text-transform:uppercase;}
.ark-title span{color:var(--accent);}
.ark-badge{font-family:'Share Tech Mono','Courier New',monospace;font-size:10px;color:var(--accent);border:1px solid var(--accent-dim);padding:2px 6px;background:rgba(232,168,56,0.07);letter-spacing:2px;}

.back{position:static!important;width:auto!important;padding:6px 14px!important;background:transparent!important;color:var(--text-dim)!important;border:1px solid var(--border)!important;border-radius:0!important;font-family:'Share Tech Mono',monospace!important;font-size:11px!important;letter-spacing:2px!important;touch-action:manipulation!important;-webkit-tap-highlight-color:transparent!important;cursor:pointer;transition:all 0.2s;margin-right:12px;justify-content:center!important;}
.back:hover{color:var(--accent)!important;border-color:var(--accent-dim)!important;background:rgba(232,168,56,0.05)!important;}
.back::before{content:'â—„ ';}
.back::after{display:none!important;}

button{width:100%;padding:13px 18px;margin:5px 0;border:1px solid var(--border);background:var(--bg-card);color:var(--text);font-family:'Barlow Condensed','Arial Narrow',Arial,sans-serif;font-size:15px;font-weight:600;letter-spacing:2px;text-transform:uppercase;cursor:pointer;position:relative;overflow:hidden;transition:all 0.18s ease;text-align:left;display:flex;align-items:center;gap:10px;touch-action:manipulation;-webkit-tap-highlight-color:transparent;border-radius:0;outline:none;}
button::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--accent);opacity:0;transition:opacity 0.2s;}
button:hover{background:var(--bg-card2);color:var(--accent);border-color:var(--accent-dim);}
button:hover::before{opacity:1;}
button::after{content:'';position:absolute;bottom:-1px;right:-1px;width:13px;height:13px;background:var(--bg-deep);transform:translate(50%,50%) rotate(45deg);pointer-events:none;transition:background 0.18s;}
button:hover::after{background:var(--bg-card2);}
button.correct::after{background:rgba(58,154,92,0.15)!important;}
button.wrong::after{background:rgba(201,64,64,0.15)!important;}
button.played::after{background:var(--bg-panel)!important;}
button.choiceBtn{text-align:center;justify-content:center;}
button.choiceBtn::after{display:none;}
button.correct{background:rgba(58,154,92,0.15)!important;border-color:#3a9a5c!important;color:#5ecf8a!important;}
button.correct::before{background:#3a9a5c;opacity:1;}
button.wrong{background:rgba(201,64,64,0.15)!important;border-color:#c94040!important;color:#e86060!important;}
button.wrong::before{background:#c94040;opacity:1;}
button.played{background:var(--bg-panel)!important;border-color:var(--border)!important;color:var(--text-dim)!important;opacity:0.65;}
button:disabled{opacity:0.4;cursor:not-allowed;}
button:disabled:hover{background:var(--bg-card);color:var(--text);border-color:var(--border);}
button:disabled:hover::before,button:disabled:hover::after{opacity:0;}

.ark-stat-row{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;}
.ark-stat{flex:1;min-width:90px;background:var(--bg-card);border:1px solid var(--border);padding:10px 14px;clip-path:polygon(8px 0%,100% 0%,100% calc(100% - 8px),calc(100% - 8px) 100%,0% 100%,0% 8px);}
.ark-stat-label{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;}
.ark-stat-value{font-family:'Rajdhani',sans-serif;font-size:24px;font-weight:700;color:var(--accent);line-height:1.1;}

.ark-section{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--accent);text-transform:uppercase;margin:18px 0 10px;display:flex;align-items:center;gap:8px;}
.ark-section::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--accent-dim),transparent);}

.xp-bar-wrap{background:var(--bg-card);border:1px solid var(--border);padding:12px 14px;margin-bottom:14px;clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,0 100%);}
.xp-bar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.xp-rank{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:2px;}
.xp-nums{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);}
.xp-bar-bg{height:6px;background:var(--border);position:relative;overflow:hidden;}
.xp-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent-dim),var(--accent));box-shadow:0 0 8px var(--accent);transition:width 0.6s ease;}
.xp-bar-shine{position:absolute;top:0;left:-60px;width:40px;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.4),transparent);animation:xpShine 2s infinite;}
@keyframes xpShine{0%{left:-60px;}100%{left:110%}}

.ark-progress{height:3px;background:var(--border);margin:6px 0;}
.ark-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent-dim),var(--accent));transition:width 0.4s ease;box-shadow:0 0 6px var(--accent);}

.card{font-family:'Rajdhani','Arial Narrow',Arial,sans-serif;font-size:52px;font-weight:700;color:var(--text-bright);margin:16px 0;padding:28px 20px;background:var(--bg-card);border:1px solid var(--border);border-top:3px solid var(--accent);position:relative;clip-path:polygon(0 0,calc(100% - 20px) 0,100% 20px,100% 100%,0 100%);text-shadow:0 0 30px rgba(232,168,56,0.2);letter-spacing:4px;text-align:center;}
.card::before{content:'OPERATOR DATA';position:absolute;top:8px;left:12px;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--accent);opacity:0.6;}

.combo-display{text-align:center;padding:6px 0;font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700;color:var(--accent2);letter-spacing:3px;text-shadow:0 0 16px rgba(240,192,96,0.5);animation:comboPop 0.3s ease;}
@keyframes comboPop{from{transform:scale(1.3);}to{transform:scale(1);}}

.ark-lives{font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:600;color:var(--red);letter-spacing:2px;padding:8px 14px;background:rgba(201,64,64,0.08);border:1px solid rgba(201,64,64,0.25);border-left:3px solid var(--red);margin-bottom:10px;display:inline-block;}

input[type=text],input[type=number],textarea{width:100%;padding:11px 14px;margin:6px 0;background:var(--bg-panel);border:1px solid var(--border);border-left:3px solid var(--accent-dim);color:var(--text-bright);font-family:'Share Tech Mono','Courier New',monospace;font-size:13px;outline:none;transition:border-color 0.2s;border-radius:0;}
input[type=text]:focus,input[type=number]:focus,textarea:focus{border-color:var(--accent);border-left-color:var(--accent);box-shadow:0 0 0 1px rgba(232,168,56,0.15);}
input[type=file]{color:var(--text-dim);font-size:12px;margin:6px 0;display:block;}
input[type=checkbox]{accent-color:var(--accent);width:14px;height:14px;vertical-align:middle;}
input[type=range]{accent-color:var(--accent);cursor:pointer;background:transparent;border:none;border-left:none;padding:0;width:100%;margin-top:16px;}
label{font-size:13px;color:var(--text);display:flex;align-items:center;gap:8px;padding:6px 0;letter-spacing:1px;}
textarea{resize:vertical;min-height:100px;line-height:1.5;}
hr{border:none;border-top:1px solid var(--border);margin:16px 0;}
#info{font-family:'Share Tech Mono',monospace;font-size:13px;letter-spacing:1px;padding:10px;margin-top:8px;text-align:center;}

.ach-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;}
.ach-card{background:var(--bg-card);border:1px solid var(--border);padding:12px;clip-path:polygon(8px 0%,100% 0%,100% calc(100% - 8px),calc(100% - 8px) 100%,0% 100%,0% 8px);position:relative;overflow:hidden;}
.ach-card.unlocked{border-color:var(--accent-dim);}
.ach-card.unlocked::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent-dim),var(--accent));}
.ach-card.locked{opacity:0.42;filter:grayscale(0.5);}
.ach-icon{font-size:24px;margin-bottom:4px;}
.ach-name{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:var(--text-bright);letter-spacing:1px;}
.ach-desc{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;margin-top:2px;line-height:1.4;}
.ach-reward{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);margin-top:4px;}

.daily-card{background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--blue);padding:12px 14px;margin:6px 0;display:flex;align-items:center;gap:12px;}
.daily-card.done{border-left-color:var(--green);opacity:0.7;}
.daily-check{font-size:18px;min-width:24px;}
.daily-info{flex:1;}
.daily-title{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;color:var(--text-bright);letter-spacing:1px;}
.daily-prog{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:2px;}
.daily-reward{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);}

.levelup-overlay{position:fixed;inset:0;z-index:10000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.88);animation:fadeOvIn 0.3s ease;}
@keyframes fadeOvIn{from{opacity:0;}to{opacity:1;}}
.levelup-box{text-align:center;padding:40px 48px;background:var(--bg-card);border:1px solid var(--accent);clip-path:polygon(20px 0%,100% 0%,100% calc(100% - 20px),calc(100% - 20px) 100%,0% 100%,0% 20px);position:relative;animation:levelupPop 0.4s cubic-bezier(0.34,1.56,0.64,1);}
@keyframes levelupPop{from{transform:scale(0.7);opacity:0;}to{transform:scale(1);opacity:1;}}
.levelup-box::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at center,rgba(232,168,56,0.08) 0%,transparent 70%);pointer-events:none;}
.levelup-label{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:4px;color:var(--accent);margin-bottom:8px;}
.levelup-num{font-family:'Rajdhani',sans-serif;font-size:80px;font-weight:700;color:var(--accent);line-height:1;text-shadow:0 0 40px rgba(232,168,56,0.6);}
.levelup-rank{font-family:'Rajdhani',sans-serif;font-size:20px;color:var(--text-bright);letter-spacing:4px;margin-top:6px;}

.ach-toast{position:fixed;top:16px;right:16px;z-index:10001;background:var(--bg-card);border:1px solid var(--accent-dim);border-left:3px solid var(--accent);padding:12px 16px;max-width:280px;clip-path:polygon(8px 0%,100% 0%,100% calc(100% - 8px),calc(100% - 8px) 100%,0% 100%,0% 8px);animation:toastIn 0.3s ease;}
@keyframes toastIn{from{transform:translateX(120%);opacity:0;}to{transform:translateX(0);opacity:1;}}
.ach-toast-title{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--accent);}
.ach-toast-name{font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:var(--text-bright);letter-spacing:1px;}

.streak-fire{font-size:22px;animation:flicker 1.2s infinite alternate;}
@keyframes flicker{from{text-shadow:0 0 4px #e87000;}to{text-shadow:0 0 16px #ffb000,0 0 32px #ff6000;}}

.block-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0;}
.corner-deco{position:fixed;pointer-events:none;z-index:2;}
.corner-deco.tl{top:0;left:0;width:80px;height:80px;border-top:2px solid var(--accent-dim);border-left:2px solid var(--accent-dim);}
.corner-deco.br{bottom:0;right:0;width:80px;height:80px;border-bottom:2px solid var(--accent-dim);border-right:2px solid var(--accent-dim);}
.ark-ticker{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent-dim);letter-spacing:2px;border-top:1px solid var(--border);padding:6px 0;margin-top:12px;}
.ark-summary-big{font-family:'Rajdhani',sans-serif;font-size:60px;font-weight:700;color:var(--accent);line-height:1;text-shadow:0 0 40px rgba(232,168,56,0.4);text-align:center;}
#furigana{font-family:'Share Tech Mono',monospace!important;font-size:18px!important;color:var(--accent)!important;letter-spacing:3px;padding:8px;background:rgba(232,168,56,0.05);border:1px solid var(--accent-dim);margin-top:8px;text-align:center;}
</style>
</head>
<body>
<div class="corner-deco tl"></div>
<div class="corner-deco br"></div>
<div id="app"></div>
<script>
const app=document.getElementById("app");

/* â”€â”€ STATE â”€â”€ */
// Safe localStorage parser â€” returns fallback if missing or corrupt
function lsGet(key, fallback){
  try{let v=localStorage.getItem(key);return v!==null?JSON.parse(v):fallback;}
  catch(e){return fallback;}
}

let profiles     = lsGet("profiles", {});
let globalStats  = lsGet("globalStats", {xp:0,level:0,totalCorrect:0,totalSessions:0,grindDays:0,lastDay:''});
let playedGroups = lsGet("playedGroups", {});
let achievements = lsGet("achievements", {});
let dailyMissions= lsGet("dailyMissions", {date:'',missions:[],done:[],progress:{}});

// â”€â”€ Sanitize profiles: remove null/corrupt entries, repair missing fields â”€â”€
(function sanitizeProfiles(){
  if(!profiles || typeof profiles !== 'object'){profiles={};return;}
  Object.keys(profiles).forEach(name=>{
    let p=profiles[name];
    if(!p || typeof p !== 'object'){
      delete profiles[name]; // Remove corrupt entry
    } else {
      if(!Array.isArray(p.words)) p.words=[];
      if(typeof p.xp !== 'number') p.xp=0;
      // Repair any corrupt word entries
      p.words=p.words.filter(w=>w && typeof w==='object' && w.kanji);
      p.words.forEach(w=>{
        if(typeof w.correct !== 'number') w.correct=0;
        if(typeof w.wrong   !== 'number') w.wrong=0;
        if(!w.hira) w.hira='';
        if(!w.arti) w.arti='';
      });
    }
  });
})();

// â”€â”€ Sanitize globalStats: fill missing fields â”€â”€
globalStats = Object.assign({xp:0,level:0,totalCorrect:0,totalSessions:0,grindDays:0,lastDay:''}, globalStats||{});
if(typeof globalStats.xp !== 'number') globalStats.xp=0;

let currentProfile=null,words=[],sessionWords=[],gameMode="",gameType="",currentWord={};
let stepSize=25,currentStepAmount=0,answerDelay=1500,hardcoreMode=false,hardcoreTimer=2000;
let lives=4,timerInterval=null,isLocked=false;
let sessionCorrect=0,sessionTotal=0,sessionWrong=0,combo=0,sessionComboMax=0;
let currentBlockStart=0,currentBlockEnd=0,isCustomMode=false,customPool=[];
let sessionXpStart=0,sessionXpGain=0,sessionLevelStart=0;
let _customAmt=10;
let dailyProgress={correct:0,sessions:0,combo:0,noerror:0};
let sessionHistory=lsGet("sessionHistory", []);
let appLang=lsGet("appLang","jp"); // "jp" = Japanese, "en" = English
let globalMode=lsGet("globalMode",false); // mission select: global mode (kanji+arti only)
let resetCount=lsGet("resetCount",0); // how many times player has done a full reset
let choiceCount=Math.max(4,Math.min(8,lsGet("choiceCount",4))); // number of choices in multi-choice mode (4â€“8)
let sessionWordLimit=lsGet("sessionWordLimit",0); // 0 = no limit; otherwise cap words per session (10â€“100)
let randomOptions=lsGet("randomOptions",false); // pull distractors from full vocab (outside current group)
if(!Array.isArray(sessionHistory)) sessionHistory=[];

/* â”€â”€ LANGUAGE HELPER â”€â”€ */
const T={
  jp:{
    menu:"ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼",deployOp:"â¬¡ &nbsp;ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ",combatRec:"â–£ &nbsp;æˆ¦é—˜è¨˜éŒ²",
    achiev:"ğŸ† &nbsp;å®Ÿç¸¾ã‚®ãƒ£ãƒ©ãƒªãƒ¼",dailyMiss:"â—ˆ &nbsp;ãƒ‡ã‚¤ãƒªãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³",
    vocabDB:"ğŸ“– &nbsp;å˜èªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹",sessHist:"ğŸ“‹ &nbsp;ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´",
    transmit:"â‡ª &nbsp;é€²æ—ã‚’é€ä¿¡",langBtn:"EN",langLabel:"è¨€èª",
    howToPlay:"â“ &nbsp;éŠã³æ–¹",
    // header/nav
    back:"æˆ»ã‚‹",profile:"ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«",selectProfile:"ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼é¸æŠ",
    newProfile:"ï¼‹ æ–°è¦ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼",deleteProfile:"å‰Šé™¤",confirmDelete:"æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
    enterName:"ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼åã‚’å…¥åŠ›",create:"ä½œæˆ",cancel:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
    // stats
    operator:"ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼",streak:"é€£ç¶šãƒ­ã‚°ã‚¤ãƒ³",missions:"ãƒŸãƒƒã‚·ãƒ§ãƒ³",
    sessions:"ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°",avgAcc:"å¹³å‡æ­£è§£ç‡",best:"æœ€é«˜è©•ä¾¡",totalXp:"åˆè¨ˆXP",
    // game mode
    selectMode:"ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰é¸æŠ",modeKanji:"æ¼¢å­— â†’ èª­ã¿",modeHira:"èª­ã¿ â†’ æ¼¢å­—",
    modeArti:"æ¼¢å­— â†’ æ„å‘³",modeChoice:"å››æŠã‚¯ã‚¤ã‚º",
    startGame:"ã‚²ãƒ¼ãƒ é–‹å§‹",customAmt:"ã‚«ã‚¹ã‚¿ãƒ å‡ºé¡Œæ•°",customBlock:"ãƒ–ãƒ­ãƒƒã‚¯é¸æŠ",
    allWords:"å…¨å˜èª",
    // gameplay
    correct:"æ­£è§£ï¼",wrong:"ä¸æ­£è§£",lives:"ãƒ©ã‚¤ãƒ•",combo:"ã‚³ãƒ³ãƒœ",
    revealFuri:"èª­ã¿ä»®åã‚’è¡¨ç¤º",skip:"ã‚¹ã‚­ãƒƒãƒ—",next:"æ¬¡ã¸",
    // results
    sessionComplete:"ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†",accuracy:"æ­£è§£ç‡",grade:"è©•ä¾¡",
    xpGained:"ç²å¾—XP",backMenu:"ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸",playAgain:"ã‚‚ã†ä¸€åº¦",
    // vocab
    vocabTitle:"å˜èªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹",masteredWords:"ç¿’å¾—æ¸ˆã¿å˜èª",totalWords:"ç·å˜èªæ•°",
    // history
    histTitle:"ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´",runs:"å›",recentOps:"ç›´è¿‘ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",clearHist:"âœ• å±¥æ­´ã‚’å‰Šé™¤",
    confirmClearHist:"å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
    // daily missions
    todayMissions:"æœ¬æ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³",grindStreak:"é€£ç¶šãƒ­ã‚°ã‚¤ãƒ³",
    dayStreak:"æ—¥é€£ç¶š",keepStreak:"æ¯æ—¥ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’ç¶­æŒã—ã‚ˆã†ï¼",
    resets:"ãƒªã‚»ãƒƒãƒˆ",
    // achievements
    achievTitle:"å®Ÿç¸¾ä¸€è¦§",locked:"æœªé”æˆ",unlocked:"é”æˆæ¸ˆã¿",
    achUnlocked:"â¬¡ å®Ÿç¸¾è§£é™¤",xpBonus:"XP ãƒœãƒ¼ãƒŠã‚¹",
    achNames:{
      first_blood:"åˆé™£",centurion:"ç™¾äººæ–¬ã‚Š",veteran:"æ­´æˆ¦ã®å‹‡å£«",legend:"ä¼èª¬",
      lv10:"å£«å®˜æ˜‡é€²",lv25:"ç¾å ´æ˜‡é€²",lv50:"ã‚¨ãƒªãƒ¼ãƒˆæ˜‡é€²",lv80:"æœ€é«˜ä½",
      combo5:"é€£ç¶šæ”»æ’ƒ",combo10:"æ­¢ã¾ã‚‰ãªã„",combo20:"é€£é–åå¿œ",
      sessions10:"ç²¾é‹­",sessions50:"å®¹èµ¦ãªã—",
      streak3:"3æ—¥æˆ¦å£«",streak7:"é€±é–“æˆ¦å£«",streak30:"æœˆé–“ä¼èª¬",
      perfect10:"å®Œç’§",speedster:"ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¹ã‚¿ãƒ¼",
      master10:"å­¦è€…",master50:"è³¢è€…",
      reset1:"åˆå›ãƒªã‚»ãƒƒãƒˆ",reset2:"äºŒé‡ãƒªã‚»ãƒƒãƒˆ",reset3:"ä¸‰é‡ã®è„…å¨",
      reset5:"ç„¡é™ãƒ«ãƒ¼ãƒ—",reset10:"ç„¡é™ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼",
    },
    achDescs:{
      first_blood:"{1}å•æ­£è§£ã™ã‚‹",centurion:"{100}å•æ­£è§£ã™ã‚‹",veteran:"{500}å•æ­£è§£ã™ã‚‹",legend:"{2000}å•æ­£è§£ã™ã‚‹",
      lv10:"ãƒ¬ãƒ™ãƒ«{10}ã«åˆ°é”",lv25:"ãƒ¬ãƒ™ãƒ«{25}ã«åˆ°é”",lv50:"ãƒ¬ãƒ™ãƒ«{50}ã«åˆ°é”",lv80:"ãƒ¬ãƒ™ãƒ«{80}ã«åˆ°é”",
      combo5:"1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§{5}ã‚³ãƒ³ãƒœé”æˆ",combo10:"1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§{10}ã‚³ãƒ³ãƒœé”æˆ",combo20:"1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§{20}ã‚³ãƒ³ãƒœé”æˆ",
      sessions10:"{10}ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†",sessions50:"{50}ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†",
      streak3:"{3}æ—¥é€£ç¶šãƒ­ã‚°ã‚¤ãƒ³",streak7:"{7}æ—¥é€£ç¶šãƒ­ã‚°ã‚¤ãƒ³",streak30:"{30}æ—¥é€£ç¶šãƒ­ã‚°ã‚¤ãƒ³",
      perfect10:"ãƒŸã‚¹ãªã—10å•æ­£è§£",speedster:"ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å‹åˆ©",
      master10:"{10}å˜èªã‚’ç¿’å¾—ï¼ˆâ‰¥5å›æ­£è§£ï¼‰",master50:"{50}å˜èªã‚’ç¿’å¾—",
      reset1:"1å›ãƒ•ãƒ«ãƒªã‚»ãƒƒãƒˆå®Œäº†",reset2:"2å›ãƒ•ãƒ«ãƒªã‚»ãƒƒãƒˆå®Œäº†",reset3:"3å›ãƒ•ãƒ«ãƒªã‚»ãƒƒãƒˆå®Œäº†",
      reset5:"5å›ãƒ•ãƒ«ãƒªã‚»ãƒƒãƒˆå®Œäº†",reset10:"10å›ãƒ•ãƒ«ãƒªã‚»ãƒƒãƒˆå®Œäº†",
    },
    // daily mission titles
    missionTitles:{
      m_c20:"æœ¬æ—¥20å•æ­£è§£ã™ã‚‹",m_c50:"æœ¬æ—¥50å•æ­£è§£ã™ã‚‹",
      m_s2:"æœ¬æ—¥2ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†",m_cb8:"8ã‚³ãƒ³ãƒœé”æˆ",
      m_ne10:"ãƒŸã‚¹ãªã—10å•æ­£è§£",m_c100:"æœ¬æ—¥100å•æ­£è§£ã™ã‚‹",
      m_s3:"æœ¬æ—¥3ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†",m_cb15:"15ã‚³ãƒ³ãƒœé”æˆ",
    },
    // prestige / reset UI
    allComplete:"å…¨{N}å®Ÿç¸¾é”æˆï¼",
    prestigeReset:"âŸ³ ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆ",
    prestigeBtn:"ğŸ” ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆ â†’ {M}Ã— é›£æ˜“åº¦",
    prestigeLocked:"ğŸ”’ ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆè§£é™¤æ¸ˆã¿ â€” ã¾ãšå…¨å®Ÿç¸¾ã‚’é”æˆã—ã¦ãã ã•ã„",
    prestigeRemaining:"{R}å€‹æ®‹ã‚Š Â· ãƒªã‚»ãƒƒãƒˆå›æ•°: {C}",
    trueMax:"ğŸ‘‘ å…¨å®Ÿç¸¾é”æˆ â€” æœ€é«˜é›£æ˜“åº¦åˆ°é” â€” çœŸã®ä¼èª¬",
    hardnessBanner:"âš¡ ãƒªã‚»ãƒƒãƒˆ #{N} ã‚¢ã‚¯ãƒ†ã‚£ãƒ– â€” é›£æ˜“åº¦ {M}Ã—",
    // share
    shareTitle:"é€²æ—ã‚’é€ä¿¡",
    // settings
    settings:"è¨­å®š",hardcoreMode:"ãƒãƒ¼ãƒ‰ã‚³ã‚¢ãƒ¢ãƒ¼ãƒ‰",answerDelay:"å›ç­”é…å»¶",
    globalMode:"ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ¼¢å­—ï¼‹æ„å‘³ã®ã¿ï¼‰",
  },
  en:{
    menu:"MAIN MENU",deployOp:"â¬¡ &nbsp;Start Game",combatRec:"â–£ &nbsp;Combat Records",
    achiev:"ğŸ† &nbsp;Achievement Gallery",dailyMiss:"â—ˆ &nbsp;Daily Missions",
    vocabDB:"ğŸ“– &nbsp;Vocabulary Database",sessHist:"ğŸ“‹ &nbsp;Session History",
    transmit:"â‡ª &nbsp;Transmit Progress",langBtn:"JP",langLabel:"Language",
    howToPlay:"â“ &nbsp;How to Play",
    // header/nav
    back:"BACK",profile:"PROFILE",selectProfile:"SELECT OPERATOR",
    newProfile:"+ NEW OPERATOR",deleteProfile:"DELETE",confirmDelete:"Really delete this profile?",
    enterName:"Enter operator name",create:"CREATE",cancel:"CANCEL",
    // stats
    operator:"Operator",streak:"Streak",missions:"Missions",
    sessions:"Sessions",avgAcc:"Avg Acc.",best:"Best",totalXp:"Total XP",
    // game mode
    selectMode:"SELECT MODE",modeKanji:"Kanji â†’ Reading",modeHira:"Reading â†’ Kanji",
    modeArti:"Kanji â†’ Meaning",modeChoice:"Multiple Choice",
    startGame:"START",customAmt:"Custom Amount",customBlock:"Block Select",
    allWords:"All Words",
    // gameplay
    correct:"CORRECT!",wrong:"WRONG",lives:"LIVES",combo:"COMBO",
    revealFuri:"Reveal Furigana",skip:"SKIP",next:"NEXT",
    // results
    sessionComplete:"SESSION COMPLETE",accuracy:"Accuracy",grade:"Grade",
    xpGained:"XP Gained",backMenu:"MAIN MENU",playAgain:"PLAY AGAIN",
    // vocab
    vocabTitle:"VOCABULARY DATABASE",masteredWords:"Mastered Words",totalWords:"Total Words",
    // history
    histTitle:"Session History",runs:"RUNS",recentOps:"RECENT OPERATIONS â€” LAST",
    clearHist:"âœ• &nbsp;CLEAR HISTORY",confirmClearHist:"Clear all session history?",
    // daily missions
    todayMissions:"TODAY'S MISSIONS",grindStreak:"GRIND STREAK",
    dayStreak:"DAY CONSECUTIVE STREAK",keepStreak:"Log in daily to keep your streak alive!",
    resets:"RESETS",
    // achievements
    achievTitle:"ACHIEVEMENTS",locked:"LOCKED",unlocked:"UNLOCKED",
    achUnlocked:"â¬¡ ACHIEVEMENT UNLOCKED",xpBonus:"XP BONUS",
    achNames:{
      first_blood:"First Blood",centurion:"Centurion",veteran:"Veteran",legend:"Legendary",
      lv10:"Cadet Promotion",lv25:"Field Promotion",lv50:"Elite Promotion",lv80:"Supreme Class",
      combo5:"Hot Streak",combo10:"Unstoppable",combo20:"Chain Reaction",
      sessions10:"Dedicated",sessions50:"Relentless",
      streak3:"3-Day Warrior",streak7:"Week Warrior",streak30:"Monthly Legend",
      perfect10:"Flawless",speedster:"Speedster",
      master10:"Scholar",master50:"Sage",
      reset1:"First Reset",reset2:"Double Reset",reset3:"Triple Threat",
      reset5:"Endless Loop",reset10:"Infinite Operator",
    },
    achDescs:{
      first_blood:"Answer {1} correctly",centurion:"Answer {100} correctly",veteran:"Answer {500} correctly",legend:"Answer {2000} correctly",
      lv10:"Reach level {10}",lv25:"Reach level {25}",lv50:"Reach level {50}",lv80:"Reach level {80}",
      combo5:"{5} combo in one session",combo10:"{10} combo in one session",combo20:"{20} combo in one session",
      sessions10:"Complete {10} sessions",sessions50:"Complete {50} sessions",
      streak3:"{3} consecutive login days",streak7:"{7} consecutive login days",streak30:"{30} consecutive login days",
      perfect10:"10 correct with 0 mistakes",speedster:"Win a Hardcore session",
      master10:"Master {10} words (â‰¥5 correct)",master50:"Master {50} words",
      reset1:"Complete 1 full reset",reset2:"Complete 2 full resets",reset3:"Complete 3 full resets",
      reset5:"Complete 5 full resets",reset10:"Complete 10 full resets",
    },
    missionTitles:{
      m_c20:"Answer 20 correctly today",m_c50:"Answer 50 correctly today",
      m_s2:"Complete 2 sessions today",m_cb8:"Reach an 8-combo streak",
      m_ne10:"10 correct with no mistakes",m_c100:"Answer 100 correctly today",
      m_s3:"Complete 3 sessions today",m_cb15:"Reach a 15-combo streak",
    },
    prestigeReset:"âŸ³ PRESTIGE RESET",
    prestigeBtn:"ğŸ” PRESTIGE RESET â†’ {M}Ã— HARDNESS",
    prestigeLocked:"ğŸ”’ PRESTIGE RESET LOCKED â€” COMPLETE ALL ACHIEVEMENTS FIRST",
    prestigeRemaining:"{R} remaining Â· Resets completed: {C}",
    allComplete:"ğŸ‰ ALL {N} ACHIEVEMENTS COMPLETE!",
    trueMax:"ğŸ‘‘ ALL ACHIEVEMENTS COMPLETE â€” MAX HARDNESS REACHED â€” TRUE LEGEND",
    hardnessBanner:"âš¡ RESET #{N} ACTIVE â€” HARDNESS {M}Ã—",
    // share
    shareTitle:"TRANSMIT PROGRESS",
    // settings
    settings:"SETTINGS",hardcoreMode:"Hardcore Mode",answerDelay:"Answer Delay",
    globalMode:"Global Mode (Kanji+Meaning only)",
  }
};
function t(key){return (T[appLang]||T.en)[key]||key;}

/* â”€â”€ RESET ACHIEVEMENTS â”€â”€ */
const RESET_ACHIEVEMENTS=[
  {id:"reset1", resets:1,  mult:1.5, icon:"ğŸ”", name:"First Reset",       desc:"Complete 1 full reset",          reward:1000},
  {id:"reset2", resets:2,  mult:2.0, icon:"ğŸ”„", name:"Double Reset",       desc:"Complete 2 full resets",         reward:2500},
  {id:"reset3", resets:3,  mult:2.5, icon:"âš¡", name:"Triple Threat",      desc:"Complete 3 full resets",         reward:5000},
  {id:"reset5", resets:5,  mult:3.0, icon:"ğŸ’€", name:"Endless Loop",       desc:"Complete 5 full resets",         reward:10000},
  {id:"reset10",resets:10, mult:4.0, icon:"ğŸ‘‘", name:"Infinite Operator",  desc:"Complete 10 full resets",        reward:25000},
];

/* â”€â”€ SAVE â”€â”€ */
function saveAll(){
  localStorage.setItem("profiles",JSON.stringify(profiles));
  localStorage.setItem("globalStats",JSON.stringify(globalStats));
  localStorage.setItem("playedGroups",JSON.stringify(playedGroups));
  localStorage.setItem("achievements",JSON.stringify(achievements));
  localStorage.setItem("dailyMissions",JSON.stringify(dailyMissions));
  localStorage.setItem("sessionHistory",JSON.stringify(sessionHistory));
  localStorage.setItem("appLang",JSON.stringify(appLang));
  localStorage.setItem("globalMode",JSON.stringify(globalMode));
  localStorage.setItem("resetCount",JSON.stringify(resetCount));
  localStorage.setItem("choiceCount",JSON.stringify(choiceCount));
  localStorage.setItem("sessionWordLimit",JSON.stringify(sessionWordLimit));
  localStorage.setItem("randomOptions",JSON.stringify(randomOptions));
}


/* â”€â”€ HARDNESS MULTIPLIER â”€â”€ */
function getHardnessMult(){
  let m=1.0;
  RESET_ACHIEVEMENTS.forEach(r=>{if(resetCount>=r.resets)m=r.mult;});
  return m;
}
function xpForLevel(lvl){return Math.min(100+Math.floor(lvl/10)*150,3000);}
function calcLevel(totalXp){let l=0,x=totalXp;while(x>=xpForLevel(l)){x-=xpForLevel(l);l++;}return l;}
function xpInCurrentLevel(totalXp){let l=0,x=totalXp;while(x>=xpForLevel(l)){x-=xpForLevel(l);l++;}return x;}
function getRankTitle(level){
  if(level>=80)return{title:"SUPREME OPERATOR",color:"#ff80ff",glow:"0 0 20px rgba(255,128,255,0.6)"};
  if(level>=60)return{title:"SENIOR OPERATOR",color:"#e8a838",glow:"0 0 16px rgba(232,168,56,0.5)"};
  if(level>=40)return{title:"ELITE OPERATOR",color:"#3a9a5c",glow:"0 0 14px rgba(58,154,92,0.5)"};
  if(level>=25)return{title:"FIELD OPERATOR",color:"#3a72b0",glow:"none"};
  if(level>=10)return{title:"CADET",color:"#6e7a8a",glow:"none"};
  return{title:"RECRUIT",color:"#4a5060",glow:"none"};
}
function comboMultiplier(c){if(c>=20)return 3.0;if(c>=10)return 2.0;if(c>=5)return 1.5;return 1.0;}
function shuffle(a){return a.sort(()=>Math.random()-0.5);}

/* â”€â”€ ACHIEVEMENTS â”€â”€ */
// Base thresholds â€” multiplied by hardness on each reset
const ACH_BASE=[
  {id:"first_blood", icon:"âš”ï¸",  name:"First Blood",     baseDesc:"Answer {1} correctly",          reward:50,   type:"totalCorrect",   base:1},
  {id:"centurion",   icon:"ğŸ’¯",  name:"Centurion",        baseDesc:"Answer {100} correctly",         reward:200,  type:"totalCorrect",   base:100},
  {id:"veteran",     icon:"ğŸ–ï¸", name:"Veteran",          baseDesc:"Answer {500} correctly",         reward:500,  type:"totalCorrect",   base:500},
  {id:"legend",      icon:"ğŸ†", name:"Legendary",        baseDesc:"Answer {2000} correctly",        reward:2000, type:"totalCorrect",   base:2000},
  {id:"lv10",        icon:"â¬¡",  name:"Cadet Promotion",  baseDesc:"Reach level {10}",               reward:300,  type:"level",          base:10},
  {id:"lv25",        icon:"â¬¡",  name:"Field Promotion",  baseDesc:"Reach level {25}",               reward:600,  type:"level",          base:25},
  {id:"lv50",        icon:"â¬¡",  name:"Elite Promotion",  baseDesc:"Reach level {50}",               reward:1500, type:"level",          base:50},
  {id:"lv80",        icon:"ğŸ‘‘", name:"Supreme Class",    baseDesc:"Reach level {80}",               reward:5000, type:"level",          base:80},
  {id:"combo5",      icon:"ğŸ”¥", name:"Hot Streak",       baseDesc:"{5} combo in one session",       reward:75,   type:"_combo",         base:5},
  {id:"combo10",     icon:"ğŸ’¥", name:"Unstoppable",      baseDesc:"{10} combo in one session",      reward:150,  type:"_combo",         base:10},
  {id:"combo20",     icon:"âš¡", name:"Chain Reaction",   baseDesc:"{20} combo in one session",      reward:500,  type:"_combo",         base:20},
  {id:"sessions10",  icon:"ğŸ“‹", name:"Dedicated",        baseDesc:"Complete {10} sessions",         reward:200,  type:"totalSessions",  base:10},
  {id:"sessions50",  icon:"ğŸ“‹", name:"Relentless",       baseDesc:"Complete {50} sessions",         reward:800,  type:"totalSessions",  base:50},
  {id:"streak3",     icon:"ğŸ“…", name:"3-Day Warrior",    baseDesc:"{3} consecutive login days",     reward:150,  type:"grindDays",      base:3},
  {id:"streak7",     icon:"ğŸ“…", name:"Week Warrior",     baseDesc:"{7} consecutive login days",     reward:500,  type:"grindDays",      base:7},
  {id:"streak30",    icon:"ğŸ“…", name:"Monthly Legend",   baseDesc:"{30} consecutive login days",    reward:3000, type:"grindDays",      base:30},
  {id:"perfect10",   icon:"âœ¨", name:"Flawless",         baseDesc:"10 correct with 0 mistakes",     reward:300,  type:"_perfect",       base:0},
  {id:"speedster",   icon:"â±ï¸", name:"Speedster",        baseDesc:"Win a Hardcore session",         reward:400,  type:"_hardcoreWin",   base:0},
  {id:"master10",    icon:"ğŸ“–", name:"Scholar",          baseDesc:"Master {10} words (â‰¥5 correct)", reward:100,  type:"masteredWords",  base:10},
  {id:"master50",    icon:"ğŸ“š", name:"Sage",             baseDesc:"Master {50} words",              reward:500,  type:"masteredWords",  base:50},
];

// Build ACHIEVEMENTS dynamically â€” thresholds scale with hardness
function buildAchievements(){
  let hm=getHardnessMult();
  let lang=T[appLang]||T.en;
  return ACH_BASE.map(a=>{
    let threshold=Math.ceil(a.base*hm);
    let rawDesc=(lang.achDescs&&lang.achDescs[a.id])||a.baseDesc;
    let desc=rawDesc.replace(/\{(\d+)\}/,()=>threshold);
    let name=(lang.achNames&&lang.achNames[a.id])||a.name;
    return {...a, name, threshold, desc,
      check:(g,p)=>{
        if(a.type==='_perfect')     return !!g._perfect;
        if(a.type==='_hardcoreWin') return !!g._hardcoreWin;
        if(a.type==='_combo')       return (g._combo||0)>=threshold;
        if(a.type==='masteredWords') return p&&p.words&&p.words.filter(w=>w.correct>=5).length>=threshold;
        return (g[a.type]||0)>=threshold;
      }
    };
  });
}
// Recompute on access
function getAchievements(){return buildAchievements();}

function allNonResetUnlocked(){
  let achs=getAchievements();
  return achs.every(a=>achievements[a.id]);
}

function checkAchievements(extra={}){
  let profile=currentProfile?profiles[currentProfile]:null;
  let g={...globalStats,...extra};
  let achs=getAchievements();
  let unlocked=[];
  achs.forEach(a=>{
    if(!achievements[a.id]&&a.check(g,profile)){
      achievements[a.id]={unlockedAt:Date.now()};
      globalStats.xp+=a.reward;
      globalStats.level=calcLevel(globalStats.xp);
      unlocked.push(a);
    }
  });
  if(unlocked.length)saveAll();
  return unlocked;
}
function showAchievementToast(a){
  let toast=document.createElement("div");
  toast.className="ach-toast";
  toast.innerHTML=`<div class="ach-toast-title">${t('achUnlocked')}</div><div class="ach-toast-name">${a.icon} ${a.name}</div><div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);margin-top:4px;">+${a.reward} ${t('xpBonus')}</div>`;
  document.body.appendChild(toast);
  setTimeout(()=>{toast.style.transition="opacity 0.3s";toast.style.opacity="0";setTimeout(()=>toast.remove(),300);},3200);
}

/* â”€â”€ DAILY MISSIONS â”€â”€ */
const MISSION_POOL=[
  {id:"m_c20",  title:"Answer 20 correctly today",  reward:100,target:20, type:"correct"},
  {id:"m_c50",  title:"Answer 50 correctly today",  reward:250,target:50, type:"correct"},
  {id:"m_s2",   title:"Complete 2 sessions today",  reward:80, target:2,  type:"sessions"},
  {id:"m_cb8",  title:"Reach an 8-combo streak",    reward:120,target:8,  type:"combo"},
  {id:"m_ne10", title:"10 correct with no mistakes",reward:150,target:10, type:"noerror"},
  {id:"m_c100", title:"Answer 100 correctly today", reward:400,target:100,type:"correct"},
  {id:"m_s3",   title:"Complete 3 sessions today",  reward:180,target:3,  type:"sessions"},
  {id:"m_cb15", title:"Reach a 15-combo streak",    reward:300,target:15, type:"combo"},
];

function ensureDailyMissions(){
  let today=new Date().toDateString();
  if(dailyMissions.date!==today){
    dailyMissions={date:today,missions:shuffle([...MISSION_POOL]).slice(0,3),done:[],progress:{}};
    dailyProgress={correct:0,sessions:0,combo:0,noerror:0};
    saveAll();
  } else {
    dailyProgress=dailyMissions.progress||{correct:0,sessions:0,combo:0,noerror:0};
  }
}

function updateDailyProgress(type,val){
  dailyProgress[type]=(dailyProgress[type]||0)+val;
  dailyMissions.progress=dailyProgress;
  dailyMissions.missions.forEach(m=>{
    if(!dailyMissions.done.includes(m.id)&&(dailyProgress[m.type]||0)>=m.target){
      dailyMissions.done.push(m.id);
      globalStats.xp+=m.reward;
      globalStats.level=calcLevel(globalStats.xp);
      showMissionToast(m);
    }
  });
  saveAll();
}

function showMissionToast(m){
  let lang=T[appLang]||T.en;
  let title=(lang.missionTitles&&lang.missionTitles[m.id])||m.title;
  let toastEl=document.createElement("div");
  toastEl.className="ach-toast";
  toastEl.style.borderLeftColor="var(--blue)";
  toastEl.innerHTML=`<div class="ach-toast-title" style="color:var(--blue);">â—ˆ ${appLang==='jp'?'ãƒŸãƒƒã‚·ãƒ§ãƒ³å®Œäº†':'MISSION COMPLETE'}</div><div class="ach-toast-name">${title}</div><div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);margin-top:4px;">+${m.reward} XP</div>`;
  document.body.appendChild(toastEl);
  setTimeout(()=>{toastEl.style.transition="opacity 0.3s";toastEl.style.opacity="0";setTimeout(()=>toastEl.remove(),300);},3500);
}

/* â”€â”€ STREAK â”€â”€ */
function updateDailyStreak(){
  let today=new Date().toDateString();
  let yesterday=new Date(Date.now()-86400000).toDateString();
  if(globalStats.lastDay===today)return;
  globalStats.grindDays=(globalStats.lastDay===yesterday)?(globalStats.grindDays||0)+1:1;
  globalStats.lastDay=today;
  saveAll();
}

/* â”€â”€ LEVEL UP OVERLAY â”€â”€ */
function showLevelUp(newLevel,cb){
  let rank=getRankTitle(newLevel);
  let ov=document.createElement("div");
  ov.className="levelup-overlay";
  ov.innerHTML=`<div class="levelup-box" style="box-shadow:${rank.glow};"><div class="levelup-label">LEVEL UP</div><div class="levelup-num" style="color:${rank.color};">${newLevel}</div><div class="levelup-rank" style="color:${rank.color};">${rank.title}</div><div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:16px;letter-spacing:2px;">TAP TO CONTINUE</div></div>`;
  document.body.appendChild(ov);
  let done=false;
  function proceed(){if(done)return;done=true;ov.remove();if(cb)cb();}
  ov.addEventListener("click",proceed);
  setTimeout(proceed,4000);
}

/* â”€â”€ XP BAR WIDGET â”€â”€ */
function renderXpBar(){
  let lvl=globalStats.level,rank=getRankTitle(lvl);
  let cur=xpInCurrentLevel(globalStats.xp),need=xpForLevel(lvl);
  let pct=Math.min(100,Math.floor((cur/need)*100));
  return `<div class="xp-bar-wrap"><div class="xp-bar-header"><div><span class="xp-rank" style="color:${rank.color};">LV ${lvl}</span><span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-left:8px;letter-spacing:1px;">${rank.title}</span></div><div class="xp-nums">${cur} / ${need} XP</div></div><div class="xp-bar-bg"><div class="xp-bar-fill" style="width:${pct}%;"></div><div class="xp-bar-shine"></div></div></div>`;
}

/* â”€â”€ MENU â”€â”€ */
function renderMenu(){
  ensureDailyMissions();updateDailyStreak();
  let achs=checkAchievements();
  achs.forEach((a,i)=>setTimeout(()=>showAchievementToast(a),400+i*3300));
  let streakEmoji=globalStats.grindDays>=7?"ğŸ”¥":globalStats.grindDays>=3?"ğŸŒŸ":"ğŸ“…";
  // Current hardness multiplier based on resetCount
  let currentMult=1.0;
  let rach=RESET_ACHIEVEMENTS.filter(r=>resetCount>=r.resets);
  if(rach.length>0)currentMult=rach[rach.length-1].mult;
  let resetBadge=resetCount>0?`<div class="ark-badge" style="color:var(--purple);border-color:var(--purple);background:rgba(156,85,208,0.1);">RESET Ã—${resetCount} | ${currentMult}Ã— HARD</div>`:'';
  app.innerHTML=`<div class="container">
    <div class="ark-header"><div style="flex:1;"><div class="ark-title">KOTOBA <span>TRAINER</span></div><div class="ark-badge">PROTOCOL v3.0 // RHODES ISLAND</div>${resetBadge}</div>
    <div style="display:flex;flex-direction:column;align-items:center;gap:3px;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;">${t('langLabel')}</div>
      <button id="btn-lang-toggle" style="width:auto;min-width:52px;padding:5px 12px;font-size:12px;font-weight:700;border-color:var(--accent-dim);color:var(--accent);justify-content:center;letter-spacing:2px;">${t('langBtn')}</button>
    </div>
    </div>
    ${renderXpBar()}
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">${t('operator')}</div><div class="ark-stat-value" style="font-size:13px;">${currentProfile||'---'}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${streakEmoji} ${t('streak')}</div><div class="ark-stat-value">${globalStats.grindDays}d</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${t('missions')}</div><div class="ark-stat-value" style="color:${dailyMissions.done.length===dailyMissions.missions.length?'var(--green)':'var(--accent)'};">${dailyMissions.done.length}/${dailyMissions.missions.length}</div></div>
    </div>
    <div class="ark-section">${t('menu')}</div>
    <button data-action="renderProfile">${t('deployOp')}</button>
    <button data-action="renderStats">${t('combatRec')}</button>
    <button data-action="renderAchievements">${t('achiev')}</button>
    <button data-action="renderDailyMissions">${t('dailyMiss')}</button>
    <button data-action="renderKotoba">${t('vocabDB')}</button>
    <button data-action="renderHistory">${t('sessHist')}</button>
    <button data-action="renderShare">${t('transmit')}</button>
    <button id="btn-how-to-play" style="border-color:var(--blue);color:var(--blue);background:rgba(58,114,176,0.05);">${t('howToPlay')}</button>
    <div class="ark-ticker">// RHODES ISLAND PHARMACEUTICAL // TRAINING PROTOCOL ACTIVE // ${globalStats.grindDays} DAY STREAK //</div>
  </div>`;
  document.getElementById("btn-lang-toggle").addEventListener("click",()=>{
    appLang=appLang==="jp"?"en":"jp";saveAll();renderMenu();
  });
  document.getElementById("btn-how-to-play").addEventListener("click", renderHowToPlay);
}

/* â”€â”€ HOW TO PLAY â”€â”€ */
function renderHowToPlay(){
  let isJP=appLang==='jp';

  let sections=isJP?`
    <div class="ark-section">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ä½œã‚Šæ–¹</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--accent);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:1.9;letter-spacing:0.5px;margin:0;">
        1. ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ <span style="color:var(--accent);">ã€Œã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆã€</span> ã‚’é¸æŠ<br>
        2. <span style="color:var(--accent);">ã€Œã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼åã€</span> ã®å…¥åŠ›æ¬„ã«åå‰ã‚’å…¥åŠ›ã™ã‚‹<br>
        3. CSVãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆã§å˜èªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹<br>
        4. <span style="color:var(--accent);">ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã€</span> ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ä½œæˆå®Œäº†ï¼
      </p>
    </div>

    <div class="ark-section">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èªãƒ¢ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå½¢å¼</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--accent);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:1.8;margin:0 0 10px;">
        å„è¡Œã‚’ä»¥ä¸‹ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š<br>
        <span style="color:var(--accent2);font-size:13px;letter-spacing:1px;">æ¼¢å­—,ã²ã‚‰ãŒãª,æ„å‘³</span>
      </p>
      <div style="background:var(--bg-deep);border:1px solid var(--border);padding:12px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--green);line-height:2.1;">
        æ—¥æœ¬èª,ã«ã»ã‚“ã”,Japanese language<br>
        å­¦æ ¡,ãŒã£ã“ã†,school<br>
        é£Ÿã¹ã‚‹,ãŸã¹ã‚‹,to eat<br>
        é›»è»Š,ã§ã‚“ã—ã‚ƒ,train<br>
        å‹é”,ã¨ã‚‚ã ã¡,friend
      </div>
      <p style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin:8px 0 0;line-height:1.7;">
        â€» 3åˆ—å¿…é ˆï¼šæ¼¢å­— / ã²ã‚‰ãŒãª / æ„å‘³<br>
        â€» ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€1è¡Œ1å˜èª
      </p>
    </div>

    <div class="ark-section">ğŸŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå½¢å¼</div>
    <div style="background:var(--bg-card);border:1px solid rgba(58,114,176,0.4);border-left:3px solid var(--blue);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:1.8;margin:0 0 10px;">
        ã²ã‚‰ãŒãªãŒä¸è¦ãªå ´åˆã¯2åˆ—ç›®ã« <span style="color:var(--accent2);">ã€Œ-ã€</span> ã‚’å…¥ã‚Œã‚‹ã ã‘ï¼š<br>
        <span style="color:var(--accent2);font-size:13px;letter-spacing:1px;">å˜èª,-,æ„å‘³</span>
      </p>
      <div style="background:var(--bg-deep);border:1px solid var(--border);padding:12px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--green);line-height:2.1;">
        apple,-,ã‚Šã‚“ã”<br>
        cat,-,çŒ«<br>
        é‹å‹•,-,exercise<br>
        å‹‡æ°—,-,courage
      </div>
      <p style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin:8px 0 0;line-height:1.7;">
        â€» 2åˆ—ç›®ã¯ä½¿ã‚ã‚Œã¾ã›ã‚“ã€‚ä½•ã‚’å…¥ã‚Œã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚
      </p>
    </div>

    <div class="ark-section">â˜  ãƒãƒ¼ãƒ‰ã‚³ã‚¢ãƒ¢ãƒ¼ãƒ‰</div>
    <div style="background:rgba(201,64,64,0.07);border:1px solid rgba(201,64,64,0.3);border-left:3px solid var(--red);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:2;margin:0;">
        ğŸ”´ <span style="color:var(--red);">ã‚¿ã‚¤ãƒãƒ¼åˆ¶é™</span> â€” æ™‚é–“å†…ã«ç­”ãˆãªã„ã¨ãƒ©ã‚¤ãƒ•ã‚’å¤±ã†<br>
        ğŸ”´ <span style="color:var(--red);">ãƒ©ã‚¤ãƒ•åˆ¶ â¤â¤â¤â¤</span> â€” ãƒ©ã‚¤ãƒ•ãŒ0ã§ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼<br>
        ğŸ”´ ãƒŸã‚¹ã™ã‚‹ã¨XPãŒæ¸›å°‘ï¼ˆâˆ’15XPï¼‰<br>
        ğŸ”´ ã‚¿ã‚¤ãƒãƒ¼æ™‚é–“ã¯ã‚²ãƒ¼ãƒ è¨­å®šç”»é¢ã§å¤‰æ›´å¯èƒ½<br>
        â­ å…¨å•æ­£è§£ã™ã‚‹ã¨ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¹ã‚¿ãƒ¼å®Ÿç¸¾ã‚’ç²å¾—ï¼
      </p>
    </div>`

  :`
    <div class="ark-section">ğŸ‘¤ How to Create a Profile</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--accent);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:1.9;letter-spacing:0.5px;margin:0;">
        1. From the main menu tap <span style="color:var(--accent);">"Start Game"</span><br>
        2. Type a name in the <span style="color:var(--accent);">"Operator Designation"</span> field<br>
        3. Import vocabulary via CSV file or paste text in the box below<br>
        4. Hit <span style="color:var(--accent);">"Import"</span> â€” your profile is ready!
      </p>
    </div>

    <div class="ark-section">ğŸ‡¯ğŸ‡µ Japanese Mode â€” Import Format</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--accent);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:1.8;margin:0 0 10px;">
        Each line must follow this format:<br>
        <span style="color:var(--accent2);font-size:13px;letter-spacing:1px;">Kanji,Hiragana,Meaning</span>
      </p>
      <div style="background:var(--bg-deep);border:1px solid var(--border);padding:12px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--green);line-height:2.1;">
        æ—¥æœ¬èª,ã«ã»ã‚“ã”,Japanese language<br>
        å­¦æ ¡,ãŒã£ã“ã†,school<br>
        é£Ÿã¹ã‚‹,ãŸã¹ã‚‹,to eat<br>
        é›»è»Š,ã§ã‚“ã—ã‚ƒ,train<br>
        å‹é”,ã¨ã‚‚ã ã¡,friend
      </div>
      <p style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin:8px 0 0;line-height:1.7;">
        â€» 3 columns required: Kanji / Hiragana / Meaning<br>
        â€» Comma-separated, one word per line, no headers
      </p>
    </div>

    <div class="ark-section">ğŸŒ Global Mode â€” Import Format</div>
    <div style="background:var(--bg-card);border:1px solid rgba(58,114,176,0.4);border-left:3px solid var(--blue);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:1.8;margin:0 0 10px;">
        Global mode ignores hiragana. Just put <span style="color:var(--accent2);">"-"</span> in column 2:<br>
        <span style="color:var(--accent2);font-size:13px;letter-spacing:1px;">Word,-,Meaning</span>
      </p>
      <div style="background:var(--bg-deep);border:1px solid var(--border);padding:12px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--green);line-height:2.1;">
        apple,-,ã‚Šã‚“ã”<br>
        cat,-,çŒ«<br>
        é‹å‹•,-,exercise<br>
        å‹‡æ°—,-,courage
      </div>
      <p style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin:8px 0 0;line-height:1.7;">
        â€» Column 2 is ignored â€” put anything there, it doesn't matter.
      </p>
    </div>

    <div class="ark-section">â˜  Hardcore Mode</div>
    <div style="background:rgba(201,64,64,0.07);border:1px solid rgba(201,64,64,0.3);border-left:3px solid var(--red);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:2;margin:0;">
        ğŸ”´ <span style="color:var(--red);">Timer pressure</span> â€” answer before the bar runs out or lose a life<br>
        ğŸ”´ <span style="color:var(--red);">4 lives â¤â¤â¤â¤</span> â€” reach zero and it's game over<br>
        ğŸ”´ Each wrong answer deducts XP (âˆ’15XP per miss)<br>
        ğŸ”´ Timer length is adjustable in the Game Config screen<br>
        â­ Beat a full session without dying to unlock the Speedster achievement!
      </p>
    </div>`;

  app.innerHTML=`<div class="container">
    <div class="ark-header">
      <button class="back" data-action="renderMenu">${t('back')}</button>
      <div class="ark-title">${isJP?'éŠã³æ–¹ <span>ã‚¬ã‚¤ãƒ‰</span>':'How to <span>Play</span>'}</div>
    </div>
    ${sections}
    <button data-action="renderMenu" style="justify-content:center;margin-top:6px;border-color:var(--accent-dim);color:var(--accent);">â¬¡ &nbsp;${isJP?'ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹':'Return to Main Menu'}</button>
  </div>`;
}

/* â”€â”€ DAILY MISSIONS â”€â”€ */
function renderDailyMissions(){
  ensureDailyMissions();
  let html=dailyMissions.missions.map(m=>{
    let done=dailyMissions.done.includes(m.id);
    let prog=dailyProgress[m.type]||0;
    let pct=Math.min(100,Math.floor((prog/m.target)*100));
    let lang=T[appLang]||T.en;
    let title=(lang.missionTitles&&lang.missionTitles[m.id])||m.title;
    return `<div class="daily-card ${done?'done':''}"><div class="daily-check">${done?'âœ…':'â¬œ'}</div><div class="daily-info"><div class="daily-title">${title}</div><div class="daily-prog">${Math.min(prog,m.target)} / ${m.target}${done?` â€” ${appLang==='jp'?'å®Œäº†':'COMPLETE'}`:''}</div><div class="ark-progress" style="margin-top:6px;"><div class="ark-progress-fill" style="width:${pct}%;"></div></div></div><div class="daily-reward">+${m.reward} XP</div></div>`;
  }).join('');
  let r=new Date();r.setHours(24,0,0,0);let ms=r-Date.now();
  let hL=Math.floor(ms/3600000),mL=Math.floor((ms%3600000)/60000);
  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderMenu">${t('back')}</button><div class="ark-title">${appLang==='jp'?'ãƒ‡ã‚¤ãƒªãƒ¼ <span>ãƒŸãƒƒã‚·ãƒ§ãƒ³</span>':'Daily <span>Missions</span>'}</div><div class="ark-badge" style="margin-left:auto;">${t('resets')} ${hL}h ${mL}m</div></div>
    ${renderXpBar()}
    <div class="ark-section">${t('todayMissions')}</div>${html}
    <div class="ark-section">${t('grindStreak')}</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);padding:20px;clip-path:polygon(8px 0%,100% 0%,100% calc(100% - 8px),calc(100% - 8px) 100%,0% 100%,0% 8px);text-align:center;">
      <div class="streak-fire">ğŸ”¥</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:50px;font-weight:700;color:var(--accent);line-height:1;">${globalStats.grindDays}</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--text-dim);">${t('dayStreak')}</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:8px;">${t('keepStreak')}</div>
    </div>
  </div>`;
}

/* â”€â”€ ACHIEVEMENTS â”€â”€ */
function renderAchievements(){
  let achs=getAchievements();
  let hm=getHardnessMult();
  let unlocked=achs.filter(a=>achievements[a.id]).length;
  let allDone=unlocked===achs.length;
  let profile=currentProfile?profiles[currentProfile]:null;
  let masteredCount=profile&&profile.words?profile.words.filter(w=>(w.correct||0)>=5).length:0;

  function getCurrentVal(a){
    if(a.type==="totalCorrect") return globalStats.totalCorrect||0;
    if(a.type==="level") return globalStats.level||0;
    if(a.type==="totalSessions") return globalStats.totalSessions||0;
    if(a.type==="grindDays") return globalStats.grindDays||0;
    if(a.type==="masteredWords") return masteredCount;
    return achievements[a.id]?1:0;
  }

  function makeCard(a){
    let done=!!achievements[a.id];
    let cur=getCurrentVal(a);
    let req=a.threshold||a.base||1;
    let pct=a.base>0?Math.min(100,Math.floor((Math.min(cur,req)/req)*100)):done?100:0;
    let hardTag=(hm>1&&a.base>0)?`<span style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--red);letter-spacing:1px;"> Ã—${hm}</span>`:'';
    let prog=done?'':a.base>0?`<div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);margin-top:4px;">${Math.min(cur,req)} / ${req}</div><div class="ark-progress" style="margin-top:2px;"><div class="ark-progress-fill" style="width:${pct}%;"></div></div>`:'';
    return `<div class="ach-card ${done?'unlocked':'locked'}">
      <div class="ach-icon">${a.icon}</div>
      <div class="ach-name">${a.name}${hardTag}</div>
      <div class="ach-desc">${a.desc}</div>
      <div class="ach-reward">+${a.reward} XP${done?' âœ“':''}</div>
      ${prog}
    </div>`;
  }

  let cards=achs.map(makeCard).join('');

  let hardBanner=hm>1?`<div style="background:rgba(201,64,64,0.08);border:1px solid rgba(201,64,64,0.3);border-left:3px solid var(--red);padding:10px 14px;margin-bottom:12px;">
    <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--red);letter-spacing:2px;">${(t('hardnessBanner')).replace('{N}',resetCount).replace('{M}',hm)}</div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:3px;">${appLang==='jp'?`ä¾‹: "100å•æ­£è§£" â†’ "${Math.round(100*hm)}å•æ­£è§£" Â· "10ã‚³ãƒ³ãƒœ" â†’ "${Math.round(10*hm)}ã‚³ãƒ³ãƒœ"`:`e.g. "100 correct" â†’ "${Math.round(100*hm)} correct" Â· "10 combo" â†’ "${Math.round(10*hm)} combo"`}</div>
  </div>`:'';

  let currentMult=1.0,nextReset=null;
  RESET_ACHIEVEMENTS.forEach(r=>{if(resetCount>=r.resets)currentMult=r.mult;else if(!nextReset)nextReset=r;});

  let resetSection='';
  if(allDone){
    if(nextReset){
      let allCompleteText=t('allComplete').replace('{N}',achs.length);
      let prestigeBtnText=t('prestigeBtn').replace('{M}',nextReset.mult);
      let resetInfoEN=`Reset Ã—${resetCount} Â· Hardness ${currentMult}Ã— â†’ Next: ${nextReset.mult}Ã—`;
      let resetInfoJP=`ãƒªã‚»ãƒƒãƒˆ Ã—${resetCount} Â· é›£æ˜“åº¦ ${currentMult}Ã— â†’ æ¬¡: ${nextReset.mult}Ã—`;
      let threshInfoEN=`Clears achievements & multiplies all thresholds by ${nextReset.mult}Ã—`;
      let threshInfoJP=`å®Ÿç¸¾ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€å…¨é–¾å€¤ã‚’${nextReset.mult}Ã—ã«ä¹—ç®—`;
      resetSection=`<div class="ark-section" style="color:var(--purple);">${t('prestigeReset')}</div>
      <div style="background:rgba(156,85,208,0.08);border:1px solid rgba(156,85,208,0.35);border-left:3px solid var(--purple);padding:12px 14px;margin-bottom:10px;">
        <div style="font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:var(--purple);">${allCompleteText}</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:4px;">${appLang==='jp'?resetInfoJP:resetInfoEN}</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:2px;">${appLang==='jp'?threshInfoJP:threshInfoEN}</div>
        <button id="btn-do-reset" style="margin-top:10px;border-color:rgba(156,85,208,0.5);color:var(--purple);justify-content:center;">${prestigeBtnText}</button>
      </div>`;
    } else {
      resetSection=`<div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--accent);text-align:center;padding:16px;border:1px solid var(--accent-dim);">${t('trueMax')}</div>`;
    }
  } else {
    let rem=achs.filter(a=>!achievements[a.id]).length;
    let remText=t('prestigeRemaining').replace('{R}',rem).replace('{C}',resetCount);
    resetSection=`<div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--border);padding:10px 14px;margin-top:10px;opacity:0.5;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text-dim);">${t('prestigeLocked')}</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:4px;">${remText}</div>
    </div>`;
  }

  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderMenu">${t('back')}</button><div class="ark-title">${appLang==='jp'?'å®Ÿç¸¾ <span>ã‚®ãƒ£ãƒ©ãƒªãƒ¼</span>':'Achievement <span>Gallery</span>'}</div><div class="ark-badge" style="margin-left:auto;">${unlocked}/${achs.length}</div></div>
    <div class="ark-progress" style="margin-bottom:14px;"><div class="ark-progress-fill" style="width:${achs.length?Math.floor(unlocked/achs.length*100):0}%;"></div></div>
    ${hardBanner}
    <div class="ach-grid">${cards}</div>
    ${resetSection}
  </div>`;

  let rb=document.getElementById("btn-do-reset");
  if(rb) rb.addEventListener("click",()=>{
    if(!nextReset)return;
    let confirmMsg=appLang==='jp'
      ?`ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆ #${resetCount+1}?\n\nå…¨å®Ÿç¸¾ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ã€‚\né›£æ˜“åº¦: ${currentMult}Ã— â†’ ${nextReset.mult}Ã—\nå…¨é–¾å€¤ Ã—${nextReset.mult}ï¼ˆä¾‹: 10ã‚³ãƒ³ãƒœ â†’ ${Math.ceil(10*nextReset.mult)}ã‚³ãƒ³ãƒœï¼‰\n\nXPãƒ»ãƒ¬ãƒ™ãƒ«ãƒ»å˜èªãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚`
      :`PRESTIGE RESET #${resetCount+1}?\n\nAll achievement unlocks CLEAR.\nHardness: ${currentMult}Ã— â†’ ${nextReset.mult}Ã—\nAll thresholds Ã—${nextReset.mult} (e.g. 10 combo â†’ ${Math.ceil(10*nextReset.mult)} combo)\n\nXP, level, words and sessions are preserved.`;
    if(!confirm(confirmMsg))return;
    achievements={};resetCount++;saveAll();
    let toastEl=document.createElement("div");toastEl.className="ach-toast";toastEl.style.borderLeftColor="var(--purple)";
    let resetToastMsg=appLang==='jp'?`å®Ÿç¸¾ãƒªã‚»ãƒƒãƒˆ â€” å†åº¦ç²å¾—ã—ã‚ˆã†ï¼`:`ACHIEVEMENTS RESET â€” RE-EARN THEM!`;
    toastEl.innerHTML=`<div class="ach-toast-title" style="color:var(--purple);">ğŸ” ${appLang==='jp'?'ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸':'PRESTIGE'} #${resetCount}</div><div class="ach-toast-name">${appLang==='jp'?'é›£æ˜“åº¦':'Hardness'} ${getHardnessMult()}Ã—</div><div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--red);margin-top:4px;">${resetToastMsg}</div>`;
    document.body.appendChild(toastEl);setTimeout(()=>{toastEl.style.transition="opacity 0.3s";toastEl.style.opacity="0";setTimeout(()=>toastEl.remove(),300);},4000);
    renderAchievements();
  });
}

function renderProfile(){
  let profileNames=Object.keys(profiles).filter(n=>profiles[n]&&typeof profiles[n]==='object');
  let listHtml=profileNames.length
    ? profileNames.map((name,i)=>{
        let p=profiles[name];
        let lv=calcLevel((p&&typeof p.xp==='number'?p.xp:0));
        return `<button id="prof-btn-${i}" data-name="${name.replace(/"/g,'&quot;')}">â–¶ &nbsp;${name}<span style="margin-left:auto;font-size:11px;color:var(--accent-dim);">LV${lv}</span></button>`;
      }).join('')
    : '<p style="color:var(--text-dim);font-family:\'Share Tech Mono\',monospace;font-size:12px;padding:10px 0;">// NO OPERATORS REGISTERED //</p>';

  app.innerHTML=`<div class="container">
    <div class="ark-header"><button id="btn-back-profile" class="back">${t('back')}</button><div class="ark-title">${appLang==='jp'?'ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ <span>é¸æŠ</span>':'Operator <span>Select</span>'}</div></div>
    ${listHtml}
    <div class="ark-section">${t('newProfile')}</div>
    <input id="pname" placeholder="${appLang==='jp'?'ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼å':'OPERATOR DESIGNATION'}" type="text">
    <input type="file" id="csvfile" accept=".csv,.txt" style="display:none;">
    <button id="btn-choose-csv">ğŸ“‚ &nbsp;${appLang==='jp'?'CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ':'Choose CSV File'}</button>
    <div id="csvFilename" style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--accent-dim);padding:4px 0;letter-spacing:1px;">${appLang==='jp'?'// ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ //':'// NO FILE SELECTED //'}</div>
    <button id="btn-import-csv">âŠ• &nbsp;${appLang==='jp'?'CSVã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ':'Import from CSV'}</button>
    <hr>
    <textarea id="txtImport" placeholder="Kanji,Hiragana,Arti â€” one entry per line" style="height:110px;"></textarea>
    <button id="btn-import-text">âŠ• &nbsp;${appLang==='jp'?'ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ':'Import from Text'}</button>
    <hr>
    <button id="btn-delete-profile" style="border-color:rgba(201,64,64,0.4);color:var(--text-dim);">âœ• &nbsp;${appLang==='jp'?'ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤':'Remove Operator'}</button>
  </div>`;

  // Wire up events after render (avoids all quoting issues & PWA restrictions)
  document.getElementById("btn-back-profile").addEventListener("click", renderMenu);
  document.getElementById("btn-import-csv").addEventListener("click", createProfileCSV);
  document.getElementById("btn-import-text").addEventListener("click", createProfileText);
  document.getElementById("btn-delete-profile").addEventListener("click", deleteProfileMenu);

  // File input â€” direct user-gesture click forwarding (works in PWA)
  let csvInput=document.getElementById("csvfile");
  csvInput.addEventListener("change", handleCsvFileSelected);
  document.getElementById("btn-choose-csv").addEventListener("click", function(){
    csvInput.value="";
    csvInput.click();
  });

  // Profile select buttons
  profileNames.forEach((name,i)=>{
    let btn=document.getElementById("prof-btn-"+i);
    if(btn) btn.addEventListener("click", function(){ selectProfile(name); });
  });
}

function makeWordObj(kanji,hira,arti){return{kanji:kanji.trim(),hira:hira.trim(),arti:arti.trim(),correct:0,wrong:0,mastered:false,interval:1,nextReview:Date.now()};}
function handleCsvFileSelected(){
  let f=document.getElementById("csvfile").files[0];
  let el=document.getElementById("csvFilename");
  if(el&&f)el.textContent="// "+f.name+" //";
}
function createProfileCSV(){
  let name=document.getElementById("pname").value.trim(),file=document.getElementById("csvfile").files[0];
  if(!name||!file)return alert("Fill operator name & choose a CSV file");
  let r=new FileReader();
  r.onload=e=>{let data=[];e.target.result.split("\n").forEach(l=>{let [k,h,a]=l.split(",");if(k&&h&&a)data.push(makeWordObj(k,h,a));});
    if(!data.length)return alert("No valid data found in CSV!");
    profiles[name]={words:data,xp:0};saveAll();renderProfile();};
  r.readAsText(file);
}
function createProfileText(){
  let name=document.getElementById("pname").value.trim(),text=document.getElementById("txtImport").value.trim();
  if(!name||!text)return alert("Fill name & text");
  let data=[];text.split("\n").forEach(l=>{let [k,h,a]=l.split(",");if(k){if(a){data.push(makeWordObj(k,h||'',a));}else if(h){data.push(makeWordObj(k,'',h));}}});
  if(!data.length)return alert("Invalid text!");
  profiles[name]={words:data,xp:0};saveAll();renderProfile();
}
function deleteProfileMenu(){
  if(!Object.keys(profiles).length)return alert("No profiles yet!");
  let names=Object.keys(profiles);
  let listHtml=names.map((n,i)=>`<button id="del-prof-${i}" data-name="${n.replace(/"/g,'&quot;')}">${n}</button>`).join('');
  app.innerHTML=`<div class="container"><div class="ark-header"><button id="btn-back-del" class="back">${t('back')}</button><div class="ark-title">${appLang==='jp'?'ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ <span>å‰Šé™¤</span>':'Remove <span>Operator</span>'}</div></div><div class="ark-section">${appLang==='jp'?'å‰Šé™¤ã™ã‚‹ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’é¸æŠ':'SELECT TO REMOVE'}</div>${listHtml}<button id="btn-cancel-del" style="border-color:var(--border);color:var(--text-dim);justify-content:center;margin-top:10px;">âœ• ${appLang==='jp'?'ã‚­ãƒ£ãƒ³ã‚»ãƒ«':'CANCEL'}</button></div>`;
  document.getElementById("btn-back-del").addEventListener("click", renderProfile);
  document.getElementById("btn-cancel-del").addEventListener("click", renderProfile);
  names.forEach((n,i)=>{
    let btn=document.getElementById("del-prof-"+i);
    if(btn) btn.addEventListener("click", ()=>deleteProfile(n));
  });
}
function deleteProfile(name){if(confirm(`Remove "${name}"?`)){delete profiles[name];saveAll();}renderProfile();}
function selectProfile(name){
  let p=profiles[name];
  if(!p||typeof p!=='object'){alert("Operator data is missing or corrupt. Please re-import.");renderProfile();return;}
  if(!Array.isArray(p.words)) p.words=[];
  currentProfile=name;words=[...p.words];renderGroup();
}

/* â”€â”€ GROUP â”€â”€ */
function renderGroup(){
  isCustomMode=false;
  let gModeBtnStyle=globalMode
    ? "border-color:var(--accent);color:var(--accent);background:rgba(232,168,56,0.1);"
    : "border-color:var(--border);color:var(--text-dim);";
  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderProfile">${t('back')}</button><div class="ark-title">${appLang==='jp'?'ãƒŸãƒƒã‚·ãƒ§ãƒ³ <span>é¸æŠ</span>':'Mission <span>Select</span>'}</div></div>
    ${renderXpBar()}
    <div class="ark-section">${appLang==='jp'?'ãƒ¢ãƒ¼ãƒ‰':'MODE'}</div>
    <div style="display:flex;gap:8px;margin-bottom:4px;">
      <button id="btn-jp-mode" style="flex:1;justify-content:center;padding:10px;${!globalMode?'border-color:var(--accent);color:var(--accent);background:rgba(232,168,56,0.1);':'border-color:var(--border);color:var(--text-dim);'}">ğŸ‡¯ğŸ‡µ ${appLang==='jp'?'æ—¥æœ¬èªãƒ¢ãƒ¼ãƒ‰':'JAPANESE MODE'}<br><span style="font-size:9px;letter-spacing:1px;opacity:0.7;">${appLang==='jp'?'æ¼¢å­— / ã²ã‚‰ãŒãª / æ„å‘³':'Kanji / Hiragana / Arti'}</span></button>
      <button id="btn-global-mode" style="flex:1;justify-content:center;padding:10px;${globalMode?'border-color:var(--blue);color:var(--blue);background:rgba(58,114,176,0.1);':'border-color:var(--border);color:var(--text-dim);'}">ğŸŒ ${appLang==='jp'?'ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰':'GLOBAL MODE'}<br><span style="font-size:9px;letter-spacing:1px;opacity:0.7;">${appLang==='jp'?'æ¼¢å­— / æ„å‘³ã®ã¿':'Kanji / Arti only'}</span></button>
    </div>
    <div class="ark-section">${appLang==='jp'?'å‡ºé¡Œæ•°':'DEPLOYMENT SIZE'}</div>
    <button data-action="chooseStep:25">â¬¡ &nbsp;${appLang==='jp'?'ã‚°ãƒ«ãƒ¼ãƒ—A â€” 25å•':'Squad Alpha â€” 25 Units'}</button>
    <button data-action="chooseStep:50">â¬¡ &nbsp;${appLang==='jp'?'ã‚°ãƒ«ãƒ¼ãƒ—B â€” 50å•':'Squad Beta â€” 50 Units'}</button>
    <button data-action="startAll">â¬› &nbsp;${appLang==='jp'?'å…¨å•å‡ºé¡Œ â€” ALL':'Full Deployment â€” ALL'}</button>
    <button data-action="renderCustomAmount" style="border-color:var(--accent-dim);color:var(--accent);">â—ˆ &nbsp;${t('customAmt')}</button>
  </div>`;

  document.getElementById("btn-jp-mode").addEventListener("click",()=>{globalMode=false;saveAll();renderGroup();});
  document.getElementById("btn-global-mode").addEventListener("click",()=>{globalMode=true;saveAll();renderGroup();});
}

function renderCustomAmount(){
  isCustomMode=false;let max=words.length;_customAmt=Math.min(10,max);
  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderGroup">BACK</button><div class="ark-title">Custom <span>Count</span></div></div>
    <div class="ark-section">SET DEPLOYMENT COUNT</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-top:3px solid var(--accent);padding:24px 20px;clip-path:polygon(0 0,calc(100% - 16px) 0,100% 16px,100% 100%,0 100%);margin-bottom:16px;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--text-dim);margin-bottom:12px;">UNIT COUNT (MAX: ${max})</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <button data-action="stepAmt:-10" style="width:52px;min-width:52px;justify-content:center;padding:10px 6px;font-size:13px;">âˆ’10</button>
        <button data-action="stepAmt:-1"  style="width:44px;min-width:44px;justify-content:center;padding:10px 6px;font-size:13px;">âˆ’1</button>
        <div id="amtDisplay" style="flex:1;text-align:center;font-family:'Rajdhani',sans-serif;font-size:52px;font-weight:700;color:var(--accent);text-shadow:0 0 20px rgba(232,168,56,0.4);line-height:1;">${_customAmt}</div>
        <button data-action="stepAmt:1"   style="width:44px;min-width:44px;justify-content:center;padding:10px 6px;font-size:13px;">+1</button>
        <button data-action="stepAmt:10"  style="width:52px;min-width:52px;justify-content:center;padding:10px 6px;font-size:13px;">+10</button>
      </div>
      <input id="amtSlider" type="range" min="1" max="${max}" value="${_customAmt}">
    </div>
    <button data-action="startCustomAmount" style="justify-content:center;font-size:16px;">â¬› &nbsp;DEPLOY</button>
  </div>`;
  document.getElementById("amtSlider").addEventListener("input",function(){syncSlider(this.value);});
}
function stepAmt(d){_customAmt=Math.max(1,Math.min(words.length,_customAmt+d));document.getElementById("amtDisplay").textContent=_customAmt;document.getElementById("amtSlider").value=_customAmt;}
function syncSlider(v){_customAmt=parseInt(v);document.getElementById("amtDisplay").textContent=_customAmt;}
function startCustomAmount(){currentStepAmount=_customAmt;isCustomMode=true;customPool=[...words];sessionWords=shuffle([...words]).slice(0,_customAmt);renderMode();}

function chooseStep(size){
  stepSize=size;let total=words.length,buttons="";
  for(let start=0;start<total;start+=size){
    let end=Math.min(start+size,total),key=currentProfile+"-"+start+"-"+end;
    let played=playedGroups[key]?"played":"",pct=getBlockProgress(start,end),rank=getRankStyle(pct);
    buttons+=`<button class="${played}" data-action="selectBlock:${start}:${end}" style="position:relative;overflow:hidden;box-shadow:${rank.glow};flex-direction:column;align-items:flex-start;gap:4px;padding:12px 14px;">${pct===100?"<div style='font-size:9px;letter-spacing:2px;color:#c060e8;font-weight:700;'>âœ¦ MASTERED</div>":""}<div style="font-size:14px;letter-spacing:1px;">${start+1}â€“${end}${rank.emoji}</div><div style="width:100%;height:2px;background:var(--border);overflow:hidden;"><div style="height:100%;width:${pct}%;background:${rank.color};box-shadow:0 0 4px ${rank.color};"></div></div><div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:${rank.color};letter-spacing:1px;">${pct}% CLEARED</div></button>`;
  }
  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderGroup">BACK</button><div class="ark-title">Block <span>Select</span></div></div>
    <div class="ark-section">COMBAT ZONES â€” UNIT SIZE: ${size}</div>
    <div class="block-grid">${buttons}</div>
    <button data-action="renderCustomBlock" style="margin-top:10px;border-color:var(--accent-dim);color:var(--accent);">â—ˆ &nbsp;Custom Formation</button>
  </div>`;
}

function selectBlock(start,end){
  isCustomMode=false;currentBlockStart=start;currentBlockEnd=end;
  let pool=words.slice(start,end);
  if(!pool.length){alert(appLang==='jp'?'ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã«å˜èªãŒã‚ã‚Šã¾ã›ã‚“ã€‚':'No words in this block.');renderGroup();return;}
  sessionWords=shuffle([...pool]);
  currentStepAmount=sessionWords.length;
  playedGroups[currentProfile+"-"+start+"-"+end]=true;saveAll();renderMode();
}
function renderCustomBlock(){
  let total=words.length,size=stepSize,checkboxes="";
  for(let s=0;s<total;s+=size){let e=Math.min(s+size,total);checkboxes+=`<label style="display:block;margin:8px 0;"><input type="checkbox" value="${s}-${e}"> ${s+1}â€“${e}</label>`;}
  app.innerHTML=`<div class="container"><div class="ark-header"><button class="back" data-action="chooseStepBack">BACK</button><div class="ark-title">Custom <span>Formation</span></div></div><div class="ark-section">SELECT ZONES</div>${checkboxes}<button data-action="startCustomBlock" style="justify-content:center;margin-top:12px;">â¬› DEPLOY FORMATION</button></div>`;
}
function startCustomBlock(){
  let sel=document.querySelectorAll("input[type=checkbox]:checked");
  if(!sel.length)return alert("Select at least 1 block");
  isCustomMode=true;customPool=[];
  sel.forEach(cb=>{let[s,e]=cb.value.split("-").map(Number);customPool.push(...words.slice(s,e));});
  sessionWords=shuffle([...customPool]);
  currentStepAmount=sessionWords.length;renderMode();
}
function startAll(){currentStepAmount=words.length;sessionWords=shuffle([...words]);renderMode();}

/* â”€â”€ MODE / TYPE â”€â”€ */
function renderMode(){
  let isJP=appLang==='jp';
  let maxWords=sessionWords.length||100;
  let limitDisplay=sessionWordLimit>0?sessionWordLimit:appLang==='jp'?'åˆ¶é™ãªã—':'No limit';

  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderGroup">${t('back')}</button><div class="ark-title">${isJP?'ã‚²ãƒ¼ãƒ  <span>è¨­å®š</span>':'Combat <span>Config</span>'}</div></div>

    <div class="ark-section">${isJP?'ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰':'ENGAGEMENT MODE'}</div>
    <button data-action="selectMode:choice">â—ˆ &nbsp;${isJP?'å››æŠã‚¯ã‚¤ã‚º':'Multi-Choice Protocol'}</button>
    <button data-action="selectMode:typing">âœ &nbsp;${isJP?'æ‰‹å‹•å…¥åŠ›':'Manual Input Protocol'}</button>
    <button data-action="renderCurrentStepKotoba">â–£ &nbsp;${isJP?'å˜èªãƒªã‚¹ãƒˆç¢ºèª':'Intelligence Briefing'}</button>

    <div class="ark-section">${isJP?'ã‚«ã‚¹ã‚¿ãƒ è¨­å®š':'CUSTOM SELECTION'}</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-top:2px solid var(--accent-dim);padding:16px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);margin-bottom:8px;">

      <div style="margin-bottom:16px;">
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text-dim);margin-bottom:10px;">${isJP?'é¸æŠè‚¢ã®æ•°ï¼ˆå››æŠã‚¯ã‚¤ã‚ºç”¨ï¼‰':'ANSWER CHOICES (Multi-Choice only)'}</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <button id="choice-minus" style="width:40px;min-width:40px;padding:8px 0;justify-content:center;font-size:16px;">âˆ’</button>
          <div style="flex:1;text-align:center;">
            <div id="choice-display" style="font-family:'Rajdhani',sans-serif;font-size:40px;font-weight:700;color:var(--accent);line-height:1;text-shadow:0 0 16px rgba(232,168,56,0.35);">${choiceCount}</div>
            <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:2px;margin-top:2px;">${isJP?'é¸æŠè‚¢':'CHOICES'}</div>
          </div>
          <button id="choice-plus" style="width:40px;min-width:40px;padding:8px 0;justify-content:center;font-size:16px;">+</button>
        </div>
        <input id="choice-slider" type="range" min="4" max="8" value="${choiceCount}" style="margin-top:10px;">
      </div>

      <hr style="border-color:var(--border);margin:0 0 16px;">

      <div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text-dim);margin-bottom:10px;">${isJP?'1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‡ºé¡Œæ•°':'WORDS PER SESSION'} <span style="color:var(--accent);">(${isJP?'æœ€å¤§':'max'}: ${maxWords})</span></div>
        <div style="display:flex;align-items:center;gap:8px;">
          <button id="limit-minus" style="width:40px;min-width:40px;padding:8px 0;justify-content:center;font-size:16px;">âˆ’</button>
          <div style="flex:1;text-align:center;">
            <div id="limit-display" style="font-family:'Rajdhani',sans-serif;font-size:40px;font-weight:700;color:${sessionWordLimit>0?'var(--accent)':'var(--text-dim)'};line-height:1;text-shadow:0 0 16px rgba(232,168,56,0.2);">${limitDisplay}</div>
            <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:2px;margin-top:2px;">${isJP?'å˜èª':'WORDS'}</div>
          </div>
          <button id="limit-plus" style="width:40px;min-width:40px;padding:8px 0;justify-content:center;font-size:16px;">+</button>
        </div>
        <input id="limit-slider" type="range" min="0" max="${Math.min(maxWords,100)}" value="${Math.min(sessionWordLimit,100)}" style="margin-top:10px;">
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:6px;letter-spacing:1px;">${isJP?'0 = åˆ¶é™ãªã—ï¼ˆå…¨å˜èªï¼‰':'0 = No limit (all words in block)'}</div>
      </div>
    </div>

    <div class="ark-section">${isJP?'ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼':'PARAMETERS'}</div>
    <label style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--text-dim);display:block;margin-bottom:4px;">${isJP?'å›ç­”é…å»¶ï¼ˆç§’ï¼‰':'RESPONSE DELAY (SEC)'}</label>
    <input type="number" min="0.5" step="0.5" value="${answerDelay/1000}" id="inp-delay" style="max-width:160px;">
    <hr>

    <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--purple);margin:10px 0 6px;">ğŸ² ${isJP?'ãƒ©ãƒ³ãƒ€ãƒ é¸æŠè‚¢ãƒ¢ãƒ¼ãƒ‰':'RANDOM OPTION ANSWER'}</div>
    <label style="background:${randomOptions?'rgba(156,85,208,0.1)':'var(--bg-card)'};border:1px solid ${randomOptions?'rgba(156,85,208,0.5)':'var(--border)'};border-left:3px solid ${randomOptions?'var(--purple)':'var(--border)'};padding:12px 14px;cursor:pointer;transition:all 0.2s;display:flex;align-items:flex-start;gap:10px;" id="lbl-random">
      <input type="checkbox" id="inp-random" ${randomOptions?'checked':''} style="margin-top:2px;">
      <div>
        <div style="font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;letter-spacing:2px;color:${randomOptions?'var(--purple)':'var(--text)'};">${isJP?'ãƒ©ãƒ³ãƒ€ãƒ é¸æŠè‚¢ ğŸ²':'Random Distractors ğŸ²'}</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:4px;line-height:1.6;">${isJP?'ã‚°ãƒ«ãƒ¼ãƒ—å¤–ã®å˜èªã‹ã‚‰é¸æŠè‚¢ã‚’ç”Ÿæˆã€‚æ­£è§£æ™‚ã®XP +10%':'Wrong options pulled from outside the current group. Correct answers give +10% XP'}</div>
      </div>
    </label>
    <hr>

    <label><input type="checkbox" id="inp-hardcore" ${hardcoreMode?'checked':''}><span style="color:var(--red);font-family:'Rajdhani',sans-serif;font-size:15px;letter-spacing:2px;">${isJP?'ãƒãƒ¼ãƒ‰ã‚³ã‚¢ãƒ¢ãƒ¼ãƒ‰ â˜ ':'HARDCORE MODE â˜ '}</span></label>
    <div style="margin-top:8px;">
      <label style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--text-dim);display:block;margin-bottom:4px;">${isJP?'ã‚¿ã‚¤ãƒãƒ¼åˆ¶é™ï¼ˆ0.1ã€œ4ç§’ï¼‰':'TIMER LIMIT (0.1â€“4 SEC)'}</label>
      <input type="number" min="0.1" max="4" step="0.1" value="${hardcoreTimer/1000}" id="inp-hctimer" style="max-width:160px;">
    </div>
  </div>`;

  // â”€â”€ Choice count controls â”€â”€
  const choiceDisp=document.getElementById("choice-display");
  const choiceSlider=document.getElementById("choice-slider");
  function updateChoiceDisplay(){
    choiceDisp.textContent=choiceCount;
    choiceSlider.value=choiceCount;
    saveAll();
  }
  document.getElementById("choice-minus").addEventListener("click",()=>{if(choiceCount>4){choiceCount--;updateChoiceDisplay();}});
  document.getElementById("choice-plus").addEventListener("click",()=>{if(choiceCount<8){choiceCount++;updateChoiceDisplay();}});
  choiceSlider.addEventListener("input",function(){choiceCount=parseInt(this.value);updateChoiceDisplay();});

  // â”€â”€ Word limit controls â”€â”€
  const limitDisp=document.getElementById("limit-display");
  const limitSlider=document.getElementById("limit-slider");
  function updateLimitDisplay(){
    let isJP=appLang==='jp';
    if(sessionWordLimit===0){
      limitDisp.textContent=isJP?'åˆ¶é™ãªã—':'No limit';
      limitDisp.style.color='var(--text-dim)';
    } else {
      limitDisp.textContent=sessionWordLimit;
      limitDisp.style.color='var(--accent)';
    }
    limitSlider.value=Math.min(sessionWordLimit,100);
    saveAll();
  }
  document.getElementById("limit-minus").addEventListener("click",()=>{
    if(sessionWordLimit===0) return;
    if(sessionWordLimit<=10){sessionWordLimit=0;}
    else{sessionWordLimit=Math.max(10,sessionWordLimit-10);}
    updateLimitDisplay();
  });
  document.getElementById("limit-plus").addEventListener("click",()=>{
    if(sessionWordLimit===0){sessionWordLimit=10;}
    else{sessionWordLimit=Math.min(Math.min(maxWords,100),sessionWordLimit+10);}
    updateLimitDisplay();
  });
  limitSlider.addEventListener("input",function(){
    let v=parseInt(this.value);
    sessionWordLimit=(v<10)?0:v;
    updateLimitDisplay();
  });

  document.getElementById("inp-delay").addEventListener("change",function(){answerDelay=this.value*1000;});
  document.getElementById("inp-hardcore").addEventListener("change",function(){hardcoreMode=this.checked;});
  document.getElementById("inp-hctimer").addEventListener("change",function(){hardcoreTimer=this.value*1000;});
  document.getElementById("inp-random").addEventListener("change",function(){
    randomOptions=this.checked;
    let lbl=document.getElementById("lbl-random");
    let nameEl=lbl.querySelector('div > div:first-child');
    let isJP=appLang==='jp';
    lbl.style.background=randomOptions?'rgba(156,85,208,0.1)':'var(--bg-card)';
    lbl.style.border=`1px solid ${randomOptions?'rgba(156,85,208,0.5)':'var(--border)'}`;
    lbl.style.borderLeft=`3px solid ${randomOptions?'var(--purple)':'var(--border)'}`;
    if(nameEl) nameEl.style.color=randomOptions?'var(--purple)':'var(--text)';
    saveAll();
  });
}
function selectMode(mode){gameMode=mode;renderType();}
function renderType(){
  let drills=globalMode
    ? `<button data-action="startGame:kanji-arti">ğŸ“– &nbsp;${appLang==='jp'?'å˜èª â†’ æ„å‘³':'Vocabulary â†’ Meaning'}</button>
       <button data-action="startGame:arti-kanji">ğŸ’¬ &nbsp;${appLang==='jp'?'æ„å‘³ â†’ å˜èª':'Meaning â†’ Vocabulary'}</button>`
    : `<button data-action="startGame:kanji-hira">æ¼¢ &nbsp;${appLang==='jp'?'æ¼¢å­— â†’ ã²ã‚‰ãŒãª':'Kanji â†’ Hiragana'}</button>
       <button data-action="startGame:kanji-arti">ğŸ“– &nbsp;${appLang==='jp'?'æ¼¢å­— â†’ æ„å‘³':'Kanji â†’ Meaning'}</button>
       <button data-action="startGame:hira-kanji">ã² &nbsp;${appLang==='jp'?'ã²ã‚‰ãŒãª â†’ æ¼¢å­—':'Hiragana â†’ Kanji'}</button>
       <button data-action="startGame:arti-kanji">ğŸ’¬ &nbsp;${appLang==='jp'?'æ„å‘³ â†’ æ¼¢å­—':'Meaning â†’ Kanji'}</button>`;
  let modeTag=globalMode?`<div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--blue);letter-spacing:2px;margin-bottom:8px;">ğŸŒ ${appLang==='jp'?'ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ â€” ã²ã‚‰ãŒãªç„¡åŠ¹':'GLOBAL MODE â€” HIRAGANA DISABLED'}</div>`:'';
  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderMode">${t('back')}</button><div class="ark-title">${appLang==='jp'?'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° <span>ã‚¿ã‚¤ãƒ—</span>':'Training <span>Type</span>'}</div></div>
    <div class="ark-section">${appLang==='jp'?'ãƒ‰ãƒªãƒ«ã‚’é¸æŠ':'SELECT DRILL'}</div>
    ${modeTag}${drills}
  </div>`;
}
function renderCurrentStepKotoba(){
  let pool=isCustomMode?customPool:words.slice(currentBlockStart,currentBlockEnd);
  let title=isCustomMode?"Custom Block":`${currentBlockStart+1}â€“${currentBlockEnd}`;
  let list=pool.map(w=>`<li style="padding:6px 12px;border-left:2px solid var(--border);margin:3px 0;font-family:'Share Tech Mono',monospace;font-size:11px;background:var(--bg-card);list-style:none;"><b style="font-size:15px;font-family:'Rajdhani',sans-serif;">${w.kanji}</b> <span style="color:var(--accent);">${w.hira}</span> <span style="color:var(--text-dim);">â€” ${w.arti}</span></li>`).join('');
  app.innerHTML=`<div class="container"><div class="ark-header"><button class="back" data-action="renderMode">BACK</button><div class="ark-title">Intel <span>Briefing</span></div></div><div class="ark-section">ZONE: ${title}</div><ul style="padding:0;">${list}</ul></div>`;
}

/* â”€â”€ GAME â”€â”€ */
function startGame(type){
  gameType=type;sessionCorrect=0;sessionWrong=0;combo=0;sessionComboMax=0;
  if(!sessionWords.length){alert(appLang==='jp'?'å˜èªãŒã‚ã‚Šã¾ã›ã‚“ï¼':'No words available!');renderGroup();return;}
  // Apply word limit if set
  if(sessionWordLimit>0 && sessionWords.length>sessionWordLimit){
    sessionWords=shuffle([...sessionWords]).slice(0,sessionWordLimit);
  }
  sessionTotal=sessionWords.length;
  if(hardcoreMode){
    lives=4;
    // Scale hardcore timer down (harder = less time)
    let hm=getHardnessMult();
    hardcoreTimer=Math.max(500,Math.round((2000/hm)));
  }
  sessionXpStart=globalStats.xp;sessionLevelStart=globalStats.level;sessionXpGain=0;
  nextWord();
}
function nextWord(){clearTimeout(timerInterval);if(!sessionWords||!sessionWords.length){renderSummary();return;}currentWord=sessionWords.pop();renderGame();}

function checkTyping(correct){
  if(isLocked)return;isLocked=true;
  if(hardcoreMode)clearTimeout(timerInterval);
  let input=document.getElementById("ans"),val=input.value.trim(),info=document.getElementById("info");
  if(val===correct){input.style.borderColor="#3a9a5c";info.innerHTML=`<span style="color:#5ecf8a;">âœ… CORRECT</span>`;}
  else{input.style.borderColor="#c94040";info.innerHTML=`<span style="color:#e86060;">âœ— WRONG â€” ANSWER: <b>${correct}</b></span>`;}
  processAnswer(val===correct);
}
function checkChoice(sel,correct,options){
  if(isLocked)return;isLocked=true;
  document.querySelectorAll(".choiceBtn").forEach(b=>{
    b.disabled=true;
    let idx=parseInt(b.getAttribute("data-idx"));
    let val=options[idx];
    if(val===correct)b.classList.add("correct");
    else if(val===sel&&sel!==correct)b.classList.add("wrong");
  });
  processAnswer(sel===correct);
}
function handleHardcoreFail(){
  if(isLocked)return;isLocked=true;combo=0;sessionWrong++;lives--;
  globalStats.xp=Math.max(0,globalStats.xp-15);
  if(lives<=0){showGameOver();return;}
  nextWord();
}
function showGameOver(){
  app.innerHTML=`<div class="container" style="text-align:center;padding-top:60px;">
    <div class="ark-header"><div class="ark-title">Game <span>Over</span></div></div>
    <div style="font-size:60px;margin:20px 0;">â˜ </div>
    <div style="font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700;color:var(--red);letter-spacing:4px;">OPERATOR DOWN</div>
    <div class="ark-stat-row" style="margin-top:24px;">
      <div class="ark-stat"><div class="ark-stat-label">Correct</div><div class="ark-stat-value" style="color:var(--green);">${sessionCorrect}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Max Combo</div><div class="ark-stat-value">${sessionComboMax}</div></div>
    </div>
    <button data-action="renderGroup" style="justify-content:center;margin-top:16px;">â†© RETURN TO BASE</button>
  </div>`;
}

function processAnswer(isCorrect){
  let prof=profiles[currentProfile];
  if(!prof){renderMenu();return;}
  let word=prof.words.find(w=>w.kanji===currentWord.kanji);
  if(!word){word={kanji:currentWord.kanji,hira:currentWord.hira||'',arti:currentWord.arti||'',correct:0,wrong:0};prof.words.push(word);}
  if(hardcoreMode)clearTimeout(timerInterval);
  let xpBase=10,flags={};

  if(isCorrect){
    combo++;if(combo>sessionComboMax)sessionComboMax=combo;
    let mult=comboMultiplier(combo);
    let randomBonus=randomOptions?1.1:1.0;
    let xpGained=Math.round(xpBase*mult*(hardcoreMode?1.5:1)*randomBonus);
    word.correct++;sessionCorrect++;
    prof.xp=(prof.xp||0)+xpGained;
    globalStats.xp+=xpGained;sessionXpGain+=xpGained;
    globalStats.totalCorrect=(globalStats.totalCorrect||0)+1;
    flags._combo=sessionComboMax;
    if(sessionWrong===0&&sessionCorrect>=10)flags._perfect=true;
    updateDailyProgress("correct",1);
    if(combo>(dailyProgress.combo||0)){updateDailyProgress("combo",combo-(dailyProgress.combo||0));}
    if(sessionWrong===0)updateDailyProgress("noerror",1);
  } else {
    combo=0;sessionWrong++;word.wrong++;
    if(hardcoreMode){
      lives--;
      globalStats.xp=Math.max(0,globalStats.xp-10);
      prof.xp=Math.max(0,(prof.xp||0)-10);
      if(lives<=0){updateSRS(word,false);globalStats.level=calcLevel(globalStats.xp);saveAll();showGameOver();return;}
    }
  }

  updateSRS(word,isCorrect);
  let oldLevel=globalStats.level;
  globalStats.level=calcLevel(globalStats.xp);
  saveAll();

  let newAchs=checkAchievements(flags);
  newAchs.forEach((a,i)=>setTimeout(()=>showAchievementToast(a),i*3300));

  if(globalStats.level>oldLevel){
    setTimeout(()=>showLevelUp(globalStats.level,()=>setTimeout(()=>nextWord(),200)),answerDelay);
  } else {
    setTimeout(()=>nextWord(),answerDelay);
  }
}

function exitGame(){
  if(hardcoreMode){globalStats.xp=Math.max(0,globalStats.xp-30);saveAll();}
  renderType();
}

/* â”€â”€ SUMMARY â”€â”€ */
function renderSummary(){
  // â”€â”€ Autosave session history â”€â”€
  let accuracy=sessionTotal>0?Math.floor((sessionCorrect/sessionTotal)*100):0;
  let grade=accuracy>=90?"S":accuracy>=75?"A":accuracy>=55?"B":accuracy>=35?"C":"D";
  let histEntry={
    ts:Date.now(),
    profile:currentProfile,
    gameType:gameType,
    gameMode:gameMode,
    correct:sessionCorrect,
    total:sessionTotal,
    wrong:sessionWrong,
    combo:sessionComboMax,
    xpGain:sessionXpGain,
    grade:grade,
    accuracy:accuracy,
    hardcore:hardcoreMode,
    isCustom:isCustomMode
  };
  sessionHistory.unshift(histEntry);
  if(sessionHistory.length>200)sessionHistory=sessionHistory.slice(0,200);
  globalStats.totalSessions=(globalStats.totalSessions||0)+1;
  globalStats.level=calcLevel(globalStats.xp);saveAll();
  updateDailyProgress("sessions",1);
  let flags={_combo:sessionComboMax};
  if(sessionWrong===0&&sessionCorrect>=10)flags._perfect=true;
  if(hardcoreMode&&sessionCorrect===sessionTotal)flags._hardcoreWin=true;
  let newAchs=checkAchievements(flags);
  setTimeout(()=>newAchs.forEach((a,i)=>setTimeout(()=>showAchievementToast(a),i*3300)),800);

  let gradeColor=grade==="S"?"#e8a838":grade==="A"?"#3a9a5c":grade==="B"?"#3a72b0":grade==="C"?"#c9a030":"#c94040";
  let levelUpText=globalStats.level>sessionLevelStart?`<div style="color:var(--accent);font-family:'Rajdhani',sans-serif;font-size:18px;letter-spacing:3px;margin:10px 0;text-align:center;">â¬¡ LEVEL UP: ${sessionLevelStart} â†’ ${globalStats.level}</div>`:"";

  app.innerHTML=`<div class="container">
    <div class="ark-header"><div class="ark-title">${appLang==='jp'?'ãƒŸãƒƒã‚·ãƒ§ãƒ³ <span>ãƒ¬ãƒãƒ¼ãƒˆ</span>':'Mission <span>Report</span>'}</div></div>
    <div style="text-align:center;padding:16px 0;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--text-dim);">${t('grade')}</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:90px;font-weight:700;color:${gradeColor};line-height:1;text-shadow:0 0 40px ${gradeColor}88;">${grade}</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);letter-spacing:2px;">${accuracy}% ${t('accuracy')}</div>
    </div>
    ${renderXpBar()}
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'æ­£è§£':'Correct'}</div><div class="ark-stat-value" style="color:var(--green);">${sessionCorrect}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'åˆè¨ˆ':'Total'}</div><div class="ark-stat-value">${sessionTotal}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${t('xpGained')}</div><div class="ark-stat-value">+${sessionXpGain}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'æœ€å¤§ã‚³ãƒ³ãƒœ':'Max Combo'}</div><div class="ark-stat-value" style="color:var(--accent2);">${sessionComboMax}</div></div>
    </div>
    ${levelUpText}
    <button id="backBtn" disabled style="justify-content:center;margin-top:16px;">â¬¡ ${t('backMenu')}</button>
  </div>`;
  setTimeout(()=>document.getElementById("backBtn").disabled=false,500);
  document.getElementById("backBtn").addEventListener("click",()=>renderGroup());
  setTimeout(renderGroup,6000);
}

/* â”€â”€ STATS â”€â”€ */
function renderStats(){
  let cp=currentProfile&&profiles[currentProfile]?profiles[currentProfile]:null;
  let pXP=cp?(cp.xp||0):0;
  let pLv=calcLevel(pXP),totalWords=cp?(cp.words||[]).length:0;
  let mastered=0,correct=0,wrong=0;
  if(cp)(cp.words||[]).forEach(w=>{correct+=(w.correct||0);wrong+=(w.wrong||0);if((w.correct||0)>=5)mastered++;});
  let mastPct=totalWords>0?Math.floor((mastered/totalWords)*100):0;
  let unlocked=getAchievements().filter(a=>achievements[a.id]).length;
  let pRank=getRankTitle(pLv);
  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderMenu">${t('back')}</button><div class="ark-title">${appLang==='jp'?'æˆ¦é—˜ <span>è¨˜éŒ²</span>':'Combat <span>Records</span>'}</div></div>
    ${renderXpBar()}
    <div class="ark-section">${appLang==='jp'?'ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹':'GLOBAL STATS'}</div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'ã‚°ãƒ­ãƒ¼ãƒãƒ«LV':'Global LV'}</div><div class="ark-stat-value">${globalStats.level}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${t('totalXp')}</div><div class="ark-stat-value">${globalStats.xp}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'å®Ÿç¸¾':'Achievements'}</div><div class="ark-stat-value">${unlocked}/${getAchievements().length}</div></div>
    </div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'åˆè¨ˆæ­£è§£':'Total Correct'}</div><div class="ark-stat-value" style="color:var(--green);">${globalStats.totalCorrect||0}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${t('sessions')}</div><div class="ark-stat-value">${globalStats.totalSessions||0}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${t('streak')}</div><div class="ark-stat-value">${globalStats.grindDays||0}d</div></div>
    </div>
    <div class="ark-section">${appLang==='jp'?'ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼: ':'OPERATOR: '}${currentProfile||'NONE'}</div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'ã‚ªãƒšLV':'Op. Level'}</div><div class="ark-stat-value" style="color:${pRank.color};">${pLv}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'ãƒ©ãƒ³ã‚¯':'Rank'}</div><div class="ark-stat-value" style="font-size:11px;color:${pRank.color};">${pRank.title}</div></div>
    </div>
    <div class="ark-section">${appLang==='jp'?'èªå½™ãƒ‡ãƒ¼ã‚¿':'VOCABULARY INTEL'}</div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'ç·æ•°':'Total'}</div><div class="ark-stat-value">${totalWords}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'æ­£è§£æ•°':'Correct'}</div><div class="ark-stat-value" style="color:var(--green);">${correct}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'ä¸æ­£è§£æ•°':'Wrong'}</div><div class="ark-stat-value" style="color:var(--red);">${wrong}</div></div>
    </div>
    <div style="margin:12px 0 6px;"><div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text-dim);margin-bottom:6px;">${appLang==='jp'?'ç¿’å¾—ç‡':'MASTERY'} â€” ${mastered}/${totalWords} (${mastPct}%)</div><div class="ark-progress"><div class="ark-progress-fill" style="width:${mastPct}%;"></div></div></div>
    <button data-action="renderAchievements" style="margin-top:12px;border-color:var(--accent-dim);color:var(--accent);">ğŸ† ${t('achiev')}</button>
  </div>`;
}

/* â”€â”€ KOTOBA â”€â”€ */
function renderKotoba(){
  if(!currentProfile){alert("Select a profile first!");return;}
  let cp=profiles[currentProfile];
  if(!cp||!Array.isArray(cp.words)){alert("Operator data missing. Please re-import.");return;}
  let list=cp.words.map(w=>{let done=(w.correct||0)>=5;return `<li style="padding:8px 12px;border-left:2px solid ${done?'var(--green)':'var(--border)'};margin:3px 0;font-family:'Share Tech Mono',monospace;font-size:11px;background:var(--bg-card);color:${done?'var(--green)':'var(--text)'};list-style:none;">${done?'âœ“ ':'  '}<b style="font-size:15px;font-family:'Rajdhani',sans-serif;">${w.kanji}</b> <span style="color:var(--accent);">${w.hira}</span> <span style="color:var(--text-dim);">â€” ${w.arti}</span></li>`;}).join('');
  app.innerHTML=`<div class="container"><div class="ark-header"><button class="back" data-action="renderMenu">${t('back')}</button><div class="ark-title">${appLang==='jp'?'å˜èª <span>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</span>':'Vocab <span>Database</span>'}</div></div><div class="ark-section">${appLang==='jp'?'ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«':'INTELLIGENCE FILE'} â€” ${cp.words.length} ${appLang==='jp'?'èª':'ENTRIES'}</div><ul style="padding:0;">${list}</ul></div>`;
}

/* â”€â”€ SHARE â”€â”€ */
function renderShare(){
  if(!currentProfile)return alert("Select a profile first!");
  let p=profiles[currentProfile];
  if(!p||!Array.isArray(p.words)){alert("Operator data missing. Please re-import.");return;}
  let mastered=p.words.filter(w=>(w.correct||0)>=5),learning=p.words.filter(w=>(w.correct||0)>0&&(w.correct||0)<5);
  let pct=p.words.length>0?Math.floor((mastered.length/p.words.length)*100):0,rank=getRankTitle(globalStats.level);
  let unlocked=getAchievements().filter(a=>achievements[a.id]).length;
  let text=`ğŸ“˜ Kotoba Trainer Progress\nğŸ‘¤ Operator: ${currentProfile}\nâ­ Global Level: ${globalStats.level} (${rank.title})\nğŸ’  Global XP: ${globalStats.xp}\nğŸ”¥ Streak: ${globalStats.grindDays} days\nğŸ† Achievements: ${unlocked}/${getAchievements().length}\n\nğŸ“Š Mastered: ${mastered.length}/${p.words.length} (${pct}%)\nâœ… ${mastered.map(w=>`${w.kanji}(${w.hira})`).join(', ')||'-'}\nğŸ“– Learning: ${learning.map(w=>w.kanji).join(', ')||'-'}\n\n#KotobaTrainer #RhodesIsland`;

  // Static info panels
  let gRank=getRankTitle(globalStats.level);
  let profLv=calcLevel(p.xp||0),profRank=getRankTitle(profLv);
  let mastPct=p.words.length>0?Math.floor((mastered.length/p.words.length)*100):0;
  let resetMult=1.0;let ra=RESET_ACHIEVEMENTS.filter(r=>resetCount>=r.resets);if(ra.length>0)resetMult=ra[ra.length-1].mult;

  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderMenu">${t('back')}</button><div class="ark-title">${appLang==='jp'?'é€²æ— <span>é€ä¿¡</span>':'Transmit <span>Progress</span>'}</div></div>

    <div class="ark-section">â¬¡ GLOBAL STATS (STATIC)</div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">Global LV</div><div class="ark-stat-value" style="color:${gRank.color};">${globalStats.level}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Global XP</div><div class="ark-stat-value">${globalStats.xp}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Streak</div><div class="ark-stat-value">${globalStats.grindDays}d</div></div>
    </div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">Achievements</div><div class="ark-stat-value">${unlocked}/${getAchievements().length}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Resets</div><div class="ark-stat-value" style="color:var(--purple);">${resetCount}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Hardness</div><div class="ark-stat-value" style="color:var(--red);">${resetMult}Ã—</div></div>
    </div>

    <div class="ark-section">ğŸ‘¤ PROFILE: ${currentProfile}</div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">Op. LV</div><div class="ark-stat-value" style="color:${profRank.color};">${profLv}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Rank</div><div class="ark-stat-value" style="font-size:10px;color:${profRank.color};">${profRank.title}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Words</div><div class="ark-stat-value">${p.words.length}</div></div>
    </div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">Mastered</div><div class="ark-stat-value" style="color:var(--green);">${mastered.length}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Learning</div><div class="ark-stat-value" style="color:var(--accent);">${learning.length}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Mastery%</div><div class="ark-stat-value">${mastPct}%</div></div>
    </div>

    <div class="ark-section">ENCODED REPORT</div>
    <textarea id="shareText" style="width:100%;height:180px;font-size:11px;">${text}</textarea>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
      <button id="btn-copy-share" style="justify-content:center;">â‡ª &nbsp;COPY TRANSMISSION</button>
      <button id="btn-export-savedata" style="justify-content:center;border-color:var(--blue);color:var(--blue);">ğŸ’¾ &nbsp;EXPORT SAVEDATA</button>
    </div>
    <button id="btn-export-progress" style="justify-content:center;border-color:var(--green);color:var(--green);margin-top:8px;">ğŸ“¤ &nbsp;EXPORT PROGRESS (TXT)</button>
  </div>`;

  document.getElementById("btn-copy-share").addEventListener("click",()=>navigator.clipboard.writeText(document.getElementById("shareText").value));

  document.getElementById("btn-export-savedata").addEventListener("click",()=>{
    let saveData={profiles,globalStats,playedGroups,achievements,dailyMissions,sessionHistory,resetCount};
    let blob=new Blob([JSON.stringify(saveData,null,2)],{type:"application/json"});
    let a=document.createElement("a");a.href=URL.createObjectURL(blob);
    a.download=`kotoba_savedata_${new Date().toISOString().slice(0,10)}.json`;a.click();
  });

  document.getElementById("btn-export-progress").addEventListener("click",()=>{
    let blob=new Blob([document.getElementById("shareText").value],{type:"text/plain"});
    let a=document.createElement("a");a.href=URL.createObjectURL(blob);
    a.download=`kotoba_progress_${currentProfile}_${new Date().toISOString().slice(0,10)}.txt`;a.click();
  });
}

/* â”€â”€ UTIL â”€â”€ */
function updateSRS(word,isCorrect){
  if(!word.ease)word.ease=2.5;if(!word.interval)word.interval=1;
  if(isCorrect){word.ease=Math.min(3,word.ease+0.1);word.interval=Math.round(word.interval*word.ease);}
  else{word.ease=Math.max(1.3,word.ease-0.2);word.interval=1;}
  word.nextReview=Date.now()+(word.interval*24*60*60*1000);
}
function getBlockProgress(start,end){
  let bw=words.slice(start,end);if(!bw.length)return 0;
  let cp=currentProfile&&profiles[currentProfile]?profiles[currentProfile]:null;
  if(!cp||!Array.isArray(cp.words))return 0;
  let m=bw.filter(w=>{let o=cp.words.find(p=>p.kanji===w.kanji);return o&&(o.correct||0)>=5;}).length;
  return Math.floor((m/bw.length)*100);
}
function getRankStyle(percent){
  if(percent===100)return{color:"#9c27b0",emoji:" ğŸ‘‘",glow:"0 0 12px rgba(156,39,176,0.6)"};
  if(percent>=70)return{color:"#2196F3",emoji:"",glow:"none"};
  if(percent>=30)return{color:"#FFC107",emoji:"",glow:"none"};
  return{color:"#e74c3c",emoji:"",glow:"none"};
}
function getOptions(correct){
  // When randomOptions is ON, pull distractors from the full vocab (all words)
  // When OFF, only pull from the current group/block
  let groupPool=isCustomMode?customPool:words.slice(currentBlockStart,currentBlockEnd);
  let distractorPool=randomOptions?words:groupPool;
  // If distractor pool is too small, fall back to full words
  if(distractorPool.length<choiceCount) distractorPool=words;
  let arr=[...new Set(
    distractorPool.map(w=>{if(gameType==="kanji-hira")return w.hira;if(gameType==="kanji-arti")return w.arti;return w.kanji;})
  )].filter(x=>x&&x!==correct);
  return shuffle(arr).slice(0,choiceCount-1);
}

function renderGame(){
  isLocked=false;
  let q="",c="";
  if(gameType==="kanji-hira"){q=currentWord.kanji;c=currentWord.hira;}
  if(gameType==="kanji-arti"){q=currentWord.kanji;c=currentWord.arti;}
  if(gameType==="hira-kanji"){q=currentWord.hira; c=currentWord.kanji;}
  if(gameType==="arti-kanji"){q=currentWord.arti; c=currentWord.kanji;}

  // In global mode, hide hiragana reveal button
  let furiganaButton="",furiganaDisplay="";
  if(gameType!=="kanji-hira" && !globalMode){
    furiganaButton=`<button id="btn-reveal-hira" style="width:auto;padding:6px 16px;font-size:11px;justify-content:center;border-color:var(--accent-dim);color:var(--accent-dim);">â—ˆ ${appLang==='jp'?'ã²ã‚‰ãŒãªã‚’è¡¨ç¤º':'REVEAL HIRAGANA'}</button>`;
    furiganaDisplay=`<div id="furigana" style="display:none;">${currentWord.hira}</div>`;
  }

  let mult=comboMultiplier(combo);
  let comboHtml=combo>=3?`<div class="combo-display">${appLang==='jp'?'ã‚³ãƒ³ãƒœ':'COMBO'} Ã—${combo} <span style="font-size:14px;color:var(--text-dim);">[${mult}Ã—XP]</span></div>`:"";

  let inputHtml="";
  if(gameMode==="typing"){
    inputHtml=`<input id="ans" type="text" style="width:100%;font-size:20px;text-align:center;letter-spacing:3px;" placeholder="${appLang==='jp'?'// å›ç­”ã‚’å…¥åŠ› //':'// INPUT ANSWER //'}"><button id="btnTyping" style="margin-top:6px;justify-content:center;">â¬› ${appLang==='jp'?'ç¢ºèª':'CONFIRM'}</button><div id="info"></div>`;
  }
  let choiceButtons="";
  let _choiceOptions=[];
  if(gameMode==="choice"){
    _choiceOptions=shuffle([c,...getOptions(c)]);
    let cols=_choiceOptions.length>4?2:1;
    let gridStyle=cols===2?`display:grid;grid-template-columns:1fr 1fr;gap:6px;`:``;
    let btns=_choiceOptions.map((opt,i)=>`<button class="choiceBtn" data-idx="${i}" style="text-align:center;justify-content:center;font-size:${opt.length>12?'12px':'14px'};padding:11px 8px;">${opt}</button>`).join('');
    choiceButtons=`<div style="${gridStyle}margin-top:4px;">${btns}</div>`;
  }
  let timerBar="";
  if(hardcoreMode){
    timerBar=`<div class="ark-progress"><div id="timerFill" class="ark-progress-fill" style="width:100%;transition:width linear ${hardcoreTimer}ms;background:linear-gradient(90deg,#c94040,#e87070);"></div></div>`;
  }
  let progress=sessionTotal>0?Math.floor(((sessionTotal-sessionWords.length)/sessionTotal)*100):0;
  let hmLabel=getHardnessMult()>1?`<span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--purple);margin-left:6px;">Ã—${getHardnessMult()} HARD</span>`:'';
  let randLabel=randomOptions?`<span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--purple);margin-left:6px;">ğŸ² +10%</span>`:'';

  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="exitGame">${appLang==='jp'?'é€€å‡º':'EXIT'}</button><div class="ark-title">Field <span>Op</span></div><div class="ark-badge" style="margin-left:auto;">${sessionWords.length} ${appLang==='jp'?'æ®‹ã‚Š':'LEFT'}</div>${hmLabel}${randLabel}</div>
    <div class="ark-progress"><div class="ark-progress-fill" style="width:${progress}%;"></div></div>
    ${hardcoreMode?`<div class="ark-lives">â¤ ${appLang==='jp'?'ãƒ©ã‚¤ãƒ•':'LIVES'}: ${lives}</div>`:""}
    ${comboHtml}
    <div class="card">${q}</div>
    ${furiganaButton}${timerBar}${furiganaDisplay}
    <div>${inputHtml}${choiceButtons}</div>
  </div>`;

  if(hardcoreMode){
    setTimeout(()=>{let f=document.getElementById("timerFill");if(f)f.style.width="0%";},50);
    timerInterval=setTimeout(handleHardcoreFail,hardcoreTimer);
  }
  let revealBtn=document.getElementById("btn-reveal-hira");
  if(revealBtn) revealBtn.addEventListener("click",()=>{let fg=document.getElementById("furigana");if(fg)fg.style.display="block";});
  if(gameMode==="choice"){
    document.querySelectorAll(".choiceBtn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        let idx=parseInt(btn.getAttribute("data-idx"));
        let sel=_choiceOptions[idx];
        checkChoice(sel,c,_choiceOptions);
      });
    });
  }
  if(gameMode==="typing"){
    document.getElementById("btnTyping").addEventListener("click",()=>checkTyping(c));
    document.getElementById("ans").addEventListener("keydown",e=>{if(e.key==="Enter")checkTyping(c);});
  }
}


function renderHistory(){
  let hist=sessionHistory;
  if(!hist.length){
    app.innerHTML=`<div class="container"><div class="ark-header"><button class="back" data-action="renderMenu">${t('back')}</button><div class="ark-title">${appLang==='jp'?'ã‚»ãƒƒã‚·ãƒ§ãƒ³ <span>å±¥æ­´</span>':'Session <span>History</span>'}</div></div><div class="ark-section">${appLang==='jp'?'ãƒ‡ãƒ¼ã‚¿ãªã—':'NO DATA'}</div><div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);padding:20px 0;text-align:center;">${appLang==='jp'?'// ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ //':'// NO SESSIONS RECORDED YET //'}</div></div>`;
    return;
  }
  let typeLabels={"kanji-hira":"Kâ†’H","kanji-arti":"Kâ†’M","hira-kanji":"Hâ†’K","arti-kanji":"Mâ†’K"};
  let gradeColor=g=>g==="S"?"#e8a838":g==="A"?"#3a9a5c":g==="B"?"#3a72b0":g==="C"?"#c9a030":"#c94040";
  let cards=hist.slice(0,50).map((h,i)=>{
    let d=new Date(h.ts);
    let dateStr=d.toLocaleDateString('ja-JP',{month:'2-digit',day:'2-digit'})+" "+d.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'});
    let mode=h.gameMode==="choice"?"MC":"TYPE";
    let type=typeLabels[h.gameType]||h.gameType||"?";
    let gc=gradeColor(h.grade||"D");
    return `<div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid ${gc};padding:10px 14px;margin:5px 0;display:flex;align-items:center;gap:12px;clip-path:polygon(8px 0%,100% 0%,100% calc(100% - 8px),calc(100% - 8px) 100%,0% 100%,0% 8px);">
      <div style="font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700;color:${gc};min-width:28px;text-align:center;text-shadow:0 0 12px ${gc}88;">${h.grade||"?"}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:var(--text-bright);letter-spacing:1px;">${h.profile||'?'} <span style="font-size:10px;color:var(--accent);font-family:'Share Tech Mono',monospace;">${type} Â· ${mode}${h.hardcore?" Â· HC":""}</span></div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:2px;">${dateStr}</div>
        <div style="display:flex;gap:10px;margin-top:4px;">
          <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:#3a9a5c;">âœ“ ${h.correct}</span>
          <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:#c94040;">âœ— ${h.wrong||0}</span>
          <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);">+${h.xpGain||0}XP</span>
          <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent2);">Ã—${h.combo||0}</span>
        </div>
      </div>
      <div style="text-align:right;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);">${h.accuracy||0}%</div>
    </div>`;
  }).join('');
  let totalSess=hist.length,avgAcc=hist.length?Math.floor(hist.reduce((s,h)=>s+(h.accuracy||0),0)/hist.length):0;
  let bestGrade=["S","A","B","C","D"].find(g=>hist.some(h=>h.grade===g))||"â€”";
  let totalXpEarned=hist.reduce((s,h)=>s+(h.xpGain||0),0);
  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderMenu">${t('back')}</button><div class="ark-title">${appLang==='jp'?'ã‚»ãƒƒã‚·ãƒ§ãƒ³ <span>å±¥æ­´</span>':'Session <span>History</span>'}</div><div class="ark-badge" style="margin-left:auto;">${totalSess} ${t('runs')}</div></div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">${t('sessions')}</div><div class="ark-stat-value">${totalSess}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${t('avgAcc')}</div><div class="ark-stat-value">${avgAcc}%</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${t('best')}</div><div class="ark-stat-value" style="color:${gradeColor(bestGrade)};">${bestGrade}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${t('totalXp')}</div><div class="ark-stat-value">+${totalXpEarned}</div></div>
    </div>
    <div class="ark-section">${t('recentOps')} ${Math.min(50,hist.length)}</div>
    ${cards}
    ${hist.length>0?`<button data-action="clearHistory" style="margin-top:12px;border-color:rgba(201,64,64,0.4);color:var(--text-dim);justify-content:center;">${t('clearHist')}</button>`:''}
  </div>`;
}

/* â”€â”€ BOOT â”€â”€ */
updateDailyStreak();
ensureDailyMissions();

/* â”€â”€ GLOBAL ACTION DISPATCHER â”€â”€
   All buttons use data-action="fnName" or data-action="fnName:arg1:arg2"
   This one listener handles everything â€” works in PWA, no CSP issues â”€â”€ */
app.addEventListener("click", function(e){
  let btn=e.target.closest("[data-action]");
  if(!btn) return;
  let parts=btn.getAttribute("data-action").split(":");
  let action=parts[0], args=parts.slice(1);
  switch(action){
    case "renderMenu":           renderMenu(); break;
    case "renderProfile":        renderProfile(); break;
    case "renderStats":          renderStats(); break;
    case "renderAchievements":   renderAchievements(); break;
    case "renderDailyMissions":  renderDailyMissions(); break;
    case "renderKotoba":         renderKotoba(); break;
    case "renderHistory":        renderHistory(); break;
    case "renderShare":          renderShare(); break;
    case "renderGroup":          renderGroup(); break;
    case "renderMode":           renderMode(); break;
    case "renderCustomAmount":   renderCustomAmount(); break;
    case "renderCustomBlock":    renderCustomBlock(); break;
    case "renderCurrentStepKotoba": renderCurrentStepKotoba(); break;
    case "startAll":             startAll(); break;
    case "startCustomAmount":    startCustomAmount(); break;
    case "startCustomBlock":     startCustomBlock(); break;
    case "exitGame":             exitGame(); break;
    case "deleteProfileMenu":    deleteProfileMenu(); break;
    case "revealFurigana":       {let fg=document.getElementById("furigana");if(fg)fg.style.display="block";} break;
    case "chooseStep":           chooseStep(parseInt(args[0])); break;
    case "chooseStepBack":       chooseStep(stepSize); break;
    case "selectMode":           selectMode(args[0]); break;
    case "startGame":            startGame(args[0]); break;
    case "stepAmt":              stepAmt(parseInt(args[0])); break;
    case "selectBlock":          selectBlock(parseInt(args[0]),parseInt(args[1])); break;
    case "clearHistory":
      if(confirm(t('confirmClearHist'))){sessionHistory=[];saveAll();renderHistory();}
      break;
  }
});

renderMenu();

/* â”€â”€ CLEANUP: Kill all service workers immediately â”€â”€ */
if('serviceWorker' in navigator){
  // If a SW is currently controlling this page, unregister and hard reload once
  if(navigator.serviceWorker.controller){
    navigator.serviceWorker.getRegistrations().then(regs=>{
      Promise.all(regs.map(r=>r.unregister())).then(()=>{
        // Only reload if we haven't already done so (prevent reload loop)
        if(!sessionStorage.getItem('sw_cleared')){
          sessionStorage.setItem('sw_cleared','1');
          location.reload();
        }
      });
    }).catch(()=>{});
  } else {
    // No active SW controller - just clean up any registered ones silently
    navigator.serviceWorker.getRegistrations().then(regs=>{
      regs.forEach(r=>r.unregister());
    }).catch(()=>{});
  }
}

/* â”€â”€ Load fonts non-blocking after app is rendered â”€â”€ */
(function(){
  try{
    let link=document.createElement('link');
    link.rel='stylesheet';
    link.href='https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700&display=swap';
    document.head.appendChild(link);
  }catch(e){}
})();
</script>
</body>
</html>
