<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Kotoba">
<meta name="theme-color" content="#0a0c10">
<title>Kotoba Trainer Pro</title>
<style>
:root{
  --bg-deep:#0a0c10;--bg-panel:#10141c;--bg-card:#161b26;--bg-card2:#1c2333;
  --accent:#e8a838;--accent2:#f0c060;--accent-dim:#8a6020;
  --red:#c94040;--green:#3a9a5c;--blue:#3a72b0;--purple:#9c55d0;
  --text:#d4cfc4;--text-dim:#6e7a8a;--text-bright:#f0ebe0;
  --border:#2a3344;--scan:rgba(232,168,56,0.03);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Barlow Condensed','Arial Narrow',Arial,sans-serif;background:var(--bg-deep);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,var(--scan) 2px,var(--scan) 4px);pointer-events:none;z-index:9999;}
body::after{content:'';position:fixed;inset:0;background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);background-size:40px 40px;opacity:0.18;pointer-events:none;z-index:0;}
#app{position:relative;z-index:1;min-height:100vh;}
.container{max-width:680px;margin:0 auto;padding:12px 12px 60px;animation:screenIn 0.22s ease;}
@keyframes screenIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
@keyframes pulse{from{opacity:1;}to{opacity:0.3;}}
@keyframes chargeGlow{0%{box-shadow:0 0 4px rgba(200,60,255,0.3);}100%{box-shadow:0 0 12px rgba(200,60,255,0.8);}}

.ark-header{display:flex;align-items:center;gap:10px;padding:8px 0 12px;border-bottom:1px solid var(--border);margin-bottom:12px;position:relative;}
.ark-header::after{content:'';position:absolute;bottom:-1px;left:0;width:80px;height:2px;background:var(--accent);}
.ark-title{font-family:'Rajdhani','Arial Narrow',Arial,sans-serif;font-size:18px;font-weight:700;color:var(--text-bright);letter-spacing:3px;text-transform:uppercase;}
.ark-title span{color:var(--accent);}
.ark-badge{font-family:'Share Tech Mono','Courier New',monospace;font-size:10px;color:var(--accent);border:1px solid var(--accent-dim);padding:2px 6px;background:rgba(232,168,56,0.07);letter-spacing:2px;}

.back{position:static!important;width:auto!important;padding:6px 14px!important;background:transparent!important;color:var(--text-dim)!important;border:1px solid var(--border)!important;border-radius:0!important;font-family:'Share Tech Mono',monospace!important;font-size:11px!important;letter-spacing:2px!important;touch-action:manipulation!important;-webkit-tap-highlight-color:transparent!important;cursor:pointer;transition:all 0.2s;margin-right:12px;justify-content:center!important;}
.back:hover{color:var(--accent)!important;border-color:var(--accent-dim)!important;background:rgba(232,168,56,0.05)!important;}
.back::before{content:'â—„ ';}
.back::after{display:none!important;}

button{width:100%;padding:10px 14px;margin:3px 0;border:1px solid var(--border);background:var(--bg-card);color:var(--text);font-family:'Barlow Condensed','Arial Narrow',Arial,sans-serif;font-size:14px;font-weight:600;letter-spacing:2px;text-transform:uppercase;cursor:pointer;position:relative;overflow:hidden;transition:all 0.18s ease;text-align:left;display:flex;align-items:center;gap:8px;touch-action:manipulation;-webkit-tap-highlight-color:transparent;border-radius:0;outline:none;}
button::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--accent);opacity:0;transition:opacity 0.2s;}
button:hover{background:var(--bg-card2);color:var(--accent);border-color:var(--accent-dim);}
button:hover::before{opacity:1;}
button::after{content:'';position:absolute;bottom:-1px;right:-1px;width:13px;height:13px;background:var(--bg-deep);transform:translate(50%,50%) rotate(45deg);pointer-events:none;transition:background 0.18s;}
button:hover::after{background:var(--bg-card2);}
button.correct::after{background:rgba(58,154,92,0.15)!important;}
button.wrong::after{background:rgba(201,64,64,0.15)!important;}
button.played::after{background:var(--bg-panel)!important;}
button.choiceBtn{text-align:center;justify-content:center;}
button.choiceBtn::after{display:none;}
button.correct{background:rgba(58,154,92,0.15)!important;border-color:#3a9a5c!important;color:#5ecf8a!important;}
button.correct::before{background:#3a9a5c;opacity:1;}
button.wrong{background:rgba(201,64,64,0.15)!important;border-color:#c94040!important;color:#e86060!important;}
button.wrong::before{background:#c94040;opacity:1;}
button.played{background:var(--bg-panel)!important;border-color:var(--border)!important;color:var(--text-dim)!important;opacity:0.65;}
button:disabled{opacity:0.4;cursor:not-allowed;}
button:disabled:hover{background:var(--bg-card);color:var(--text);border-color:var(--border);}
button:disabled:hover::before,button:disabled:hover::after{opacity:0;}

.ark-stat-row{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;}
.ark-stat{flex:1;min-width:80px;background:var(--bg-card);border:1px solid var(--border);padding:7px 10px;clip-path:polygon(8px 0%,100% 0%,100% calc(100% - 8px),calc(100% - 8px) 100%,0% 100%,0% 8px);}
.ark-stat-label{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;}
.ark-stat-value{font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;color:var(--accent);line-height:1.1;}

.ark-section{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--accent);text-transform:uppercase;margin:10px 0 6px;display:flex;align-items:center;gap:8px;}
.ark-section::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--accent-dim),transparent);}

.xp-bar-wrap{background:var(--bg-card);border:1px solid var(--border);padding:12px 14px;margin-bottom:14px;clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,0 100%);}
.xp-bar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.xp-rank{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:2px;}
.xp-nums{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);}
.xp-bar-bg{height:6px;background:var(--border);position:relative;overflow:hidden;}
.xp-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent-dim),var(--accent));box-shadow:0 0 8px var(--accent);transition:width 0.6s ease;}
.xp-bar-shine{position:absolute;top:0;left:-60px;width:40px;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.4),transparent);animation:xpShine 2s infinite;}
@keyframes xpShine{0%{left:-60px;}100%{left:110%}}

.ark-progress{height:3px;background:var(--border);margin:6px 0;}
.ark-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent-dim),var(--accent));transition:width 0.4s ease;box-shadow:0 0 6px var(--accent);}

.card{font-family:'Rajdhani','Arial Narrow',Arial,sans-serif;font-size:52px;font-weight:700;color:var(--text-bright);margin:16px 0;padding:28px 20px;background:var(--bg-card);border:1px solid var(--border);border-top:3px solid var(--accent);position:relative;clip-path:polygon(0 0,calc(100% - 20px) 0,100% 20px,100% 100%,0 100%);text-shadow:0 0 30px rgba(232,168,56,0.2);letter-spacing:4px;text-align:center;}
.card::before{content:'OPERATOR DATA';position:absolute;top:8px;left:12px;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--accent);opacity:0.6;}

.combo-display{text-align:center;padding:6px 0;font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700;color:var(--accent2);letter-spacing:3px;text-shadow:0 0 16px rgba(240,192,96,0.5);animation:comboPop 0.3s ease;}
@keyframes comboPop{from{transform:scale(1.3);}to{transform:scale(1);}}

.ark-lives{font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:600;color:var(--red);letter-spacing:2px;padding:8px 14px;background:rgba(201,64,64,0.08);border:1px solid rgba(201,64,64,0.25);border-left:3px solid var(--red);margin-bottom:10px;display:inline-block;}

input[type=text],input[type=number],textarea{width:100%;padding:11px 14px;margin:6px 0;background:var(--bg-panel);border:1px solid var(--border);border-left:3px solid var(--accent-dim);color:var(--text-bright);font-family:'Share Tech Mono','Courier New',monospace;font-size:13px;outline:none;transition:border-color 0.2s;border-radius:0;}
input[type=text]:focus,input[type=number]:focus,textarea:focus{border-color:var(--accent);border-left-color:var(--accent);box-shadow:0 0 0 1px rgba(232,168,56,0.15);}
input[type=file]{color:var(--text-dim);font-size:12px;margin:6px 0;display:block;}
input[type=checkbox]{accent-color:var(--accent);width:14px;height:14px;vertical-align:middle;}
input[type=range]{accent-color:var(--accent);cursor:pointer;background:transparent;border:none;border-left:none;padding:0;width:100%;margin-top:16px;}
label{font-size:13px;color:var(--text);display:flex;align-items:center;gap:8px;padding:6px 0;letter-spacing:1px;}
textarea{resize:vertical;min-height:100px;line-height:1.5;}
hr{border:none;border-top:1px solid var(--border);margin:16px 0;}
#info{font-family:'Share Tech Mono',monospace;font-size:13px;letter-spacing:1px;padding:10px;margin-top:8px;text-align:center;}

.ach-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;}
.ach-card{background:var(--bg-card);border:1px solid var(--border);padding:12px;clip-path:polygon(8px 0%,100% 0%,100% calc(100% - 8px),calc(100% - 8px) 100%,0% 100%,0% 8px);position:relative;overflow:hidden;}
.ach-card.unlocked{border-color:var(--accent-dim);}
.ach-card.unlocked::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent-dim),var(--accent));}
.ach-card.locked{opacity:0.42;filter:grayscale(0.5);}
.ach-icon{font-size:24px;margin-bottom:4px;}
.ach-name{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:var(--text-bright);letter-spacing:1px;}
.ach-desc{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;margin-top:2px;line-height:1.4;}
.ach-reward{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);margin-top:4px;}

.daily-card{background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--blue);padding:12px 14px;margin:6px 0;display:flex;align-items:center;gap:12px;}
.daily-card.done{border-left-color:var(--green);opacity:0.7;}
.daily-check{font-size:18px;min-width:24px;}
.daily-info{flex:1;}
.daily-title{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;color:var(--text-bright);letter-spacing:1px;}
.daily-prog{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:2px;}
.daily-reward{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);}

.levelup-overlay{position:fixed;inset:0;z-index:10000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.88);animation:fadeOvIn 0.3s ease;}
@keyframes fadeOvIn{from{opacity:0;}to{opacity:1;}}
.levelup-box{text-align:center;padding:40px 48px;background:var(--bg-card);border:1px solid var(--accent);clip-path:polygon(20px 0%,100% 0%,100% calc(100% - 20px),calc(100% - 20px) 100%,0% 100%,0% 20px);position:relative;animation:levelupPop 0.4s cubic-bezier(0.34,1.56,0.64,1);}
@keyframes levelupPop{from{transform:scale(0.7);opacity:0;}to{transform:scale(1);opacity:1;}}
.levelup-box::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at center,rgba(232,168,56,0.08) 0%,transparent 70%);pointer-events:none;}
.levelup-label{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:4px;color:var(--accent);margin-bottom:8px;}
.levelup-num{font-family:'Rajdhani',sans-serif;font-size:80px;font-weight:700;color:var(--accent);line-height:1;text-shadow:0 0 40px rgba(232,168,56,0.6);}
.levelup-rank{font-family:'Rajdhani',sans-serif;font-size:20px;color:var(--text-bright);letter-spacing:4px;margin-top:6px;}

.ach-toast{position:fixed;top:16px;right:16px;z-index:10001;background:var(--bg-card);border:1px solid var(--accent-dim);border-left:3px solid var(--accent);padding:12px 16px;max-width:280px;clip-path:polygon(8px 0%,100% 0%,100% calc(100% - 8px),calc(100% - 8px) 100%,0% 100%,0% 8px);animation:toastIn 0.3s ease;}
@keyframes toastIn{from{transform:translateX(120%);opacity:0;}to{transform:translateX(0);opacity:1;}}
.ach-toast-title{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--accent);}
.ach-toast-name{font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:var(--text-bright);letter-spacing:1px;}

.streak-fire{font-size:22px;animation:flicker 1.2s infinite alternate;}
@keyframes flicker{from{text-shadow:0 0 4px #e87000;}to{text-shadow:0 0 16px #ffb000,0 0 32px #ff6000;}}

.block-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0;}
.corner-deco{position:fixed;pointer-events:none;z-index:2;}
.corner-deco.tl{top:0;left:0;width:80px;height:80px;border-top:2px solid var(--accent-dim);border-left:2px solid var(--accent-dim);}
.corner-deco.br{bottom:0;right:0;width:80px;height:80px;border-bottom:2px solid var(--accent-dim);border-right:2px solid var(--accent-dim);}
.ark-ticker{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent-dim);letter-spacing:2px;border-top:1px solid var(--border);padding:6px 0;margin-top:12px;}
.ark-summary-big{font-family:'Rajdhani',sans-serif;font-size:60px;font-weight:700;color:var(--accent);line-height:1;text-shadow:0 0 40px rgba(232,168,56,0.4);text-align:center;}
#furigana{font-family:'Share Tech Mono',monospace!important;font-size:15px!important;color:var(--accent)!important;letter-spacing:2px;padding:10px 14px;background:rgba(232,168,56,0.05);border:1px solid var(--accent-dim);margin-top:8px;text-align:center;line-height:1.6;word-break:break-word;}
/* â”€â”€ ADVENTURE MODE â”€â”€ */
.adv-hp-bar{height:7px;background:#1a0808;border:1px solid #4a1818;border-radius:0;overflow:hidden;position:relative;}
.adv-hp-fill{height:100%;background:linear-gradient(90deg,#cc2020,#ff4444);transition:width 0.5s ease;box-shadow:0 0 4px rgba(255,60,60,0.4);}
.adv-hp-fill.enemy{background:linear-gradient(90deg,#8b1a1a,#cc2222);}
.adv-sp-bar{height:5px;background:#0a1a08;border:1px solid #1a4a18;border-radius:0;overflow:hidden;margin-top:2px;}
.adv-sp-fill{height:100%;background:linear-gradient(90deg,#1a8b20,#44ff60);transition:width 0.4s ease;}
.adv-combat-zone{display:flex;gap:6px;align-items:stretch;margin:6px 0;}
.adv-fighter{flex:1;background:var(--bg-card);border:1px solid var(--border);padding:8px 6px;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);position:relative;text-align:center;}
.adv-fighter.player-side{border-color:rgba(58,114,176,0.4);}
.adv-fighter.enemy-side{border-color:rgba(201,64,64,0.4);}
.adv-char-art{font-size:40px;line-height:1;margin:4px 0;filter:drop-shadow(0 0 6px rgba(232,168,56,0.3));display:flex;align-items:center;justify-content:center;min-height:48px;overflow:hidden;}
.adv-char-art.enemy-art{filter:drop-shadow(0 0 8px rgba(200,0,0,0.5));}
.adv-char-art svg{max-width:64px;max-height:72px;display:block;}
.adv-char-name{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;color:var(--text-bright);margin-bottom:2px;}
.adv-hp-label{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:0;margin:2px 0 1px;}
.adv-vs{display:flex;align-items:center;justify-content:center;font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:var(--accent);padding:0 2px;flex-shrink:0;}
.adv-skill-btn{width:100%;padding:6px 8px;margin:2px 0;border:1px solid var(--border);background:var(--bg-card);color:var(--text);font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:1px;cursor:pointer;display:flex;align-items:center;gap:6px;justify-content:space-between;transition:all 0.15s;clip-path:polygon(3px 0%,100% 0%,100% calc(100% - 3px),calc(100% - 3px) 100%,0% 100%,0% 3px);}
.adv-skill-btn:hover{background:var(--bg-card2);border-color:var(--accent-dim);color:var(--accent);}
.adv-skill-btn.disabled{opacity:0.35;cursor:not-allowed;}
.adv-skill-btn.special{border-color:rgba(156,85,208,0.5);color:#c080ff;}
.adv-skill-btn.defend-btn{border-color:rgba(58,114,176,0.5);color:var(--blue);}
.adv-combat-log{background:var(--bg-deep);border:1px solid var(--border);border-left:3px solid var(--accent-dim);padding:5px 8px;margin:4px 0;font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);max-height:60px;overflow-y:auto;letter-spacing:0.3px;line-height:1.6;}
.adv-map-node{display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;position:relative;z-index:2;flex:1;min-width:0;}
.adv-map-icon{width:36px;height:36px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:15px;background:var(--bg-card);transition:all 0.2s;clip-path:polygon(3px 0%,100% 0%,100% calc(100% - 3px),calc(100% - 3px) 100%,0% 100%,0% 3px);position:relative;margin:0 auto;}
.adv-map-icon.done{border-color:rgba(58,154,92,0.6);background:rgba(58,154,92,0.08);}
.adv-map-icon.current{border-color:var(--accent);box-shadow:0 0 10px rgba(232,168,56,0.5);background:rgba(232,168,56,0.12);animation:mapPulse 1.8s ease-in-out infinite;}
.adv-map-icon.locked{opacity:0.2;cursor:not-allowed;filter:grayscale(1);}
.adv-map-icon.boss{border-color:rgba(201,64,64,0.7);background:rgba(201,64,64,0.1);}
.adv-map-icon.miniboss{border-color:rgba(156,85,208,0.7);background:rgba(156,85,208,0.1);}
.adv-map-icon.shop-node{border-color:rgba(240,192,96,0.5);background:rgba(240,192,96,0.07);}
@keyframes mapPulse{0%,100%{box-shadow:0 0 10px rgba(232,168,56,0.5);}50%{box-shadow:0 0 18px rgba(232,168,56,0.8);}}
.adv-map-label{font-family:'Share Tech Mono',monospace;font-size:6px;color:var(--text-dim);letter-spacing:0;text-align:center;line-height:1.2;white-space:nowrap;}
/* â”€â”€ CONTINENT MAP â”€â”€ */
.continent-map{width:100%;margin:6px 0;display:flex;flex-direction:column;gap:6px;}
.continent-bg{width:100%;position:relative;border:1px solid var(--border);overflow:hidden;box-sizing:border-box;}
.continent-header{font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:5px 10px 4px;display:flex;align-items:center;gap:6px;border-bottom:1px solid rgba(255,255,255,0.05);}
.continent-stages-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:0;padding:8px 8px 6px;width:100%;box-sizing:border-box;}
.continent-connector-h{height:2px;align-self:center;margin-top:-12px;}
.map-stage-num{font-family:'Share Tech Mono',monospace;font-size:6px;color:var(--text-dim);text-align:center;line-height:1.3;}
.adv-damage-pop{position:fixed;pointer-events:none;font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700;z-index:20000;animation:dmgFloat 1.2s ease forwards;}
/* â”€â”€ CHAR STATS MODAL â”€â”€ */
.adv-stats-overlay{position:fixed;inset:0;z-index:15000;display:flex;align-items:flex-end;justify-content:center;background:rgba(0,0,0,0.75);animation:fadeOvIn 0.2s ease;}
.adv-stats-panel{width:100%;max-width:680px;background:var(--bg-card);border-top:2px solid var(--accent);padding:20px 18px 32px;clip-path:polygon(0 12px,12px 0,100% 0,100% 100%,0 100%);animation:statsSlideUp 0.25s ease;}
@keyframes statsSlideUp{from{transform:translateY(100%);opacity:0;}to{transform:translateY(0);opacity:1;}}
.adv-stats-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:12px 0;}
.adv-stat-block{background:var(--bg-deep);border:1px solid var(--border);padding:10px 12px;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);text-align:center;}
.adv-stat-block-label{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;margin-bottom:3px;}
.adv-stat-block-val{font-family:'Rajdhani',sans-serif;font-size:26px;font-weight:700;line-height:1;}
.adv-stat-block-sub{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);margin-top:2px;letter-spacing:1px;}
.adv-stats-close{width:100%;padding:11px;margin-top:14px;border:1px solid var(--accent-dim);background:transparent;color:var(--accent);font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:3px;cursor:pointer;text-align:center;justify-content:center;}
.adv-stats-close:hover{background:rgba(232,168,56,0.08);}
.adv-stats-btn{padding:5px 10px!important;width:auto!important;font-size:9px!important;letter-spacing:2px!important;border-color:rgba(58,114,176,0.5)!important;color:var(--blue)!important;background:rgba(20,40,80,0.4)!important;margin:0!important;flex-shrink:0;}
@keyframes dmgFloat{0%{opacity:1;transform:translateY(0);}100%{opacity:0;transform:translateY(-60px);}}
.adv-char-select{background:var(--bg-card);border:1px solid var(--border);padding:10px 12px;margin:4px 0;clip-path:polygon(8px 0%,100% 0%,100% calc(100% - 8px),calc(100% - 8px) 100%,0% 100%,0% 8px);cursor:pointer;transition:all 0.2s;position:relative;}
.adv-char-select:hover,.adv-char-select.selected{border-color:var(--accent-dim);background:var(--bg-card2);}
.adv-char-select.selected::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent-dim),var(--accent));}
.adv-stat-pill{display:inline-flex;align-items:center;gap:2px;font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);background:var(--bg-deep);border:1px solid var(--border);padding:1px 5px;margin:1px;}
.adv-gold-display{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:#f0c060;background:rgba(240,192,96,0.07);border:1px solid rgba(240,192,96,0.2);padding:3px 8px;display:inline-flex;align-items:center;gap:3px;}
.adv-shop-item{background:var(--bg-card);border:1px solid var(--border);padding:8px 10px;margin:3px 0;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);cursor:pointer;display:flex;align-items:center;gap:10px;transition:all 0.15s;}
.adv-shop-item:hover{border-color:var(--accent-dim);background:var(--bg-card2);}
.adv-story-box{background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--purple);padding:10px 12px;margin:6px 0;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);font-family:'Share Tech Mono',monospace;font-size:10px;line-height:1.7;color:var(--text);}
.shop-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0;}
.shop-item{background:var(--bg-card);border:1px solid var(--border);padding:14px;position:relative;cursor:pointer;transition:all 0.2s;clip-path:polygon(8px 0%,100% 0%,100% calc(100% - 8px),calc(100% - 8px) 100%,0% 100%,0% 8px);}
.shop-item:hover{border-color:var(--accent-dim);background:var(--bg-card2);}
.shop-item.owned{border-color:var(--accent-dim);}
.shop-item.owned::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent-dim),var(--accent));}
.shop-item.active-ui{border-color:var(--green)!important;}
.shop-item.active-ui::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#3a9a5c,#5ecf8a)!important;}
.shop-item-preview{width:100%;height:54px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.07);border-radius:0;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:11px;letter-spacing:1px;font-weight:700;position:relative;}
.shop-item-name{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:var(--text-bright);letter-spacing:1px;}
.shop-item-price{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--accent);margin-top:3px;}
.shop-item-tag{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;padding:2px 5px;border:1px solid;display:inline-block;margin-top:3px;}
.shop-tab{flex:1;padding:8px;text-align:center;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-dim);cursor:pointer;transition:all 0.2s;width:auto;margin:0;}
.shop-tab.active-tab{background:rgba(232,168,56,0.1);color:var(--accent);border-color:var(--accent-dim);}
.coin-display{font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;color:#f0c060;letter-spacing:2px;background:rgba(240,192,96,0.08);border:1px solid rgba(240,192,96,0.25);padding:6px 14px;display:inline-flex;align-items:center;gap:6px;}
</style>
<body>
<div class="corner-deco tl"></div>
<div class="corner-deco br"></div>
<div id="app"></div>
<script>
const app=document.getElementById("app");

/* â”€â”€ STATE â”€â”€ */
// Safe localStorage parser â€” returns fallback if missing or corrupt
function lsGet(key, fallback){
  try{let v=localStorage.getItem(key);return v!==null?JSON.parse(v):fallback;}
  catch(e){return fallback;}
}

let profiles     = lsGet("profiles", {});
let globalStats  = lsGet("globalStats", {xp:0,level:0,totalCorrect:0,totalSessions:0,grindDays:0,lastDay:''});
let playedGroups = lsGet("playedGroups", {});
let achievements = lsGet("achievements", {});
let dailyMissions= lsGet("dailyMissions", {date:'',missions:[],done:[],progress:{}});

// â”€â”€ Sanitize profiles: remove null/corrupt entries, repair missing fields â”€â”€
(function sanitizeProfiles(){
  if(!profiles || typeof profiles !== 'object'){profiles={};return;}
  Object.keys(profiles).forEach(name=>{
    let p=profiles[name];
    if(!p || typeof p !== 'object'){
      delete profiles[name]; // Remove corrupt entry
    } else {
      if(!Array.isArray(p.words)) p.words=[];
      if(typeof p.xp !== 'number') p.xp=0;
      // Repair any corrupt word entries
      p.words=p.words.filter(w=>w && typeof w==='object' && w.kanji);
      p.words.forEach(w=>{
        if(typeof w.correct !== 'number') w.correct=0;
        if(typeof w.wrong   !== 'number') w.wrong=0;
        if(!w.hira) w.hira='';
        if(!w.arti) w.arti='';
      });
    }
  });
})();

// â”€â”€ Sanitize globalStats: fill missing fields â”€â”€
globalStats = Object.assign({xp:0,level:0,totalCorrect:0,totalSessions:0,grindDays:0,lastDay:''}, globalStats||{});
if(typeof globalStats.xp !== 'number') globalStats.xp=0;

let currentProfile=null,words=[],sessionWords=[],gameMode="",gameType="",currentWord={};
let stepSize=25,currentStepAmount=0,answerDelay=500,hardcoreMode=false,hardcoreTimer=2000;
let lives=4,timerInterval=null,isLocked=false;
let sessionCorrect=0,sessionTotal=0,sessionWrong=0,combo=0,sessionComboMax=0;
let currentBlockStart=0,currentBlockEnd=0,isCustomMode=false,customPool=[];
let sessionXpStart=0,sessionXpGain=0,sessionLevelStart=0;
let _customAmt=10;
let dailyProgress={correct:0,sessions:0,combo:0,noerror:0};
let sessionHistory=lsGet("sessionHistory", []);
let appLang=lsGet("appLang","jp");

/* â”€â”€ SHOP STATE â”€â”€ */
let shopData=lsGet("shopData",{
  coins:0,
  ownedUIs:["arknight"],
  activeUI:"arknight",
  ownedFonts:["default"],
  activeFont:"default"
});
if(!shopData.ownedUIs)shopData.ownedUIs=["arknight"];
if(!shopData.activeUI)shopData.activeUI="arknight";
if(!shopData.ownedFonts)shopData.ownedFonts=["default"];
if(!shopData.activeFont)shopData.activeFont="default";

/* â”€â”€ ADVENTURE STATE â”€â”€ */
let advData=lsGet("advData",{
  ownedChars:["hiro"],
  activeChar:"hiro",
  charStats:{
    hiro:{hp:100,maxHp:100,atk:18,def:10,spd:8,level:1,xp:0,gold:0},
    roku:{hp:75,maxHp:75,atk:28,def:6,spd:15,level:1,xp:0,gold:0},
    kisaragi:{hp:120,maxHp:120,atk:22,def:16,spd:6,level:1,xp:0,gold:0}
  },
  skills:{hiro:[],roku:[],kisaragi:[]},
  equip:{hiro:{weapon:null,armor:null},roku:{weapon:null,armor:null},kisaragi:{weapon:null,armor:null}},
  stageProgress:{},
  totalGold:0,
  ownedSkills:[],
  ownedWeapons:[],
  ownedArmors:[],
  statUpgrades:{hiro:{hp:0,atk:0,def:0,skillDmg:0},roku:{hp:0,atk:0,def:0,skillDmg:0},kisaragi:{hp:0,atk:0,def:0,skillDmg:0}},
  upgradePoints:{hiro:0,roku:0,kisaragi:0}
});
if(!advData.ownedChars)advData.ownedChars=["hiro"];
if(!advData.charStats)advData.charStats={hiro:{hp:100,maxHp:100,atk:18,def:10,spd:8,level:1,xp:0,gold:0},roku:{hp:75,maxHp:75,atk:28,def:6,spd:15,level:1,xp:0,gold:0},kisaragi:{hp:120,maxHp:120,atk:22,def:16,spd:6,level:1,xp:0,gold:0}};
["hiro","roku","kisaragi"].forEach(c=>{if(!advData.charStats[c])advData.charStats[c]={hp:100,maxHp:100,atk:18,def:10,spd:8,level:1,xp:0,gold:0};});
if(!advData.skills)advData.skills={hiro:[],roku:[],kisaragi:[]};
if(!advData.equip)advData.equip={hiro:{weapon:null,armor:null},roku:{weapon:null,armor:null},kisaragi:{weapon:null,armor:null}};
if(!advData.stageProgress)advData.stageProgress={};
if(typeof advData.totalGold!=='number')advData.totalGold=0; // "jp" = Japanese, "en" = English
if(!advData.statUpgrades)advData.statUpgrades={hiro:{hp:0,atk:0,def:0,skillDmg:0},roku:{hp:0,atk:0,def:0,skillDmg:0},kisaragi:{hp:0,atk:0,def:0,skillDmg:0}};
if(!advData.upgradePoints)advData.upgradePoints={hiro:0,roku:0,kisaragi:0};
if(!advData.ownedWeapons)advData.ownedWeapons=[];
if(!advData.ownedArmors)advData.ownedArmors=[];
if(!advData.seenEnemies)advData.seenEnemies=[];
if(typeof advData.typingMode==='undefined')advData.typingMode=false;

/* â”€â”€ LEVENSHTEIN DISTANCE (for typo tolerance in type mode) â”€â”€ */
function levenshtein(a,b){
  let m=a.length,n=b.length;
  let dp=Array.from({length:m+1},(_,i)=>Array.from({length:n+1},(_,j)=>i===0?j:j===0?i:0));
  for(let i=1;i<=m;i++)for(let j=1;j<=n;j++)
    dp[i][j]=a[i-1]===b[j-1]?dp[i-1][j-1]:1+Math.min(dp[i-1][j],dp[i][j-1],dp[i-1][j-1]);
  return dp[m][n];
}
/* Returns: "correct" | "close1" | "close2" | "close3" | "wrong"
   close1=1 typo, close2=2 typos, close3=3 typos */
function checkTypoTolerance(given, correct){
  let g=given.trim().toLowerCase(), c=correct.trim().toLowerCase();
  if(g===c) return "correct";
  let dist=levenshtein(g,c);
  if(dist===1) return "close1";
  if(dist===2) return "close2";
  if(dist===3) return "close3";
  return "wrong";
}
let globalMode=lsGet("globalMode",false); // mission select: global mode (kanji+arti only)
let resetCount=lsGet("resetCount",0); // how many times player has done a full reset
let choiceCount=Math.max(4,Math.min(8,lsGet("choiceCount",4))); // number of choices in multi-choice mode (4â€“8)
let sessionWordLimit=lsGet("sessionWordLimit",0); // 0 = no limit; otherwise cap words per session (10â€“100)
let randomOptions=lsGet("randomOptions",false); // pull distractors from full vocab (outside current group)
let bamboozleMode=lsGet("bamboozleMode",false); // generate visually-similar fake answers by mutating characters
let secondChance=Math.max(0,Math.min(100,lsGet("secondChance",0))); // 0 = off; 1-100 = % chance wrong word re-queued
let sortTileMode=lsGet("sortTileMode","chunks"); // "chars" = individual letters, "chunks" = syllable groups
if(!Array.isArray(sessionHistory)) sessionHistory=[];

/* â”€â”€ LANGUAGE HELPER â”€â”€ */
const T={
  jp:{
    menu:"ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼",deployOp:"â¬¡ &nbsp;ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ",combatRec:"â–£ &nbsp;æˆ¦é—˜è¨˜éŒ²",
    achiev:"ðŸ† &nbsp;å®Ÿç¸¾ã‚®ãƒ£ãƒ©ãƒªãƒ¼",dailyMiss:"â—ˆ &nbsp;ãƒ‡ã‚¤ãƒªãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³",
    vocabDB:"ðŸ“– &nbsp;å˜èªžãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹",sessHist:"ðŸ“‹ &nbsp;ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´",
    transmit:"â‡ª &nbsp;é€²æ—ã‚’é€ä¿¡",langBtn:"EN",langLabel:"è¨€èªž",
    howToPlay:"â“ &nbsp;éŠã³æ–¹",
    // header/nav
    back:"æˆ»ã‚‹",profile:"ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«",selectProfile:"ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼é¸æŠž",
    newProfile:"ï¼‹ æ–°è¦ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼",deleteProfile:"å‰Šé™¤",confirmDelete:"æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
    enterName:"ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼åã‚’å…¥åŠ›",create:"ä½œæˆ",cancel:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
    // stats
    operator:"ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼",streak:"é€£ç¶šãƒ­ã‚°ã‚¤ãƒ³",missions:"ãƒŸãƒƒã‚·ãƒ§ãƒ³",
    sessions:"ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°",avgAcc:"å¹³å‡æ­£è§£çŽ‡",best:"æœ€é«˜è©•ä¾¡",totalXp:"åˆè¨ˆXP",
    // game mode
    selectMode:"ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰é¸æŠž",modeKanji:"æ¼¢å­— â†’ èª­ã¿",modeHira:"èª­ã¿ â†’ æ¼¢å­—",
    modeArti:"æ¼¢å­— â†’ æ„å‘³",modeChoice:"å››æŠžã‚¯ã‚¤ã‚º",
    startGame:"ã‚²ãƒ¼ãƒ é–‹å§‹",customAmt:"ã‚«ã‚¹ã‚¿ãƒ å‡ºé¡Œæ•°",customBlock:"ãƒ–ãƒ­ãƒƒã‚¯é¸æŠž",
    allWords:"å…¨å˜èªž",
    // gameplay
    correct:"æ­£è§£ï¼",wrong:"ä¸æ­£è§£",lives:"ãƒ©ã‚¤ãƒ•",combo:"ã‚³ãƒ³ãƒœ",
    revealFuri:"èª­ã¿ä»®åã‚’è¡¨ç¤º",skip:"ã‚¹ã‚­ãƒƒãƒ—",next:"æ¬¡ã¸",
    // results
    sessionComplete:"ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†",accuracy:"æ­£è§£çŽ‡",grade:"è©•ä¾¡",
    xpGained:"ç²å¾—XP",backMenu:"ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸",playAgain:"ã‚‚ã†ä¸€åº¦",
    // vocab
    vocabTitle:"å˜èªžãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹",masteredWords:"ç¿’å¾—æ¸ˆã¿å˜èªž",totalWords:"ç·å˜èªžæ•°",
    // history
    histTitle:"ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´",runs:"å›ž",recentOps:"ç›´è¿‘ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",clearHist:"âœ• å±¥æ­´ã‚’å‰Šé™¤",
    confirmClearHist:"å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
    // daily missions
    todayMissions:"æœ¬æ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³",grindStreak:"é€£ç¶šãƒ­ã‚°ã‚¤ãƒ³",
    dayStreak:"æ—¥é€£ç¶š",keepStreak:"æ¯Žæ—¥ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’ç¶­æŒã—ã‚ˆã†ï¼",
    resets:"ãƒªã‚»ãƒƒãƒˆ",
    // achievements
    achievTitle:"å®Ÿç¸¾ä¸€è¦§",locked:"æœªé”æˆ",unlocked:"é”æˆæ¸ˆã¿",
    achUnlocked:"â¬¡ å®Ÿç¸¾è§£é™¤",xpBonus:"XP ãƒœãƒ¼ãƒŠã‚¹",
    achNames:{
      first_blood:"åˆé™£",centurion:"ç™¾äººæ–¬ã‚Š",veteran:"æ­´æˆ¦ã®å‹‡å£«",legend:"ä¼èª¬",
      lv10:"å£«å®˜æ˜‡é€²",lv25:"ç¾å ´æ˜‡é€²",lv50:"ã‚¨ãƒªãƒ¼ãƒˆæ˜‡é€²",lv80:"æœ€é«˜ä½",
      combo5:"é€£ç¶šæ”»æ’ƒ",combo10:"æ­¢ã¾ã‚‰ãªã„",combo20:"é€£éŽ–åå¿œ",
      sessions10:"ç²¾é‹­",sessions50:"å®¹èµ¦ãªã—",
      streak3:"3æ—¥æˆ¦å£«",streak7:"é€±é–“æˆ¦å£«",streak30:"æœˆé–“ä¼èª¬",
      perfect10:"å®Œç’§",speedster:"ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¹ã‚¿ãƒ¼",
      master10:"å­¦è€…",master50:"è³¢è€…",
      reset1:"åˆå›žãƒªã‚»ãƒƒãƒˆ",reset2:"äºŒé‡ãƒªã‚»ãƒƒãƒˆ",reset3:"ä¸‰é‡ã®è„…å¨",
      reset5:"ç„¡é™ãƒ«ãƒ¼ãƒ—",reset10:"ç„¡é™ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼",
    },
    achDescs:{
      first_blood:"{1}å•æ­£è§£ã™ã‚‹",centurion:"{100}å•æ­£è§£ã™ã‚‹",veteran:"{500}å•æ­£è§£ã™ã‚‹",legend:"{2000}å•æ­£è§£ã™ã‚‹",
      lv10:"ãƒ¬ãƒ™ãƒ«{10}ã«åˆ°é”",lv25:"ãƒ¬ãƒ™ãƒ«{25}ã«åˆ°é”",lv50:"ãƒ¬ãƒ™ãƒ«{50}ã«åˆ°é”",lv80:"ãƒ¬ãƒ™ãƒ«{80}ã«åˆ°é”",
      combo5:"1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§{5}ã‚³ãƒ³ãƒœé”æˆ",combo10:"1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§{10}ã‚³ãƒ³ãƒœé”æˆ",combo20:"1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§{20}ã‚³ãƒ³ãƒœé”æˆ",
      sessions10:"{10}ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†",sessions50:"{50}ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†",
      streak3:"{3}æ—¥é€£ç¶šãƒ­ã‚°ã‚¤ãƒ³",streak7:"{7}æ—¥é€£ç¶šãƒ­ã‚°ã‚¤ãƒ³",streak30:"{30}æ—¥é€£ç¶šãƒ­ã‚°ã‚¤ãƒ³",
      perfect10:"ãƒŸã‚¹ãªã—10å•æ­£è§£",speedster:"ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å‹åˆ©",
      master10:"{10}å˜èªžã‚’ç¿’å¾—ï¼ˆâ‰¥5å›žæ­£è§£ï¼‰",master50:"{50}å˜èªžã‚’ç¿’å¾—",
      reset1:"1å›žãƒ•ãƒ«ãƒªã‚»ãƒƒãƒˆå®Œäº†",reset2:"2å›žãƒ•ãƒ«ãƒªã‚»ãƒƒãƒˆå®Œäº†",reset3:"3å›žãƒ•ãƒ«ãƒªã‚»ãƒƒãƒˆå®Œäº†",
      reset5:"5å›žãƒ•ãƒ«ãƒªã‚»ãƒƒãƒˆå®Œäº†",reset10:"10å›žãƒ•ãƒ«ãƒªã‚»ãƒƒãƒˆå®Œäº†",
    },
    // daily mission titles
    missionTitles:{
      m_c20:"æœ¬æ—¥20å•æ­£è§£ã™ã‚‹",m_c50:"æœ¬æ—¥50å•æ­£è§£ã™ã‚‹",
      m_s2:"æœ¬æ—¥2ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†",m_cb8:"8ã‚³ãƒ³ãƒœé”æˆ",
      m_ne10:"ãƒŸã‚¹ãªã—10å•æ­£è§£",m_c100:"æœ¬æ—¥100å•æ­£è§£ã™ã‚‹",
      m_s3:"æœ¬æ—¥3ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†",m_cb15:"15ã‚³ãƒ³ãƒœé”æˆ",
    },
    // prestige / reset UI
    allComplete:"å…¨{N}å®Ÿç¸¾é”æˆï¼",
    prestigeReset:"âŸ³ ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆ",
    prestigeBtn:"ðŸ” ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆ â†’ {M}Ã— é›£æ˜“åº¦",
    prestigeLocked:"ðŸ”’ ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆè§£é™¤æ¸ˆã¿ â€” ã¾ãšå…¨å®Ÿç¸¾ã‚’é”æˆã—ã¦ãã ã•ã„",
    prestigeRemaining:"{R}å€‹æ®‹ã‚Š Â· ãƒªã‚»ãƒƒãƒˆå›žæ•°: {C}",
    trueMax:"ðŸ‘‘ å…¨å®Ÿç¸¾é”æˆ â€” æœ€é«˜é›£æ˜“åº¦åˆ°é” â€” çœŸã®ä¼èª¬",
    hardnessBanner:"âš¡ ãƒªã‚»ãƒƒãƒˆ #{N} ã‚¢ã‚¯ãƒ†ã‚£ãƒ– â€” é›£æ˜“åº¦ {M}Ã—",
    // share
    shareTitle:"é€²æ—ã‚’é€ä¿¡",
    // settings
    settings:"è¨­å®š",hardcoreMode:"ãƒãƒ¼ãƒ‰ã‚³ã‚¢ãƒ¢ãƒ¼ãƒ‰",answerDelay:"å›žç­”é…å»¶",
    globalMode:"ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ¼¢å­—ï¼‹æ„å‘³ã®ã¿ï¼‰",
  },
  en:{
    menu:"MAIN MENU",deployOp:"â¬¡ &nbsp;Start Game",combatRec:"â–£ &nbsp;Combat Records",
    achiev:"ðŸ† &nbsp;Achievement Gallery",dailyMiss:"â—ˆ &nbsp;Daily Missions",
    vocabDB:"ðŸ“– &nbsp;Vocabulary Database",sessHist:"ðŸ“‹ &nbsp;Session History",
    transmit:"â‡ª &nbsp;Transmit Progress",langBtn:"JP",langLabel:"Language",
    howToPlay:"â“ &nbsp;How to Play",
    // header/nav
    back:"BACK",profile:"PROFILE",selectProfile:"SELECT OPERATOR",
    newProfile:"+ NEW OPERATOR",deleteProfile:"DELETE",confirmDelete:"Really delete this profile?",
    enterName:"Enter operator name",create:"CREATE",cancel:"CANCEL",
    // stats
    operator:"Operator",streak:"Streak",missions:"Missions",
    sessions:"Sessions",avgAcc:"Avg Acc.",best:"Best",totalXp:"Total XP",
    // game mode
    selectMode:"SELECT MODE",modeKanji:"Kanji â†’ Reading",modeHira:"Reading â†’ Kanji",
    modeArti:"Kanji â†’ Meaning",modeChoice:"Multiple Choice",
    startGame:"START",customAmt:"Custom Amount",customBlock:"Block Select",
    allWords:"All Words",
    // gameplay
    correct:"CORRECT!",wrong:"WRONG",lives:"LIVES",combo:"COMBO",
    revealFuri:"Reveal Furigana",skip:"SKIP",next:"NEXT",
    // results
    sessionComplete:"SESSION COMPLETE",accuracy:"Accuracy",grade:"Grade",
    xpGained:"XP Gained",backMenu:"MAIN MENU",playAgain:"PLAY AGAIN",
    // vocab
    vocabTitle:"VOCABULARY DATABASE",masteredWords:"Mastered Words",totalWords:"Total Words",
    // history
    histTitle:"Session History",runs:"RUNS",recentOps:"RECENT OPERATIONS â€” LAST",
    clearHist:"âœ• &nbsp;CLEAR HISTORY",confirmClearHist:"Clear all session history?",
    // daily missions
    todayMissions:"TODAY'S MISSIONS",grindStreak:"GRIND STREAK",
    dayStreak:"DAY CONSECUTIVE STREAK",keepStreak:"Log in daily to keep your streak alive!",
    resets:"RESETS",
    // achievements
    achievTitle:"ACHIEVEMENTS",locked:"LOCKED",unlocked:"UNLOCKED",
    achUnlocked:"â¬¡ ACHIEVEMENT UNLOCKED",xpBonus:"XP BONUS",
    achNames:{
      first_blood:"First Blood",centurion:"Centurion",veteran:"Veteran",legend:"Legendary",
      lv10:"Cadet Promotion",lv25:"Field Promotion",lv50:"Elite Promotion",lv80:"Supreme Class",
      combo5:"Hot Streak",combo10:"Unstoppable",combo20:"Chain Reaction",
      sessions10:"Dedicated",sessions50:"Relentless",
      streak3:"3-Day Warrior",streak7:"Week Warrior",streak30:"Monthly Legend",
      perfect10:"Flawless",speedster:"Speedster",
      master10:"Scholar",master50:"Sage",
      reset1:"First Reset",reset2:"Double Reset",reset3:"Triple Threat",
      reset5:"Endless Loop",reset10:"Infinite Operator",
    },
    achDescs:{
      first_blood:"Answer {1} correctly",centurion:"Answer {100} correctly",veteran:"Answer {500} correctly",legend:"Answer {2000} correctly",
      lv10:"Reach level {10}",lv25:"Reach level {25}",lv50:"Reach level {50}",lv80:"Reach level {80}",
      combo5:"{5} combo in one session",combo10:"{10} combo in one session",combo20:"{20} combo in one session",
      sessions10:"Complete {10} sessions",sessions50:"Complete {50} sessions",
      streak3:"{3} consecutive login days",streak7:"{7} consecutive login days",streak30:"{30} consecutive login days",
      perfect10:"10 correct with 0 mistakes",speedster:"Win a Hardcore session",
      master10:"Master {10} words (â‰¥5 correct)",master50:"Master {50} words",
      reset1:"Complete 1 full reset",reset2:"Complete 2 full resets",reset3:"Complete 3 full resets",
      reset5:"Complete 5 full resets",reset10:"Complete 10 full resets",
    },
    missionTitles:{
      m_c20:"Answer 20 correctly today",m_c50:"Answer 50 correctly today",
      m_s2:"Complete 2 sessions today",m_cb8:"Reach an 8-combo streak",
      m_ne10:"10 correct with no mistakes",m_c100:"Answer 100 correctly today",
      m_s3:"Complete 3 sessions today",m_cb15:"Reach a 15-combo streak",
    },
    prestigeReset:"âŸ³ PRESTIGE RESET",
    prestigeBtn:"ðŸ” PRESTIGE RESET â†’ {M}Ã— HARDNESS",
    prestigeLocked:"ðŸ”’ PRESTIGE RESET LOCKED â€” COMPLETE ALL ACHIEVEMENTS FIRST",
    prestigeRemaining:"{R} remaining Â· Resets completed: {C}",
    allComplete:"ðŸŽ‰ ALL {N} ACHIEVEMENTS COMPLETE!",
    trueMax:"ðŸ‘‘ ALL ACHIEVEMENTS COMPLETE â€” MAX HARDNESS REACHED â€” TRUE LEGEND",
    hardnessBanner:"âš¡ RESET #{N} ACTIVE â€” HARDNESS {M}Ã—",
    // share
    shareTitle:"TRANSMIT PROGRESS",
    // settings
    settings:"SETTINGS",hardcoreMode:"Hardcore Mode",answerDelay:"Answer Delay",
    globalMode:"Global Mode (Kanji+Meaning only)",
  }
};
function t(key){return (T[appLang]||T.en)[key]||key;}

/* â”€â”€ RESET ACHIEVEMENTS â”€â”€ */
const RESET_ACHIEVEMENTS=[
  {id:"reset1", resets:1,  mult:1.5, icon:"ðŸ”", name:"First Reset",       desc:"Complete 1 full reset",          reward:1000},
  {id:"reset2", resets:2,  mult:2.0, icon:"ðŸ”„", name:"Double Reset",       desc:"Complete 2 full resets",         reward:2500},
  {id:"reset3", resets:3,  mult:2.5, icon:"âš¡", name:"Triple Threat",      desc:"Complete 3 full resets",         reward:5000},
  {id:"reset5", resets:5,  mult:3.0, icon:"ðŸ’€", name:"Endless Loop",       desc:"Complete 5 full resets",         reward:10000},
  {id:"reset10",resets:10, mult:4.0, icon:"ðŸ‘‘", name:"Infinite Operator",  desc:"Complete 10 full resets",        reward:25000},
];

/* â”€â”€ SAVE â”€â”€ */
function saveAll(){
  localStorage.setItem("profiles",JSON.stringify(profiles));
  localStorage.setItem("globalStats",JSON.stringify(globalStats));
  localStorage.setItem("playedGroups",JSON.stringify(playedGroups));
  localStorage.setItem("achievements",JSON.stringify(achievements));
  localStorage.setItem("dailyMissions",JSON.stringify(dailyMissions));
  localStorage.setItem("sessionHistory",JSON.stringify(sessionHistory));
  localStorage.setItem("appLang",JSON.stringify(appLang));
  localStorage.setItem("globalMode",JSON.stringify(globalMode));
  localStorage.setItem("resetCount",JSON.stringify(resetCount));
  localStorage.setItem("choiceCount",JSON.stringify(choiceCount));
  localStorage.setItem("sessionWordLimit",JSON.stringify(sessionWordLimit));
  localStorage.setItem("randomOptions",JSON.stringify(randomOptions));
  localStorage.setItem("bamboozleMode",JSON.stringify(bamboozleMode));
  localStorage.setItem("secondChance",JSON.stringify(secondChance));
  localStorage.setItem("sortTileMode",JSON.stringify(sortTileMode));
  localStorage.setItem("shopData",JSON.stringify(shopData));
  localStorage.setItem("advData",JSON.stringify(advData));
}

/* â”€â”€ ENCODE / DECODE (Kotoba-specific, not human-readable) â”€â”€ */
// XOR cipher with a rotating key seeded to this app's identity
const _ENC_KEY="KotobaRhodesIslandProtocol_v3";
function _encodeData(obj){
  try{
    let raw=JSON.stringify(obj);
    let out=[];
    let k=[..._ENC_KEY].map(c=>c.charCodeAt(0));
    for(let i=0;i<raw.length;i++){out.push(raw.charCodeAt(i)^k[i%k.length]^((i*7+13)&0xFF));}
    // base64 of the xor'd bytes
    return btoa(String.fromCharCode(...out));
  }catch(e){return null;}
}
function _decodeData(encoded){
  try{
    let bytes=[...atob(encoded)].map(c=>c.charCodeAt(0));
    let k=[..._ENC_KEY].map(c=>c.charCodeAt(0));
    let out=[];
    for(let i=0;i<bytes.length;i++){out.push(bytes[i]^k[i%k.length]^((i*7+13)&0xFF));}
    return JSON.parse(out.map(c=>String.fromCharCode(c)).join(''));
  }catch(e){return null;}
}

/* â”€â”€ RESET ALL PROGRESS â”€â”€ */
function resetAllProgress(){
  let msg=appLang==='jp'
    ?'âš  å…¨é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\n\nãƒ»å…¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¨å˜èªžãƒ‡ãƒ¼ã‚¿\nãƒ»ã‚°ãƒ­ãƒ¼ãƒãƒ«XPãƒ»ãƒ¬ãƒ™ãƒ«ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´\nãƒ»å®Ÿç¸¾ãƒ»ãƒ‡ã‚¤ãƒªãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\n\næœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'
    :'âš  DELETE ALL PROGRESS DATA.\n\nThis will remove:\nÂ· All profiles & vocabulary data\nÂ· Global XP, level & session history\nÂ· All achievements & daily missions\n\nThis CANNOT be undone.\n\nAre you sure?';
  if(!confirm(msg))return;
  if(!confirm(appLang==='jp'?'æœ€çµ‚ç¢ºèªï¼šæœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ':'Final confirmation: Really delete everything?'))return;
  localStorage.clear();
  profiles={};globalStats={xp:0,level:0,totalCorrect:0,totalSessions:0,grindDays:0,lastDay:''};
  playedGroups={};achievements={};sessionHistory=[];
  dailyMissions={date:'',missions:[],done:[],progress:{}};
  resetCount=0;currentProfile=null;words=[];
  shopData={coins:0,ownedUIs:["arknight"],activeUI:"arknight",ownedFonts:["default"],activeFont:"default"};
  // Reset ALL adventure data â€” characters, weapons, armors, upgrades, gold
  advData={
    ownedChars:["hiro"],activeChar:"hiro",
    charStats:{
      hiro:{hp:120,maxHp:120,atk:20,def:14,spd:8,level:1,xp:0},
      roku:{hp:85,maxHp:85,atk:32,def:7,spd:18,level:1,xp:0},
      kisaragi:{hp:160,maxHp:160,atk:24,def:18,spd:5,level:1,xp:0}
    },
    skills:{hiro:[],roku:[],kisaragi:[]},
    equip:{hiro:{weapon:null,armor:null},roku:{weapon:null,armor:null},kisaragi:{weapon:null,armor:null}},
    stageProgress:{},totalGold:0,
    ownedWeapons:[],ownedArmors:[],
    statUpgrades:{hiro:{hp:0,atk:0,def:0,skillDmg:0},roku:{hp:0,atk:0,def:0,skillDmg:0},kisaragi:{hp:0,atk:0,def:0,skillDmg:0}},
    upgradePoints:{hiro:0,roku:0,kisaragi:0},
    gearUpgrades:{}
  };
  applyTheme();
  saveAll();
  alert(appLang==='jp'?'ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚':'All progress data has been reset.');
  renderMenu();
}


/* â”€â”€ HARDNESS MULTIPLIER â”€â”€ */
function getHardnessMult(){
  let m=1.0;
  RESET_ACHIEVEMENTS.forEach(r=>{if(resetCount>=r.resets)m=r.mult;});
  return m;
}
function xpForLevel(lvl){return Math.min(100+Math.floor(lvl/10)*150,3000);}
function calcLevel(totalXp){let l=0,x=totalXp;while(x>=xpForLevel(l)){x-=xpForLevel(l);l++;}return l;}
function xpInCurrentLevel(totalXp){let l=0,x=totalXp;while(x>=xpForLevel(l)){x-=xpForLevel(l);l++;}return x;}
function getRankTitle(level){
  if(level>=80)return{title:"SUPREME OPERATOR",color:"#ff80ff",glow:"0 0 20px rgba(255,128,255,0.6)"};
  if(level>=60)return{title:"SENIOR OPERATOR",color:"#e8a838",glow:"0 0 16px rgba(232,168,56,0.5)"};
  if(level>=40)return{title:"ELITE OPERATOR",color:"#3a9a5c",glow:"0 0 14px rgba(58,154,92,0.5)"};
  if(level>=25)return{title:"FIELD OPERATOR",color:"#3a72b0",glow:"none"};
  if(level>=10)return{title:"CADET",color:"#6e7a8a",glow:"none"};
  return{title:"RECRUIT",color:"#4a5060",glow:"none"};
}
function comboMultiplier(c){if(c>=20)return 3.0;if(c>=10)return 2.0;if(c>=5)return 1.5;return 1.0;}
function shuffle(a){return a.sort(()=>Math.random()-0.5);}

/* â”€â”€ ACHIEVEMENTS â”€â”€ */
// RESETABLE achievements â€” one per category, scale with hardness
// These reset on prestige and must be re-earned
const ACH_BASE=[
  {id:"centurion",   icon:"ðŸ’¯",  name:"Centurion",       baseDesc:"Answer {100} correctly",        reward:300,  type:"totalCorrect",   base:100},
  {id:"veteran",     icon:"ðŸŽ–ï¸", name:"Veteran",          baseDesc:"Answer {500} correctly",        reward:600,  type:"totalCorrect",   base:500},
  {id:"legend",      icon:"ðŸ†", name:"Legendary",        baseDesc:"Answer {2000} correctly",       reward:2000, type:"totalCorrect",   base:2000},
  {id:"lv25",        icon:"â¬¡",  name:"Field Promotion",  baseDesc:"Reach level {25}",              reward:600,  type:"level",          base:25},
  {id:"lv50",        icon:"â¬¡",  name:"Elite Promotion",  baseDesc:"Reach level {50}",              reward:1500, type:"level",          base:50},
  {id:"lv80",        icon:"ðŸ‘‘", name:"Supreme Class",    baseDesc:"Reach level {80}",              reward:5000, type:"level",          base:80},
  {id:"combo10",     icon:"ðŸ’¥", name:"Unstoppable",      baseDesc:"{10} combo in one session",     reward:200,  type:"_combo",         base:10},
  {id:"combo20",     icon:"âš¡", name:"Chain Reaction",   baseDesc:"{20} combo in one session",     reward:500,  type:"_combo",         base:20},
  {id:"sessions10",  icon:"ðŸ“‹", name:"Dedicated",        baseDesc:"Complete {10} sessions",        reward:200,  type:"totalSessions",  base:10},
  {id:"sessions50",  icon:"ðŸ“‹", name:"Relentless",       baseDesc:"Complete {50} sessions",        reward:800,  type:"totalSessions",  base:50},
  {id:"streak7",     icon:"ðŸ“…", name:"Week Warrior",     baseDesc:"{7} consecutive login days",    reward:500,  type:"grindDays",      base:7},
  {id:"streak30",    icon:"ðŸ”¥", name:"Monthly Legend",   baseDesc:"{30} consecutive login days",   reward:3000, type:"grindDays",      base:30},
  {id:"master10",    icon:"ðŸ“–", name:"Scholar",          baseDesc:"Master {10} words (â‰¥5 correct)",reward:100,  type:"masteredWords",  base:10},
  {id:"master50",    icon:"ðŸ“š", name:"Sage",             baseDesc:"Master {50} words",             reward:500,  type:"masteredWords",  base:50},
  {id:"perfect10",   icon:"âœ¨", name:"Flawless",         baseDesc:"10 correct with 0 mistakes",    reward:300,  type:"_perfect",       base:0},
];

// FIXED achievements â€” never reset, earned once forever
const FIXED_ACHIEVEMENTS=[
  {id:"fix_speedster",   icon:"â±ï¸", name:"Speedster",        desc:"Win a Hardcore session (0 lives lost)",         reward:400,  check:(g)=>!!g._hardcoreWin},
  {id:"fix_sortmaster",  icon:"ðŸ”¤", name:"Sort Master",       desc:"Complete a Word Sort session",                  reward:350,  check:(g)=>!!g._sortWin},
  {id:"fix_firstblood",  icon:"âš”ï¸", name:"First Blood",       desc:"Answer your first question correctly",          reward:50,   check:(g)=>(g.totalCorrect||0)>=1},
  {id:"fix_streak3",     icon:"ðŸŒŸ", name:"3-Day Warrior",     desc:"Log in 3 consecutive days",                     reward:150,  check:(g)=>(g.grindDays||0)>=3},
  {id:"fix_adv_first",   icon:"ðŸ—ºï¸", name:"First Steps",       desc:"Complete your first Adventure Mode run",        reward:300,  check:(g)=>!!g._advFirstClear},
  {id:"fix_adv_boss",    icon:"ðŸ‘¹", name:"Boss Slayer",       desc:"Defeat a Boss enemy in Adventure Mode",         reward:500,  check:(g)=>!!g._advBossKill},
  {id:"fix_adv_lv10",    icon:"âš”ï¸", name:"Battle Hardened",   desc:"Reach character level 10 in Adventure Mode",   reward:600,  check:(g)=>(g._advCharLevel||0)>=10},
  {id:"fix_adv_lv20",    icon:"ðŸ°", name:"Dungeon Lord",      desc:"Reach character level 20 in Adventure Mode",   reward:1200, check:(g)=>(g._advCharLevel||0)>=20},
  {id:"fix_adv_hidden",  icon:"ðŸ’€", name:"Shadow Hunter",     desc:"Defeat the Hidden Boss in Adventure Mode",      reward:1000, check:(g)=>!!g._advHiddenBossKill},
  {id:"fix_adv_gold500", icon:"ðŸ’°", name:"Treasure Hunter",   desc:"Accumulate 500 gold across Adventure runs",    reward:400,  check:(g)=>(g._advTotalGold||0)>=500},
  {id:"fix_adv_stage10", icon:"ðŸ—¡ï¸", name:"Unstoppable Force", desc:"Clear 10 stages in Adventure Mode",            reward:800,  check:(g)=>(g._advStagesCleared||0)>=10},
];

// Build RESETABLE achievements dynamically â€” thresholds scale with hardness
function buildAchievements(){
  let hm=getHardnessMult();
  let lang=T[appLang]||T.en;
  return ACH_BASE.map(a=>{
    let threshold=Math.ceil(a.base*hm);
    let rawDesc=(lang.achDescs&&lang.achDescs[a.id])||a.baseDesc;
    let desc=rawDesc.replace(/\{(\d+)\}/,()=>threshold);
    let name=(lang.achNames&&lang.achNames[a.id])||a.name;
    return {...a, name, threshold, desc,
      check:(g,p)=>{
        if(a.type==='_perfect')     return !!g._perfect;
        if(a.type==='_combo')       return (g._combo||0)>=threshold;
        if(a.type==='masteredWords') return p&&p.words&&p.words.filter(w=>w.correct>=5).length>=threshold;
        return (g[a.type]||0)>=threshold;
      }
    };
  });
}
function getAchievements(){return buildAchievements();}

function allNonResetUnlocked(){
  let achs=getAchievements();
  return achs.every(a=>achievements[a.id]);
}

function checkAchievements(extra={}){
  let profile=currentProfile?profiles[currentProfile]:null;
  let g={...globalStats,...extra};
  let achs=getAchievements();
  let unlocked=[];
  achs.forEach(a=>{
    if(!achievements[a.id]&&a.check(g,profile)){
      achievements[a.id]={unlockedAt:Date.now()};
      globalStats.xp+=a.reward;
      globalStats.level=calcLevel(globalStats.xp);
      unlocked.push(a);
    }
  });
  // Check fixed achievements
  FIXED_ACHIEVEMENTS.forEach(a=>{
    if(!achievements[a.id]&&a.check(g)){
      achievements[a.id]={unlockedAt:Date.now()};
      globalStats.xp+=a.reward;
      globalStats.level=calcLevel(globalStats.xp);
      unlocked.push(a);
    }
  });
  if(unlocked.length)saveAll();
  return unlocked;
}
function showAchievementToast(a){
  let toast=document.createElement("div");
  toast.className="ach-toast";
  toast.innerHTML=`<div class="ach-toast-title">${t('achUnlocked')}</div><div class="ach-toast-name">${a.icon} ${a.name}</div><div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);margin-top:4px;">+${a.reward} ${t('xpBonus')}</div>`;
  document.body.appendChild(toast);
  setTimeout(()=>{toast.style.transition="opacity 0.3s";toast.style.opacity="0";setTimeout(()=>toast.remove(),300);},3200);
}

/* â”€â”€ DAILY MISSIONS â”€â”€ */
const MISSION_POOL=[
  {id:"m_c20",  title:"Answer 20 correctly today",  reward:100,target:20, type:"correct"},
  {id:"m_c50",  title:"Answer 50 correctly today",  reward:250,target:50, type:"correct"},
  {id:"m_s2",   title:"Complete 2 sessions today",  reward:80, target:2,  type:"sessions"},
  {id:"m_cb8",  title:"Reach an 8-combo streak",    reward:120,target:8,  type:"combo"},
  {id:"m_ne10", title:"10 correct with no mistakes",reward:150,target:10, type:"noerror"},
  {id:"m_c100", title:"Answer 100 correctly today", reward:400,target:100,type:"correct"},
  {id:"m_s3",   title:"Complete 3 sessions today",  reward:180,target:3,  type:"sessions"},
  {id:"m_cb15", title:"Reach a 15-combo streak",    reward:300,target:15, type:"combo"},
];

function ensureDailyMissions(){
  let today=new Date().toDateString();
  if(dailyMissions.date!==today){
    dailyMissions={date:today,missions:shuffle([...MISSION_POOL]).slice(0,3),done:[],progress:{}};
    dailyProgress={correct:0,sessions:0,combo:0,noerror:0};
    saveAll();
  } else {
    dailyProgress=dailyMissions.progress||{correct:0,sessions:0,combo:0,noerror:0};
  }
}

function updateDailyProgress(type,val){
  dailyProgress[type]=(dailyProgress[type]||0)+val;
  dailyMissions.progress=dailyProgress;
  dailyMissions.missions.forEach(m=>{
    if(!dailyMissions.done.includes(m.id)&&(dailyProgress[m.type]||0)>=m.target){
      dailyMissions.done.push(m.id);
      globalStats.xp+=m.reward;
      globalStats.level=calcLevel(globalStats.xp);
      showMissionToast(m);
    }
  });
  saveAll();
}

function showMissionToast(m){
  let lang=T[appLang]||T.en;
  let title=(lang.missionTitles&&lang.missionTitles[m.id])||m.title;
  let toastEl=document.createElement("div");
  toastEl.className="ach-toast";
  toastEl.style.borderLeftColor="var(--blue)";
  toastEl.innerHTML=`<div class="ach-toast-title" style="color:var(--blue);">â—ˆ ${appLang==='jp'?'ãƒŸãƒƒã‚·ãƒ§ãƒ³å®Œäº†':'MISSION COMPLETE'}</div><div class="ach-toast-name">${title}</div><div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);margin-top:4px;">+${m.reward} XP</div>`;
  document.body.appendChild(toastEl);
  setTimeout(()=>{toastEl.style.transition="opacity 0.3s";toastEl.style.opacity="0";setTimeout(()=>toastEl.remove(),300);},3500);
}

/* â”€â”€ STREAK â”€â”€ */
function updateDailyStreak(){
  let today=new Date().toDateString();
  let yesterday=new Date(Date.now()-86400000).toDateString();
  if(globalStats.lastDay===today)return;
  globalStats.grindDays=(globalStats.lastDay===yesterday)?(globalStats.grindDays||0)+1:1;
  globalStats.lastDay=today;
  saveAll();
}

/* â”€â”€ LEVEL UP OVERLAY â”€â”€ */
function showLevelUp(newLevel,cb){
  let rank=getRankTitle(newLevel);
  let ov=document.createElement("div");
  ov.className="levelup-overlay";
  ov.innerHTML=`<div class="levelup-box" style="box-shadow:${rank.glow};"><div class="levelup-label">LEVEL UP</div><div class="levelup-num" style="color:${rank.color};">${newLevel}</div><div class="levelup-rank" style="color:${rank.color};">${rank.title}</div><div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:16px;letter-spacing:2px;">TAP TO CONTINUE</div></div>`;
  document.body.appendChild(ov);
  let done=false;
  function proceed(){if(done)return;done=true;ov.remove();if(cb)cb();}
  ov.addEventListener("click",proceed);
  setTimeout(proceed,4000);
}

/* â”€â”€ XP BAR WIDGET â”€â”€ */
function renderXpBar(){
  let lvl=globalStats.level,rank=getRankTitle(lvl);
  let cur=xpInCurrentLevel(globalStats.xp),need=xpForLevel(lvl);
  let pct=Math.min(100,Math.floor((cur/need)*100));
  return `<div class="xp-bar-wrap"><div class="xp-bar-header"><div><span class="xp-rank" style="color:${rank.color};">LV ${lvl}</span><span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-left:8px;letter-spacing:1px;">${rank.title}</span></div><div class="xp-nums">${cur} / ${need} XP</div></div><div class="xp-bar-bg"><div class="xp-bar-fill" style="width:${pct}%;"></div><div class="xp-bar-shine"></div></div></div>`;
}

/* â”€â”€ SHOP DATA â”€â”€ */
const UI_THEMES=[
  /* â”€â”€â”€ ARKNIGHTS â”€â”€â”€ */
  {
    id:"arknight", name:"Arknights", price:0, auto:true,
    preview:{bg:"#10141c",accent:"#e8a838",text:"#d4cfc4",border:"#2a3344",label:"â—‡ RHODES ISLAND"},
    css:`
      @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Barlow+Condensed:wght@400;600;700&family=Share+Tech+Mono&display=swap');
      :root{--bg-deep:#0a0c10;--bg-panel:#10141c;--bg-card:#161b26;--bg-card2:#1c2333;
        --accent:#e8a838;--accent2:#f0c060;--accent-dim:#8a6020;
        --red:#c94040;--green:#3a9a5c;--blue:#3a72b0;--purple:#9c55d0;
        --text:#d4cfc4;--text-dim:#6e7a8a;--text-bright:#f0ebe0;
        --border:#2a3344;--scan:rgba(232,168,56,0.03);}
      body{font-family:'Barlow Condensed','Arial Narrow',Arial,sans-serif;}
    `
  },

  /* â”€â”€â”€ DEVIL MAY CRY â”€â”€â”€ */
  {
    id:"dmc", name:"Devil May Cry", price:800,
    preview:{bg:"#1a0005",accent:"#e30018",text:"#f0e0e0",border:"#4a0010",label:"STYLISH!!"},
    css:`
      @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700;900&family=Share+Tech+Mono&display=swap');
      :root{--bg-deep:#0d0003;--bg-panel:#1a0005;--bg-card:#240008;--bg-card2:#2e000a;
        --accent:#e30018;--accent2:#ff4444;--accent-dim:#6a000a;
        --red:#ff0020;--green:#00cc44;--blue:#4466ff;--purple:#cc44cc;
        --text:#f0d0d0;--text-dim:#805060;--text-bright:#ffe0e0;
        --border:#4a0010;--scan:rgba(227,0,24,0.05);}
      body{font-family:'Rajdhani',sans-serif;background:#0d0003;}
      body::before{background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(227,0,24,0.04) 3px,rgba(227,0,24,0.04) 4px)!important;}
      body::after{background-image:none!important;background:#0d0003!important;opacity:1!important;}
      #app::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 50% 100%,rgba(180,0,20,0.18) 0%,transparent 70%);pointer-events:none;z-index:0;}
      #app::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
        background-image:radial-gradient(circle 2px at 10% 80%, rgba(255,60,0,0.9) 0%, transparent 100%),radial-gradient(circle 1px at 25% 70%, rgba(255,100,0,0.7) 0%, transparent 100%),radial-gradient(circle 2px at 40% 85%, rgba(255,40,0,0.8) 0%, transparent 100%),radial-gradient(circle 1px at 60% 75%, rgba(255,80,0,0.6) 0%, transparent 100%),radial-gradient(circle 2px at 75% 88%, rgba(255,50,0,0.85) 0%, transparent 100%),radial-gradient(circle 1px at 88% 72%, rgba(255,120,0,0.7) 0%, transparent 100%);
        background-size:100% 100%;animation:dmcEmbers 4s linear infinite;}
      @keyframes dmcEmbers{0%{background-position:0% 0%;}100%{background-position:0% -200%;}}
      .ark-title{font-family:'Bebas Neue','Rajdhani',sans-serif!important;letter-spacing:6px!important;font-size:26px!important;text-shadow:0 0 20px rgba(227,0,24,0.6);}
      .ark-title span{color:#ff2030!important;text-shadow:0 0 30px rgba(255,0,30,0.9)!important;}
      .ark-header{border-bottom-color:#4a0010!important;}
      .ark-header::after{background:linear-gradient(90deg,#e30018,transparent)!important;width:100%!important;height:1px!important;}
      .ark-section{font-family:'Bebas Neue','Rajdhani',sans-serif!important;font-size:14px!important;letter-spacing:5px!important;color:#e30018!important;}
      .ark-section::after{background:linear-gradient(90deg,#6a000a,transparent)!important;}
      button{font-family:'Rajdhani',sans-serif!important;font-weight:700!important;letter-spacing:3px!important;border-color:#4a0010!important;background:#1a0005!important;clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px))!important;}
      button:hover{background:#2e000a!important;border-color:#e30018!important;color:#ff4444!important;box-shadow:inset 0 0 20px rgba(227,0,24,0.1),0 0 12px rgba(227,0,24,0.2)!important;}
      button::before{background:linear-gradient(180deg,#e30018,#6a000a)!important;}
      button::after{display:none!important;}
      .card{font-family:'Bebas Neue','Rajdhani',sans-serif!important;border-top-color:#e30018!important;background:linear-gradient(180deg,#1a0005,#240008)!important;clip-path:polygon(0 0,calc(100% - 24px) 0,100% 24px,100% 100%,0 100%)!important;text-shadow:0 0 30px rgba(227,0,24,0.4)!important;}
      .card::before{content:'S T Y L I S H'!important;color:#e30018!important;opacity:0.5!important;}
      .xp-bar-fill{background:linear-gradient(90deg,#6a000a,#e30018,#ff4444)!important;box-shadow:0 0 10px rgba(227,0,24,0.7)!important;}
      .ark-stat{clip-path:polygon(10px 0%,100% 0%,100% calc(100% - 10px),calc(100% - 10px) 100%,0% 100%,0% 10px)!important;background:linear-gradient(135deg,#240008,#1a0005)!important;border-color:#4a0010!important;}
      .ark-stat-value{font-family:'Bebas Neue','Rajdhani',sans-serif!important;color:#ff2030!important;text-shadow:0 0 12px rgba(255,32,48,0.6)!important;}
      .ach-card{background:linear-gradient(135deg,#1a0005,#240008)!important;border-color:#4a0010!important;clip-path:polygon(10px 0%,100% 0%,100% calc(100% - 10px),calc(100% - 10px) 100%,0% 100%,0% 10px)!important;}
      .ach-card.unlocked{border-color:#e30018!important;box-shadow:0 0 14px rgba(227,0,24,0.2)!important;}
      .ach-card.unlocked::before{background:linear-gradient(90deg,#6a000a,#e30018)!important;}
      .ach-name{font-family:'Bebas Neue','Rajdhani',sans-serif!important;letter-spacing:2px!important;}
      .ach-reward{color:#ff4444!important;}
      .daily-card{border-left-color:#4466ff!important;background:linear-gradient(90deg,#1a0005,#240008)!important;}
      .daily-card.done{border-left-color:#00cc44!important;}
      .levelup-box{background:linear-gradient(135deg,#240008,#1a0005)!important;border-color:#e30018!important;clip-path:polygon(24px 0%,100% 0%,100% calc(100% - 24px),calc(100% - 24px) 100%,0% 100%,0% 24px)!important;}
      .levelup-num{font-family:'Bebas Neue','Rajdhani',sans-serif!important;color:#e30018!important;text-shadow:0 0 50px rgba(227,0,24,0.8)!important;}
      .ach-toast{background:#1a0005!important;border-color:#e30018!important;border-left-color:#e30018!important;}
      .corner-deco{border-color:rgba(227,0,24,0.4)!important;}
      .coin-display{color:#ff4444!important;background:rgba(227,0,24,0.08)!important;border-color:rgba(227,0,24,0.3)!important;}
      .adv-fighter{background:linear-gradient(135deg,#1a0005,#240008)!important;}
      .adv-map-icon.current{border-color:#e30018!important;box-shadow:0 0 14px rgba(227,0,24,0.5)!important;background:rgba(227,0,24,0.1)!important;}
      input[type=text],input[type=number],textarea{border-left-color:#6a000a!important;background:#1a0005!important;}
      input:focus,textarea:focus{border-color:#e30018!important;box-shadow:0 0 0 1px rgba(227,0,24,0.2)!important;}
      button.correct{background:rgba(0,204,68,0.12)!important;border-color:#00cc44!important;color:#00cc44!important;text-shadow:0 0 12px rgba(0,204,68,0.6)!important;}
      button.correct::before{background:#00cc44!important;opacity:1!important;}
      button.wrong{background:rgba(255,0,32,0.12)!important;border-color:#ff0020!important;color:#ff4444!important;text-shadow:0 0 12px rgba(255,0,32,0.6)!important;}
      button.wrong::before{background:#ff0020!important;opacity:1!important;}
      button.played{background:#100003!important;border-color:#3a0008!important;color:#805060!important;opacity:0.6!important;}
    `
  },

  /* â”€â”€â”€ BLACK & WHITE â”€â”€â”€ */
  {
    id:"bnw", name:"Black & White", price:500,
    preview:{bg:"#111",accent:"#fff",text:"#ccc",border:"#333",label:"MONOCHROME"},
    css:`
      @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;700;900&display=swap');
      :root{--bg-deep:#050505;--bg-panel:#0f0f0f;--bg-card:#1a1a1a;--bg-card2:#222222;
        --accent:#eeeeee;--accent2:#ffffff;--accent-dim:#555555;
        --red:#ff4444;--green:#44ff44;--blue:#6699ff;--purple:#cc88ff;
        --text:#cccccc;--text-dim:#666666;--text-bright:#ffffff;
        --border:#2a2a2a;--scan:rgba(255,255,255,0.015);}
      body{font-family:'DM Sans',sans-serif;}
      body::before{background:none!important;}
      body::after{background-image:linear-gradient(#1a1a1a 1px,transparent 1px),linear-gradient(90deg,#1a1a1a 1px,transparent 1px)!important;background-size:24px 24px!important;opacity:0.6!important;animation:bnwGridShift 8s linear infinite!important;}
      @keyframes bnwGridShift{0%{background-position:0 0;}100%{background-position:24px 24px;}}
      .ark-title{font-family:'DM Sans',sans-serif!important;font-weight:900!important;letter-spacing:2px!important;text-transform:uppercase;}
      .ark-title span{color:#ffffff!important;}
      .ark-header::after{background:#fff!important;height:1px!important;}
      .ark-section{font-family:'DM Mono',monospace!important;font-size:9px!important;letter-spacing:4px!important;color:#aaaaaa!important;}
      button{font-family:'DM Sans',sans-serif!important;font-weight:700!important;border-color:#2a2a2a!important;background:#0f0f0f!important;clip-path:none!important;border-radius:0!important;letter-spacing:2px!important;}
      button:hover{background:#1a1a1a!important;border-color:#ffffff!important;color:#ffffff!important;box-shadow:inset 0 0 0 1px #fff!important;}
      button::before{background:#ffffff!important;}
      button::after{display:none!important;}
      .card{font-family:'DM Mono',monospace!important;border-top:2px solid #fff!important;border-top-color:#fff!important;background:#0f0f0f!important;clip-path:none!important;letter-spacing:2px!important;}
      .card::before{content:'WORD DATA'!important;color:#555!important;}
      .xp-bar-fill{background:linear-gradient(90deg,#555,#fff)!important;box-shadow:none!important;}
      .ark-stat{clip-path:none!important;background:#0f0f0f!important;border-color:#2a2a2a!important;border-radius:0;}
      .ark-stat-value{font-family:'DM Mono',monospace!important;color:#ffffff!important;}
      .ach-card{clip-path:none!important;background:#0f0f0f!important;border:1px solid #2a2a2a!important;border-radius:0;}
      .ach-card.unlocked{border-color:#ffffff!important;}
      .ach-card.unlocked::before{background:linear-gradient(90deg,#555,#fff)!important;}
      .ach-name{font-family:'DM Sans',sans-serif!important;font-weight:900!important;letter-spacing:1px!important;}
      .ach-reward{color:#ffffff!important;}
      .daily-card{border-left:3px solid #555!important;background:#0f0f0f!important;}
      .daily-card.done{border-left-color:#ffffff!important;}
      .levelup-box{background:#0f0f0f!important;border:2px solid #fff!important;clip-path:none!important;}
      .levelup-num{font-family:'DM Mono',monospace!important;color:#ffffff!important;text-shadow:none!important;}
      .corner-deco{border-color:rgba(255,255,255,0.3)!important;}
      .coin-display{color:#fff!important;background:rgba(255,255,255,0.05)!important;border-color:rgba(255,255,255,0.2)!important;}
      input[type=text],input[type=number],textarea{font-family:'DM Mono',monospace!important;border-left-color:#555!important;}
      button.correct{background:#080808!important;border:2px solid #44ff44!important;color:#44ff44!important;}
      button.correct::before{background:#44ff44!important;opacity:1!important;}
      button.wrong{background:#080808!important;border:2px solid #ff4444!important;color:#ff4444!important;}
      button.wrong::before{background:#ff4444!important;opacity:1!important;}
      button.played{background:#050505!important;border-color:#1a1a1a!important;color:#333!important;opacity:0.55!important;}
    `
  },

  /* â”€â”€â”€ CLASSIC RPG â”€â”€â”€ */
  {
    id:"rpg", name:"Classic RPG", price:600,
    preview:{bg:"#1a1200",accent:"#d4a017",text:"#f0e8c8",border:"#3a2800",label:"â– QUEST LOG"},
    css:`
      @import url('https://fonts.googleapis.com/css2?family=MedievalSharp&family=Cinzel:wght@400;700;900&family=IM+Fell+English&display=swap');
      :root{--bg-deep:#110c00;--bg-panel:#1a1200;--bg-card:#231800;--bg-card2:#2d2000;
        --accent:#d4a017;--accent2:#f0c040;--accent-dim:#7a5c00;
        --red:#cc3333;--green:#448833;--blue:#3355aa;--purple:#8844aa;
        --text:#f0e8c8;--text-dim:#907840;--text-bright:#fff8e0;
        --border:#3a2800;--scan:rgba(212,160,23,0.02);}
      body{font-family:'IM Fell English',Georgia,serif;background:#110c00;}
      body::before{background:none!important;}
      body::after{background-image:radial-gradient(circle at 1px 1px,#3a2800 1px,transparent 0)!important;background-size:20px 20px!important;opacity:0.5!important;animation:rpgStarDrift 12s linear infinite!important;}
      @keyframes rpgStarDrift{0%{background-position:0 0;}100%{background-position:40px 20px;}}
      @keyframes rpgLanternPulse{0%,100%{opacity:0.07;}50%{opacity:0.14;}}
      #app::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 50% 0%,rgba(212,160,23,0.07) 0%,transparent 60%);pointer-events:none;z-index:0;}
      .ark-title{font-family:'Cinzel',Georgia,serif!important;letter-spacing:4px!important;font-size:20px!important;}
      .ark-title span{color:#d4a017!important;}
      .ark-header::after{background:linear-gradient(90deg,#7a5c00,#d4a017,#7a5c00)!important;height:1px!important;width:100%!important;}
      .ark-section{font-family:'Cinzel',Georgia,serif!important;font-size:11px!important;letter-spacing:3px!important;color:#d4a017!important;}
      button{font-family:'Cinzel',Georgia,serif!important;font-weight:700!important;text-transform:none!important;letter-spacing:1px!important;border-color:#3a2800!important;background:linear-gradient(180deg,#231800,#1a1200)!important;clip-path:none!important;border-radius:2px!important;}
      button:hover{background:linear-gradient(180deg,#2d2000,#231800)!important;border-color:#d4a017!important;color:#f0c040!important;}
      button::before{background:linear-gradient(180deg,#d4a017,#7a5c00)!important;}
      button::after{display:none!important;}
      .card{font-family:'Cinzel',Georgia,serif!important;border:2px solid #7a5c00!important;border-top:3px solid #d4a017!important;background:linear-gradient(180deg,#231800,#1a1200)!important;clip-path:none!important;font-size:44px!important;letter-spacing:6px!important;}
      .card::before{content:'â€” WORD OF FATE â€”'!important;color:#7a5c00!important;font-family:'Cinzel',serif!important;font-size:7px!important;letter-spacing:3px!important;}
      .xp-bar-fill{background:linear-gradient(90deg,#7a5c00,#d4a017,#f0c040)!important;}
      .ark-stat{clip-path:none!important;background:linear-gradient(135deg,#231800,#1a1200)!important;border:1px solid #3a2800!important;border-top:2px solid #7a5c00!important;}
      .ark-stat-value{font-family:'Cinzel',Georgia,serif!important;color:#d4a017!important;}
      .ach-card{clip-path:none!important;background:linear-gradient(135deg,#231800,#1a1200)!important;border:1px solid #3a2800!important;border-top:2px solid #7a5c00!important;}
      .ach-card.unlocked{border-top-color:#d4a017!important;border-color:#7a5c00!important;}
      .ach-card.unlocked::before{background:linear-gradient(90deg,#7a5c00,#d4a017,#7a5c00)!important;}
      .ach-name{font-family:'Cinzel',Georgia,serif!important;letter-spacing:1px!important;}
      .ach-reward{color:#d4a017!important;}
      .daily-card{background:linear-gradient(90deg,#231800,#1a1200)!important;border-left:3px solid #3355aa!important;}
      .daily-card.done{border-left-color:#448833!important;}
      .levelup-box{background:linear-gradient(135deg,#231800,#1a1200)!important;border:2px solid #d4a017!important;clip-path:none!important;}
      .levelup-label{font-family:'Cinzel',serif!important;letter-spacing:5px!important;}
      .levelup-num{font-family:'Cinzel',Georgia,serif!important;color:#d4a017!important;text-shadow:0 0 30px rgba(212,160,23,0.6)!important;}
      .corner-deco{border-color:rgba(212,160,23,0.3)!important;}
      .coin-display{font-family:'Cinzel',serif!important;color:#d4a017!important;}
      input[type=text],input[type=number],textarea{font-family:'IM Fell English',Georgia,serif!important;border-left-color:#7a5c00!important;background:#1a1200!important;}
      button.correct{background:linear-gradient(180deg,#162610,#0e1a08)!important;border-color:#448833!important;color:#7acc55!important;}
      button.correct::before{background:linear-gradient(180deg,#448833,#2a5520)!important;opacity:1!important;}
      button.wrong{background:linear-gradient(180deg,#261010,#1a0808)!important;border-color:#cc3333!important;color:#e06060!important;}
      button.wrong::before{background:linear-gradient(180deg,#cc3333,#882020)!important;opacity:1!important;}
      button.played{background:linear-gradient(180deg,#1a1200,#110c00)!important;border-color:#2a2000!important;color:#5a4020!important;opacity:0.65!important;}
    `
  },

  /* â”€â”€â”€ CHAINSAW MAN â”€â”€â”€ */
  {
    id:"csm", name:"Manga Panel", price:900,
    preview:{bg:"#ffffff",accent:"#111111",text:"#111111",border:"#000000",label:"â˜… MANGA STYLE"},
    css:`
      @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:ital,wght@0,400;0,700;1,400&family=Share+Tech+Mono&display=swap');
      :root{--bg-deep:#f0f0f0;--bg-panel:#ffffff;--bg-card:#fafafa;--bg-card2:#f5f5f5;
        --accent:#111111;--accent2:#333333;--accent-dim:#666666;
        --red:#cc0000;--green:#007700;--blue:#0033cc;--purple:#660099;
        --text:#111111;--text-dim:#555555;--text-bright:#000000;
        --border:#111111;--scan:rgba(0,0,0,0.03);}
      body{font-family:'Comic Neue','Comic Sans MS',cursive;background:#f0f0f0;}
      body::before{background:radial-gradient(circle,rgba(0,0,0,0.08) 1px,transparent 1px)!important;background-size:6px 6px!important;animation:csmDots 3s linear infinite!important;}
      @keyframes csmDots{0%{background-position:0 0;}100%{background-position:6px 6px;}}
      @keyframes csmSpeedLines{0%{transform:scaleX(0);opacity:0;}50%{transform:scaleX(1);opacity:0.07;}100%{transform:scaleX(0);opacity:0;}}
      body::after{background-image:none!important;opacity:0!important;}
      .ark-title{font-family:'Bangers',cursive!important;font-size:28px!important;letter-spacing:4px!important;color:#000!important;-webkit-text-stroke:1px #000!important;paint-order:stroke fill!important;}
      .ark-title span{color:#cc0000!important;-webkit-text-stroke:1px #000!important;}
      .ark-header{border-bottom:3px solid #000!important;background:#fff!important;}
      .ark-header::after{background:#000!important;height:3px!important;width:100%!important;}
      .ark-section{font-family:'Bangers',cursive!important;font-size:16px!important;letter-spacing:3px!important;color:#000!important;border-bottom:2px solid #000!important;}
      .ark-section::after{background:#000!important;}
      button{font-family:'Bangers',cursive!important;letter-spacing:2px!important;font-size:15px!important;border:2px solid #000!important;background:#fff!important;color:#000!important;clip-path:none!important;box-shadow:3px 3px 0 #000!important;border-radius:0!important;}
      button:hover{background:#fff700!important;color:#000!important;box-shadow:4px 4px 0 #000!important;transform:translate(-1px,-1px)!important;}
      button::before{display:none!important;}
      button::after{display:none!important;}
      .card{font-family:'Bangers',cursive!important;border:3px solid #000!important;background:#fff!important;clip-path:none!important;color:#000!important;box-shadow:4px 4px 0 #000!important;-webkit-text-stroke:1px #000!important;}
      .card::before{content:'èª­ã‚€!'!important;color:rgba(0,0,0,0.08)!important;font-family:'Bangers',cursive!important;}
      .xp-bar-fill{background:linear-gradient(90deg,#333,#000)!important;box-shadow:none!important;}
      .xp-bar-bg{background:#ddd!important;border:1px solid #000!important;}
      .ark-stat{clip-path:none!important;background:#fff!important;border:2px solid #000!important;box-shadow:3px 3px 0 #000!important;}
      .ark-stat-value{font-family:'Bangers',cursive!important;color:#000!important;font-size:22px!important;}
      .ach-card{clip-path:none!important;background:#fff!important;border:2px solid #000!important;box-shadow:2px 2px 0 #000!important;}
      .ach-card.unlocked{border-color:#cc0000!important;box-shadow:3px 3px 0 #cc0000!important;}
      .ach-card.unlocked::before{background:#cc0000!important;height:3px!important;}
      .ach-name{font-family:'Bangers',cursive!important;letter-spacing:1px!important;color:#000!important;}
      .ach-reward{color:#cc0000!important;font-family:'Bangers',cursive!important;}
      .daily-card{background:#fff!important;border:2px solid #000!important;border-left:5px solid #0033cc!important;box-shadow:2px 2px 0 #000!important;}
      .daily-card.done{border-left-color:#007700!important;}
      .levelup-box{background:#fff!important;border:4px solid #000!important;clip-path:none!important;box-shadow:6px 6px 0 #000!important;}
      .levelup-label{font-family:'Bangers',cursive!important;color:#000!important;letter-spacing:4px!important;}
      .levelup-num{font-family:'Bangers',cursive!important;color:#cc0000!important;-webkit-text-stroke:2px #000!important;text-shadow:none!important;}
      .corner-deco{border-color:rgba(0,0,0,0.3)!important;}
      .coin-display{font-family:'Bangers',cursive!important;color:#000!important;background:#fff!important;border:2px solid #000!important;box-shadow:2px 2px 0 #000!important;}
      .ark-badge{border-color:#000!important;color:#000!important;background:#fff700!important;font-family:'Comic Neue',cursive!important;}
      .ach-toast{background:#fff!important;border:2px solid #000!important;border-left:4px solid #cc0000!important;box-shadow:3px 3px 0 #000!important;}
      input[type=text],input[type=number],textarea{font-family:'Comic Neue',cursive!important;border:2px solid #000!important;background:#fff!important;color:#000!important;box-shadow:2px 2px 0 #000!important;}
      input:focus,textarea:focus{border-color:#cc0000!important;box-shadow:2px 2px 0 #cc0000!important;}
      button.correct{background:#f0fff0!important;border:3px solid #007700!important;color:#007700!important;box-shadow:3px 3px 0 #007700!important;}
      button.correct::before{display:none!important;}
      button.wrong{background:#fff0f0!important;border:3px solid #cc0000!important;color:#cc0000!important;box-shadow:3px 3px 0 #cc0000!important;}
      button.wrong::before{display:none!important;}
      button.played{background:#ececec!important;border:2px solid #aaa!important;color:#aaa!important;box-shadow:2px 2px 0 #ccc!important;opacity:0.65!important;}
    `
  },

  /* â”€â”€â”€ CYBERPUNK â”€â”€â”€ */
  {
    id:"cyberpunk", name:"Cyberpunk", price:1000,
    preview:{bg:"#050510",accent:"#00ffff",text:"#c0e0ff",border:"#0a2040",label:"â–¶ NETRUNNER"},
    css:`
      @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&family=Share+Tech+Mono&display=swap');
      :root{--bg-deep:#030308;--bg-panel:#050510;--bg-card:#080820;--bg-card2:#0c0c2a;
        --accent:#00ffff;--accent2:#80ffff;--accent-dim:#006666;
        --red:#ff4466;--green:#00ff88;--blue:#0088ff;--purple:#ff00ff;
        --text:#c0e0ff;--text-dim:#3a6080;--text-bright:#e0f4ff;
        --border:#0a2040;--scan:rgba(0,255,255,0.04);}
      body{font-family:'Exo 2',sans-serif;background:#030308;}
      body::before{background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,255,255,0.025) 2px,rgba(0,255,255,0.025) 4px)!important;}
      body::after{background-image:linear-gradient(rgba(0,255,255,0.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,255,255,0.04) 1px,transparent 1px)!important;background-size:32px 32px!important;opacity:1!important;animation:cyberGridRain 3s linear infinite!important;}
      @keyframes cyberGridRain{0%{background-position:0 0;}100%{background-position:0 32px;}}
      #app::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 40% at 50% 0%,rgba(0,200,255,0.08) 0%,transparent 60%);pointer-events:none;z-index:0;}
      .ark-title{font-family:'Exo 2',sans-serif!important;font-weight:900!important;letter-spacing:4px!important;text-shadow:0 0 16px rgba(0,255,255,0.6);}
      .ark-title span{color:#00ffff!important;text-shadow:0 0 24px rgba(0,255,255,1)!important;}
      .ark-header{border-bottom:1px solid rgba(0,255,255,0.2)!important;}
      .ark-header::after{background:linear-gradient(90deg,#00ffff,transparent)!important;height:1px!important;width:100%!important;}
      .ark-section{font-family:'Share Tech Mono',monospace!important;letter-spacing:4px!important;color:#00ffff!important;text-shadow:0 0 8px rgba(0,255,255,0.5)!important;}
      button{font-family:'Exo 2',sans-serif!important;font-weight:700!important;letter-spacing:2px!important;border-color:#0a2040!important;background:#080820!important;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%)!important;}
      button:hover{background:#0c0c2a!important;border-color:#00ffff!important;color:#00ffff!important;box-shadow:inset 0 0 20px rgba(0,255,255,0.05),0 0 16px rgba(0,255,255,0.15)!important;}
      button::before{background:linear-gradient(180deg,#00ffff,#006666)!important;}
      button::after{display:none!important;}
      .card{font-family:'Exo 2',sans-serif!important;font-weight:900!important;border-top:2px solid #00ffff!important;background:linear-gradient(180deg,#080820,#050510)!important;clip-path:polygon(0 0,calc(100% - 20px) 0,100% 20px,100% 100%,0 100%)!important;text-shadow:0 0 24px rgba(0,255,255,0.5)!important;}
      .card::before{content:'NETRUNNER DATA'!important;color:#00ffff!important;opacity:0.5!important;}
      .xp-bar-fill{background:linear-gradient(90deg,#006666,#00ffff)!important;box-shadow:0 0 14px rgba(0,255,255,0.7)!important;}
      .ark-stat{background:linear-gradient(135deg,#080820,#050510)!important;border-color:#0a2040!important;border-top:1px solid rgba(0,255,255,0.3)!important;}
      .ark-stat-value{font-family:'Exo 2',sans-serif!important;color:#00ffff!important;text-shadow:0 0 10px rgba(0,255,255,0.6)!important;}
      .ach-card{background:linear-gradient(135deg,#080820,#050510)!important;border-color:#0a2040!important;}
      .ach-card.unlocked{border-color:rgba(0,255,255,0.5)!important;box-shadow:0 0 14px rgba(0,255,255,0.1)!important;}
      .ach-card.unlocked::before{background:linear-gradient(90deg,#006666,#00ffff)!important;}
      .ach-name{font-family:'Exo 2',sans-serif!important;font-weight:700!important;}
      .ach-reward{color:#00ffff!important;}
      .daily-card{background:linear-gradient(90deg,#080820,#050510)!important;border-left-color:#0088ff!important;}
      .daily-card.done{border-left-color:#00ff88!important;}
      .levelup-box{background:#080820!important;border:1px solid #00ffff!important;box-shadow:0 0 40px rgba(0,255,255,0.2)!important;}
      .levelup-num{font-family:'Exo 2',sans-serif!important;color:#00ffff!important;text-shadow:0 0 50px rgba(0,255,255,0.9)!important;}
      .corner-deco{border-color:rgba(0,255,255,0.3)!important;}
      .coin-display{color:#00ffff!important;background:rgba(0,255,255,0.06)!important;border-color:rgba(0,255,255,0.25)!important;}
      input[type=text],input[type=number],textarea{font-family:'Share Tech Mono',monospace!important;border-left-color:#006666!important;background:#050510!important;}
      input:focus,textarea:focus{border-color:#00ffff!important;box-shadow:0 0 0 1px rgba(0,255,255,0.2)!important;}
      button.correct{background:rgba(0,255,136,0.1)!important;border-color:#00ff88!important;color:#00ff88!important;text-shadow:0 0 12px rgba(0,255,136,0.7)!important;box-shadow:0 0 16px rgba(0,255,136,0.2)!important;}
      button.correct::before{background:linear-gradient(180deg,#00ff88,#006644)!important;opacity:1!important;}
      button.wrong{background:rgba(255,68,102,0.1)!important;border-color:#ff4466!important;color:#ff4466!important;text-shadow:0 0 12px rgba(255,68,102,0.7)!important;box-shadow:0 0 16px rgba(255,68,102,0.2)!important;}
      button.wrong::before{background:linear-gradient(180deg,#ff4466,#880022)!important;opacity:1!important;}
      button.played{background:#030308!important;border-color:#060618!important;color:#1a3048!important;opacity:0.6!important;}
    `
  },

  /* â”€â”€â”€ HACKER MODE â”€â”€â”€ */
  {
    id:"hacker", name:"Hacker Mode", price:700,
    preview:{bg:"#000800",accent:"#00ff41",text:"#88ff88",border:"#003300",label:"$ ./run.sh"},
    css:`
      @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
      :root{--bg-deep:#000300;--bg-panel:#000800;--bg-card:#001000;--bg-card2:#001a00;
        --accent:#00ff41;--accent2:#66ff88;--accent-dim:#005500;
        --red:#ff4444;--green:#00ff41;--blue:#00aaff;--purple:#aa44ff;
        --text:#88ff88;--text-dim:#336633;--text-bright:#ccffcc;
        --border:#003300;--scan:rgba(0,255,65,0.05);}
      body{font-family:'Share Tech Mono','Courier New',monospace;background:#000300;}
      body::before{background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,255,65,0.04) 3px,rgba(0,255,65,0.04) 4px)!important;}
      body::after{background-image:repeating-linear-gradient(90deg,transparent,transparent 19px,rgba(0,255,65,0.06) 19px,rgba(0,255,65,0.06) 20px)!important;opacity:1!important;animation:hackerRain 1.5s linear infinite!important;}
      @keyframes hackerRain{0%{background-position:0 0;}100%{background-position:0 20px;}}
      #app::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 60% 80% at 50% 50%,rgba(0,80,0,0.15) 0%,transparent 70%);pointer-events:none;z-index:0;}
      .ark-title{font-family:'Share Tech Mono',monospace!important;font-size:16px!important;letter-spacing:3px!important;text-shadow:0 0 10px rgba(0,255,65,0.5);}
      .ark-title::before{content:'> ';}
      .ark-title span{color:#00ff41!important;text-shadow:0 0 16px rgba(0,255,65,0.8)!important;}
      .ark-header::after{background:linear-gradient(90deg,#00ff41,transparent)!important;height:1px!important;width:100%!important;}
      .ark-section{font-family:'Share Tech Mono',monospace!important;font-size:9px!important;letter-spacing:3px!important;color:#00ff41!important;}
      .ark-section::before{content:'// ';}
      button{font-family:'Share Tech Mono',monospace!important;text-transform:none!important;letter-spacing:0px!important;border-color:#003300!important;background:#000800!important;clip-path:none!important;border-radius:0!important;}
      button::before{content:'> '!important;position:static!important;width:auto!important;background:none!important;opacity:1!important;color:#00ff41!important;font-size:12px!important;}
      button:hover{background:#001000!important;border-color:#00ff41!important;color:#00ff41!important;text-shadow:0 0 8px rgba(0,255,65,0.4)!important;}
      button::after{display:none!important;}
      .card{font-family:'Share Tech Mono',monospace!important;font-size:34px!important;border:1px solid #003300!important;border-top:2px solid #00ff41!important;background:#000800!important;clip-path:none!important;text-shadow:0 0 20px rgba(0,255,65,0.6)!important;letter-spacing:4px!important;}
      .card::before{content:'root@kotoba:~$ '!important;color:#336633!important;font-size:8px!important;letter-spacing:1px!important;}
      .xp-bar-fill{background:linear-gradient(90deg,#005500,#00ff41)!important;box-shadow:0 0 10px rgba(0,255,65,0.6)!important;}
      .ark-stat{clip-path:none!important;background:#000800!important;border-color:#003300!important;}
      .ark-stat-value{font-family:'Share Tech Mono',monospace!important;color:#00ff41!important;font-size:20px!important;text-shadow:0 0 8px rgba(0,255,65,0.5)!important;}
      .ach-card{clip-path:none!important;background:#000800!important;border-color:#003300!important;}
      .ach-card.unlocked{border-color:#00ff41!important;}
      .ach-card.unlocked::before{background:linear-gradient(90deg,#005500,#00ff41)!important;}
      .ach-name{font-family:'Share Tech Mono',monospace!important;font-weight:normal!important;font-size:11px!important;}
      .ach-reward{color:#00ff41!important;}
      .daily-card{background:#000800!important;border-left-color:#00aaff!important;}
      .daily-card.done{border-left-color:#00ff41!important;}
      .levelup-box{background:#000800!important;border:1px solid #00ff41!important;clip-path:none!important;}
      .levelup-label{font-family:'Share Tech Mono',monospace!important;}
      .levelup-label::before{content:'// ';}
      .levelup-num{font-family:'Share Tech Mono',monospace!important;color:#00ff41!important;text-shadow:0 0 40px rgba(0,255,65,0.8)!important;}
      .corner-deco{border-color:rgba(0,255,65,0.3)!important;}
      .coin-display{font-family:'Share Tech Mono',monospace!important;color:#00ff41!important;background:rgba(0,255,65,0.05)!important;border-color:rgba(0,255,65,0.2)!important;}
      input[type=text],input[type=number],textarea{font-family:'Share Tech Mono',monospace!important;border-left-color:#005500!important;background:#000800!important;}
      input:focus,textarea:focus{border-color:#00ff41!important;box-shadow:0 0 0 1px rgba(0,255,65,0.2)!important;}
      button.correct{background:#001a00!important;border-color:#00ff41!important;color:#00ff41!important;text-shadow:0 0 8px rgba(0,255,65,0.6)!important;}
      button.correct::before{content:'âœ“ '!important;position:static!important;width:auto!important;background:none!important;color:#00ff41!important;opacity:1!important;font-size:12px!important;}
      button.wrong{background:#1a0000!important;border-color:#ff4444!important;color:#ff4444!important;text-shadow:0 0 8px rgba(255,68,68,0.6)!important;}
      button.wrong::before{content:'âœ— '!important;position:static!important;width:auto!important;background:none!important;color:#ff4444!important;opacity:1!important;font-size:12px!important;}
      button.played{background:#000300!important;border-color:#002200!important;color:#224422!important;opacity:0.55!important;}
    `
  },

  /* â”€â”€â”€ ULTRAKILL â”€â”€â”€ */
  {
    id:"ultrakill", name:"Sakura", price:1200,
    preview:{bg:"#fff0f5",accent:"#e0607e",text:"#5a2040",border:"#f4a0c0",label:"ðŸŒ¸ ã•ãã‚‰"},
    css:`
      @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=M+PLUS+Rounded+1c:wght@400;700&family=Share+Tech+Mono&display=swap');
      :root{--bg-deep:#fff0f5;--bg-panel:#fdf4f8;--bg-card:#fff8fb;--bg-card2:#ffeef5;
        --accent:#e0607e;--accent2:#f090a8;--accent-dim:#c04060;
        --red:#e02050;--green:#50a070;--blue:#6080c0;--purple:#9060b0;
        --text:#5a2040;--text-dim:#c090a8;--text-bright:#3a1030;
        --border:#f4a0c0;--scan:rgba(224,96,126,0.03);}
      body{font-family:'M PLUS Rounded 1c','Hiragino Maru Gothic Pro',sans-serif;background:#fff0f5;}
      body::before{background:none!important;}
      body::after{background-image:radial-gradient(circle 2px at 15% 10%, rgba(255,160,192,0.6) 0%, transparent 100%),radial-gradient(circle 3px at 35% 5%, rgba(255,180,210,0.5) 0%, transparent 100%),radial-gradient(circle 2px at 55% 15%, rgba(255,140,180,0.7) 0%, transparent 100%),radial-gradient(circle 2px at 75% 8%, rgba(255,170,200,0.5) 0%, transparent 100%),radial-gradient(circle 3px at 90% 3%, rgba(255,150,190,0.6) 0%, transparent 100%),radial-gradient(circle 2px at 5% 3%, rgba(255,190,215,0.4) 0%, transparent 100%)!important;background-size:100% 200%!important;opacity:1!important;animation:sakuraPetals 6s linear infinite!important;}
      @keyframes sakuraPetals{0%{background-position:0% -50%;}100%{background-position:5% 120%;}}
      #app::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 100% 60% at 50% 0%,rgba(255,200,220,0.4) 0%,transparent 60%);pointer-events:none;z-index:0;}
      .ark-title{font-family:'Noto Serif JP',serif!important;letter-spacing:4px!important;font-size:20px!important;color:#3a1030!important;font-weight:700!important;}
      .ark-title span{color:#e0607e!important;}
      .ark-header{border-bottom:1px solid #f4a0c0!important;background:linear-gradient(180deg,rgba(255,220,235,0.6),transparent)!important;}
      .ark-header::after{background:linear-gradient(90deg,#e0607e,#f4a0c0,transparent)!important;height:2px!important;width:100%!important;}
      .ark-section{font-family:'Noto Serif JP',serif!important;font-size:11px!important;letter-spacing:3px!important;color:#e0607e!important;border-bottom:1px solid #f4a0c0!important;}
      .ark-section::after{background:linear-gradient(90deg,#e0607e,transparent)!important;}
      button{font-family:'M PLUS Rounded 1c',sans-serif!important;letter-spacing:1px!important;border:1px solid #f4a0c0!important;background:linear-gradient(180deg,#fff8fb,#ffeef5)!important;color:#5a2040!important;clip-path:none!important;border-radius:20px!important;box-shadow:0 2px 8px rgba(224,96,126,0.15)!important;}
      button:hover{background:linear-gradient(180deg,#ffeef5,#ffdde8)!important;border-color:#e0607e!important;color:#e0607e!important;box-shadow:0 4px 14px rgba(224,96,126,0.3)!important;}
      button::before{background:linear-gradient(180deg,#f090a8,#e0607e)!important;border-radius:20px 0 0 20px!important;}
      button::after{display:none!important;}
      .card{font-family:'Noto Serif JP',serif!important;border:1px solid #f4a0c0!important;background:linear-gradient(180deg,#fff8fb,#ffeef5)!important;clip-path:none!important;border-radius:12px!important;box-shadow:0 4px 16px rgba(224,96,126,0.12)!important;}
      .card::before{content:'ðŸŒ¸'!important;color:rgba(224,96,126,0.2)!important;font-size:60px!important;font-family:sans-serif!important;}
      .xp-bar-fill{background:linear-gradient(90deg,#f4a0c0,#e0607e,#c04060)!important;box-shadow:0 0 8px rgba(224,96,126,0.4)!important;}
      .xp-bar-bg{background:#ffd8e8!important;border:1px solid #f4a0c0!important;}
      .ark-stat{clip-path:none!important;background:linear-gradient(135deg,#fff8fb,#ffeef5)!important;border:1px solid #f4a0c0!important;border-radius:8px!important;box-shadow:0 2px 8px rgba(224,96,126,0.1)!important;}
      .ark-stat-value{font-family:'Noto Serif JP',serif!important;color:#e0607e!important;}
      .ach-card{clip-path:none!important;background:linear-gradient(135deg,#fff8fb,#ffeef5)!important;border:1px solid #f4a0c0!important;border-radius:8px!important;}
      .ach-card.unlocked{border-color:#e0607e!important;box-shadow:0 2px 12px rgba(224,96,126,0.2)!important;}
      .ach-card.unlocked::before{background:linear-gradient(90deg,#f4a0c0,#e0607e)!important;}
      .ach-name{font-family:'Noto Serif JP',serif!important;color:#3a1030!important;}
      .ach-reward{color:#e0607e!important;}
      .daily-card{background:linear-gradient(90deg,#fff8fb,#ffeef5)!important;border:1px solid #f4a0c0!important;border-left:3px solid #6080c0!important;border-radius:0 8px 8px 0!important;}
      .daily-card.done{border-left-color:#50a070!important;}
      .levelup-box{background:#fff8fb!important;border:2px solid #f4a0c0!important;clip-path:none!important;border-radius:16px!important;box-shadow:0 8px 32px rgba(224,96,126,0.25)!important;}
      .levelup-label{font-family:'Noto Serif JP',serif!important;color:#e0607e!important;letter-spacing:4px!important;}
      .levelup-num{font-family:'Noto Serif JP',serif!important;color:#e0607e!important;text-shadow:0 0 30px rgba(224,96,126,0.5)!important;}
      .corner-deco{border-color:rgba(244,160,192,0.5)!important;}
      .coin-display{font-family:'M PLUS Rounded 1c',sans-serif!important;color:#e0607e!important;background:rgba(244,160,192,0.2)!important;border:1px solid rgba(224,96,126,0.3)!important;border-radius:20px!important;}
      .ark-badge{border-color:#f4a0c0!important;color:#e0607e!important;background:rgba(244,160,192,0.15)!important;}
      .ach-toast{background:#fff8fb!important;border:1px solid #f4a0c0!important;border-left-color:#e0607e!important;border-radius:0 8px 8px 0!important;box-shadow:0 4px 12px rgba(224,96,126,0.15)!important;}
      input[type=text],input[type=number],textarea{font-family:'M PLUS Rounded 1c',sans-serif!important;border:1px solid #f4a0c0!important;border-radius:8px!important;background:#fff8fb!important;color:#3a1030!important;}
      input:focus,textarea:focus{border-color:#e0607e!important;box-shadow:0 0 0 2px rgba(224,96,126,0.15)!important;}
      button.correct{background:rgba(80,160,112,0.12)!important;border-color:#50a070!important;color:#50a070!important;border-radius:20px!important;box-shadow:0 2px 12px rgba(80,160,112,0.25)!important;}
      button.correct::before{background:linear-gradient(180deg,#50a070,#2a7050)!important;border-radius:20px 0 0 20px!important;opacity:1!important;}
      button.wrong{background:rgba(224,96,126,0.1)!important;border-color:#e0607e!important;color:#c04060!important;border-radius:20px!important;box-shadow:0 2px 12px rgba(224,96,126,0.2)!important;}
      button.wrong::before{background:linear-gradient(180deg,#e0607e,#a03050)!important;border-radius:20px 0 0 20px!important;opacity:1!important;}
      button.played{background:rgba(255,240,248,0.5)!important;border-color:#f4c0d4!important;color:#c090a8!important;border-radius:20px!important;opacity:0.65!important;}
    `
  },

  /* â”€â”€â”€ VOID PROTOCOL â”€â”€â”€ */
  {
    id:"void", name:"VOID PROTOCOL", price:1500,
    preview:{bg:"#080010",accent:"#9900ff",text:"#d0a0ff",border:"#2a0060",label:"â—‰ VOID.EXE"},
    css:`
      @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=Share+Tech+Mono&display=swap');
      :root{--bg-deep:#04000a;--bg-panel:#080010;--bg-card:#0e0020;--bg-card2:#140030;
        --accent:#9900ff;--accent2:#cc66ff;--accent-dim:#440088;
        --red:#ff4488;--green:#44ffcc;--blue:#4488ff;--purple:#9900ff;
        --text:#d0a0ff;--text-dim:#5a3080;--text-bright:#eebbff;
        --border:#2a0060;--scan:rgba(153,0,255,0.05);}
      body{font-family:'Space Grotesk',sans-serif;background:#04000a;}
      body::before{background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(153,0,255,0.03) 2px,rgba(153,0,255,0.03) 4px)!important;}
      body::after{background-image:linear-gradient(rgba(42,0,96,0.5) 1px,transparent 1px),linear-gradient(90deg,rgba(42,0,96,0.5) 1px,transparent 1px)!important;background-size:40px 40px!important;opacity:0.3!important;animation:voidGridPulse 6s ease-in-out infinite!important;}
      @keyframes voidGridPulse{0%,100%{background-position:0 0;opacity:0.3;}50%{background-position:2px 2px;opacity:0.5;}}
      #app::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 70% 70% at 50% 50%,rgba(100,0,200,0.12) 0%,transparent 70%);pointer-events:none;z-index:0;animation:voidNebulaShift 8s ease-in-out infinite;}
      @keyframes voidNebulaShift{0%,100%{background-position:center;opacity:1;}50%{background:radial-gradient(ellipse 80% 80% at 55% 45%,rgba(150,0,255,0.18) 0%,transparent 70%);opacity:1;}}
      .ark-title{font-family:'Space Grotesk',sans-serif!important;font-weight:700!important;letter-spacing:3px!important;text-shadow:0 0 16px rgba(153,0,255,0.5);}
      .ark-title span{color:#cc66ff!important;text-shadow:0 0 24px rgba(153,0,255,0.9)!important;}
      .ark-header::after{background:linear-gradient(90deg,#9900ff,transparent)!important;height:1px!important;width:100%!important;}
      .ark-section{font-family:'Share Tech Mono',monospace!important;letter-spacing:3px!important;color:#9900ff!important;text-shadow:0 0 8px rgba(153,0,255,0.4)!important;}
      button{font-family:'Space Grotesk',sans-serif!important;font-weight:700!important;letter-spacing:1px!important;border-color:#2a0060!important;background:#0e0020!important;clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px))!important;}
      button:hover{background:#140030!important;border-color:#9900ff!important;color:#cc66ff!important;box-shadow:inset 0 0 20px rgba(153,0,255,0.06),0 0 16px rgba(153,0,255,0.15)!important;}
      button::before{background:linear-gradient(180deg,#9900ff,#440088)!important;}
      button::after{display:none!important;}
      .card{font-family:'Space Grotesk',sans-serif!important;font-weight:700!important;border-top:2px solid #9900ff!important;background:linear-gradient(180deg,#0e0020,#080010)!important;clip-path:none!important;text-shadow:0 0 28px rgba(153,0,255,0.5)!important;}
      .card::before{content:'VOID DATA'!important;color:#440088!important;}
      .xp-bar-fill{background:linear-gradient(90deg,#440088,#9900ff,#cc66ff)!important;box-shadow:0 0 14px rgba(153,0,255,0.7)!important;}
      .ark-stat{background:linear-gradient(135deg,#0e0020,#080010)!important;border-color:#2a0060!important;animation:voidPulse 3s infinite;}
      @keyframes voidPulse{0%,100%{box-shadow:0 0 4px rgba(153,0,255,0.2);}50%{box-shadow:0 0 14px rgba(153,0,255,0.5);}}
      .ark-stat-value{font-family:'Space Grotesk',sans-serif!important;color:#cc66ff!important;text-shadow:0 0 10px rgba(153,0,255,0.5)!important;}
      .ach-card{background:linear-gradient(135deg,#0e0020,#080010)!important;border-color:#2a0060!important;clip-path:none!important;}
      .ach-card.unlocked{border-color:#9900ff!important;box-shadow:0 0 12px rgba(153,0,255,0.15)!important;}
      .ach-card.unlocked::before{background:linear-gradient(90deg,#440088,#9900ff,#cc66ff)!important;}
      .ach-name{font-family:'Space Grotesk',sans-serif!important;font-weight:700!important;}
      .ach-reward{color:#cc66ff!important;}
      .daily-card{background:linear-gradient(90deg,#0e0020,#080010)!important;border-left-color:#4488ff!important;}
      .daily-card.done{border-left-color:#44ffcc!important;}
      .levelup-box{background:#0e0020!important;border:1px solid #9900ff!important;box-shadow:0 0 40px rgba(153,0,255,0.25)!important;}
      .levelup-num{font-family:'Space Grotesk',sans-serif!important;color:#cc66ff!important;text-shadow:0 0 50px rgba(153,0,255,0.9)!important;}
      .corner-deco{border-color:rgba(153,0,255,0.35)!important;}
      .coin-display{color:#cc66ff!important;background:rgba(153,0,255,0.07)!important;border-color:rgba(153,0,255,0.25)!important;}
      input[type=text],input[type=number],textarea{font-family:'Share Tech Mono',monospace!important;border-left-color:#440088!important;background:#080010!important;}
      input:focus,textarea:focus{border-color:#9900ff!important;box-shadow:0 0 0 1px rgba(153,0,255,0.2)!important;}
      button.correct{background:rgba(68,255,204,0.1)!important;border-color:#44ffcc!important;color:#44ffcc!important;box-shadow:0 0 14px rgba(68,255,204,0.3)!important;text-shadow:0 0 8px rgba(68,255,204,0.7)!important;}
      button.correct::before{background:#44ffcc!important;opacity:1!important;}
      button.wrong{background:rgba(255,68,136,0.1)!important;border-color:#ff4488!important;color:#ff4488!important;box-shadow:0 0 14px rgba(255,68,136,0.3)!important;text-shadow:0 0 8px rgba(255,68,136,0.7)!important;}
      button.wrong::before{background:#ff4488!important;opacity:1!important;}
      button.played{background:#040008!important;border-color:#1a0040!important;color:#3a1060!important;opacity:0.55!important;}
    `
  },

  /* â”€â”€â”€ METAPHOR â”€â”€â”€ */
  {
    id:"metaphor", name:"Metaphor UI", price:1100,
    preview:{bg:"#0d0d1a",accent:"#c8b050",text:"#e0d8c0",border:"#2a2a44",label:"â—† THE ARCHETYPAL"},
    css:`
      @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Cinzel:wght@400;700&family=Share+Tech+Mono&display=swap');
      :root{--bg-deep:#08081a;--bg-panel:#0d0d20;--bg-card:#121228;--bg-card2:#181832;
        --accent:#c8b050;--accent2:#e0cc80;--accent-dim:#705820;
        --red:#cc4444;--green:#44aa66;--blue:#4466bb;--purple:#9955cc;
        --text:#e0d8c0;--text-dim:#6a6080;--text-bright:#f4ecd8;
        --border:#2a2a44;--scan:rgba(200,176,80,0.02);}
      body{font-family:'Cormorant Garamond',Georgia,serif;background:#08081a;}
      body::before{background:none!important;}
      body::after{background-image:linear-gradient(#2a2a44 1px,transparent 1px),linear-gradient(90deg,#2a2a44 1px,transparent 1px)!important;background-size:60px 60px!important;opacity:0.12!important;animation:metaConstellation 20s linear infinite!important;}
      @keyframes metaConstellation{0%{background-position:0 0;}100%{background-position:60px 60px;}}
      #app::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 60% at 50% 20%,rgba(200,176,80,0.05) 0%,transparent 60%);pointer-events:none;z-index:0;animation:metaAuraPulse 5s ease-in-out infinite;}
      @keyframes metaAuraPulse{0%,100%{background:radial-gradient(ellipse 80% 60% at 50% 20%,rgba(200,176,80,0.05) 0%,transparent 60%);}50%{background:radial-gradient(ellipse 90% 70% at 52% 18%,rgba(200,176,80,0.09) 0%,transparent 65%);}}
      .ark-title{font-family:'Cinzel',Georgia,serif!important;letter-spacing:5px!important;font-size:20px!important;}
      .ark-title span{color:#c8b050!important;}
      .ark-header::after{background:linear-gradient(90deg,#705820,#c8b050,#705820)!important;height:1px!important;width:100%!important;}
      .ark-section{font-family:'Cinzel',Georgia,serif!important;font-size:10px!important;letter-spacing:4px!important;color:#c8b050!important;}
      button{font-family:'Cinzel',Georgia,serif!important;font-weight:700!important;text-transform:none!important;letter-spacing:2px!important;border-color:#2a2a44!important;background:linear-gradient(180deg,#121228,#0d0d20)!important;clip-path:none!important;border-radius:0!important;}
      button::before{display:none!important;}
      button::after{display:none!important;}
      button:hover{background:linear-gradient(180deg,#181832,#121228)!important;border-color:#c8b050!important;color:#e0cc80!important;}
      .card{font-family:'Cinzel',Georgia,serif!important;border:1px solid #2a2a44!important;border-top:2px solid #c8b050!important;border-bottom:2px solid #c8b050!important;background:linear-gradient(180deg,#121228,#0d0d20)!important;clip-path:none!important;font-size:44px!important;letter-spacing:8px!important;}
      .card::before{content:'â—† THE WORD â—†'!important;color:#705820!important;font-family:'Cinzel',serif!important;font-size:7px!important;letter-spacing:3px!important;}
      .xp-bar-fill{background:linear-gradient(90deg,#705820,#c8b050)!important;}
      .ark-stat{clip-path:none!important;background:linear-gradient(180deg,#121228,#0d0d20)!important;border:1px solid #2a2a44!important;border-top:2px solid #705820!important;}
      .ark-stat-value{font-family:'Cinzel',Georgia,serif!important;color:#c8b050!important;}
      .ach-card{clip-path:none!important;background:linear-gradient(180deg,#121228,#0d0d20)!important;border:1px solid #2a2a44!important;border-top:2px solid #705820!important;}
      .ach-card.unlocked{border-top-color:#c8b050!important;border-color:#705820!important;}
      .ach-card.unlocked::before{background:linear-gradient(90deg,#705820,#c8b050,#705820)!important;}
      .ach-name{font-family:'Cinzel',Georgia,serif!important;font-size:12px!important;letter-spacing:1px!important;}
      .ach-reward{color:#c8b050!important;}
      .daily-card{background:linear-gradient(90deg,#121228,#0d0d20)!important;border:1px solid #2a2a44!important;border-left:3px solid #4466bb!important;}
      .daily-card.done{border-left-color:#44aa66!important;}
      .levelup-box{background:#121228!important;border:1px solid #c8b050!important;clip-path:none!important;}
      .levelup-label{font-family:'Cinzel',serif!important;letter-spacing:5px!important;}
      .levelup-num{font-family:'Cinzel',Georgia,serif!important;color:#c8b050!important;text-shadow:0 0 30px rgba(200,176,80,0.5)!important;}
      .corner-deco{border-color:rgba(200,176,80,0.25)!important;}
      .coin-display{font-family:'Cinzel',serif!important;color:#c8b050!important;background:rgba(200,176,80,0.05)!important;border-color:rgba(200,176,80,0.2)!important;}
      input[type=text],input[type=number],textarea{font-family:'Cormorant Garamond',Georgia,serif!important;border-left-color:#705820!important;background:#0d0d20!important;}
      button.correct{background:linear-gradient(180deg,rgba(68,170,102,0.14),rgba(68,170,102,0.07))!important;border-color:#44aa66!important;color:#44aa66!important;}
      button.correct::before{display:none!important;}
      button.wrong{background:linear-gradient(180deg,rgba(204,68,68,0.14),rgba(204,68,68,0.07))!important;border-color:#cc4444!important;color:#cc4444!important;}
      button.wrong::before{display:none!important;}
      button.played{background:linear-gradient(180deg,#0d0d20,#08081a)!important;border-color:#1e1e36!important;color:#4a4860!important;opacity:0.6!important;}
    `
  },

  /* â”€â”€â”€ PICAYUNE DREAMS â”€â”€â”€ */
  {
    id:"picayune", name:"Picayune Dreams", price:6666,
    preview:{bg:"#080808",accent:"#ffffff",text:"#cccccc",border:"#222222",label:"âŠ¹ DREAMING âŠ¹"},
    css:`
      @import url('https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap');
      :root{
        --bg-deep:#030303;--bg-panel:#070707;--bg-card:#0d0d0d;--bg-card2:#141414;
        --accent:#ffffff;--accent2:#eeeeee;--accent-dim:#444444;
        --red:#ff2222;--green:#22ff22;--blue:#2222ff;--purple:#cc00cc;
        --text:#999999;--text-dim:#333333;--text-bright:#ffffff;
        --border:#1c1c1c;--scan:rgba(255,255,255,0.012);
      }

      /* â”€â”€ BASE â”€â”€ */
      body{font-family:'VT323','Share Tech Mono',monospace;background:#030303;color:#999999;}

      /* â”€â”€ GLITCH SCANLINES â”€â”€ */
      body::before{
        background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(255,255,255,0.018) 2px,rgba(255,255,255,0.018) 4px)!important;
        pointer-events:none!important;z-index:9999!important;
        animation:picScanGlitch 3s steps(1) infinite!important;
      }

      /* â”€â”€ ANIMATED GRID + SCROLLING BACKGROUND â”€â”€ */
      body::after{
        background-image:
          linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),
          linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px),
          radial-gradient(circle 1px at 50% 50%, rgba(255,255,255,0.15) 0%, transparent 100%)!important;
        background-size:28px 28px,28px 28px,28px 28px!important;
        opacity:1!important;
        animation:picGridScroll 8s linear infinite!important;
      }
      @keyframes picGridScroll{
        0%{background-position:0 0,0 0,14px 14px;}
        100%{background-position:0 28px,0 28px,14px 42px;}
      }

      /* â”€â”€ MASTER GLITCH KEYFRAMES â”€â”€ */
      @keyframes picScanGlitch{
        0%,92%,100%{transform:translateY(0);filter:none;}
        93%{transform:translateY(-3px);filter:invert(0.05);}
        94%{transform:translateY(2px);filter:saturate(0);}
        95%{transform:translateY(-1px);filter:none;}
        96%{transform:translateY(4px);filter:invert(0.08) hue-rotate(180deg);}
        97%{transform:translateY(0);filter:none;}
      }
      @keyframes picChromaticAb{
        0%,88%,100%{text-shadow:none;filter:none;}
        89%{text-shadow:2px 0 0 rgba(255,0,0,0.8),-2px 0 0 rgba(0,0,255,0.8);filter:none;}
        90%{text-shadow:-3px 0 0 rgba(255,0,0,0.9),3px 0 0 rgba(0,255,255,0.9);filter:contrast(1.2);}
        91%{text-shadow:0 2px 0 rgba(0,0,255,0.7),0 -2px 0 rgba(255,0,0,0.7);filter:none;}
        92%{text-shadow:4px 0 0 rgba(255,0,128,0.8),-4px 0 0 rgba(0,255,128,0.8);filter:saturate(3) hue-rotate(90deg);}
        93%{text-shadow:none;filter:invert(1);}
        94%{text-shadow:none;filter:none;}
      }
      @keyframes picBlockGlitch{
        0%,85%,100%{clip-path:none;transform:translate(0);}
        86%{clip-path:inset(30% 0 50% 0);transform:translate(-8px,0);}
        87%{clip-path:inset(60% 0 10% 0);transform:translate(6px,0);}
        88%{clip-path:inset(10% 0 75% 0);transform:translate(-4px,2px);}
        89%{clip-path:inset(45% 0 30% 0);transform:translate(10px,0);}
        90%{clip-path:none;transform:translate(0);}
      }
      @keyframes picColorFlash{
        0%,80%,100%{filter:none;}
        81%{filter:invert(1) hue-rotate(180deg) saturate(5);}
        82%{filter:none;}
        83%{filter:invert(0.5) hue-rotate(90deg) saturate(3);}
        84%{filter:none;}
        90%{filter:invert(1) saturate(0);}
        91%{filter:none;}
      }
      @keyframes picFlicker{
        0%,90%,100%{opacity:1;}
        91%{opacity:0.1;}92%{opacity:1;}93%{opacity:0.6;}94%{opacity:1;}
        95%{opacity:0;}96%{opacity:1;}
      }
      @keyframes picRGBSplit{
        0%,95%,100%{text-shadow:none;}
        96%{text-shadow:2px 0 0 #f00,-2px 0 0 #0ff;}
        97%{text-shadow:-4px 0 0 #f0f,4px 0 0 #0f0;}
        98%{text-shadow:3px 2px 0 #00f,-3px -2px 0 #ff0;}
        99%{text-shadow:-2px 0 0 #f00,2px 0 0 #0ff;}
      }
      @keyframes picHorzSlice{
        0%,93%,100%{transform:skewX(0);}
        94%{transform:skewX(-2deg) translateX(-4px);}
        95%{transform:skewX(2deg) translateX(4px);}
        96%{transform:skewX(0);}
      }
      @keyframes picNoiseShimmer{
        0%,100%{opacity:0.04;}50%{opacity:0.09;}
      }
      @keyframes picVignettePulse{
        0%,100%{box-shadow:inset 0 0 100px rgba(0,0,0,0.9);}
        50%{box-shadow:inset 0 0 140px rgba(0,0,0,0.98);}
      }
      @keyframes picCornerFlicker{
        0%,85%,100%{opacity:0.4;}86%{opacity:0.0;}87%{opacity:0.6;}88%{opacity:0.1;}89%{opacity:0.4;}
      }
      @keyframes picTextWobble{
        0%,100%{transform:skewX(0);}
        95%{transform:skewX(-1.5deg) translateX(-2px);}
        96%{transform:skewX(1deg) translateX(1px);}
        97%{transform:skewX(0);}
      }
      @keyframes picHologramScan{
        0%{top:-10%;}100%{top:110%;}
      }
      @keyframes picStatPop{
        0%,100%{transform:scale(1);filter:none;}
        50%{transform:scale(1.02);filter:brightness(1.3);}
      }
      @keyframes picDeadPixels{
        0%,94%,100%{opacity:0;}
        95%{opacity:1;}96%{opacity:0;}97%{opacity:0.7;}98%{opacity:0;}
      }

      /* â”€â”€ GLOBAL GLITCH OVERLAY LAYERS (injected by applyTheme) â”€â”€ */
      #picayune-blackhole-outer{
        position:fixed;top:0;left:0;width:100%;height:100%;
        pointer-events:none;z-index:1;
        animation:picColorFlash 4s steps(1) infinite;
        mix-blend-mode:difference;
      }
      #picayune-blackhole-mid{
        position:fixed;top:0;left:0;width:100%;height:100%;
        pointer-events:none;z-index:1;
        background:repeating-linear-gradient(90deg,transparent,transparent 7px,rgba(255,255,255,0.015) 7px,rgba(255,255,255,0.015) 8px);
        animation:picHorzSlice 5s steps(1) infinite;
      }
      #picayune-blackhole-inner{
        position:fixed;top:0;left:0;width:30px;height:100%;
        pointer-events:none;z-index:9998;
        background:linear-gradient(90deg,rgba(255,0,0,0.06),transparent 50%,rgba(0,0,255,0.06));
        animation:picBlockGlitch 6s steps(1) infinite;
      }

      /* â”€â”€ VIGNETTE + HOLOGRAM SCAN LINE â”€â”€ */
      #picayune-vignette{
        position:fixed;top:0;left:0;width:100%;height:100%;
        pointer-events:none;z-index:2;
        box-shadow:inset 0 0 120px rgba(0,0,0,0.92);
        animation:picVignettePulse 6s ease-in-out infinite;
      }
      #picayune-hologram{
        position:fixed;left:0;width:100%;height:3px;
        pointer-events:none;z-index:9997;
        background:linear-gradient(90deg,transparent,rgba(255,255,255,0.06),transparent);
        animation:picHologramScan 4s linear infinite;
      }
      #picayune-deadpixels{
        position:fixed;top:0;left:0;width:100%;height:100%;
        pointer-events:none;z-index:9996;
        background-image:
          radial-gradient(circle 1px at 23% 41%, white 0%, transparent 100%),
          radial-gradient(circle 1px at 67% 18%, white 0%, transparent 100%),
          radial-gradient(circle 1px at 81% 72%, white 0%, transparent 100%),
          radial-gradient(circle 2px at 12% 88%, white 0%, transparent 100%),
          radial-gradient(circle 1px at 44% 63%, white 0%, transparent 100%),
          radial-gradient(circle 1px at 90% 35%, white 0%, transparent 100%);
        animation:picDeadPixels 7s steps(1) infinite;
      }

      /* â”€â”€ SKELETON GLITCH â”€â”€ */
      #picayune-skeleton{
        position:fixed;top:0;left:0;width:100%;height:100%;
        pointer-events:none;z-index:3;
        display:flex;align-items:center;justify-content:center;
      }
      #picayune-skeleton svg{
        width:min(55vw,380px);height:auto;
        opacity:0;
        animation:skelAppear 9s steps(1) infinite;
        filter:drop-shadow(0 0 6px rgba(255,255,255,0.5));
      }
      @keyframes skelAppear{
        0%,60%,100%{opacity:0;transform:translate(0,0) scaleX(1);filter:drop-shadow(0 0 6px rgba(255,255,255,0.4));}
        61%{opacity:0.18;transform:translate(0,0) scaleX(1);}
        62%{opacity:0;transform:translate(-6px,0) scaleX(1);}
        63%{opacity:0.22;transform:translate(4px,0) scaleX(1);filter:drop-shadow(2px 0 0 rgba(255,0,0,0.9)) drop-shadow(-2px 0 0 rgba(0,255,255,0.9));}
        64%{opacity:0;transform:translate(0,0) scaleX(1);}
        65%{opacity:0.30;transform:translate(0,0) scaleX(1);filter:drop-shadow(0 0 12px rgba(255,255,255,0.7));}
        66%{opacity:0;transform:translate(0,0) scaleX(-1);}
        67%{opacity:0.28;transform:translate(-3px,2px) scaleX(-1);filter:drop-shadow(3px 0 0 rgba(255,0,128,0.8)) drop-shadow(-3px 0 0 rgba(0,255,128,0.8));}
        68%{opacity:0.08;transform:translate(0,0) scaleX(1);filter:drop-shadow(0 0 4px rgba(255,255,255,0.2));}
        69%{opacity:0;transform:translate(0,0) scaleX(1);}
        70%{opacity:0.35;transform:translate(8px,0) scaleX(1);filter:drop-shadow(0 0 20px rgba(255,255,255,0.5));}
        71%{opacity:0;transform:translate(0,0) scaleX(1);}
        72%{opacity:0.14;transform:translate(-5px,-3px) scaleX(1);filter:drop-shadow(-4px 0 0 rgba(255,0,0,0.7)) drop-shadow(4px 0 0 rgba(0,0,255,0.7));}
        73%{opacity:0;transform:translate(0,0) scaleX(1);}
        74%,100%{opacity:0;}
      }
      @keyframes skelSegGlitch{
        0%,85%,100%{transform:translate(0,0);}
        86%{transform:translate(-4px,0);}87%{transform:translate(6px,1px);}
        88%{transform:translate(-2px,-1px);}89%{transform:translate(0,0);}
      }
      .skel-skull{animation:skelSegGlitch 11s steps(1) infinite;}
      .skel-spine{animation:skelSegGlitch 13s steps(1) infinite 0.4s;}
      .skel-ribs{animation:skelSegGlitch 7s steps(1) infinite 0.8s;}
      .skel-pelvis{animation:skelSegGlitch 17s steps(1) infinite 0.2s;}
      .skel-arms{animation:skelSegGlitch 9s steps(1) infinite 1.1s;}
      .skel-legs{animation:skelSegGlitch 15s steps(1) infinite 0.6s;}

      /* â”€â”€ MAIN APP SCANLINES â”€â”€ */
      #app::before{
        content:'';position:fixed;inset:0;
        background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(255,255,255,0.008) 2px,rgba(255,255,255,0.008) 4px);
        pointer-events:none;z-index:0;
        animation:picScanGlitch 5s steps(1) infinite!important;
      }
      /* noise shimmer overlay */
      #app::after{
        content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
        background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='0.08'/%3E%3C/svg%3E");
        animation:picNoiseShimmer 2s ease-in-out infinite;
      }

      /* â”€â”€ UI ELEMENTS â”€â”€ */
      .ark-title{
        font-family:'VT323',monospace!important;font-size:26px!important;letter-spacing:4px!important;
        color:#ffffff!important;
        animation:picChromaticAb 5s infinite,picBlockGlitch 7s infinite!important;
      }
      .ark-title span{
        color:#ffffff!important;
        text-shadow:2px 0 0 rgba(255,0,0,0.5),-2px 0 0 rgba(0,255,255,0.5)!important;
        animation:picRGBSplit 3s infinite!important;
      }
      .ark-header{border-bottom:1px solid #1c1c1c!important;animation:picFlicker 9s infinite!important;}
      .ark-header::after{background:linear-gradient(90deg,#fff,#444,transparent)!important;height:1px!important;width:100%!important;}

      .ark-section{
        font-family:'VT323',monospace!important;font-size:16px!important;letter-spacing:3px!important;
        color:#cccccc!important;
        animation:picChromaticAb 11s infinite!important;
      }
      .ark-section::after{background:linear-gradient(90deg,#555,transparent)!important;}

      button{
        font-family:'VT323',monospace!important;font-size:17px!important;letter-spacing:2px!important;
        border-color:#1c1c1c!important;background:#070707!important;color:#999999!important;
        clip-path:none!important;
        animation:picTextWobble 12s infinite!important;
        transition:all 0.1s!important;
      }
      button:hover{
        background:#161616!important;border-color:#ffffff!important;color:#ffffff!important;
        box-shadow:0 0 0 1px #fff,inset 0 0 14px rgba(255,255,255,0.05),0 0 20px rgba(255,255,255,0.08)!important;
        animation:picRGBSplit 0.8s infinite,picTextWobble 0s!important;
        filter:brightness(1.2)!important;
      }
      button::before{background:#ffffff!important;}
      button::after{display:none!important;}
      button.correct{
        background:#050505!important;border:2px solid #22ff22!important;color:#22ff22!important;
        text-shadow:0 0 8px rgba(34,255,34,0.9),0 0 16px rgba(34,255,34,0.4)!important;
        box-shadow:inset 0 0 12px rgba(34,255,34,0.08),0 0 12px rgba(34,255,34,0.15)!important;
        animation:picFlicker 3s infinite!important;
      }
      button.correct::before{background:#22ff22!important;opacity:1!important;}
      button.wrong{
        background:#050505!important;border:2px solid #ff2222!important;color:#ff2222!important;
        text-shadow:0 0 8px rgba(255,34,34,0.9),0 0 16px rgba(255,34,34,0.4)!important;
        box-shadow:inset 0 0 12px rgba(255,34,34,0.08),0 0 12px rgba(255,34,34,0.15)!important;
        animation:picChromaticAb 1s infinite!important;
      }
      button.wrong::before{background:#ff2222!important;opacity:1!important;}
      button.played{background:#020202!important;border-color:#0d0d0d!important;color:#2a2a2a!important;opacity:0.45!important;animation:none!important;}
      button:disabled{opacity:0.25!important;animation:none!important;}

      .card{
        font-family:'VT323',monospace!important;font-size:56px!important;letter-spacing:6px!important;
        border:1px solid #1c1c1c!important;border-top:2px solid #fff!important;
        background:#070707!important;clip-path:none!important;
        color:#ffffff!important;
        text-shadow:3px 0 0 rgba(255,0,0,0.3),-3px 0 0 rgba(0,255,255,0.3)!important;
        animation:picChromaticAb 6s infinite,picFlicker 12s infinite,picTextWobble 8s infinite!important;
        position:relative!important;overflow:hidden!important;
      }
      .card::before{content:'âŠ¹ DREAM DATA âŠ¹'!important;color:#2a2a2a!important;
        font-family:'VT323',monospace!important;letter-spacing:2px!important;}
      .card::after{
        content:'';position:absolute;inset:0;
        background:linear-gradient(180deg,rgba(255,255,255,0.03) 0%,transparent 40%,transparent 60%,rgba(255,255,255,0.02) 100%);
        pointer-events:none;
      }

      .xp-bar-wrap{background:#070707!important;border-color:#1c1c1c!important;clip-path:none!important;}
      .xp-bar-fill{background:linear-gradient(90deg,#333,#888,#fff)!important;box-shadow:0 0 6px rgba(255,255,255,0.3)!important;}
      .xp-bar-bg{background:#111!important;border:1px solid #1c1c1c!important;}
      .xp-rank{color:#fff!important;font-family:'VT323',monospace!important;}
      .xp-bar-shine{background:linear-gradient(90deg,transparent,rgba(255,255,255,0.25),transparent)!important;}

      .ark-stat{
        clip-path:none!important;background:#070707!important;
        border:1px solid #1c1c1c!important;
        animation:picFlicker 15s infinite,picStatPop 4s ease-in-out infinite!important;
        position:relative!important;overflow:hidden!important;
      }
      .ark-stat::after{
        content:'';position:absolute;top:0;left:0;right:0;height:1px;
        background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);
        animation:picHologramScan 3s linear infinite;
      }
      .ark-stat-value{
        font-family:'VT323',monospace!important;color:#ffffff!important;font-size:26px!important;
        animation:picRGBSplit 8s infinite!important;
      }
      .ark-stat-label{color:#444!important;}

      .ach-card{
        clip-path:none!important;background:#070707!important;border:1px solid #1c1c1c!important;
        animation:picFlicker 20s infinite!important;
      }
      .ach-card.unlocked{border-color:#666!important;box-shadow:0 0 8px rgba(255,255,255,0.06)!important;}
      .ach-card.unlocked::before{background:linear-gradient(90deg,#333,#fff,#333)!important;}
      .ach-name{font-family:'VT323',monospace!important;font-size:15px!important;color:#fff!important;animation:picRGBSplit 20s infinite!important;}
      .ach-desc{color:#444!important;}
      .ach-reward{color:#888!important;animation:picFlicker 10s infinite!important;}

      .daily-card{background:#070707!important;border-left-color:#444!important;border-color:#1c1c1c!important;}
      .daily-card.done{border-left-color:#22ff22!important;opacity:0.7!important;}
      .daily-title{color:#fff!important;font-family:'VT323',monospace!important;}
      .daily-reward{color:#888!important;font-family:'VT323',monospace!important;}

      .levelup-box{
        background:#050505!important;border:2px solid #fff!important;clip-path:none!important;
        box-shadow:0 0 40px rgba(255,255,255,0.12),inset 0 0 30px rgba(0,0,0,0.8)!important;
        animation:picChromaticAb 1.5s infinite!important;
      }
      .levelup-label{font-family:'VT323',monospace!important;font-size:14px!important;letter-spacing:4px!important;color:#ccc!important;animation:picFlicker 6s infinite!important;}
      .levelup-num{
        font-family:'VT323',monospace!important;color:#ffffff!important;
        text-shadow:none!important;
        animation:picChromaticAb 1s infinite,picBlockGlitch 1.8s infinite!important;
      }
      .levelup-rank{color:#888!important;letter-spacing:3px!important;font-family:'VT323',monospace!important;}

      .combo-display{
        color:#ffffff!important;
        animation:picRGBSplit 1.5s infinite,picFlicker 4s infinite!important;
        text-shadow:3px 0 0 rgba(255,0,0,0.4),-3px 0 0 rgba(0,255,255,0.4)!important;
      }
      .ark-lives{color:#ff2222!important;background:rgba(255,34,34,0.07)!important;border-left-color:#ff2222!important;font-family:'VT323',monospace!important;animation:picFlicker 5s infinite!important;}

      .corner-deco{border-color:rgba(255,255,255,0.2)!important;animation:picCornerFlicker 7s infinite!important;}
      .coin-display{
        font-family:'VT323',monospace!important;color:#fff!important;
        background:rgba(255,255,255,0.03)!important;border-color:rgba(255,255,255,0.15)!important;
        animation:picRGBSplit 12s infinite!important;
      }
      .ach-toast{
        background:#070707!important;border:1px solid #fff!important;border-left:3px solid #fff!important;
        box-shadow:0 0 20px rgba(0,0,0,0.9),0 0 10px rgba(255,255,255,0.05)!important;
        animation:picBlockGlitch 7s infinite!important;
      }
      .ach-toast-title{color:#888!important;font-family:'VT323',monospace!important;}
      .ach-toast-name{color:#fff!important;font-family:'VT323',monospace!important;animation:picRGBSplit 4s infinite!important;}

      input[type=text],input[type=number],textarea{
        font-family:'VT323',monospace!important;border-left-color:#444!important;
        background:#070707!important;color:#eee!important;font-size:18px!important;
        border-color:#1c1c1c!important;
        animation:picTextWobble 18s infinite!important;
        caret-color:#fff!important;
      }
      input:focus,textarea:focus{
        border-color:#fff!important;
        box-shadow:0 0 0 1px rgba(255,255,255,0.15),0 0 10px rgba(255,255,255,0.05)!important;
        animation:picChromaticAb 3s infinite!important;
      }

      .ark-ticker{color:#2a2a2a!important;border-top-color:#111!important;font-family:'VT323',monospace!important;}
      .ark-badge{font-family:'VT323',monospace!important;color:#888!important;border-color:#333!important;background:rgba(255,255,255,0.03)!important;animation:picFlicker 8s infinite!important;}
      .ark-progress-fill{background:linear-gradient(90deg,#333,#fff)!important;box-shadow:0 0 4px rgba(255,255,255,0.3)!important;}
      .ark-progress{background:#111!important;}

      .adv-story-box{background:#070707!important;border-color:#1c1c1c!important;border-left-color:#555!important;}
      .adv-map-icon{background:#070707!important;border-color:#1c1c1c!important;}
      .adv-map-icon.current{border-color:#fff!important;box-shadow:0 0 14px rgba(255,255,255,0.4)!important;animation:picFlicker 2s infinite!important;}
      .adv-combat-log{background:#030303!important;border-color:#1c1c1c!important;border-left-color:#444!important;color:#555!important;}
    `
  }
];
const FONT_ITEMS=[
  {id:"default",   name:"Default",        price:0,   auto:true, family:"'Barlow Condensed','Arial Narrow',Arial,sans-serif"},
  {id:"mono",      name:"Terminal Mono",  price:300, family:"'Share Tech Mono','Courier New',monospace"},
  {id:"rajdhani",  name:"Rajdhani",       price:300, family:"'Rajdhani','Arial Narrow',Arial,sans-serif"},
  {id:"serif",     name:"Warrior Serif",  price:400, family:"'Georgia','Times New Roman',serif"},
  {id:"narrow",    name:"Ultra Narrow",   price:200, family:"'Arial Narrow',Arial,sans-serif"},
];

/* â”€â”€ APPLY ACTIVE THEME â”€â”€ */
function applyTheme(){
  let themeId=shopData.activeUI||"arknight";
  let theme=UI_THEMES.find(t=>t.id===themeId)||UI_THEMES[0];
  let css=theme.css||"";
  // Extract @import and inject as <link> tags (more reliable than inline @import)
  let importRe=/@import url\('([^']+)'\)[^;]*;/g;
  let match;
  document.querySelectorAll("link[data-theme-font]").forEach(l=>l.remove());
  while((match=importRe.exec(css))!==null){
    let href=match[1];
    if(!document.querySelector(`link[href="${href}"]`)){
      let link=document.createElement("link");
      link.rel="stylesheet";link.href=href;
      link.setAttribute("data-theme-font","1");
      document.head.appendChild(link);
    }
  }
  let cleanCss=css.replace(/@import url\('[^']+'\)[^;]*;\s*/g,"");
  let existingStyle=document.getElementById("shop-theme-style");
  if(!existingStyle){existingStyle=document.createElement("style");existingStyle.id="shop-theme-style";document.head.appendChild(existingStyle);}
  existingStyle.textContent=cleanCss;
  // Fonts bundled in theme â€” clear legacy font override
  let bodyFontStyle=document.getElementById("shop-font-style");
  if(bodyFontStyle)bodyFontStyle.textContent="";
  // Inject / remove picayune blackhole divs + special overlays
  ["picayune-blackhole-outer","picayune-blackhole-mid","picayune-blackhole-inner","picayune-vignette","picayune-hologram","picayune-deadpixels","picayune-skeleton"].forEach(id=>{let el=document.getElementById(id);if(el)el.remove();});
  if(themeId==="picayune"){
    ["outer","mid","inner"].forEach(k=>{
      let d=document.createElement("div");d.id="picayune-blackhole-"+k;document.body.appendChild(d);
    });
    // Vignette overlay
    let vig=document.createElement("div");vig.id="picayune-vignette";document.body.appendChild(vig);
    // Hologram scan line
    let holo=document.createElement("div");holo.id="picayune-hologram";document.body.appendChild(holo);
    // Dead pixels
    let dp=document.createElement("div");dp.id="picayune-deadpixels";document.body.appendChild(dp);
    // Skeleton glitch figure
    let sk=document.createElement("div");sk.id="picayune-skeleton";
    sk.innerHTML=`<svg viewBox="0 0 200 400" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="rgba(255,255,255,0.85)" stroke-linecap="round" stroke-linejoin="round">
      <!-- SKULL -->
      <g class="skel-skull">
        <!-- cranium -->
        <ellipse cx="100" cy="38" rx="28" ry="30" stroke-width="2.5"/>
        <!-- eye sockets -->
        <ellipse cx="89" cy="34" rx="8" ry="9" stroke-width="2" fill="rgba(0,0,0,0.6)"/>
        <ellipse cx="111" cy="34" rx="8" ry="9" stroke-width="2" fill="rgba(0,0,0,0.6)"/>
        <!-- nose cavity -->
        <path d="M97 47 L100 44 L103 47 L101 51 L99 51 Z" stroke-width="1.5" fill="rgba(0,0,0,0.4)"/>
        <!-- teeth -->
        <path d="M88 57 L88 63" stroke-width="2"/>
        <path d="M93 56 L93 64" stroke-width="2.5"/>
        <path d="M100 56 L100 65" stroke-width="2.5"/>
        <path d="M107 56 L107 64" stroke-width="2.5"/>
        <path d="M112 57 L112 63" stroke-width="2"/>
        <!-- jaw outline -->
        <path d="M84 55 Q88 68 100 68 Q112 68 116 55" stroke-width="2"/>
        <!-- temporal cracks -->
        <path d="M72 28 L80 36" stroke-width="1" stroke-dasharray="2 2" opacity="0.5"/>
        <path d="M128 28 L120 36" stroke-width="1" stroke-dasharray="2 2" opacity="0.5"/>
      </g>
      <!-- NECK -->
      <g class="skel-spine">
        <rect x="93" y="68" width="14" height="8" rx="2" stroke-width="1.8"/>
        <rect x="93" y="77" width="14" height="8" rx="2" stroke-width="1.8"/>
      </g>
      <!-- CLAVICLES -->
      <g class="skel-ribs">
        <path d="M100 85 Q70 82 55 90" stroke-width="2.2"/>
        <path d="M100 85 Q130 82 145 90" stroke-width="2.2"/>
        <!-- sternum -->
        <rect x="93.5" y="85" width="13" height="70" rx="2" stroke-width="2"/>
        <!-- ribs left -->
        <path d="M94 95 Q70 93 62 103 Q60 112 94 108" stroke-width="1.8"/>
        <path d="M94 108 Q68 106 60 117 Q58 127 94 122" stroke-width="1.8"/>
        <path d="M94 122 Q68 120 62 131 Q60 141 94 136" stroke-width="1.8"/>
        <path d="M94 136 Q70 134 64 144 Q63 153 94 150" stroke-width="1.8"/>
        <!-- ribs right -->
        <path d="M106 95 Q130 93 138 103 Q140 112 106 108" stroke-width="1.8"/>
        <path d="M106 108 Q132 106 140 117 Q142 127 106 122" stroke-width="1.8"/>
        <path d="M106 122 Q132 120 138 131 Q140 141 106 136" stroke-width="1.8"/>
        <path d="M106 136 Q130 134 136 144 Q137 153 106 150" stroke-width="1.8"/>
      </g>
      <!-- SPINE VERTEBRAE -->
      <g class="skel-spine">
        <rect x="93" y="85" width="14" height="8" rx="2" stroke-width="1.5" opacity="0.6"/>
        <rect x="93" y="97" width="14" height="8" rx="2" stroke-width="1.5" opacity="0.6"/>
        <rect x="93" y="109" width="14" height="8" rx="2" stroke-width="1.5" opacity="0.6"/>
        <rect x="93" y="121" width="14" height="8" rx="2" stroke-width="1.5" opacity="0.6"/>
        <rect x="93" y="133" width="14" height="8" rx="2" stroke-width="1.5" opacity="0.6"/>
        <rect x="93" y="145" width="14" height="8" rx="2" stroke-width="1.5" opacity="0.6"/>
      </g>
      <!-- PELVIS -->
      <g class="skel-pelvis">
        <path d="M68 162 Q64 180 72 194 Q84 205 100 202 Q116 205 128 194 Q136 180 132 162 Z" stroke-width="2.2"/>
        <ellipse cx="82" cy="184" rx="10" ry="13" stroke-width="1.8" fill="rgba(0,0,0,0.3)"/>
        <ellipse cx="118" cy="184" rx="10" ry="13" stroke-width="1.8" fill="rgba(0,0,0,0.3)"/>
        <path d="M90 162 L90 200" stroke-width="1.5" opacity="0.5"/>
        <path d="M110 162 L110 200" stroke-width="1.5" opacity="0.5"/>
      </g>
      <!-- LEFT ARM -->
      <g class="skel-arms">
        <!-- upper arm -->
        <path d="M55 90 Q40 110 36 130" stroke-width="3"/>
        <!-- elbow joint -->
        <circle cx="36" cy="132" r="4" stroke-width="2"/>
        <!-- forearm -->
        <path d="M36 136 Q30 156 28 178" stroke-width="2.5"/>
        <!-- wrist -->
        <ellipse cx="28" cy="180" rx="5" ry="3" stroke-width="1.8"/>
        <!-- hand / fingers -->
        <path d="M23 180 L18 172" stroke-width="1.5"/>
        <path d="M25 178 L21 169" stroke-width="1.5"/>
        <path d="M28 177 L26 167" stroke-width="1.5"/>
        <path d="M31 178 L31 168" stroke-width="1.5"/>
        <path d="M33 180 L35 171" stroke-width="1.5"/>
        <!-- knuckles -->
        <circle cx="18" cy="172" r="1.5" stroke-width="1.2"/>
        <circle cx="21" cy="169" r="1.5" stroke-width="1.2"/>
        <circle cx="26" cy="167" r="1.5" stroke-width="1.2"/>
        <circle cx="31" cy="168" r="1.5" stroke-width="1.2"/>
        <circle cx="35" cy="171" r="1.5" stroke-width="1.2"/>
      </g>
      <!-- RIGHT ARM -->
      <g class="skel-arms">
        <!-- upper arm -->
        <path d="M145 90 Q160 110 164 130" stroke-width="3"/>
        <!-- elbow joint -->
        <circle cx="164" cy="132" r="4" stroke-width="2"/>
        <!-- forearm -->
        <path d="M164 136 Q170 156 172 178" stroke-width="2.5"/>
        <!-- wrist -->
        <ellipse cx="172" cy="180" rx="5" ry="3" stroke-width="1.8"/>
        <!-- hand / fingers -->
        <path d="M177 180 L182 172" stroke-width="1.5"/>
        <path d="M175 178 L179 169" stroke-width="1.5"/>
        <path d="M172 177 L174 167" stroke-width="1.5"/>
        <path d="M169 178 L169 168" stroke-width="1.5"/>
        <path d="M167 180 L165 171" stroke-width="1.5"/>
        <!-- knuckles -->
        <circle cx="182" cy="172" r="1.5" stroke-width="1.2"/>
        <circle cx="179" cy="169" r="1.5" stroke-width="1.2"/>
        <circle cx="174" cy="167" r="1.5" stroke-width="1.2"/>
        <circle cx="169" cy="168" r="1.5" stroke-width="1.2"/>
        <circle cx="165" cy="171" r="1.5" stroke-width="1.2"/>
      </g>
      <!-- LEFT LEG -->
      <g class="skel-legs">
        <!-- hip socket -->
        <circle cx="82" cy="205" r="7" stroke-width="2"/>
        <!-- femur -->
        <path d="M82 212 Q78 242 80 272" stroke-width="3"/>
        <!-- knee -->
        <ellipse cx="80" cy="274" rx="8" ry="6" stroke-width="2.2"/>
        <!-- tibia/fibula -->
        <path d="M77 280 Q74 310 74 340" stroke-width="2.5"/>
        <path d="M83 280 Q83 310 82 340" stroke-width="1.5" opacity="0.6"/>
        <!-- ankle -->
        <ellipse cx="77" cy="342" rx="7" ry="4" stroke-width="2"/>
        <!-- foot -->
        <path d="M70 342 Q60 345 54 350 Q52 355 70 356 L84 356 Q84 350 80 346" stroke-width="2"/>
        <path d="M54 350 L52 360" stroke-width="1.5"/>
        <path d="M60 348 L58 360" stroke-width="1.5"/>
        <path d="M67 347 L66 360" stroke-width="1.5"/>
        <path d="M74 347 L74 358" stroke-width="1.5"/>
        <path d="M80 348 L81 358" stroke-width="1.5"/>
      </g>
      <!-- RIGHT LEG -->
      <g class="skel-legs">
        <!-- hip socket -->
        <circle cx="118" cy="205" r="7" stroke-width="2"/>
        <!-- femur -->
        <path d="M118 212 Q122 242 120 272" stroke-width="3"/>
        <!-- knee -->
        <ellipse cx="120" cy="274" rx="8" ry="6" stroke-width="2.2"/>
        <!-- tibia/fibula -->
        <path d="M123 280 Q126 310 126 340" stroke-width="2.5"/>
        <path d="M117 280 Q117 310 118 340" stroke-width="1.5" opacity="0.6"/>
        <!-- ankle -->
        <ellipse cx="123" cy="342" rx="7" ry="4" stroke-width="2"/>
        <!-- foot -->
        <path d="M130 342 Q140 345 146 350 Q148 355 130 356 L116 356 Q116 350 120 346" stroke-width="2"/>
        <path d="M146 350 L148 360" stroke-width="1.5"/>
        <path d="M140 348 L142 360" stroke-width="1.5"/>
        <path d="M133 347 L134 360" stroke-width="1.5"/>
        <path d="M126 347 L126 358" stroke-width="1.5"/>
        <path d="M120 348 L119 358" stroke-width="1.5"/>
      </g>
    </svg>`;
    document.body.appendChild(sk);
  }
}

/* â”€â”€ RENDER SHOP â”€â”€ */
/* Per-theme shop card renderers */
const THEME_CARD_RENDERS={
  arknight:(item,owned,isActive,action)=>{
    let p=item.preview;
    return `<div class="shop-item${owned?' owned':''}${isActive?' active-ui':''}" ${action} style="background:#10141c;border-color:${isActive?'#3a9a5c':owned?'#8a6020':'#2a3344'};">
      <div style="height:58px;background:${p.bg};border:1px solid ${p.border};display:flex;flex-direction:column;align-items:flex-start;justify-content:flex-end;padding:6px 8px;margin-bottom:8px;position:relative;overflow:hidden;">
        <div style="position:absolute;top:0;left:0;right:0;height:2px;background:${p.accent};opacity:0.8;"></div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:${p.accent};letter-spacing:2px;">${p.label}</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:7px;color:${p.text};opacity:0.6;letter-spacing:1px;">RHODES ISLAND OPS</div>
      </div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;color:#f0ebe0;letter-spacing:1px;">${item.name}</div>
      ${_shopBadge(isActive,owned,item.price,'#e8a838','#8a6020','#f0c060','#7a6020')}
    </div>`;
  },
  dmc:(item,owned,isActive,action)=>{
    let p=item.preview;
    return `<div class="shop-item${owned?' owned':''}${isActive?' active-ui':''}" ${action} style="background:#1a0005;border-color:${isActive?'#00cc44':owned?'#6a000a':'#4a0010'};clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);">
      <div style="height:58px;background:#0d0003;border:1px solid #4a0010;display:flex;align-items:center;justify-content:center;margin-bottom:8px;position:relative;overflow:hidden;">
        <div style="font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:900;color:#e30018;letter-spacing:4px;text-transform:uppercase;text-shadow:0 0 20px rgba(227,0,24,0.8);">STYLISH!!</div>
        <div style="position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,#e30018,transparent);"></div>
      </div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:900;color:#ff4444;letter-spacing:3px;text-transform:uppercase;">${item.name}</div>
      ${_shopBadge(isActive,owned,item.price,'#e30018','#6a000a','#e30018','#6a000a')}
    </div>`;
  },
  bnw:(item,owned,isActive,action)=>{
    return `<div class="shop-item${owned?' owned':''}${isActive?' active-ui':''}" ${action} style="background:#111;border-color:${isActive?'#fff':owned?'#555':'#333'};">
      <div style="height:58px;background:#050505;border:1px solid #333;display:flex;align-items:center;justify-content:center;margin-bottom:8px;position:relative;">
        <div style="width:40px;height:40px;border:2px solid #eee;border-radius:50%;display:flex;align-items:center;justify-content:center;">
          <div style="width:16px;height:16px;background:#eee;border-radius:50%;"></div>
        </div>
        <div style="position:absolute;top:6px;right:8px;font-family:'Courier New',monospace;font-size:7px;color:#555;letter-spacing:1px;">MONO</div>
      </div>
      <div style="font-family:'Arial Narrow',Arial,sans-serif;font-size:14px;font-weight:700;color:#fff;letter-spacing:4px;text-transform:uppercase;">${item.name}</div>
      ${_shopBadge(isActive,owned,item.price,'#ffffff','#555','#eeeeee','#444')}
    </div>`;
  },
  rpg:(item,owned,isActive,action)=>{
    return `<div class="shop-item${owned?' owned':''}${isActive?' active-ui':''}" ${action} style="background:#1a1200;border-color:${isActive?'#d4a017':owned?'#7a5c00':'#3a2800'};">
      <div style="height:58px;background:#110c00;border:1px solid #3a2800;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:8px;position:relative;">
        <div style="font-size:22px;">ðŸ“œ</div>
        <div style="font-family:'Georgia',serif;font-size:10px;color:#d4a017;line-height:1.4;text-align:center;">Quest<br>Journal</div>
        <div style="position:absolute;top:4px;left:8px;font-family:'Georgia',serif;font-size:7px;color:#7a5c00;">â– â”€ â”€ â–</div>
        <div style="position:absolute;bottom:4px;right:8px;font-family:'Georgia',serif;font-size:7px;color:#7a5c00;">â– â”€ â”€ â–</div>
      </div>
      <div style="font-family:'Georgia',serif;font-size:13px;color:#f0e8c8;letter-spacing:1px;">âœ¦ ${item.name}</div>
      ${_shopBadge(isActive,owned,item.price,'#d4a017','#7a5c00','#f0c040','#7a5c00')}
    </div>`;
  },
  csm:(item,owned,isActive,action)=>{
    return `<div class="shop-item${owned?' owned':''}${isActive?' active-ui':''}" ${action} style="background:#fff;border:2px solid #000;box-shadow:${isActive?'0 0 0 2px #cc0000,4px 4px 0 #cc0000':'4px 4px 0 #000'};clip-path:none;border-radius:0;">
      <div style="height:62px;background:radial-gradient(circle,rgba(0,0,0,0.06) 1px,transparent 1px);background-size:5px 5px;background-color:#f8f8f8;border:1px solid #000;display:flex;align-items:center;justify-content:center;margin-bottom:8px;position:relative;overflow:hidden;">
        <div style="font-family:'Bangers',cursive;font-size:22px;color:#000;letter-spacing:3px;-webkit-text-stroke:0.5px #000;">â˜… MANGA â˜…</div>
        <div style="position:absolute;top:4px;left:6px;font-family:'Comic Neue',cursive;font-size:7px;color:#666;font-style:italic;">vol.1</div>
        ${isActive?'<div style="position:absolute;top:4px;right:6px;font-family:\'Bangers\',cursive;font-size:10px;color:#cc0000;letter-spacing:1px;">èª­ã‚€!</div>':''}
        <div style="position:absolute;bottom:0;left:0;right:0;height:2px;background:#000;"></div>
      </div>
      <div style="font-family:'Bangers',cursive;font-size:14px;color:#000;letter-spacing:1px;">${item.name}</div>
      ${_shopBadge(isActive,owned,item.price,'#cc0000','#cc0000','#000000','#000000')}
    </div>`;
  },
  cyberpunk:(item,owned,isActive,action)=>{
    return `<div class="shop-item${owned?' owned':''}${isActive?' active-ui':''}" ${action} style="background:#080820;border-color:${isActive?'#00ff88':owned?'#006666':'#0a2040'};">
      <div style="height:58px;background:#030308;border:1px solid #0a2040;display:flex;align-items:center;justify-content:center;margin-bottom:8px;position:relative;overflow:hidden;">
        <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:#00ffff;letter-spacing:3px;text-shadow:0 0 12px rgba(0,255,255,0.9);">â–¶ NETRUNNER</div>
        <div style="position:absolute;top:4px;left:0;right:0;height:1px;background:rgba(0,255,255,0.3);"></div>
        <div style="position:absolute;bottom:4px;left:0;right:0;height:1px;background:rgba(0,255,255,0.15);"></div>
        <div style="position:absolute;top:0;right:14px;width:1px;height:100%;background:rgba(0,255,255,0.15);"></div>
      </div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:12px;color:#80ffff;letter-spacing:2px;">${item.name}</div>
      ${_shopBadge(isActive,owned,item.price,'#00ffff','#006666','#80ffff','#006666')}
    </div>`;
  },
  hacker:(item,owned,isActive,action)=>{
    return `<div class="shop-item${owned?' owned':''}${isActive?' active-ui':''}" ${action} style="background:#001000;border-color:${isActive?'#00ff41':owned?'#005500':'#003300'};">
      <div style="height:58px;background:#000300;border:1px solid #003300;display:flex;align-items:flex-start;justify-content:flex-start;padding:4px 8px;margin-bottom:8px;overflow:hidden;">
        <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#00ff41;line-height:1.6;opacity:0.9;">
          <div>&gt; ./kotoba.sh</div>
          <div style="color:#005500;">&gt; loading vocab...</div>
          <div style="color:#00ff41;">&gt; <span style="animation:pulse 1s infinite;">_</span></div>
        </div>
      </div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:#88ff88;letter-spacing:1px;">$ ${item.name}</div>
      ${_shopBadge(isActive,owned,item.price,'#00ff41','#005500','#66ff88','#005500')}
    </div>`;
  },
  ultrakill:(item,owned,isActive,action)=>{
    return `<div class="shop-item${owned?' owned':''}${isActive?' active-ui':''}" ${action} style="background:linear-gradient(135deg,#fff8fb,#ffeef5);border:1px solid ${isActive?'#e0607e':owned?'#e0607e':'#f4a0c0'};border-radius:12px;box-shadow:${isActive?'0 4px 20px rgba(224,96,126,0.4)':'0 2px 10px rgba(224,96,126,0.15)'};clip-path:none;">
      <div style="height:62px;background:linear-gradient(135deg,#ffdde8,#fff0f8);border:1px solid #f4a0c0;border-radius:8px;display:flex;align-items:center;justify-content:center;margin-bottom:8px;position:relative;overflow:hidden;">
        <div style="font-size:28px;line-height:1;">ðŸŒ¸</div>
        <div style="position:absolute;top:4px;left:0;right:0;text-align:center;font-family:'M PLUS Rounded 1c',sans-serif;font-size:8px;color:rgba(224,96,126,0.6);letter-spacing:2px;">ã•ãã‚‰</div>
        <div style="position:absolute;bottom:4px;left:6px;font-size:10px;opacity:0.4;">ðŸŒ¸</div>
        <div style="position:absolute;bottom:4px;right:6px;font-size:10px;opacity:0.4;">ðŸŒ¸</div>
        ${isActive?'<div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#f4a0c0,#e0607e,#f4a0c0);border-radius:8px 8px 0 0;"></div>':''}
      </div>
      <div style="font-family:'M PLUS Rounded 1c',sans-serif;font-size:13px;color:#5a2040;letter-spacing:1px;">${item.name}</div>
      ${_shopBadge(isActive,owned,item.price,'#e0607e','#f4a0c0','#c04060','#f4a0c0')}
    </div>`;
  },
  void:(item,owned,isActive,action)=>{
    return `<div class="shop-item${owned?' owned':''}${isActive?' active-ui':''}" ${action} style="background:#0e0020;border-color:${isActive?'#44ffcc':owned?'#440088':'#2a0060'};">
      <div style="height:58px;background:#04000a;border:1px solid #2a0060;display:flex;align-items:center;justify-content:center;margin-bottom:8px;position:relative;overflow:hidden;">
        <div style="width:30px;height:30px;border-radius:50%;background:radial-gradient(circle,#9900ff,transparent);box-shadow:0 0 20px rgba(153,0,255,0.8);"></div>
        <div style="position:absolute;font-family:'Rajdhani',sans-serif;font-size:8px;color:rgba(153,0,255,0.7);letter-spacing:4px;top:6px;text-align:center;width:100%;">â—‰ VOID PROTOCOL</div>
        <div style="position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,#9900ff,transparent);"></div>
      </div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;color:#cc66ff;letter-spacing:2px;">${item.name}</div>
      ${_shopBadge(isActive,owned,item.price,'#9900ff','#440088','#cc66ff','#440088')}
    </div>`;
  },
  metaphor:(item,owned,isActive,action)=>{
    return `<div class="shop-item${owned?' owned':''}${isActive?' active-ui':''}" ${action} style="background:#121228;border-color:${isActive?'#44aa66':owned?'#705820':'#2a2a44'};">
      <div style="height:58px;background:#08081a;border-top:2px solid #c8b050;border-bottom:2px solid #c8b050;border-left:1px solid #2a2a44;border-right:1px solid #2a2a44;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:8px;">
        <div style="font-family:'Georgia',serif;font-size:10px;color:#c8b050;letter-spacing:3px;text-align:center;">â—† THE<br>ARCHETYPAL</div>
      </div>
      <div style="font-family:'Georgia',serif;font-size:13px;color:#e0d8c0;letter-spacing:2px;">â—† ${item.name}</div>
      ${_shopBadge(isActive,owned,item.price,'#c8b050','#705820','#e0cc80','#705820')}
    </div>`;
  },
  picayune:(item,owned,isActive,action)=>{
    return `<div class="shop-item${owned?' owned':''}${isActive?' active-ui':''}" ${action} style="background:#0a0a0a;border:1px solid ${isActive?'#fff':owned?'#555':'#222'};box-shadow:${isActive?'0 0 14px rgba(255,255,255,0.2)':owned?'0 0 6px rgba(100,100,100,0.2)':'none'};position:relative;overflow:hidden;clip-path:none;">
      <div style="height:62px;background:#000;border:1px solid #222;display:flex;align-items:center;justify-content:center;margin-bottom:8px;position:relative;overflow:hidden;">
        <div style="font-family:'VT323',monospace;font-size:26px;color:#ffffff;letter-spacing:3px;text-shadow:2px 0 0 rgba(255,0,0,0.5),-2px 0 0 rgba(0,255,255,0.5);animation:picChromaticAb 3s infinite;">âŠ¹ DREAM âŠ¹</div>
        <div style="position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,#fff,transparent);"></div>
        <div style="position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,#444,transparent);"></div>
        <div style="position:absolute;top:4px;left:6px;font-family:'VT323',monospace;font-size:9px;color:rgba(255,255,255,0.25);letter-spacing:2px;">ERR_404</div>
      </div>
      <div style="font-family:'VT323',monospace;font-size:16px;color:#ccc;letter-spacing:2px;">${item.name}</div>
      ${_shopBadge(isActive,owned,item.price,'#ffffff','#555','#eeeeee','#333')}
    </div>`;
  },
};

function _shopBadge(isActive,owned,price,activeC,activeBorder,ownedC,ownedBorder){
  if(isActive)return `<div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:${activeC};border:1px solid ${activeBorder};padding:2px 5px;letter-spacing:2px;margin-top:4px;display:inline-block;">â—ˆ ACTIVE</div>`;
  if(owned)return `<div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:${ownedC};border:1px solid ${ownedBorder};padding:2px 5px;letter-spacing:2px;margin-top:4px;display:inline-block;">OWNED</div>`;
  return `<div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#f0c060;border:1px solid #7a6020;padding:2px 5px;letter-spacing:2px;margin-top:4px;display:inline-block;">ðŸª™ ${price}</div>`;
}

/* â”€â”€ FONT PRELOADER â”€â”€ */
const THEME_FONTS={
  arknight:"https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Barlow+Condensed:wght@400;600;700&family=Share+Tech+Mono&display=swap",
  dmc:"https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700;900&family=Share+Tech+Mono&display=swap",
  bnw:"https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap",
  rpg:"https://fonts.googleapis.com/css2?family=MedievalSharp&family=IM+Fell+English:ital@0;1&display=swap",
  csm:"https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:ital,wght@0,400;0,700;1,400&family=Share+Tech+Mono&display=swap",
  cyberpunk:"https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&family=Share+Tech+Mono&display=swap",
  hacker:"https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap",
  ultrakill:"https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=M+PLUS+Rounded+1c:wght@400;700&family=Share+Tech+Mono&display=swap",
  picayune:"https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap",
  void:"https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=Share+Tech+Mono&display=swap",
  metaphor:"https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Cinzel:wght@400;700&family=Share+Tech+Mono&display=swap",
};
function preloadShopFont(themeId){
  let href=THEME_FONTS[themeId];if(!href)return;
  if(!document.querySelector(`link[href="${href}"]`)){
    let l=document.createElement("link");l.rel="stylesheet";l.href=href;
    l.setAttribute("data-shop-font","1");document.head.appendChild(l);
  }
}

/* â”€â”€ PER-THEME SHOP RENDERERS â”€â”€ */
/* Each theme builds its own full HTML layout from scratch */
const SHOP_RENDERS={

  /* â”€ ARKNIGHTS: military ops panel â”€ */
  arknight:(coins,itemsHtml,tabBar="")=>`
    <div style="max-width:680px;margin:0 auto;padding:20px 16px 60px;font-family:'Barlow Condensed','Arial Narrow',sans-serif;">
      <div style="display:flex;align-items:center;gap:10px;padding:14px 0 18px;border-bottom:1px solid #2a3344;margin-bottom:4px;position:relative;">
        <button class="back" data-action="renderMenu" style="width:auto;padding:6px 14px;margin:0 10px 0 0;background:transparent;color:#6e7a8a;border:1px solid #2a3344;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;">â—„ BACK</button>
        <div>
          <div style="font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;letter-spacing:3px;color:#f0ebe0;text-transform:uppercase;">OPERATOR <span style="color:#e8a838;">SHOP</span></div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#6e7a8a;letter-spacing:2px;margin-top:1px;">RHODES ISLAND Â· PROCUREMENT DIVISION</div>
        </div>
        <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
          <button onclick="openAdminPanel()" style="width:auto;margin:0;padding:4px 10px;border:1px solid #3a3a5c;background:rgba(80,50,120,0.2);color:#9c55d0;font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;cursor:pointer;">ADMIN</button>
          <div style="font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;color:#f0c060;background:rgba(240,192,96,0.08);border:1px solid rgba(240,192,96,0.25);padding:5px 12px;letter-spacing:2px;">ðŸª™ ${coins}</div>
        </div>
        <div style="position:absolute;bottom:-1px;left:0;width:80px;height:2px;background:#e8a838;"></div>
      </div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#6e7a8a;letter-spacing:2px;padding:10px 0 14px;border-bottom:1px solid #1c2333;margin-bottom:16px;">[ DEPLOYMENT SKINS ] Â· COINS FROM XP Â· TAP TO EQUIP OR PURCHASE</div>
      ${tabBar}<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:16px;">${itemsHtml}</div>
    </div>`,

  /* â”€ DMC: stylish slash-cut action menu â”€ */
  dmc:(coins,itemsHtml,tabBar="")=>`
    <div style="max-width:680px;margin:0 auto;padding:24px 16px 60px;font-family:'Rajdhani',sans-serif;background:linear-gradient(180deg,#0d0003 0%,#1a0005 100%);min-height:100vh;">
      <div style="position:relative;margin-bottom:24px;">
        <div style="position:absolute;inset:0;background:radial-gradient(ellipse 80% 40% at 50% 100%,rgba(180,0,20,0.2),transparent);pointer-events:none;"></div>
        <div style="display:flex;align-items:flex-start;gap:14px;padding-bottom:16px;border-bottom:1px solid #4a0010;position:relative;">
          <button class="back" data-action="renderMenu" style="width:auto;padding:8px 16px;margin:0 8px 0 0;background:#1a0005;color:#f0d0d0;border:1px solid #4a0010;font-family:'Bebas Neue','Rajdhani',sans-serif;font-size:13px;letter-spacing:4px;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px));">â—„ BACK</button>
          <div style="flex:1;">
            <div style="font-family:'Bebas Neue','Rajdhani',sans-serif;font-size:32px;letter-spacing:8px;text-transform:uppercase;color:#ffe0e0;text-shadow:0 0 24px rgba(227,0,24,0.6);line-height:1;">STYLE SHOP</div>
            <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:#805060;letter-spacing:3px;margin-top:2px;">DEVIL MAY CRY Â· DANTE'S CLOSET Â· UNLOCK THE LOOK</div>
            <div style="width:100%;height:1px;background:linear-gradient(90deg,#e30018,transparent);margin-top:10px;"></div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
            <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;color:#ff4444;background:rgba(227,0,24,0.08);border:1px solid rgba(227,0,24,0.3);padding:5px 14px;letter-spacing:3px;clip-path:polygon(0 0,calc(100% - 6px) 0,100% 6px,100% 100%,0 100%);">ðŸª™ ${coins}</div>
            <button onclick="openAdminPanel()" style="width:auto;margin:0;padding:4px 10px;border:1px solid #6a000a;background:rgba(80,0,20,0.5);color:#ff4444;font-family:'Bebas Neue',sans-serif;font-size:12px;letter-spacing:3px;cursor:pointer;">ADMIN</button>
          </div>
        </div>
      </div>
      ${tabBar}<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">${itemsHtml}</div>
    </div>`,

  /* â”€ B&W: brutalist minimal gallery â”€ */
  bnw:(coins,itemsHtml,tabBar="")=>`
    <div style="max-width:680px;margin:0 auto;padding:32px 20px 60px;font-family:'Arial Narrow',Arial,sans-serif;background:#000;min-height:100vh;">
      <div style="border-top:4px solid #fff;border-bottom:1px solid #333;padding:20px 0 16px;margin-bottom:24px;display:flex;align-items:center;gap:16px;">
        <button class="back" data-action="renderMenu" style="width:auto;margin:0;padding:8px 14px;background:#000;color:#fff;border:2px solid #fff;font-family:'Arial Narrow',Arial,sans-serif;font-size:11px;font-weight:700;letter-spacing:4px;text-transform:uppercase;cursor:pointer;">â† BACK</button>
        <div style="flex:1;">
          <div style="font-family:'Arial Narrow',Arial,sans-serif;font-size:28px;font-weight:700;letter-spacing:8px;text-transform:uppercase;color:#fff;">THE SHOP</div>
          <div style="font-family:'Courier New',monospace;font-size:9px;color:#555;letter-spacing:3px;margin-top:3px;">MONOCHROME Â· MINIMALIST Â· FUNCTIONAL</div>
        </div>
        <div style="text-align:right;">
          <div style="font-family:'Courier New',monospace;font-size:15px;color:#fff;border:1px solid #555;padding:6px 14px;letter-spacing:2px;background:#111;">ðŸª™ ${coins}</div>
          <button onclick="openAdminPanel()" style="display:block;width:100%;margin:4px 0 0;padding:4px 10px;border:1px solid #444;background:transparent;color:#888;font-family:'Courier New',monospace;font-size:8px;letter-spacing:2px;cursor:pointer;text-transform:uppercase;">ADMIN</button>
        </div>
      </div>
      <div style="font-family:'Courier New',monospace;font-size:8px;color:#444;letter-spacing:3px;margin-bottom:20px;text-transform:uppercase;">â€” AVAILABLE SKINS â€” SELECT TO PURCHASE OR ACTIVATE â€”</div>
      ${tabBar}<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">${itemsHtml}</div>
    </div>`,

  /* â”€ RPG: ancient scroll / quest board â”€ */
  rpg:(coins,itemsHtml,tabBar="")=>`
    <div style="max-width:680px;margin:0 auto;padding:24px 16px 60px;font-family:'IM Fell English','Georgia',serif;background:linear-gradient(180deg,#0a0800,#1a1200);min-height:100vh;">
      <div style="border:2px solid #3a2800;border-top:3px solid #7a5c00;padding:20px 18px 16px;margin-bottom:20px;background:linear-gradient(180deg,#110c00,#0a0800);position:relative;">
        <div style="position:absolute;top:-1px;left:20px;right:20px;height:1px;background:linear-gradient(90deg,transparent,#d4a017,transparent);"></div>
        <div style="position:absolute;top:6px;left:10px;color:#7a5c00;font-size:10px;">â–</div>
        <div style="position:absolute;top:6px;right:10px;color:#7a5c00;font-size:10px;">â–</div>
        <div style="text-align:center;margin-bottom:14px;">
          <div style="font-family:'IM Fell English','Georgia',serif;font-size:9px;color:#7a5c00;letter-spacing:4px;text-transform:uppercase;margin-bottom:6px;">âœ¦ Guild of Wares âœ¦</div>
          <div style="font-family:'IM Fell English','Georgia',serif;font-size:26px;color:#f0e8c8;letter-spacing:2px;">The Merchant's Hall</div>
          <div style="width:60%;height:1px;background:linear-gradient(90deg,transparent,#7a5c00,transparent);margin:8px auto 0;"></div>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <button class="back" data-action="renderMenu" style="width:auto;margin:0;padding:8px 18px;background:#0a0800;color:#d4a017;border:1px solid #3a2800;border-top:2px solid #7a5c00;font-family:'IM Fell English','Georgia',serif;font-size:12px;letter-spacing:1px;cursor:pointer;">â† Return</button>
          <div style="text-align:center;">
            <div style="font-family:'IM Fell English','Georgia',serif;font-size:16px;color:#d4a017;background:rgba(212,160,23,0.07);border:1px solid rgba(212,160,23,0.25);padding:5px 16px;letter-spacing:1px;">ðŸª™ ${coins} gold</div>
          </div>
          <button onclick="openAdminPanel()" style="width:auto;margin:0;padding:8px 14px;border:1px solid #7a5c00;background:rgba(90,60,0,0.3);color:#d4a017;font-family:'IM Fell English','Georgia',serif;font-size:11px;letter-spacing:1px;cursor:pointer;font-style:italic;">Admin âœ¦</button>
        </div>
      </div>
      <div style="font-family:'IM Fell English','Georgia',serif;font-size:10px;color:#7a5c00;letter-spacing:2px;text-align:center;margin-bottom:18px;font-style:italic;">~ Browse the wares, spend your coin, don your chosen vestment ~</div>
      ${tabBar}<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">${itemsHtml}</div>
    </div>`,

  /* â”€ CSM: manga panel / comic page layout â”€ */
  csm:(coins,itemsHtml,tabBar="")=>`
    <div style="max-width:680px;margin:0 auto;padding:20px 14px 60px;font-family:'Comic Neue','Comic Sans MS',cursive;background:#f0f0f0;min-height:100vh;">
      <div style="background:radial-gradient(circle,rgba(0,0,0,0.06) 1px,transparent 1px);background-size:5px 5px;background-color:#fff;border:3px solid #000;box-shadow:6px 6px 0 #000;margin-bottom:20px;padding:16px;">
        <div style="border-bottom:3px solid #000;padding-bottom:10px;margin-bottom:12px;display:flex;align-items:flex-start;gap:10px;">
          <button class="back" data-action="renderMenu" style="all:unset;box-sizing:border-box;display:inline-flex;align-items:center;cursor:pointer;width:auto;margin:0;padding:8px 16px;background:#fff!important;color:#000!important;border:2px solid #000!important;box-shadow:3px 3px 0 #000!important;font-family:'Bangers',cursive!important;font-size:14px!important;letter-spacing:2px!important;clip-path:none!important;border-radius:0!important;transform:none!important;text-shadow:none!important;flex-shrink:0;">â† BACK</button>
          <div style="flex:1;">
            <div style="font-family:'Bangers',cursive;font-size:9px;color:#666;letter-spacing:3px;margin-bottom:2px;">VOL. 1 Â· SKIN COLLECTION</div>
            <div style="font-family:'Bangers',cursive;font-size:32px;letter-spacing:4px;color:#000;line-height:1;-webkit-text-stroke:1px #000;">SKIN SHOP!</div>
          </div>
          <div style="text-align:right;flex-shrink:0;">
            <div style="font-family:'Bangers',cursive;font-size:18px;color:#000;background:#fff700;border:2px solid #000;box-shadow:2px 2px 0 #000;padding:4px 12px;letter-spacing:1px;margin-bottom:4px;">ðŸª™ ${coins}</div>
            <button onclick="openAdminPanel()" style="width:auto;margin:0;display:block;padding:4px 10px;border:2px solid #000;background:#fff;color:#000;font-family:'Bangers',cursive;font-size:11px;letter-spacing:2px;cursor:pointer;box-shadow:2px 2px 0 #000;text-transform:uppercase;">ADMIN</button>
          </div>
        </div>
        <div style="font-family:'Comic Neue',cursive;font-size:9px;color:#555;letter-spacing:1px;font-style:italic;">â€” select a skin to equip or purchase Â· coins earned from xp â€”</div>
      </div>
      ${tabBar}<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">${itemsHtml}</div>
    </div>`,

  /* â”€ CYBERPUNK: neon terminal grid â”€ */
  cyberpunk:(coins,itemsHtml,tabBar="")=>`
    <div style="max-width:680px;margin:0 auto;padding:20px 16px 60px;font-family:'Exo 2',sans-serif;background:linear-gradient(180deg,#020208,#080820);min-height:100vh;">
      <div style="border:1px solid rgba(0,255,255,0.15);border-top:2px solid #00ffff;padding:16px;margin-bottom:16px;background:rgba(0,255,255,0.03);position:relative;overflow:hidden;">
        <div style="position:absolute;top:0;right:0;width:60px;height:60px;border-bottom:1px solid rgba(0,255,255,0.1);border-left:1px solid rgba(0,255,255,0.1);"></div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:rgba(0,255,255,0.4);letter-spacing:3px;margin-bottom:6px;">â–¶ MARKET_v2.1 Â· NETRUNNER INTERFACE</div>
        <div style="font-family:'Exo 2',sans-serif;font-size:26px;font-weight:900;letter-spacing:4px;text-transform:uppercase;color:#e0f8ff;text-shadow:0 0 20px rgba(0,255,255,0.7),0 0 40px rgba(0,255,255,0.3);">SKIN <span style="color:#00ffff;">MARKET</span></div>
        <div style="display:flex;align-items:center;gap:10px;margin-top:14px;padding-top:12px;border-top:1px solid rgba(0,255,255,0.1);">
          <button class="back" data-action="renderMenu" style="width:auto;margin:0;padding:8px 16px;background:rgba(0,255,255,0.05);color:#00ffff;border:1px solid rgba(0,255,255,0.3);font-family:'Exo 2',sans-serif;font-weight:700;font-size:12px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,0 100%);">â—„ BACK</button>
          <div style="flex:1;font-family:'Share Tech Mono',monospace;font-size:8px;color:#304060;letter-spacing:2px;">SLOTS AVAILABLE Â· BUY OR JACK IN</div>
          <button onclick="openAdminPanel()" style="width:auto;margin:0;padding:6px 12px;border:1px solid rgba(0,200,255,0.3);background:rgba(0,40,80,0.6);color:#00ffff;font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;cursor:pointer;text-transform:uppercase;">ADMIN</button>
          <div style="font-family:'Share Tech Mono',monospace;font-size:14px;color:#00ffff;background:rgba(0,255,255,0.07);border:1px solid rgba(0,255,255,0.25);padding:6px 12px;letter-spacing:2px;clip-path:polygon(0 0,calc(100% - 6px) 0,100% 6px,100% 100%,0 100%);">ðŸª™ ${coins}</div>
        </div>
      </div>
      ${tabBar}<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">${itemsHtml}</div>
    </div>`,

  /* â”€ HACKER: pure terminal, no decoration â”€ */
  hacker:(coins,itemsHtml,tabBar="")=>`
    <div style="max-width:680px;margin:0 auto;padding:20px 16px 60px;font-family:'Share Tech Mono','Courier New',monospace;background:#000300;min-height:100vh;color:#88ff88;">
      <div style="border-bottom:1px solid #003300;padding-bottom:14px;margin-bottom:16px;">
        <div style="font-size:9px;color:#336633;letter-spacing:2px;margin-bottom:8px;">root@kotoba:~/shop$ ls -la skins/</div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
          <span style="color:#336633;font-size:10px;">$</span>
          <span style="font-size:16px;color:#ccffcc;letter-spacing:2px;text-shadow:0 0 10px rgba(0,255,65,0.4);">./shop --list-skins</span>
        </div>
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
          <button class="back" data-action="renderMenu" style="width:auto;margin:0;padding:6px 14px;background:transparent;color:#88ff88;border:1px solid #003300;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:1px;cursor:pointer;">$ cd ..</button>
          <span style="font-size:9px;color:#336633;flex:1;">// wallet: <span style="color:#00ff41;">ðŸª™ ${coins} coins</span></span>
          <button onclick="openAdminPanel()" style="width:auto;margin:0;padding:5px 12px;border:1px solid #005500;background:rgba(0,30,0,0.8);color:#00ff41;font-family:'Share Tech Mono',monospace;font-size:9px;cursor:pointer;">sudo admin</button>
        </div>
        <div style="font-size:8px;color:#336633;letter-spacing:1px;margin-top:8px;">// ${Object.keys(THEME_CARD_RENDERS).length} skins found Â· tap to install Â· coins earned from xp</div>
      </div>
      ${tabBar}<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">${itemsHtml}</div>
    </div>`,

  /* â”€ ULTRAKILL: sakura garden / Japanese spring â”€ */
  ultrakill:(coins,itemsHtml,tabBar="")=>`
    <div style="max-width:680px;margin:0 auto;padding:24px 16px 60px;font-family:'M PLUS Rounded 1c','Hiragino Maru Gothic Pro',sans-serif;background:linear-gradient(180deg,#fff8fa,#ffeef5);min-height:100vh;position:relative;">
      <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse 100% 50% at 50% 0%,rgba(255,200,220,0.5),transparent 60%);pointer-events:none;z-index:0;"></div>
      <div style="position:relative;z-index:1;">
        <div style="background:rgba(255,255,255,0.7);border:1px solid #f4a0c0;border-radius:16px;padding:20px;margin-bottom:20px;backdrop-filter:blur(8px);box-shadow:0 4px 24px rgba(224,96,126,0.15);">
          <div style="text-align:center;margin-bottom:16px;">
            <div style="font-size:22px;letter-spacing:6px;margin-bottom:4px;">ðŸŒ¸ ðŸŒ¸ ðŸŒ¸</div>
            <div style="font-family:'Noto Serif JP',serif;font-size:10px;color:#c090a8;letter-spacing:4px;margin-bottom:6px;">ã•ãã‚‰ Â· ã‚¹ã‚­ãƒ³ã‚·ãƒ§ãƒƒãƒ—</div>
            <div style="font-family:'Noto Serif JP',serif;font-size:24px;font-weight:700;color:#3a1030;letter-spacing:3px;">æ¡œ Sakura Shop</div>
            <div style="width:60%;height:1px;background:linear-gradient(90deg,transparent,#f4a0c0,transparent);margin:10px auto 0;"></div>
          </div>
          <div style="display:flex;align-items:center;gap:10px;justify-content:space-between;">
            <button class="back" data-action="renderMenu" style="all:unset;box-sizing:border-box;display:inline-flex;align-items:center;cursor:pointer;width:auto;margin:0;padding:9px 20px;background:rgba(255,255,255,0.8)!important;color:#5a2040!important;border:1px solid #f4a0c0!important;border-radius:20px!important;font-family:'M PLUS Rounded 1c',sans-serif!important;font-size:12px!important;letter-spacing:1px!important;box-shadow:0 2px 8px rgba(224,96,126,0.15)!important;clip-path:none!important;transform:none!important;text-shadow:none!important;">â† ã‚‚ã©ã‚‹</button>
            <div style="font-family:'M PLUS Rounded 1c',sans-serif;font-size:14px;color:#e0607e;background:rgba(244,160,192,0.2);border:1px solid rgba(224,96,126,0.3);border-radius:20px;padding:7px 16px;">ðŸª™ ${coins}</div>
            <button onclick="openAdminPanel()" style="all:unset;box-sizing:border-box;display:inline-flex;align-items:center;cursor:pointer;width:auto;margin:0;padding:9px 16px;border:1px solid #f4a0c0!important;background:rgba(255,220,235,0.6)!important;color:#e0607e!important;font-family:'M PLUS Rounded 1c',sans-serif!important;font-size:11px!important;border-radius:20px!important;clip-path:none!important;transform:none!important;text-shadow:none!important;">ç®¡ç† admin</button>
          </div>
        </div>
        <div style="font-family:'Noto Serif JP',serif;font-size:10px;color:#c090a8;text-align:center;letter-spacing:2px;margin-bottom:18px;font-style:italic;">~ ã‚¹ã‚­ãƒ³ã‚’é¸ã‚“ã§è£…å‚™ã—ã‚ˆã† Â· çµŒé¨“å€¤ã‹ã‚‰ã‚³ã‚¤ãƒ³ã‚’ç²å¾— ~</div>
        ${tabBar}<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">${itemsHtml}</div>
      </div>
    </div>`,

  /* â”€ VOID: cosmic void / portal aesthetic â”€ */
  void:(coins,itemsHtml,tabBar="")=>`
    <div style="max-width:680px;margin:0 auto;padding:24px 16px 60px;font-family:'Space Grotesk',sans-serif;background:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(80,0,160,0.2),transparent 60%),linear-gradient(180deg,#04000a,#0e0020);min-height:100vh;">
      <div style="position:relative;margin-bottom:22px;">
        <div style="text-align:center;padding:20px 16px 16px;border:1px solid #2a0060;background:rgba(153,0,255,0.04);position:relative;">
          <div style="position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,#9900ff,transparent);"></div>
          <div style="position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,#440088,transparent);"></div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#5a3080;letter-spacing:4px;margin-bottom:8px;">â—‰ VOID PROTOCOL Â· DIMENSION MARKET â—‰</div>
          <div style="font-family:'Space Grotesk',sans-serif;font-size:28px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#eebbff;text-shadow:0 0 24px rgba(153,0,255,0.7),0 0 60px rgba(153,0,255,0.3);">VOID <span style="color:#cc66ff;">MARKET</span></div>
          <div style="width:40px;height:40px;border-radius:50%;background:radial-gradient(circle,rgba(153,0,255,0.6),transparent);box-shadow:0 0 30px rgba(153,0,255,0.5);margin:12px auto 0;"></div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;margin-top:14px;">
          <button class="back" data-action="renderMenu" style="width:auto;margin:0;padding:8px 16px;background:#0e0020;color:#d0a0ff;border:1px solid #2a0060;font-family:'Space Grotesk',sans-serif;font-weight:700;font-size:12px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px));">â—„ EXIT VOID</button>
          <div style="flex:1;font-family:'Share Tech Mono',monospace;font-size:8px;color:#5a3080;letter-spacing:2px;">COINS FROM XP Â· EQUIP TO ACTIVATE</div>
          <button onclick="openAdminPanel()" style="width:auto;margin:0;padding:6px 12px;border:1px solid #440088;background:rgba(30,0,60,0.7);color:#cc66ff;font-family:'Space Grotesk',sans-serif;font-size:9px;letter-spacing:1px;cursor:pointer;text-transform:uppercase;">ADMIN</button>
          <div style="font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:700;color:#cc66ff;background:rgba(153,0,255,0.08);border:1px solid rgba(153,0,255,0.25);padding:6px 12px;letter-spacing:2px;">ðŸª™ ${coins}</div>
        </div>
      </div>
      ${tabBar}<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">${itemsHtml}</div>
    </div>`,

  /* â”€ METAPHOR: arcane illuminated manuscript â”€ */
  metaphor:(coins,itemsHtml,tabBar="")=>`
    <div style="max-width:680px;margin:0 auto;padding:28px 20px 60px;font-family:'Cormorant Garamond','Georgia',serif;background:linear-gradient(180deg,#06061a,#0d0d20);min-height:100vh;">
      <div style="border:1px solid #2a2a44;border-top:3px solid #c8b050;border-bottom:3px solid #c8b050;padding:24px 20px 20px;margin-bottom:24px;background:linear-gradient(180deg,#0e0e28,#08081a);position:relative;text-align:center;">
        <div style="position:absolute;top:8px;left:16px;font-family:'Cinzel',serif;font-size:16px;color:#705820;">â—†</div>
        <div style="position:absolute;top:8px;right:16px;font-family:'Cinzel',serif;font-size:16px;color:#705820;">â—†</div>
        <div style="position:absolute;bottom:8px;left:16px;font-family:'Cinzel',serif;font-size:12px;color:#705820;">â—‡</div>
        <div style="position:absolute;bottom:8px;right:16px;font-family:'Cinzel',serif;font-size:12px;color:#705820;">â—‡</div>
        <div style="font-family:'Cinzel',serif;font-size:9px;color:#705820;letter-spacing:5px;text-transform:uppercase;margin-bottom:10px;">The Merchants' Sanctum</div>
        <div style="font-family:'Cinzel',serif;font-size:26px;font-weight:700;letter-spacing:4px;color:#f4ecd8;text-transform:uppercase;">Vestment Hall</div>
        <div style="width:50%;height:1px;background:linear-gradient(90deg,transparent,#c8b050,transparent);margin:12px auto;"></div>
        <div style="font-family:'Cormorant Garamond','Georgia',serif;font-size:12px;color:#6a6080;font-style:italic;letter-spacing:1px;margin-bottom:16px;">~ Spend your gilded coin, don the Archetypal guise ~</div>
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <button class="back" data-action="renderMenu" style="width:auto;margin:0;padding:9px 20px;background:linear-gradient(180deg,#0e0e28,#08081a);color:#e0d8c0;border:1px solid #2a2a44;border-top:2px solid #705820;font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;cursor:pointer;">â† Return</button>
          <div style="font-family:'Cinzel',serif;font-size:16px;color:#c8b050;background:rgba(200,176,80,0.06);border:1px solid rgba(200,176,80,0.2);padding:7px 18px;letter-spacing:2px;">ðŸª™ ${coins}</div>
          <button onclick="openAdminPanel()" style="width:auto;margin:0;padding:9px 16px;border:1px solid #705820;background:rgba(40,30,0,0.5);color:#c8b050;font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;cursor:pointer;font-style:italic;">Admin â—†</button>
        </div>
      </div>
      ${tabBar}<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">${itemsHtml}</div>
    </div>`,

  /* â”€ PICAYUNE DREAMS: galaxy + blackhole + glitch â”€ */
  picayune:(coins,itemsHtml,tabBar="")=>`
    <div style="max-width:680px;margin:0 auto;padding:20px 14px 60px;font-family:'VT323','Share Tech Mono',monospace;background:#000a1a;min-height:100vh;position:relative;overflow:hidden;">
      <!-- Galaxy stars layer -->
      <div style="position:fixed;inset:0;pointer-events:none;z-index:0;
        background:
          radial-gradient(1px 1px at 10% 15%,rgba(255,255,255,0.92) 0%,transparent 100%),
          radial-gradient(1px 1px at 30% 40%,rgba(155,200,255,0.8) 0%,transparent 100%),
          radial-gradient(1px 1px at 55% 20%,rgba(255,255,255,0.88) 0%,transparent 100%),
          radial-gradient(1px 1px at 75% 55%,rgba(140,190,255,0.85) 0%,transparent 100%),
          radial-gradient(2px 2px at 20% 70%,rgba(100,165,255,0.6) 0%,transparent 100%),
          radial-gradient(1px 1px at 88% 30%,rgba(255,255,255,0.8) 0%,transparent 100%),
          radial-gradient(1px 1px at 45% 80%,rgba(140,185,255,0.72) 0%,transparent 100%),
          radial-gradient(1px 1px at 65% 10%,rgba(180,215,255,0.78) 0%,transparent 100%),
          radial-gradient(2px 2px at 5% 50%,rgba(155,200,255,0.5) 0%,transparent 100%),
          radial-gradient(1px 1px at 93% 75%,rgba(180,215,255,0.62) 0%,transparent 100%),
          radial-gradient(1px 1px at 38% 60%,rgba(255,255,255,0.9) 0%,transparent 100%),
          radial-gradient(1px 1px at 82% 88%,rgba(130,185,255,0.7) 0%,transparent 100%);
        animation:starsTwinkle 5s ease-in-out infinite alternate;
      "></div>
      <div style="position:relative;z-index:1;">
        <!-- GLITCH HEADER -->
        <div style="border:1px solid #0a2040;border-top:2px solid #3a7bd5;padding:16px 14px 12px;margin-bottom:16px;background:rgba(0,8,24,0.92);position:relative;overflow:hidden;animation:errorFlicker 9s infinite;">
          <div style="position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,#3a7bd5,#0a2040,transparent);animation:scanlineGlitch 8s infinite;"></div>
          <div style="font-family:'VT323',monospace;font-size:9px;color:rgba(58,123,213,0.35);letter-spacing:3px;margin-bottom:4px;">[ SYSTEM: DREAMING ] [ ERR_REALITY_NOT_FOUND ] [ COINS: LOADED ]</div>
          <div style="font-family:'VT323',monospace;font-size:34px;letter-spacing:6px;color:#6fa8dc;text-shadow:0 0 18px rgba(58,123,213,0.8),0 0 36px rgba(58,123,213,0.3);animation:glitchColor 5s infinite,glitchShift 7s infinite;line-height:1;">âŠ¹ PICAYUNE <span style="color:#3a7bd5;">SHOP</span> âŠ¹</div>
          <div style="font-family:'VT323',monospace;font-size:11px;color:#0a2040;letter-spacing:2px;margin-bottom:14px;">[ GALAXY INDEX: â–ˆâ–ˆâ–ˆâ–ˆ ] [ VOID DEPTH: âˆž ] [ COHERENCE: ERROR ]</div>
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
            <button class="back" data-action="renderMenu" style="width:auto;margin:0;padding:8px 16px;background:#000f22;color:#6fa8dc;border:1px solid #0a2040;font-family:'VT323',monospace;font-size:16px;letter-spacing:2px;cursor:pointer;text-shadow:0 0 7px rgba(58,123,213,0.5);">â—„ EXIT</button>
            <div style="flex:1;font-family:'VT323',monospace;font-size:11px;color:#0a2040;letter-spacing:2px;animation:errorFlicker 7s infinite;">// EQUIP TO MANIFEST Â· COINS FROM XP</div>
            <button onclick="openAdminPanel()" style="width:auto;margin:0;padding:6px 12px;border:1px solid #0d2d5e;background:rgba(0,15,50,0.7);color:#3a7bd5;font-family:'VT323',monospace;font-size:14px;letter-spacing:2px;cursor:pointer;text-shadow:0 0 7px rgba(58,123,213,0.6);">âŠ¹ ADMIN</button>
            <div style="font-family:'VT323',monospace;font-size:18px;color:#6fa8dc;background:rgba(58,123,213,0.06);border:1px solid rgba(58,123,213,0.25);padding:5px 12px;letter-spacing:2px;text-shadow:0 0 8px rgba(58,123,213,0.5);animation:glitchColor 8s infinite;">ðŸª™ ${coins}</div>
          </div>
        </div>
        ${tabBar}<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">${itemsHtml}</div>
      </div>
    </div>`,
};

/* â”€â”€ PER-THEME SHOP SHELL STYLES â”€â”€ */
const SHOP_SHELLS={
  arknight:{
    bg:"#10141c",border:"#2a3344",accent:"#e8a838",accentDim:"#8a6020",text:"#d4cfc4",textDim:"#6e7a8a",textBright:"#f0ebe0",
    titleFont:"'Rajdhani','Arial Narrow',Arial,sans-serif",bodyFont:"'Barlow Condensed',sans-serif",monoFont:"'Share Tech Mono',monospace",
    titleStyle:"font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#f0ebe0;",
    titleAccent:"#e8a838",
    headerBorder:"1px solid #2a3344",headerAccentLine:"background:linear-gradient(90deg,#e8a838,transparent);height:2px;width:80px;",
    btnStyle:"border:1px solid #2a3344;background:#161b26;color:#d4cfc4;font-family:'Barlow Condensed',sans-serif;font-size:13px;letter-spacing:2px;text-transform:uppercase;clip-path:polygon(0 0,calc(100%-10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100%-10px));padding:10px 16px;cursor:pointer;",
    btnHover:"#e8a838",coinStyle:"font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;color:#f0c060;background:rgba(240,192,96,0.08);border:1px solid rgba(240,192,96,0.25);padding:6px 14px;",
    adminStyle:"border:1px solid #3a3a5c;background:rgba(80,50,120,0.2);color:#9c55d0;font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;padding:4px 10px;",
    subtitleStyle:"font-family:'Share Tech Mono',monospace;font-size:9px;color:#6e7a8a;letter-spacing:2px;margin-bottom:14px;",
    subtitleText:"COINS EARNED FROM XP Â· TAP TO BUY OR EQUIP",
    gridStyle:"display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0;",
    containerBg:"",badgeBg:"",
  },
  dmc:{
    bg:"#1a0005",border:"#4a0010",accent:"#e30018",accentDim:"#6a000a",text:"#f0d0d0",textDim:"#805060",textBright:"#ffe0e0",
    titleFont:"'Bebas Neue','Rajdhani',sans-serif",bodyFont:"'Rajdhani',sans-serif",monoFont:"'Share Tech Mono',monospace",
    titleStyle:"font-family:'Bebas Neue','Rajdhani',sans-serif;font-size:28px;letter-spacing:6px;text-transform:uppercase;color:#ffe0e0;text-shadow:0 0 20px rgba(227,0,24,0.6);",
    titleAccent:"#ff2030",
    headerBorder:"1px solid #4a0010",headerAccentLine:"background:linear-gradient(90deg,#e30018,transparent);height:1px;width:100%;",
    btnStyle:"border:1px solid #4a0010;background:#1a0005;color:#f0d0d0;font-family:'Rajdhani',sans-serif;font-weight:700;font-size:14px;letter-spacing:3px;text-transform:uppercase;clip-path:polygon(0 0,calc(100%-10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100%-10px));padding:10px 16px;cursor:pointer;",
    btnHover:"#ff4444",coinStyle:"font-family:'Bebas Neue',sans-serif;font-size:20px;color:#ff4444;background:rgba(227,0,24,0.08);border:1px solid rgba(227,0,24,0.3);padding:6px 14px;letter-spacing:3px;",
    adminStyle:"border:1px solid #6a000a;background:rgba(80,0,20,0.5);color:#ff4444;font-family:'Bebas Neue',sans-serif;font-size:11px;letter-spacing:3px;padding:4px 10px;",
    subtitleStyle:"font-family:'Bebas Neue',sans-serif;font-size:12px;color:#805060;letter-spacing:4px;margin-bottom:14px;text-shadow:0 0 8px rgba(227,0,24,0.3);",
    subtitleText:"STYLISH OPERATOR Â· BUY OR EQUIP SKIN",
    gridStyle:"display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:10px 0;",
    containerBg:"background:linear-gradient(180deg,#0d0003,#1a0005);",badgeBg:"",
  },
  bnw:{
    bg:"#111",border:"#333",accent:"#ffffff",accentDim:"#555",text:"#cccccc",textDim:"#555",textBright:"#ffffff",
    titleFont:"'Arial Narrow',Arial,sans-serif",bodyFont:"'Arial Narrow',Arial,sans-serif",monoFont:"'Courier New',monospace",
    titleStyle:"font-family:'Arial Narrow',Arial,sans-serif;font-size:20px;font-weight:700;letter-spacing:6px;text-transform:uppercase;color:#ffffff;",
    titleAccent:"#ffffff",
    headerBorder:"1px solid #333",headerAccentLine:"background:linear-gradient(90deg,#fff,transparent);height:1px;width:100%;",
    btnStyle:"border:1px solid #333;background:#0a0a0a;color:#aaa;font-family:'Arial Narrow',Arial,sans-serif;font-size:13px;font-weight:700;letter-spacing:3px;text-transform:uppercase;padding:10px 16px;cursor:pointer;",
    btnHover:"#ffffff",coinStyle:"font-family:'Courier New',monospace;font-size:14px;color:#fff;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.2);padding:6px 14px;letter-spacing:2px;",
    adminStyle:"border:1px solid #444;background:rgba(255,255,255,0.05);color:#888;font-family:'Courier New',monospace;font-size:9px;letter-spacing:2px;padding:4px 10px;",
    subtitleStyle:"font-family:'Courier New',monospace;font-size:9px;color:#555;letter-spacing:2px;margin-bottom:14px;",
    subtitleText:"MONOCHROME Â· COINS EARNED FROM XP",
    gridStyle:"display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0;",
    containerBg:"",badgeBg:"",
  },
  rpg:{
    bg:"#1a1200",border:"#3a2800",accent:"#d4a017",accentDim:"#7a5c00",text:"#f0e8c8",textDim:"#806040",textBright:"#fff8e8",
    titleFont:"'Georgia',serif",bodyFont:"'Georgia',serif",monoFont:"'Share Tech Mono',monospace",
    titleStyle:"font-family:'Georgia',serif;font-size:20px;font-weight:700;letter-spacing:3px;color:#f0e8c8;",
    titleAccent:"#d4a017",
    headerBorder:"2px solid #3a2800",headerAccentLine:"background:linear-gradient(90deg,#7a5c00,#d4a017,#7a5c00);height:1px;width:100%;",
    btnStyle:"border:1px solid #3a2800;background:#110c00;color:#f0e8c8;font-family:'Georgia',serif;font-size:13px;letter-spacing:1px;padding:10px 16px;cursor:pointer;",
    btnHover:"#d4a017",coinStyle:"font-family:'Georgia',serif;font-size:16px;color:#d4a017;background:rgba(212,160,23,0.08);border:1px solid rgba(212,160,23,0.3);padding:6px 14px;",
    adminStyle:"border:1px solid #7a5c00;background:rgba(90,60,0,0.3);color:#d4a017;font-family:'Georgia',serif;font-size:10px;letter-spacing:1px;padding:4px 10px;",
    subtitleStyle:"font-family:'Georgia',serif;font-size:10px;color:#7a5c00;letter-spacing:2px;margin-bottom:14px;font-style:italic;",
    subtitleText:"âœ¦ Trade Coins Â· Equip a Skin Â· Begin your Quest",
    gridStyle:"display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:10px 0;",
    containerBg:"background:linear-gradient(180deg,#110c00,#1a1200);",badgeBg:"",
  },
  csm:{
    bg:"#ffffff",border:"#000000",accent:"#111111",accentDim:"#555555",text:"#111111",textDim:"#555555",textBright:"#000000",
    titleFont:"'Bangers',cursive",bodyFont:"'Comic Neue','Comic Sans MS',cursive",monoFont:"'Share Tech Mono',monospace",
    titleStyle:"font-family:'Bangers',cursive;font-size:28px;letter-spacing:4px;color:#000;-webkit-text-stroke:1px #000;",
    titleAccent:"#cc0000",
    headerBorder:"3px solid #000",headerAccentLine:"background:#000;height:3px;width:100%;",
    btnStyle:"border:2px solid #000;background:#fff;color:#000;font-family:'Bangers',cursive;font-size:14px;letter-spacing:2px;box-shadow:3px 3px 0 #000;padding:8px 16px;cursor:pointer;",
    btnHover:"#cc0000",coinStyle:"font-family:'Bangers',cursive;font-size:18px;color:#000;background:#fff700;border:2px solid #000;box-shadow:2px 2px 0 #000;padding:4px 12px;letter-spacing:1px;",
    adminStyle:"border:2px solid #000;background:#fff;color:#000;font-family:'Bangers',cursive;font-size:11px;letter-spacing:2px;box-shadow:2px 2px 0 #000;padding:4px 10px;",
    subtitleStyle:"font-family:'Comic Neue',cursive;font-size:9px;color:#555;letter-spacing:1px;margin-bottom:14px;font-style:italic;",
    subtitleText:"â€” select a skin to equip or purchase Â· coins from xp â€”",
    gridStyle:"display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:10px 0;",
    containerBg:"background:#f0f0f0;",badgeBg:"",
  },
  cyberpunk:{
    bg:"#080820",border:"#0a2040",accent:"#00ffff",accentDim:"#006666",text:"#c0e0ff",textDim:"#304060",textBright:"#e0f8ff",
    titleFont:"'Exo 2',sans-serif",bodyFont:"'Exo 2',sans-serif",monoFont:"'Share Tech Mono',monospace",
    titleStyle:"font-family:'Exo 2',sans-serif;font-size:22px;font-weight:900;letter-spacing:4px;text-transform:uppercase;color:#e0f8ff;text-shadow:0 0 16px rgba(0,255,255,0.6);",
    titleAccent:"#00ffff",
    headerBorder:"1px solid rgba(0,255,255,0.2)",headerAccentLine:"background:linear-gradient(90deg,#00ffff,transparent);height:1px;width:100%;",
    btnStyle:"border:1px solid #0a2040;background:#050510;color:#c0e0ff;font-family:'Exo 2',sans-serif;font-weight:700;font-size:13px;letter-spacing:2px;text-transform:uppercase;clip-path:polygon(0 0,calc(100%-12px) 0,100% 12px,100% 100%,0 100%);padding:10px 16px;cursor:pointer;",
    btnHover:"#00ffff",coinStyle:"font-family:'Share Tech Mono',monospace;font-size:14px;color:#00ffff;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.25);padding:6px 14px;letter-spacing:2px;",
    adminStyle:"border:1px solid rgba(0,200,255,0.3);background:rgba(0,40,80,0.5);color:#00ffff;font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;padding:4px 10px;",
    subtitleStyle:"font-family:'Share Tech Mono',monospace;font-size:9px;color:#304060;letter-spacing:2px;margin-bottom:14px;text-shadow:0 0 6px rgba(0,255,255,0.2);",
    subtitleText:"NETRUNNER MARKET Â· SLOTS AVAILABLE Â· BUY OR JACK IN",
    gridStyle:"display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0;",
    containerBg:"background:linear-gradient(180deg,#030308,#080820);",badgeBg:"",
  },
  hacker:{
    bg:"#001000",border:"#003300",accent:"#00ff41",accentDim:"#005500",text:"#88ff88",textDim:"#336633",textBright:"#ccffcc",
    titleFont:"'Share Tech Mono','Courier New',monospace",bodyFont:"'Share Tech Mono',monospace",monoFont:"'Share Tech Mono',monospace",
    titleStyle:"font-family:'Share Tech Mono',monospace;font-size:14px;letter-spacing:2px;color:#ccffcc;text-shadow:0 0 10px rgba(0,255,65,0.5);",
    titleAccent:"#00ff41",
    headerBorder:"1px solid #003300",headerAccentLine:"background:linear-gradient(90deg,#00ff41,transparent);height:1px;width:100%;",
    btnStyle:"border:1px solid #003300;background:#000800;color:#88ff88;font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:1px;padding:10px 16px;cursor:pointer;",
    btnHover:"#00ff41",coinStyle:"font-family:'Share Tech Mono',monospace;font-size:13px;color:#00ff41;background:rgba(0,255,65,0.05);border:1px solid rgba(0,255,65,0.2);padding:6px 14px;",
    adminStyle:"border:1px solid #005500;background:rgba(0,30,0,0.8);color:#00ff41;font-family:'Share Tech Mono',monospace;font-size:9px;padding:4px 10px;",
    subtitleStyle:"font-family:'Share Tech Mono',monospace;font-size:8px;color:#336633;letter-spacing:2px;margin-bottom:14px;",
    subtitleText:"// shop.init() Â· coins earned from xp Â· tap to install",
    gridStyle:"display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0;",
    containerBg:"background:#000300;",badgeBg:"",
  },
  ultrakill:{
    bg:"#fff8fb",border:"#f4a0c0",accent:"#e0607e",accentDim:"#c04060",text:"#5a2040",textDim:"#c090a8",textBright:"#3a1030",
    titleFont:"'Noto Serif JP',serif",bodyFont:"'M PLUS Rounded 1c',sans-serif",monoFont:"'Share Tech Mono',monospace",
    titleStyle:"font-family:'Noto Serif JP',serif;font-size:22px;font-weight:700;letter-spacing:3px;color:#3a1030;",
    titleAccent:"#e0607e",
    headerBorder:"1px solid #f4a0c0",headerAccentLine:"background:linear-gradient(90deg,#f4a0c0,#e0607e,#f4a0c0);height:2px;width:100%;",
    btnStyle:"border:1px solid #f4a0c0;background:rgba(255,255,255,0.8);color:#5a2040;font-family:'M PLUS Rounded 1c',sans-serif;font-size:12px;letter-spacing:1px;border-radius:20px;box-shadow:0 2px 8px rgba(224,96,126,0.15);padding:8px 18px;cursor:pointer;",
    btnHover:"#e0607e",coinStyle:"font-family:'M PLUS Rounded 1c',sans-serif;font-size:14px;color:#e0607e;background:rgba(244,160,192,0.2);border:1px solid rgba(224,96,126,0.3);border-radius:20px;padding:6px 14px;",
    adminStyle:"border:1px solid #f4a0c0;background:rgba(255,220,235,0.6);color:#e0607e;font-family:'M PLUS Rounded 1c',sans-serif;font-size:10px;border-radius:20px;padding:4px 12px;",
    subtitleStyle:"font-family:'Noto Serif JP',serif;font-size:10px;color:#c090a8;letter-spacing:2px;margin-bottom:14px;text-align:center;font-style:italic;",
    subtitleText:"~ ã‚¹ã‚­ãƒ³ã‚’é¸ã‚“ã§è£…å‚™ã—ã‚ˆã† Â· çµŒé¨“å€¤ã‹ã‚‰ã‚³ã‚¤ãƒ³ã‚’ç²å¾— ~",
    gridStyle:"display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:10px 0;",
    containerBg:"background:linear-gradient(180deg,#fff8fa,#ffeef5);",badgeBg:"",
  },
  void:{
    bg:"#0e0020",border:"#2a0060",accent:"#9900ff",accentDim:"#440088",text:"#d0a0ff",textDim:"#5a3080",textBright:"#eebbff",
    titleFont:"'Space Grotesk',sans-serif",bodyFont:"'Space Grotesk',sans-serif",monoFont:"'Share Tech Mono',monospace",
    titleStyle:"font-family:'Space Grotesk',sans-serif;font-size:20px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#eebbff;text-shadow:0 0 16px rgba(153,0,255,0.5);",
    titleAccent:"#cc66ff",
    headerBorder:"1px solid #2a0060",headerAccentLine:"background:linear-gradient(90deg,#9900ff,transparent);height:1px;width:100%;",
    btnStyle:"border:1px solid #2a0060;background:#0e0020;color:#d0a0ff;font-family:'Space Grotesk',sans-serif;font-weight:700;font-size:13px;letter-spacing:1px;text-transform:uppercase;clip-path:polygon(0 0,calc(100%-10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100%-10px));padding:10px 16px;cursor:pointer;",
    btnHover:"#cc66ff",coinStyle:"font-family:'Space Grotesk',sans-serif;font-size:16px;font-weight:700;color:#cc66ff;background:rgba(153,0,255,0.07);border:1px solid rgba(153,0,255,0.25);padding:6px 14px;",
    adminStyle:"border:1px solid #440088;background:rgba(30,0,60,0.7);color:#cc66ff;font-family:'Space Grotesk',sans-serif;font-size:9px;letter-spacing:1px;padding:4px 10px;",
    subtitleStyle:"font-family:'Share Tech Mono',monospace;font-size:9px;color:#5a3080;letter-spacing:2px;margin-bottom:14px;",
    subtitleText:"â—‰ VOID MARKET Â· COINS FROM XP Â· EQUIP TO ACTIVATE",
    gridStyle:"display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0;",
    containerBg:"background:linear-gradient(180deg,#04000a,#0e0020);",badgeBg:"",
  },
  metaphor:{
    bg:"#121228",border:"#2a2a44",accent:"#c8b050",accentDim:"#705820",text:"#e0d8c0",textDim:"#6a6080",textBright:"#f4ecd8",
    titleFont:"'Cinzel',Georgia,serif",bodyFont:"'Cormorant Garamond',Georgia,serif",monoFont:"'Share Tech Mono',monospace",
    titleStyle:"font-family:'Cinzel',Georgia,serif;font-size:18px;font-weight:700;letter-spacing:5px;text-transform:uppercase;color:#f4ecd8;",
    titleAccent:"#c8b050",
    headerBorder:"1px solid #2a2a44",headerAccentLine:"background:linear-gradient(90deg,#705820,#c8b050,#705820);height:1px;width:100%;",
    btnStyle:"border:1px solid #2a2a44;background:linear-gradient(180deg,#121228,#0d0d20);color:#e0d8c0;font-family:'Cinzel',Georgia,serif;font-size:12px;font-weight:700;letter-spacing:2px;text-transform:none;padding:10px 16px;cursor:pointer;",
    btnHover:"#e0cc80",coinStyle:"font-family:'Cinzel',serif;font-size:15px;color:#c8b050;background:rgba(200,176,80,0.05);border:1px solid rgba(200,176,80,0.2);padding:6px 14px;",
    adminStyle:"border:1px solid #705820;background:rgba(40,30,0,0.5);color:#c8b050;font-family:'Cinzel',serif;font-size:9px;letter-spacing:2px;padding:4px 10px;",
    subtitleStyle:"font-family:'Cormorant Garamond',Georgia,serif;font-size:11px;color:#6a6080;letter-spacing:2px;margin-bottom:14px;font-style:italic;",
    subtitleText:"â—† The Merchant's Guild Â· Coins from Experience Â· Equip to Manifest",
    gridStyle:"display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:10px 0;",
    containerBg:"background:linear-gradient(180deg,#08081a,#121228);",badgeBg:"",
  },
  picayune:{
    bg:"#000a1a",border:"#001430",accent:"#3a7bd5",accentDim:"#0d2d5e",text:"#5a90c0",textDim:"#0a2040",textBright:"#9ac4e8",
    titleFont:"'VT323',monospace",bodyFont:"'VT323',monospace",monoFont:"'Share Tech Mono',monospace",
    titleStyle:"font-family:'VT323',monospace;font-size:24px;letter-spacing:4px;color:#6fa8dc;text-shadow:0 0 10px rgba(58,123,213,0.7);animation:glitchColor 7s infinite;",
    titleAccent:"#3a7bd5",
    headerBorder:"1px solid #0a2040",headerAccentLine:"background:linear-gradient(90deg,#3a7bd5,#0a2040,transparent);height:1px;width:100%;",
    btnStyle:"border:1px solid #0a2040;background:#000f22;color:#5a90c0;font-family:'VT323',monospace;font-size:18px;letter-spacing:2px;padding:10px 16px;cursor:pointer;",
    btnHover:"#6fa8dc",coinStyle:"font-family:'VT323',monospace;font-size:18px;color:#6fa8dc;background:rgba(58,123,213,0.06);border:1px solid rgba(58,123,213,0.25);padding:5px 12px;letter-spacing:2px;text-shadow:0 0 8px rgba(58,123,213,0.5);",
    adminStyle:"border:1px solid #0d2d5e;background:rgba(0,15,50,0.7);color:#3a7bd5;font-family:'VT323',monospace;font-size:14px;letter-spacing:2px;padding:6px 12px;",
    subtitleStyle:"font-family:'VT323',monospace;font-size:11px;color:#0a2040;letter-spacing:2px;margin-bottom:14px;",
    subtitleText:"// coins from xp Â· tap to equip Â· reality uncertain",
    gridStyle:"display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0;",
    containerBg:"background:#000a1a;",badgeBg:"",
  },
};
function renderShop(tab){
  tab=tab||"ui";
  let coins=shopData.coins;
  let ownedUIs=shopData.ownedUIs||["arknight"];
  let ownedFonts=shopData.ownedFonts||["default"];
  let activeThemeId=shopData.activeUI||"arknight";

  // Preload the active theme's fonts so shop UI uses them immediately
  preloadShopFont(activeThemeId);

  // â”€â”€ UI SKINS TAB â”€â”€
  let uiItemsHtml=UI_THEMES.map(item=>{
    let owned=ownedUIs.includes(item.id)||item.auto;
    let isActive=shopData.activeUI===item.id;
    let action=isActive?"":owned?`data-action="equipUI:${item.id}"`:`data-action="buyUI:${item.id}"`;
    let renderer=THEME_CARD_RENDERS[item.id];
    if(renderer)return renderer(item,owned,isActive,action);
    let p=item.preview;
    return `<div class="shop-item${owned?' owned':''}${isActive?' active-ui':''}" ${action}>
      <div class="shop-item-preview" style="background:${p.bg};color:${p.accent};font-family:'Share Tech Mono',monospace;border:1px solid ${p.border};">${p.label}</div>
      <div class="shop-item-name">${item.name}</div>
      ${_shopBadge(isActive,owned,item.price,'#3a9a5c','#3a9a5c','var(--accent)','var(--accent-dim)')}
    </div>`;
  }).join("");

  // â”€â”€ FONTS TAB â”€â”€
  let fontItemsHtml=FONT_ITEMS.map(item=>{
    let owned=ownedFonts.includes(item.id)||item.auto;
    let isActive=shopData.activeFont===item.id;
    let action=isActive?"":owned?`data-action="equipFont:${item.id}"`:`data-action="buyFont:${item.id}"`;
    return `<div class="shop-item${owned?' owned':''}${isActive?' active-ui':''}" ${action} style="grid-column:span 2;">
      <div class="shop-item-preview" style="background:var(--bg-deep);color:var(--accent);font-family:${item.family};border:1px solid var(--border);font-size:16px;letter-spacing:2px;">Aa ã‚ æ¼¢</div>
      <div class="shop-item-name" style="font-family:${item.family};">${item.name}</div>
      <div style="font-family:${item.family};font-size:11px;color:var(--text-dim);margin-top:2px;letter-spacing:1px;">The quick brown fox â€” ç´ æ—©ã„èŒ¶è‰²</div>
      ${_shopBadge(isActive,owned,item.price,'#3a9a5c','#3a9a5c','var(--accent)','var(--accent-dim)')}
    </div>`;
  }).join("");

  // â”€â”€ TAB SWITCHER + CONTENT â”€â”€
  let tabBar=`<div style="display:flex;gap:6px;margin-bottom:16px;">
    <button class="shop-tab${tab==='ui'?' active-tab':''}" data-action="renderShop:ui" style="width:auto;margin:0;padding:8px 18px;">ðŸŽ¨ SKINS</button>
    <button class="shop-tab${tab==='font'?' active-tab':''}" data-action="renderShop:font" style="width:auto;margin:0;padding:8px 18px;">Aa FONTS</button>
  </div>`;

  let activeItemsHtml=tab==='font'?fontItemsHtml:uiItemsHtml;

  // Use per-theme shell renderer, fallback to arknight
  let shellRenderer=SHOP_RENDERS[activeThemeId]||SHOP_RENDERS.arknight;
  app.innerHTML=shellRenderer(coins,activeItemsHtml,tabBar);
}

function buyUI(id){
  let item=UI_THEMES.find(i=>i.id===id);
  if(!item)return;
  if(shopData.coins<item.price){showShopToast("âš  NOT ENOUGH COINS","#cc4444");return;}
  shopData.coins-=item.price;
  if(!shopData.ownedUIs.includes(id))shopData.ownedUIs.push(id);
  shopData.activeUI=id;
  saveAll();applyTheme();showShopToast(`âœ“ ${item.name} EQUIPPED`,"var(--green)");
  renderShop("ui");
}
function equipUI(id){
  let item=UI_THEMES.find(i=>i.id===id);
  if(!item)return;
  shopData.activeUI=id;
  saveAll();applyTheme();showShopToast(`âœ“ ${item.name} EQUIPPED`,"var(--green)");
  renderShop("ui");
}
function buyFont(id){
  let item=FONT_ITEMS.find(i=>i.id===id);
  if(!item)return;
  if(shopData.coins<item.price){showShopToast("âš  NOT ENOUGH COINS","#cc4444");return;}
  shopData.coins-=item.price;
  if(!shopData.ownedFonts.includes(id))shopData.ownedFonts.push(id);
  shopData.activeFont=id;
  saveAll();applyTheme();showShopToast(`âœ“ ${item.name} APPLIED`,"var(--green)");
  renderShop("font");
}
function equipFont(id){
  let item=FONT_ITEMS.find(i=>i.id===id);
  if(!item)return;
  shopData.activeFont=id;
  saveAll();applyTheme();showShopToast(`âœ“ ${item.name} APPLIED`,"var(--green)");
  renderShop("font");
}
function showShopToast(msg,color){
  let t=document.createElement("div");
  t.className="ach-toast";
  t.style.borderLeftColor=color||"var(--accent)";
  t.innerHTML=`<div class="ach-toast-name" style="color:${color||'var(--accent)'};">${msg}</div>`;
  document.body.appendChild(t);
  setTimeout(()=>{t.style.transition="opacity 0.3s";t.style.opacity="0";setTimeout(()=>t.remove(),300);},2000);
}

/* Grant coins when XP goes up */
function openAdminPanel(){
  let overlay=document.createElement("div");
  overlay.id="admin-overlay";
  overlay.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:99999;display:flex;align-items:center;justify-content:center;";
  overlay.innerHTML=`
    <div style="background:#10141c;border:1px solid #9c55d0;padding:28px 24px;min-width:280px;max-width:340px;width:90%;font-family:'Share Tech Mono',monospace;position:relative;">
      <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#9c55d0,#c080ff);"></div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;letter-spacing:3px;color:#c080ff;margin-bottom:6px;">ADMIN ACCESS</div>
      <div style="font-size:9px;color:#6e7a8a;letter-spacing:2px;margin-bottom:18px;">ENTER AUTHORIZATION CODE</div>
      <input id="admin-pw-input" type="password" placeholder="PASSWORD" style="width:100%;background:#0a0c10;border:1px solid #3a3a5c;color:#d4cfc4;padding:10px 12px;font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:2px;outline:none;margin-bottom:12px;" />
      <div id="admin-pw-error" style="font-size:9px;color:#c94040;letter-spacing:2px;height:14px;margin-bottom:10px;"></div>
      <div style="display:flex;gap:8px;">
        <button onclick="document.getElementById('admin-overlay').remove()" style="flex:1;padding:10px;margin:0;background:transparent;border:1px solid #2a3344;color:#6e7a8a;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;cursor:pointer;">CANCEL</button>
        <button onclick="submitAdminPassword()" style="flex:1;padding:10px;margin:0;background:rgba(156,85,208,0.15);border:1px solid #9c55d0;color:#c080ff;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;cursor:pointer;">CONFIRM</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  setTimeout(()=>document.getElementById("admin-pw-input")?.focus(),50);
  document.getElementById("admin-pw-input").addEventListener("keydown",e=>{if(e.key==="Enter")submitAdminPassword();});
}
function submitAdminPassword(){
  let val=document.getElementById("admin-pw-input")?.value||"";
  if(val==="becomeeverythingforthem"){
    document.getElementById("admin-overlay")?.remove();
    shopData.coins=999999999;
    saveAll();
    showShopToast("âœ“ UNLIMITED FUNDS GRANTED","#9c55d0");
    renderShop("ui");
  } else {
    let err=document.getElementById("admin-pw-error");
    if(err){err.textContent="âœ— INVALID AUTHORIZATION CODE";}
    let input=document.getElementById("admin-pw-input");
    if(input){input.style.borderColor="#c94040";setTimeout(()=>{input.style.borderColor="#3a3a5c";},800);}
  }
}
function grantShopCoins(xpGained){
  let coinsEarned=Math.floor(xpGained/10);
  if(coinsEarned>0){shopData.coins=(shopData.coins||0)+coinsEarned;saveAll();}
}

/* â”€â”€ MENU â”€â”€ */
function renderMenu(){
  ensureDailyMissions();updateDailyStreak();
  let achs=checkAchievements();
  achs.forEach((a,i)=>setTimeout(()=>showAchievementToast(a),400+i*3300));
  let streakEmoji=globalStats.grindDays>=7?"ðŸ”¥":globalStats.grindDays>=3?"ðŸŒŸ":"ðŸ“…";
  // Current hardness multiplier based on resetCount
  let currentMult=1.0;
  let rach=RESET_ACHIEVEMENTS.filter(r=>resetCount>=r.resets);
  if(rach.length>0)currentMult=rach[rach.length-1].mult;
  let resetBadge=resetCount>0?`<div class="ark-badge" style="color:var(--purple);border-color:var(--purple);background:rgba(156,85,208,0.1);">RESET Ã—${resetCount} | ${currentMult}Ã— HARD</div>`:'';
  app.innerHTML=`<div class="container">
    <div class="ark-header"><div style="flex:1;"><div class="ark-title">KOTOBA <span>TRAINER</span></div><div class="ark-badge">PROTOCOL v3.0 // RHODES ISLAND</div>${resetBadge}</div>
    <div style="display:flex;flex-direction:column;align-items:center;gap:3px;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;">${t('langLabel')}</div>
      <button id="btn-lang-toggle" style="width:auto;min-width:52px;padding:5px 12px;font-size:12px;font-weight:700;border-color:var(--accent-dim);color:var(--accent);justify-content:center;letter-spacing:2px;">${t('langBtn')}</button>
    </div>
    </div>
    ${renderXpBar()}
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">${t('operator')}</div><div class="ark-stat-value" style="font-size:13px;">${currentProfile||'---'}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${streakEmoji} ${t('streak')}</div><div class="ark-stat-value">${globalStats.grindDays}d</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${t('missions')}</div><div class="ark-stat-value" style="color:${dailyMissions.done.length===dailyMissions.missions.length?'var(--green)':'var(--accent)'};">${dailyMissions.done.length}/${dailyMissions.missions.length}</div></div>
    </div>
    <div class="ark-section">${t('menu')}</div>
    <button data-action="renderProfile">${t('deployOp')}</button>
    <button data-action="renderStats">${t('combatRec')}</button>
    <button data-action="renderAchievements">${t('achiev')}</button>
    <button data-action="renderDailyMissions">${t('dailyMiss')}</button>
    <button data-action="renderKotoba">${t('vocabDB')}</button>
    <button data-action="renderHistory">${t('sessHist')}</button>
    <button data-action="renderShare">${t('transmit')}</button>
    <button data-action="renderAdventureEntry" style="border-color:rgba(156,85,208,0.5);color:#c080ff;background:rgba(100,40,180,0.08);position:relative;overflow:hidden;">âš”ï¸ &nbsp;ADVENTURE MODE <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:#8050b0;margin-left:auto;">QUEST</span></button>
    <button data-action="renderShop:ui" style="border-color:rgba(240,192,96,0.4);color:#f0c060;background:rgba(240,192,96,0.05);">ðŸª™ &nbsp;OPERATOR SHOP <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-left:auto;">${shopData.coins} COINS</span></button>
    <button id="btn-how-to-play" style="border-color:var(--blue);color:var(--blue);background:rgba(58,114,176,0.05);">${t('howToPlay')}</button>
    <div class="ark-ticker">// RHODES ISLAND PHARMACEUTICAL // TRAINING PROTOCOL ACTIVE // ${globalStats.grindDays} DAY STREAK //</div>
  </div>`;
  document.getElementById("btn-lang-toggle").addEventListener("click",()=>{
    appLang=appLang==="jp"?"en":"jp";saveAll();renderMenu();
  });
  document.getElementById("btn-how-to-play").addEventListener("click", renderHowToPlay);
}

/* â”€â”€ HOW TO PLAY â”€â”€ */
function renderHowToPlay(){
  let isJP=appLang==='jp';

  let sections=isJP?`
    <div class="ark-section">ðŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ä½œã‚Šæ–¹</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--accent);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:1.9;letter-spacing:0.5px;margin:0;">
        1. ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ <span style="color:var(--accent);">ã€Œã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆã€</span> ã‚’é¸æŠž<br>
        2. <span style="color:var(--accent);">ã€Œã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼åã€</span> ã®å…¥åŠ›æ¬„ã«åå‰ã‚’å…¥åŠ›ã™ã‚‹<br>
        3. CSVãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆã§å˜èªžã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹<br>
        4. <span style="color:var(--accent);">ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã€</span> ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ä½œæˆå®Œäº†ï¼
      </p>
    </div>

    <div class="ark-section">ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªžãƒ¢ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå½¢å¼</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--accent);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:1.8;margin:0 0 10px;">
        å„è¡Œã‚’ä»¥ä¸‹ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š<br>
        <span style="color:var(--accent2);font-size:13px;letter-spacing:1px;">æ¼¢å­—,ã²ã‚‰ãŒãª,æ„å‘³</span>
      </p>
      <div style="background:var(--bg-deep);border:1px solid var(--border);padding:12px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--green);line-height:2.1;">
        æ—¥æœ¬èªž,ã«ã»ã‚“ã”,Japanese language<br>
        å­¦æ ¡,ãŒã£ã“ã†,school<br>
        é£Ÿã¹ã‚‹,ãŸã¹ã‚‹,to eat<br>
        é›»è»Š,ã§ã‚“ã—ã‚ƒ,train<br>
        å‹é”,ã¨ã‚‚ã ã¡,friend
      </div>
      <p style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin:8px 0 0;line-height:1.7;">
        â€» 3åˆ—å¿…é ˆï¼šæ¼¢å­— / ã²ã‚‰ãŒãª / æ„å‘³<br>
        â€» ã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Šã€1è¡Œ1å˜èªž
      </p>
    </div>

    <div class="ark-section">ðŸŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå½¢å¼</div>
    <div style="background:var(--bg-card);border:1px solid rgba(58,114,176,0.4);border-left:3px solid var(--blue);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:1.8;margin:0 0 10px;">
        ã²ã‚‰ãŒãªãŒä¸è¦ãªå ´åˆã¯2åˆ—ç›®ã« <span style="color:var(--accent2);">ã€Œ-ã€</span> ã‚’å…¥ã‚Œã‚‹ã ã‘ï¼š<br>
        <span style="color:var(--accent2);font-size:13px;letter-spacing:1px;">å˜èªž,-,æ„å‘³</span>
      </p>
      <div style="background:var(--bg-deep);border:1px solid var(--border);padding:12px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--green);line-height:2.1;">
        apple,-,ã‚Šã‚“ã”<br>
        cat,-,çŒ«<br>
        é‹å‹•,-,exercise<br>
        å‹‡æ°—,-,courage
      </div>
      <p style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin:8px 0 0;line-height:1.7;">
        â€» 2åˆ—ç›®ã¯ä½¿ã‚ã‚Œã¾ã›ã‚“ã€‚ä½•ã‚’å…¥ã‚Œã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚
      </p>
    </div>

    <div class="ark-section">ðŸŽ® ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ä¸€è¦§</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--accent);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:2.2;margin:0;">
        â—ˆ <span style="color:var(--accent2);">å››æŠžã‚¯ã‚¤ã‚º</span> â€” 4ã¤ã®é¸æŠžè‚¢ã‹ã‚‰æ­£è§£ã‚’é¸ã¶ã€‚ç´ æ—©ãå­¦ç¿’ã™ã‚‹ã®ã«æœ€é©ï¼<br>
        âœŽ <span style="color:var(--accent2);">æ‰‹å‹•å…¥åŠ›</span> â€” ç­”ãˆã‚’è‡ªåˆ†ã§ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ã™ã‚‹ã€‚ã‚ˆã‚Šæ·±ã„å®šç€ã‚’ç›®æŒ‡ã›ã‚‹ï¼<br>
        ðŸ”¤ <span style="color:var(--accent2);">æ–‡å­—ä¸¦ã³æ›¿ãˆ</span> â€” ãƒãƒ©ãƒãƒ©ã«ãªã£ãŸæ–‡å­—ã‚’æ­£ã—ã„é †ç•ªã«ä¸¦ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰ã€‚<br>
        â˜  <span style="color:var(--red);">ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰</span> â€” ã‚¿ã‚¤ãƒžãƒ¼åˆ¶ï¼‹ãƒ©ã‚¤ãƒ•åˆ¶ã®ç·Šå¼µæ„Ÿã‚ã‚‹ãƒ¢ãƒ¼ãƒ‰ã€‚è©³ã—ãã¯ä¸‹è¨˜å‚ç…§ã€‚<br>
        âš”ï¸ <span style="color:#c080ff;">ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼</span> â€” ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è‚²ã¦ãªãŒã‚‰å˜èªžå­¦ç¿’ã™ã‚‹RPGãƒ¢ãƒ¼ãƒ‰ï¼
      </p>
    </div>

    <div class="ark-section">â˜  ãƒãƒ¼ãƒ‰ã‚³ã‚¢ãƒ¢ãƒ¼ãƒ‰</div>
    <div style="background:rgba(201,64,64,0.07);border:1px solid rgba(201,64,64,0.3);border-left:3px solid var(--red);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:2;margin:0;">
        ðŸ”´ <span style="color:var(--red);">ã‚¿ã‚¤ãƒžãƒ¼åˆ¶é™</span> â€” æ™‚é–“å†…ã«ç­”ãˆãªã„ã¨ãƒ©ã‚¤ãƒ•ã‚’å¤±ã†<br>
        ðŸ”´ <span style="color:var(--red);">ãƒ©ã‚¤ãƒ•åˆ¶ â¤â¤â¤â¤</span> â€” ãƒ©ã‚¤ãƒ•ãŒ0ã§ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼<br>
        ðŸ”´ ãƒŸã‚¹ã™ã‚‹ã¨XPãŒæ¸›å°‘ï¼ˆâˆ’15XPï¼‰<br>
        ðŸ”´ ã‚¿ã‚¤ãƒžãƒ¼æ™‚é–“ã¯ã‚²ãƒ¼ãƒ è¨­å®šç”»é¢ã§å¤‰æ›´å¯èƒ½<br>
        â­ å…¨å•æ­£è§£ã™ã‚‹ã¨ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¹ã‚¿ãƒ¼å®Ÿç¸¾ã‚’ç²å¾—ï¼
      </p>
    </div>

    <div class="ark-section">âš”ï¸ ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ¢ãƒ¼ãƒ‰</div>
    <div style="background:rgba(100,40,180,0.08);border:1px solid rgba(156,85,208,0.4);border-left:3px solid var(--purple);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:2.1;margin:0 0 10px;">
        ðŸ—ºï¸ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒžãƒƒãƒ—ã‚’é€²ã¿ãªãŒã‚‰æ•µã¨æˆ¦ã„ã€å˜èªžã‚’å­¦ã¶RPGãƒ¢ãƒ¼ãƒ‰ï¼<br>
        ðŸ‘¤ <span style="color:#c080ff;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠž</span> â€” ãƒ’ãƒ­ï¼ˆãƒãƒ©ãƒ³ã‚¹ï¼‰ãƒ»ãƒ­ã‚¯ï¼ˆã‚¢ã‚¿ãƒƒã‚«ãƒ¼ï¼‰ãƒ»ã‚­ã‚µãƒ©ã‚®ï¼ˆã‚¿ãƒ³ã‚¯ï¼‰<br>
        âš”ï¸ <span style="color:#c080ff;">æˆ¦é—˜ã‚·ã‚¹ãƒ†ãƒ </span> â€” å•é¡Œã«æ­£è§£ã™ã‚‹ã¨æ”»æ’ƒã€å¤±æ•—ã™ã‚‹ã¨ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã‚‹<br>
        âœŽ/âŠž <span style="color:#c080ff;">å…¥åŠ›åˆ‡æ›¿</span> â€” æˆ¦é—˜ä¸­ã«é¸æŠžå¼â†”å…¥åŠ›å¼ã‚’ã„ã¤ã§ã‚‚åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹<br>
        ðŸª <span style="color:var(--accent);">ã‚·ãƒ§ãƒƒãƒ—</span> â€” é€”ä¸­ã§æ­¦å™¨ãƒ»é˜²å…·ãƒ»ã‚¢ã‚¤ãƒ†ãƒ ã‚’è³¼å…¥å¯èƒ½<br>
        â¬†ï¸ <span style="color:var(--accent);">è‚²æˆ</span> â€” çµŒé¨“å€¤ã§ã‚­ãƒ£ãƒ©ã‚’ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚‚å¼·åŒ–ã§ãã‚‹<br>
        ðŸ‘¹ <span style="color:var(--red);">ãƒŸãƒ‹ãƒœã‚¹ãƒ»ãƒœã‚¹</span> â€” å¼·æ•µã«å‹åˆ©ã™ã‚‹ã¨å¤§é‡ã®ã‚´ãƒ¼ãƒ«ãƒ‰ã¨XPã‚’ç²å¾—ï¼<br>
        ðŸ’€ <span style="color:#9900ff;">éš ã—ãƒœã‚¹</span> â€” 100ã‚¹ãƒ†ãƒ¼ã‚¸å‹åˆ©ã§ã‚¯ãƒ­ãƒŽãƒ´ã‚©ã‚¢ãŒå‡ºç¾ï¼<br>
        ðŸ“– <span style="color:var(--text-dim);">å›³é‘‘</span> â€” å€’ã—ãŸæ•µã®ãƒ‡ãƒ¼ã‚¿ã‚’å›³é‘‘ã«è¨˜éŒ²ã€‚å…¨åˆ¶è¦‡ã‚’ç›®æŒ‡ãã†ï¼<br>
        âš ï¸ ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã«ã¯æœ€ä½Ž100å˜èªžãŒå¿…è¦ã§ã™ã€‚
      </p>
    </div>`

  :`
    <div class="ark-section">ðŸ‘¤ How to Create a Profile</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--accent);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:1.9;letter-spacing:0.5px;margin:0;">
        1. From the main menu tap <span style="color:var(--accent);">"Start Game"</span><br>
        2. Type a name in the <span style="color:var(--accent);">"Operator Designation"</span> field<br>
        3. Import vocabulary via CSV file or paste text in the box below<br>
        4. Hit <span style="color:var(--accent);">"Import"</span> â€” your profile is ready!
      </p>
    </div>

    <div class="ark-section">ðŸ‡¯ðŸ‡µ Japanese Mode â€” Import Format</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--accent);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:1.8;margin:0 0 10px;">
        Each line must follow this format:<br>
        <span style="color:var(--accent2);font-size:13px;letter-spacing:1px;">Kanji,Hiragana,Meaning</span>
      </p>
      <div style="background:var(--bg-deep);border:1px solid var(--border);padding:12px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--green);line-height:2.1;">
        æ—¥æœ¬èªž,ã«ã»ã‚“ã”,Japanese language<br>
        å­¦æ ¡,ãŒã£ã“ã†,school<br>
        é£Ÿã¹ã‚‹,ãŸã¹ã‚‹,to eat<br>
        é›»è»Š,ã§ã‚“ã—ã‚ƒ,train<br>
        å‹é”,ã¨ã‚‚ã ã¡,friend
      </div>
      <p style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin:8px 0 0;line-height:1.7;">
        â€» 3 columns required: Kanji / Hiragana / Meaning<br>
        â€» Comma-separated, one word per line, no headers
      </p>
    </div>

    <div class="ark-section">ðŸŒ Global Mode â€” Import Format</div>
    <div style="background:var(--bg-card);border:1px solid rgba(58,114,176,0.4);border-left:3px solid var(--blue);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:1.8;margin:0 0 10px;">
        Global mode ignores hiragana. Just put <span style="color:var(--accent2);">"-"</span> in column 2:<br>
        <span style="color:var(--accent2);font-size:13px;letter-spacing:1px;">Word,-,Meaning</span>
      </p>
      <div style="background:var(--bg-deep);border:1px solid var(--border);padding:12px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--green);line-height:2.1;">
        apple,-,ã‚Šã‚“ã”<br>
        cat,-,çŒ«<br>
        é‹å‹•,-,exercise<br>
        å‹‡æ°—,-,courage
      </div>
      <p style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin:8px 0 0;line-height:1.7;">
        â€» Column 2 is ignored â€” put anything there, it doesn't matter.
      </p>
    </div>

    <div class="ark-section">ðŸŽ® Game Modes Overview</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--accent);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:2.2;margin:0;">
        â—ˆ <span style="color:var(--accent2);">Multi-Choice Protocol</span> â€” Pick the correct answer from 4 options. Great for speed learning!<br>
        âœŽ <span style="color:var(--accent2);">Manual Input Protocol</span> â€” Type the answer yourself. Builds deeper retention.<br>
        ðŸ”¤ <span style="color:var(--accent2);">Word Sort Protocol</span> â€” Rearrange scrambled characters into the correct word.<br>
        â˜  <span style="color:var(--red);">Hardcore Mode</span> â€” Timer + lives system for high-pressure training. See details below.<br>
        âš”ï¸ <span style="color:#c080ff;">Adventure Mode</span> â€” An RPG where you level up a character while mastering vocabulary!
      </p>
    </div>

    <div class="ark-section">â˜  Hardcore Mode</div>
    <div style="background:rgba(201,64,64,0.07);border:1px solid rgba(201,64,64,0.3);border-left:3px solid var(--red);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:2;margin:0;">
        ðŸ”´ <span style="color:var(--red);">Timer pressure</span> â€” answer before the bar runs out or lose a life<br>
        ðŸ”´ <span style="color:var(--red);">4 lives â¤â¤â¤â¤</span> â€” reach zero and it's game over<br>
        ðŸ”´ Each wrong answer deducts XP (âˆ’15XP per miss)<br>
        ðŸ”´ Timer length is adjustable in the Game Config screen<br>
        â­ Beat a full session without dying to unlock the Speedster achievement!
      </p>
    </div>

    <div class="ark-section">âš”ï¸ Adventure Mode</div>
    <div style="background:rgba(100,40,180,0.08);border:1px solid rgba(156,85,208,0.4);border-left:3px solid var(--purple);padding:16px;margin-bottom:10px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);">
      <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text);line-height:2.1;margin:0 0 10px;">
        ðŸ—ºï¸ An RPG-style mode where you fight enemies across a stage map while mastering words!
      </p>
      <div style="background:var(--bg-deep);border:1px solid rgba(156,85,208,0.3);padding:12px;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text);line-height:2.0;margin-bottom:10px;">
        ðŸ‘¤ <span style="color:#c080ff;">Choose a Character</span> â€” Each has unique stats:<br>
        &nbsp;&nbsp;&nbsp;â€¢ <span style="color:var(--accent);">HIRO</span> â€” Balanced fighter (HP 100 Â· ATK 18 Â· DEF 10 Â· SPD 8)<br>
        &nbsp;&nbsp;&nbsp;â€¢ <span style="color:var(--red);">ROKU</span> â€” Glass cannon (HP 75 Â· ATK 28 Â· DEF 6 Â· SPD 15)<br>
        &nbsp;&nbsp;&nbsp;â€¢ <span style="color:var(--blue);">KISARAGI</span> â€” Tank (HP 120 Â· ATK 22 Â· DEF 16 Â· SPD 6)
      </div>
      <div style="background:var(--bg-deep);border:1px solid rgba(156,85,208,0.3);padding:12px;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text);line-height:2.0;margin-bottom:10px;">
        âš”ï¸ <span style="color:#c080ff;">Combat</span> â€” Answer vocabulary questions to deal damage.<br>
        &nbsp;&nbsp;&nbsp;â€¢ Correct answer â†’ your character attacks the enemy<br>
        &nbsp;&nbsp;&nbsp;â€¢ Wrong answer â†’ enemy attacks you<br>
        &nbsp;&nbsp;&nbsp;â€¢ Use SP (skill points) to unleash special skills!<br>
        &nbsp;&nbsp;&nbsp;â€¢ Toggle âŠž CHOICE / âœŽ TYPE mode anytime during battle
      </div>
      <div style="background:var(--bg-deep);border:1px solid rgba(156,85,208,0.3);padding:12px;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text);line-height:2.0;margin-bottom:10px;">
        ðŸ—ºï¸ <span style="color:#c080ff;">Stage Map</span> â€” 30 stages across multiple zones.<br>
        &nbsp;&nbsp;&nbsp;â€¢ Normal stages â†’ fight regular enemies<br>
        &nbsp;&nbsp;&nbsp;â€¢ âš¡ Mini-Boss stages â†’ tougher enemies, bigger rewards<br>
        &nbsp;&nbsp;&nbsp;â€¢ ðŸª Shop stages â†’ buy weapons, armor, and items<br>
        &nbsp;&nbsp;&nbsp;â€¢ ðŸ‘‘ Final Boss â†’ defeat Demon King Malachar to win the run!
      </div>
      <div style="background:var(--bg-deep);border:1px solid rgba(156,85,208,0.3);padding:12px;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text);line-height:2.0;margin-bottom:10px;">
        â¬†ï¸ <span style="color:var(--accent);">Progression</span> â€” Your character gains XP and gold after each battle.<br>
        &nbsp;&nbsp;&nbsp;â€¢ Level up to increase stats (ATK / DEF / HP / SPD)<br>
        &nbsp;&nbsp;&nbsp;â€¢ Equip weapons and armor to power up further<br>
        &nbsp;&nbsp;&nbsp;â€¢ ðŸ” New Game+ carries over gear and gold with harder enemies
      </div>
      <div style="background:rgba(153,0,255,0.07);border:1px solid rgba(153,0,255,0.35);padding:12px;font-family:'Share Tech Mono',monospace;font-size:10px;color:#cc44ff;line-height:2.0;">
        ðŸ’€ <span style="color:#ffffff;font-weight:700;">HIDDEN BOSS â€” CHRONOVORE</span><br>
        Win 100 stages total to awaken the CHRONOVORE â€” a time-devouring entity that is more powerful than any regular boss. Defeating it earns the <span style="color:var(--accent);">Shadow Hunter</span> achievement and 1500 gold!
      </div>
      <p style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin:10px 0 0;line-height:1.6;">
        âš  Requires at least 100 words in your profile to start.<br>
        âš  Adventure progress is saved per character â€” your HP carries between stages.
      </p>
    </div>`;

  app.innerHTML=`<div class="container">
    <div class="ark-header">
      <button class="back" data-action="renderMenu">${t('back')}</button>
      <div class="ark-title">${isJP?'éŠã³æ–¹ <span>ã‚¬ã‚¤ãƒ‰</span>':'How to <span>Play</span>'}</div>
    </div>
    ${sections}
    <button data-action="renderMenu" style="justify-content:center;margin-top:6px;border-color:var(--accent-dim);color:var(--accent);">â¬¡ &nbsp;${isJP?'ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹':'Return to Main Menu'}</button>
  </div>`;
}
/* â”€â”€ DAILY MISSIONS â”€â”€ */
function renderDailyMissions(){
  ensureDailyMissions();
  let html=dailyMissions.missions.map(m=>{
    let done=dailyMissions.done.includes(m.id);
    let prog=dailyProgress[m.type]||0;
    let pct=Math.min(100,Math.floor((prog/m.target)*100));
    let lang=T[appLang]||T.en;
    let title=(lang.missionTitles&&lang.missionTitles[m.id])||m.title;
    return `<div class="daily-card ${done?'done':''}"><div class="daily-check">${done?'âœ…':'â¬œ'}</div><div class="daily-info"><div class="daily-title">${title}</div><div class="daily-prog">${Math.min(prog,m.target)} / ${m.target}${done?` â€” ${appLang==='jp'?'å®Œäº†':'COMPLETE'}`:''}</div><div class="ark-progress" style="margin-top:6px;"><div class="ark-progress-fill" style="width:${pct}%;"></div></div></div><div class="daily-reward">+${m.reward} XP</div></div>`;
  }).join('');
  let r=new Date();r.setHours(24,0,0,0);let ms=r-Date.now();
  let hL=Math.floor(ms/3600000),mL=Math.floor((ms%3600000)/60000);
  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderMenu">${t('back')}</button><div class="ark-title">${appLang==='jp'?'ãƒ‡ã‚¤ãƒªãƒ¼ <span>ãƒŸãƒƒã‚·ãƒ§ãƒ³</span>':'Daily <span>Missions</span>'}</div><div class="ark-badge" style="margin-left:auto;">${t('resets')} ${hL}h ${mL}m</div></div>
    ${renderXpBar()}
    <div class="ark-section">${t('todayMissions')}</div>${html}
    <div class="ark-section">${t('grindStreak')}</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);padding:20px;clip-path:polygon(8px 0%,100% 0%,100% calc(100% - 8px),calc(100% - 8px) 100%,0% 100%,0% 8px);text-align:center;">
      <div class="streak-fire">ðŸ”¥</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:50px;font-weight:700;color:var(--accent);line-height:1;">${globalStats.grindDays}</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--text-dim);">${t('dayStreak')}</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:8px;">${t('keepStreak')}</div>
    </div>
  </div>`;
}

/* â”€â”€ ACHIEVEMENTS â”€â”€ */
function renderAchievements(){
  let achs=getAchievements();
  let hm=getHardnessMult();
  let unlockedReset=achs.filter(a=>achievements[a.id]).length;
  let unlockedFixed=FIXED_ACHIEVEMENTS.filter(a=>achievements[a.id]).length;
  let allDone=unlockedReset===achs.length;
  let profile=currentProfile?profiles[currentProfile]:null;
  let masteredCount=profile&&profile.words?profile.words.filter(w=>(w.correct||0)>=5).length:0;

  function getCurrentVal(a){
    if(a.type==="totalCorrect") return globalStats.totalCorrect||0;
    if(a.type==="level") return globalStats.level||0;
    if(a.type==="totalSessions") return globalStats.totalSessions||0;
    if(a.type==="grindDays") return globalStats.grindDays||0;
    if(a.type==="masteredWords") return masteredCount;
    return achievements[a.id]?1:0;
  }

  function makeResetCard(a){
    let done=!!achievements[a.id];
    let cur=getCurrentVal(a);
    let req=a.threshold||a.base||1;
    let pct=a.base>0?Math.min(100,Math.floor((Math.min(cur,req)/req)*100)):done?100:0;
    let hardTag=(hm>1&&a.base>0)?`<span style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--red);letter-spacing:1px;"> Ã—${hm}</span>`:'';
    let prog=done?'':a.base>0?`<div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);margin-top:4px;">${Math.min(cur,req)} / ${req}</div><div class="ark-progress" style="margin-top:2px;"><div class="ark-progress-fill" style="width:${pct}%;"></div></div>`:'';
    return `<div class="ach-card ${done?'unlocked':'locked'}">
      <div class="ach-icon">${a.icon}</div>
      <div class="ach-name">${a.name}${hardTag}</div>
      <div class="ach-desc">${a.desc}</div>
      <div class="ach-reward">+${a.reward} XP${done?' âœ“':''}</div>
      ${prog}
    </div>`;
  }

  function makeFixedCard(a){
    let done=!!achievements[a.id];
    return `<div class="ach-card ${done?'unlocked':'locked'}" style="${done?'border-color:var(--blue);':''}">
      ${done?`<div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#3a72b0,#60a0e0);"></div>`:''}
      <div class="ach-icon">${a.icon}</div>
      <div class="ach-name" style="${done?'color:var(--accent2);':''}">${a.name} <span style="font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--blue);letter-spacing:1px;">FIXED</span></div>
      <div class="ach-desc">${a.desc}</div>
      <div class="ach-reward" style="color:var(--blue);">+${a.reward} XP${done?' âœ“':''}</div>
    </div>`;
  }

  let resetCards=achs.map(makeResetCard).join('');
  let fixedCards=FIXED_ACHIEVEMENTS.map(makeFixedCard).join('');

  let hardBanner=hm>1?`<div style="background:rgba(201,64,64,0.08);border:1px solid rgba(201,64,64,0.3);border-left:3px solid var(--red);padding:10px 14px;margin-bottom:12px;">
    <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--red);letter-spacing:2px;">${(t('hardnessBanner')).replace('{N}',resetCount).replace('{M}',hm)}</div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:3px;">${appLang==='jp'?`ä¾‹: "100å•æ­£è§£" â†’ "${Math.round(100*hm)}å•æ­£è§£" Â· "10ã‚³ãƒ³ãƒœ" â†’ "${Math.round(10*hm)}ã‚³ãƒ³ãƒœ"`:`e.g. "100 correct" â†’ "${Math.round(100*hm)} correct" Â· "10 combo" â†’ "${Math.round(10*hm)} combo"`}</div>
  </div>`:'';

  let currentMult=1.0,nextReset=null;
  RESET_ACHIEVEMENTS.forEach(r=>{if(resetCount>=r.resets)currentMult=r.mult;else if(!nextReset)nextReset=r;});

  let resetSection='';
  if(allDone){
    if(nextReset){
      let allCompleteText=t('allComplete').replace('{N}',achs.length);
      let prestigeBtnText=t('prestigeBtn').replace('{M}',nextReset.mult);
      let resetInfoEN=`Reset Ã—${resetCount} Â· Hardness ${currentMult}Ã— â†’ Next: ${nextReset.mult}Ã—`;
      let resetInfoJP=`ãƒªã‚»ãƒƒãƒˆ Ã—${resetCount} Â· é›£æ˜“åº¦ ${currentMult}Ã— â†’ æ¬¡: ${nextReset.mult}Ã—`;
      let threshInfoEN=`Clears resetable achievements & multiplies all thresholds by ${nextReset.mult}Ã—`;
      let threshInfoJP=`ãƒªã‚»ãƒƒãƒˆå¯èƒ½å®Ÿç¸¾ã‚’ã‚¯ãƒªã‚¢ã—ã€å…¨é–¾å€¤ã‚’${nextReset.mult}Ã—ã«ä¹—ç®—`;
      resetSection=`<div class="ark-section" style="color:var(--purple);">${t('prestigeReset')}</div>
      <div style="background:rgba(156,85,208,0.08);border:1px solid rgba(156,85,208,0.35);border-left:3px solid var(--purple);padding:12px 14px;margin-bottom:10px;">
        <div style="font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:var(--purple);">${allCompleteText}</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:4px;">${appLang==='jp'?resetInfoJP:resetInfoEN}</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:2px;">${appLang==='jp'?threshInfoJP:threshInfoEN}</div>
        <button id="btn-do-reset" style="margin-top:10px;border-color:rgba(156,85,208,0.5);color:var(--purple);justify-content:center;">${prestigeBtnText}</button>
      </div>`;
    } else {
      resetSection=`<div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--accent);text-align:center;padding:16px;border:1px solid var(--accent-dim);">${t('trueMax')}</div>`;
    }
  } else {
    let rem=achs.filter(a=>!achievements[a.id]).length;
    let remText=t('prestigeRemaining').replace('{R}',rem).replace('{C}',resetCount);
    resetSection=`<div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--border);padding:10px 14px;margin-top:10px;opacity:0.5;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text-dim);">${t('prestigeLocked')}</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:4px;">${remText}</div>
    </div>`;
  }

  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderMenu">${t('back')}</button><div class="ark-title">${appLang==='jp'?'å®Ÿç¸¾ <span>ã‚®ãƒ£ãƒ©ãƒªãƒ¼</span>':'Achievement <span>Gallery</span>'}</div><div class="ark-badge" style="margin-left:auto;">${unlockedReset+unlockedFixed}/${achs.length+FIXED_ACHIEVEMENTS.length}</div></div>
    <div class="ark-progress" style="margin-bottom:14px;"><div class="ark-progress-fill" style="width:${(achs.length+FIXED_ACHIEVEMENTS.length)?Math.floor((unlockedReset+unlockedFixed)/(achs.length+FIXED_ACHIEVEMENTS.length)*100):0}%;"></div></div>
    ${hardBanner}
    <div class="ark-section" style="color:var(--blue);">ðŸ”’ FIXED ACHIEVEMENTS <span style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:1px;"> â€” never reset Â· ${unlockedFixed}/${FIXED_ACHIEVEMENTS.length}</span></div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin:-4px 0 8px;letter-spacing:1px;">${appLang==='jp'?'// ä¸€åº¦è§£é™¤ã™ã‚‹ã¨æ°¸ä¹…ã«ä¿æŒã•ã‚Œã¾ã™ //':'// Once unlocked, kept forever â€” even after prestige reset //'}</div>
    <div class="ach-grid">${fixedCards}</div>
    <div class="ark-section" style="margin-top:16px;">ðŸ” RESETABLE ACHIEVEMENTS <span style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:1px;"> â€” ${unlockedReset}/${achs.length}</span></div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin:-4px 0 8px;letter-spacing:1px;">${appLang==='jp'?'// ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆå¾Œã«å†ç²å¾—ãŒå¿…è¦ //':'// Must be re-earned after prestige reset //'}</div>
    <div class="ach-grid">${resetCards}</div>
    ${resetSection}
  </div>`;

  let rb=document.getElementById("btn-do-reset");
  if(rb) rb.addEventListener("click",()=>{
    if(!nextReset)return;
    let confirmMsg=appLang==='jp'
      ?`ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆ #${resetCount+1}?\n\nãƒªã‚»ãƒƒãƒˆå¯èƒ½å®Ÿç¸¾ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ã€‚\nï¼ˆå›ºå®šå®Ÿç¸¾ã¯ä¿æŒã•ã‚Œã¾ã™ï¼‰\né›£æ˜“åº¦: ${currentMult}Ã— â†’ ${nextReset.mult}Ã—\nå…¨é–¾å€¤ Ã—${nextReset.mult}ï¼ˆä¾‹: 10ã‚³ãƒ³ãƒœ â†’ ${Math.ceil(10*nextReset.mult)}ã‚³ãƒ³ãƒœï¼‰\n\nXPãƒ»ãƒ¬ãƒ™ãƒ«ãƒ»å˜èªžãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚`
      :`PRESTIGE RESET #${resetCount+1}?\n\nResetable achievement unlocks CLEAR.\n(Fixed achievements are kept!)\nHardness: ${currentMult}Ã— â†’ ${nextReset.mult}Ã—\nAll thresholds Ã—${nextReset.mult} (e.g. 10 combo â†’ ${Math.ceil(10*nextReset.mult)} combo)\n\nXP, level, words and sessions are preserved.`;
    if(!confirm(confirmMsg))return;
    // Only clear resetable achievements, keep fixed ones
    let fixedIds=new Set(FIXED_ACHIEVEMENTS.map(a=>a.id));
    Object.keys(achievements).forEach(k=>{if(!fixedIds.has(k))delete achievements[k];});
    resetCount++;saveAll();
    let toastEl=document.createElement("div");toastEl.className="ach-toast";toastEl.style.borderLeftColor="var(--purple)";
    let resetToastMsg=appLang==='jp'?`ãƒªã‚»ãƒƒãƒˆå¯èƒ½å®Ÿç¸¾ã‚’ãƒªã‚»ãƒƒãƒˆ â€” å†åº¦ç²å¾—ã—ã‚ˆã†ï¼`:`RESETABLE ACHIEVEMENTS CLEARED â€” RE-EARN THEM!`;
    toastEl.innerHTML=`<div class="ach-toast-title" style="color:var(--purple);">ðŸ” ${appLang==='jp'?'ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸':'PRESTIGE'} #${resetCount}</div><div class="ach-toast-name">${appLang==='jp'?'é›£æ˜“åº¦':'Hardness'} ${getHardnessMult()}Ã—</div><div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--red);margin-top:4px;">${resetToastMsg}</div>`;
    document.body.appendChild(toastEl);setTimeout(()=>{toastEl.style.transition="opacity 0.3s";toastEl.style.opacity="0";setTimeout(()=>toastEl.remove(),300);},4000);
    renderAchievements();
  });
}

function renderProfile(){
  let profileNames=Object.keys(profiles).filter(n=>profiles[n]&&typeof profiles[n]==='object');
  let listHtml=profileNames.length
    ? profileNames.map((name,i)=>{
        let p=profiles[name];
        let lv=calcLevel((p&&typeof p.xp==='number'?p.xp:0));
        return `<button id="prof-btn-${i}" data-name="${name.replace(/"/g,'&quot;')}">â–¶ &nbsp;${name}<span style="margin-left:auto;font-size:11px;color:var(--accent-dim);">LV${lv}</span></button>`;
      }).join('')
    : '<p style="color:var(--text-dim);font-family:\'Share Tech Mono\',monospace;font-size:12px;padding:10px 0;">// NO OPERATORS REGISTERED //</p>';

  app.innerHTML=`<div class="container">
    <div class="ark-header"><button id="btn-back-profile" class="back">${t('back')}</button><div class="ark-title">${appLang==='jp'?'ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ <span>é¸æŠž</span>':'Operator <span>Select</span>'}</div></div>
    ${listHtml}
    <div class="ark-section">${t('newProfile')}</div>
    <input id="pname" placeholder="${appLang==='jp'?'ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼å':'OPERATOR DESIGNATION'}" type="text">
    <input type="file" id="csvfile" accept=".csv,.txt" style="display:none;">
    <button id="btn-choose-csv">ðŸ“‚ &nbsp;${appLang==='jp'?'CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠž':'Choose CSV File'}</button>
    <div id="csvFilename" style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--accent-dim);padding:4px 0;letter-spacing:1px;">${appLang==='jp'?'// ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠž //':'// NO FILE SELECTED //'}</div>
    <button id="btn-import-csv">âŠ• &nbsp;${appLang==='jp'?'CSVã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ':'Import from CSV'}</button>
    <hr>
    <textarea id="txtImport" placeholder="Kanji,Hiragana,Arti â€” one entry per line" style="height:110px;"></textarea>
    <button id="btn-import-text">âŠ• &nbsp;${appLang==='jp'?'ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ':'Import from Text'}</button>
    <hr>
    <button id="btn-delete-profile" style="border-color:rgba(201,64,64,0.4);color:var(--text-dim);">âœ• &nbsp;${appLang==='jp'?'ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤':'Remove Operator'}</button>
  </div>`;

  // Wire up events after render (avoids all quoting issues & PWA restrictions)
  document.getElementById("btn-back-profile").addEventListener("click", renderMenu);
  document.getElementById("btn-import-csv").addEventListener("click", createProfileCSV);
  document.getElementById("btn-import-text").addEventListener("click", createProfileText);
  document.getElementById("btn-delete-profile").addEventListener("click", deleteProfileMenu);

  // File input â€” direct user-gesture click forwarding (works in PWA)
  let csvInput=document.getElementById("csvfile");
  csvInput.addEventListener("change", handleCsvFileSelected);
  document.getElementById("btn-choose-csv").addEventListener("click", function(){
    csvInput.value="";
    csvInput.click();
  });

  // Profile select buttons
  profileNames.forEach((name,i)=>{
    let btn=document.getElementById("prof-btn-"+i);
    if(btn) btn.addEventListener("click", function(){ selectProfile(name); });
  });
}

function makeWordObj(kanji,hira,arti){return{kanji:kanji.trim(),hira:hira.trim(),arti:arti.trim(),correct:0,wrong:0,mastered:false,interval:1,nextReview:Date.now()};}
function handleCsvFileSelected(){
  let f=document.getElementById("csvfile").files[0];
  let el=document.getElementById("csvFilename");
  if(el&&f)el.textContent="// "+f.name+" //";
}
function createProfileCSV(){
  let name=document.getElementById("pname").value.trim(),file=document.getElementById("csvfile").files[0];
  if(!name||!file)return alert("Fill operator name & choose a CSV file");
  let r=new FileReader();
  r.onload=e=>{let data=[];e.target.result.split("\n").forEach(l=>{let [k,h,a]=l.split(",");if(k&&h&&a)data.push(makeWordObj(k,h,a));});
    if(!data.length)return alert("No valid data found in CSV!");
    profiles[name]={words:data,xp:0};saveAll();renderProfile();};
  r.readAsText(file);
}
function createProfileText(){
  let name=document.getElementById("pname").value.trim(),text=document.getElementById("txtImport").value.trim();
  if(!name||!text)return alert("Fill name & text");
  let data=[];text.split("\n").forEach(l=>{let [k,h,a]=l.split(",");if(k){if(a){data.push(makeWordObj(k,h||'',a));}else if(h){data.push(makeWordObj(k,'',h));}}});
  if(!data.length)return alert("Invalid text!");
  profiles[name]={words:data,xp:0};saveAll();renderProfile();
}
function deleteProfileMenu(){
  if(!Object.keys(profiles).length)return alert("No profiles yet!");
  let names=Object.keys(profiles);
  let listHtml=names.map((n,i)=>`<button id="del-prof-${i}" data-name="${n.replace(/"/g,'&quot;')}">${n}</button>`).join('');
  app.innerHTML=`<div class="container"><div class="ark-header"><button id="btn-back-del" class="back">${t('back')}</button><div class="ark-title">${appLang==='jp'?'ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ <span>å‰Šé™¤</span>':'Remove <span>Operator</span>'}</div></div><div class="ark-section">${appLang==='jp'?'å‰Šé™¤ã™ã‚‹ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’é¸æŠž':'SELECT TO REMOVE'}</div>${listHtml}<button id="btn-cancel-del" style="border-color:var(--border);color:var(--text-dim);justify-content:center;margin-top:10px;">âœ• ${appLang==='jp'?'ã‚­ãƒ£ãƒ³ã‚»ãƒ«':'CANCEL'}</button></div>`;
  document.getElementById("btn-back-del").addEventListener("click", renderProfile);
  document.getElementById("btn-cancel-del").addEventListener("click", renderProfile);
  names.forEach((n,i)=>{
    let btn=document.getElementById("del-prof-"+i);
    if(btn) btn.addEventListener("click", ()=>deleteProfile(n));
  });
}
function deleteProfile(name){if(confirm(`Remove "${name}"?`)){delete profiles[name];saveAll();}renderProfile();}
function selectProfile(name){
  let p=profiles[name];
  if(!p||typeof p!=='object'){alert("Operator data is missing or corrupt. Please re-import.");renderProfile();return;}
  if(!Array.isArray(p.words)) p.words=[];
  currentProfile=name;words=[...p.words];renderGroup();
}

/* â”€â”€ GROUP â”€â”€ */
function renderGroup(){
  isCustomMode=false;
  let gModeBtnStyle=globalMode
    ? "border-color:var(--accent);color:var(--accent);background:rgba(232,168,56,0.1);"
    : "border-color:var(--border);color:var(--text-dim);";
  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderProfile">${t('back')}</button><div class="ark-title">${appLang==='jp'?'ãƒŸãƒƒã‚·ãƒ§ãƒ³ <span>é¸æŠž</span>':'Mission <span>Select</span>'}</div></div>
    ${renderXpBar()}
    <div class="ark-section">${appLang==='jp'?'ãƒ¢ãƒ¼ãƒ‰':'MODE'}</div>
    <div style="display:flex;gap:8px;margin-bottom:4px;">
      <button id="btn-jp-mode" style="flex:1;justify-content:center;padding:10px;${!globalMode?'border-color:var(--accent);color:var(--accent);background:rgba(232,168,56,0.1);':'border-color:var(--border);color:var(--text-dim);'}">ðŸ‡¯ðŸ‡µ ${appLang==='jp'?'æ—¥æœ¬èªžãƒ¢ãƒ¼ãƒ‰':'JAPANESE MODE'}<br><span style="font-size:9px;letter-spacing:1px;opacity:0.7;">${appLang==='jp'?'æ¼¢å­— / ã²ã‚‰ãŒãª / æ„å‘³':'Kanji / Hiragana / Arti'}</span></button>
      <button id="btn-global-mode" style="flex:1;justify-content:center;padding:10px;${globalMode?'border-color:var(--blue);color:var(--blue);background:rgba(58,114,176,0.1);':'border-color:var(--border);color:var(--text-dim);'}">ðŸŒ ${appLang==='jp'?'ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰':'GLOBAL MODE'}<br><span style="font-size:9px;letter-spacing:1px;opacity:0.7;">${appLang==='jp'?'æ¼¢å­— / æ„å‘³ã®ã¿':'Kanji / Arti only'}</span></button>
    </div>
    <div class="ark-section">${appLang==='jp'?'å‡ºé¡Œæ•°':'DEPLOYMENT SIZE'}</div>
    <button data-action="chooseStep:25">â¬¡ &nbsp;${appLang==='jp'?'ã‚°ãƒ«ãƒ¼ãƒ—A â€” 25å•':'Squad Alpha â€” 25 Units'}</button>
    <button data-action="chooseStep:50">â¬¡ &nbsp;${appLang==='jp'?'ã‚°ãƒ«ãƒ¼ãƒ—B â€” 50å•':'Squad Beta â€” 50 Units'}</button>
    <button data-action="startAll">â¬› &nbsp;${appLang==='jp'?'å…¨å•å‡ºé¡Œ â€” ALL':'Full Deployment â€” ALL'}</button>
    <button data-action="renderCustomAmount" style="border-color:var(--accent-dim);color:var(--accent);">â—ˆ &nbsp;${t('customAmt')}</button>
    <button data-action="renderCustomGroupPick" style="border-color:var(--blue);color:var(--blue);background:rgba(58,114,176,0.06);">âŠž &nbsp;${appLang==='jp'?'ã‚«ã‚¹ã‚¿ãƒ ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠž':'Custom Group Pick'}</button>
  </div>`;

  document.getElementById("btn-jp-mode").addEventListener("click",()=>{globalMode=false;saveAll();renderGroup();});
  document.getElementById("btn-global-mode").addEventListener("click",()=>{globalMode=true;saveAll();renderGroup();});
}

function renderCustomAmount(){
  isCustomMode=false;let max=words.length;_customAmt=Math.min(10,max);
  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderGroup">BACK</button><div class="ark-title">Custom <span>Count</span></div></div>
    <div class="ark-section">SET DEPLOYMENT COUNT</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-top:3px solid var(--accent);padding:24px 20px;clip-path:polygon(0 0,calc(100% - 16px) 0,100% 16px,100% 100%,0 100%);margin-bottom:16px;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--text-dim);margin-bottom:12px;">UNIT COUNT (MAX: ${max})</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <button data-action="stepAmt:-10" style="width:52px;min-width:52px;justify-content:center;padding:10px 6px;font-size:13px;">âˆ’10</button>
        <button data-action="stepAmt:-1"  style="width:44px;min-width:44px;justify-content:center;padding:10px 6px;font-size:13px;">âˆ’1</button>
        <div id="amtDisplay" style="flex:1;text-align:center;font-family:'Rajdhani',sans-serif;font-size:52px;font-weight:700;color:var(--accent);text-shadow:0 0 20px rgba(232,168,56,0.4);line-height:1;">${_customAmt}</div>
        <button data-action="stepAmt:1"   style="width:44px;min-width:44px;justify-content:center;padding:10px 6px;font-size:13px;">+1</button>
        <button data-action="stepAmt:10"  style="width:52px;min-width:52px;justify-content:center;padding:10px 6px;font-size:13px;">+10</button>
      </div>
      <input id="amtSlider" type="range" min="1" max="${max}" value="${_customAmt}">
    </div>
    <button data-action="startCustomAmount" style="justify-content:center;font-size:16px;">â¬› &nbsp;DEPLOY</button>
  </div>`;
  document.getElementById("amtSlider").addEventListener("input",function(){syncSlider(this.value);});
}
function stepAmt(d){_customAmt=Math.max(1,Math.min(words.length,_customAmt+d));document.getElementById("amtDisplay").textContent=_customAmt;document.getElementById("amtSlider").value=_customAmt;}
function syncSlider(v){_customAmt=parseInt(v);document.getElementById("amtDisplay").textContent=_customAmt;}
function startCustomAmount(){currentStepAmount=_customAmt;isCustomMode=true;customPool=[...words];sessionWords=shuffle([...words]).slice(0,_customAmt);renderMode();}

function chooseStep(size){
  stepSize=size;let total=words.length,buttons="";
  for(let start=0;start<total;start+=size){
    let end=Math.min(start+size,total),key=currentProfile+"-"+start+"-"+end;
    let played=playedGroups[key]?"played":"",pct=getBlockProgress(start,end),rank=getRankStyle(pct);
    buttons+=`<button class="${played}" data-action="selectBlock:${start}:${end}" style="position:relative;overflow:hidden;box-shadow:${rank.glow};flex-direction:column;align-items:flex-start;gap:4px;padding:12px 14px;">${pct===100?"<div style='font-size:9px;letter-spacing:2px;color:#c060e8;font-weight:700;'>âœ¦ MASTERED</div>":""}<div style="font-size:14px;letter-spacing:1px;">${start+1}â€“${end}${rank.emoji}</div><div style="width:100%;height:2px;background:var(--border);overflow:hidden;"><div style="height:100%;width:${pct}%;background:${rank.color};box-shadow:0 0 4px ${rank.color};"></div></div><div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:${rank.color};letter-spacing:1px;">${pct}% CLEARED</div></button>`;
  }
  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderGroup">BACK</button><div class="ark-title">Block <span>Select</span></div></div>
    <div class="ark-section">COMBAT ZONES â€” UNIT SIZE: ${size}</div>
    <div class="block-grid">${buttons}</div>
    <button data-action="renderCustomBlock" style="margin-top:10px;border-color:var(--accent-dim);color:var(--accent);">â—ˆ &nbsp;Custom Formation</button>
  </div>`;
}

function selectBlock(start,end){
  isCustomMode=false;currentBlockStart=start;currentBlockEnd=end;
  let pool=words.slice(start,end);
  if(!pool.length){alert(appLang==='jp'?'ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã«å˜èªžãŒã‚ã‚Šã¾ã›ã‚“ã€‚':'No words in this block.');renderGroup();return;}
  sessionWords=shuffle([...pool]);
  currentStepAmount=sessionWords.length;
  playedGroups[currentProfile+"-"+start+"-"+end]=true;saveAll();renderMode();
}
function renderCustomBlock(){
  let total=words.length,size=stepSize,checkboxes="";
  for(let s=0;s<total;s+=size){let e=Math.min(s+size,total);checkboxes+=`<label style="display:block;margin:8px 0;"><input type="checkbox" value="${s}-${e}"> ${s+1}â€“${e}</label>`;}
  app.innerHTML=`<div class="container"><div class="ark-header"><button class="back" data-action="chooseStepBack">BACK</button><div class="ark-title">Custom <span>Formation</span></div></div><div class="ark-section">SELECT ZONES</div>${checkboxes}<button data-action="startCustomBlock" style="justify-content:center;margin-top:12px;">â¬› DEPLOY FORMATION</button></div>`;
}
function startCustomBlock(){
  let sel=document.querySelectorAll("input[type=checkbox]:checked");
  if(!sel.length)return alert("Select at least 1 block");
  isCustomMode=true;customPool=[];
  sel.forEach(cb=>{let[s,e]=cb.value.split("-").map(Number);customPool.push(...words.slice(s,e));});
  sessionWords=shuffle([...customPool]);
  currentStepAmount=sessionWords.length;renderMode();
}
function startAll(){currentStepAmount=words.length;sessionWords=shuffle([...words]);renderMode();}

/* â”€â”€ CUSTOM GROUP PICK â”€â”€ */
function renderCustomGroupPick(){
  if(!words.length){alert(appLang==='jp'?'å˜èªžãŒã‚ã‚Šã¾ã›ã‚“ï¼':'No words available!');renderGroup();return;}
  let isJP=appLang==='jp';
  let total=words.length;
  let size=25;
  // Build group cards
  let groupCards='';
  for(let s=0;s<total;s+=size){
    let e=Math.min(s+size,total);
    let pct=getBlockProgress(s,e),rank=getRankStyle(pct);
    let gid='grp-'+s+'-'+e;
    let count=e-s;
    groupCards+=`<div class="cgp-card" id="${gid}" data-start="${s}" data-end="${e}" onclick="cgpToggle('${gid}',${s},${e})" style="background:var(--bg-card);border:2px solid var(--border);padding:10px 12px;cursor:pointer;user-select:none;position:relative;overflow:hidden;transition:all 0.15s;clip-path:polygon(6px 0%,100% 0%,100% calc(100% - 6px),calc(100% - 6px) 100%,0% 100%,0% 6px);">
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="cgp-check" id="chk-${gid}" style="width:18px;height:18px;border:2px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;transition:all 0.15s;"></div>
        <div style="flex:1;min-width:0;">
          <div style="font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;color:var(--text-bright);letter-spacing:1px;">${s+1}â€“${e} <span style="font-size:10px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;letter-spacing:1px;">(${count} ${isJP?'èªž':'words'})</span></div>
          <div style="height:3px;background:var(--border);margin-top:4px;overflow:hidden;border-radius:0;"><div style="height:100%;width:${pct}%;background:${rank.color};box-shadow:0 0 4px ${rank.color};transition:width 0.4s;"></div></div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:${rank.color};margin-top:2px;letter-spacing:1px;">${pct}% CLEARED ${rank.emoji}</div>
        </div>
      </div>
    </div>`;
  }

  app.innerHTML=`<div class="container">
    <div class="ark-header">
      <button class="back" data-action="renderGroup">${isJP?'æˆ»ã‚‹':'BACK'}</button>
      <div class="ark-title">${isJP?'ã‚°ãƒ«ãƒ¼ãƒ— <span>é¸æŠž</span>':'Custom <span>Group Pick</span>'}</div>
    </div>

    <div class="ark-section" style="color:var(--blue);">âŠž ${isJP?'ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠž':'SELECT GROUPS'}</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--blue);padding:10px 14px;margin-bottom:10px;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);line-height:1.7;">
      ${isJP
        ? '25å•å˜ä½ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¤‡æ•°é¸æŠžã—ã¦ãã ã•ã„ã€‚<br>é¸æŠžå¾Œã€<span style="color:var(--accent);">1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‡ºé¡Œæ•°</span>ã‚’è¨­å®šã§ãã¾ã™ã€‚'
        : 'Pick any groups of 25 words. You can combine as many as you like.<br>Then set <span style="color:var(--accent);">how many words</span> you want per session.'}
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px;">
      ${groupCards}
    </div>

    <div style="display:flex;gap:8px;margin-bottom:14px;">
      <button onclick="cgpSelectAll()" style="flex:1;justify-content:center;font-size:11px;padding:7px;border-color:var(--border);color:var(--text-dim);">â˜‘ ${isJP?'å…¨é¸æŠž':'SELECT ALL'}</button>
      <button onclick="cgpClearAll()" style="flex:1;justify-content:center;font-size:11px;padding:7px;border-color:var(--border);color:var(--text-dim);">â˜ ${isJP?'å…¨è§£é™¤':'CLEAR ALL'}</button>
    </div>

    <div id="cgp-count-panel" style="display:none;background:var(--bg-card);border:1px solid var(--border);border-top:3px solid var(--blue);padding:18px 16px;clip-path:polygon(0 0,calc(100% - 14px) 0,100% 14px,100% 100%,0 100%);margin-bottom:10px;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--blue);margin-bottom:12px;">
        â—ˆ ${isJP?'ã‚»ãƒƒã‚·ãƒ§ãƒ³å‡ºé¡Œæ•°':'WORDS PER SESSION'} <span id="cgp-pool-label" style="color:var(--text-dim);"></span>
      </div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        <button id="cgp-minus10" style="width:52px;min-width:52px;justify-content:center;padding:8px 6px;font-size:13px;">âˆ’10</button>
        <button id="cgp-minus1"  style="width:44px;min-width:44px;justify-content:center;padding:8px 6px;font-size:13px;">âˆ’1</button>
        <div style="flex:1;text-align:center;">
          <div id="cgp-amt-display" style="font-family:'Rajdhani',sans-serif;font-size:52px;font-weight:700;color:var(--blue);line-height:1;text-shadow:0 0 20px rgba(58,114,176,0.5);">25</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:2px;margin-top:2px;">${isJP?'å•':'WORDS'}</div>
        </div>
        <button id="cgp-plus1"   style="width:44px;min-width:44px;justify-content:center;padding:8px 6px;font-size:13px;">+1</button>
        <button id="cgp-plus10"  style="width:52px;min-width:52px;justify-content:center;padding:8px 6px;font-size:13px;">+10</button>
      </div>
      <input id="cgp-slider" type="range" min="1" max="25" value="25" style="margin-bottom:4px;">
      <div style="display:flex;justify-content:space-between;font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;">
        <span>1</span><span id="cgp-slider-max">25</span>
      </div>
      <div id="cgp-toggle-row" style="display:flex;gap:6px;margin-top:12px;flex-wrap:wrap;"></div>
    </div>

    <div id="cgp-empty-msg" style="display:none;background:rgba(201,64,64,0.07);border:1px solid rgba(201,64,64,0.3);border-left:3px solid var(--red);padding:10px 14px;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--red);margin-bottom:10px;">
      âš  ${isJP?'ã‚°ãƒ«ãƒ¼ãƒ—ã‚’1ã¤ä»¥ä¸Šé¸æŠžã—ã¦ãã ã•ã„':'Select at least one group to continue'}
    </div>

    <button id="cgp-deploy" onclick="startCustomGroupPick()" style="justify-content:center;font-size:16px;letter-spacing:3px;border-color:var(--blue);color:var(--blue);background:rgba(58,114,176,0.08);">
      âŠž &nbsp;${isJP?'ãƒ‡ãƒ—ãƒ­ã‚¤':'DEPLOY MISSION'}
    </button>
  </div>`;

  // State
  window._cgpSelected = new Set();
  window._cgpAmt = 25;
  window._cgpPoolSize = 0;

  function cgpRefreshCountPanel(){
    let total=0;
    window._cgpSelected.forEach(key=>{
      let [s,e]=key.split('-').map(Number);
      total+=Math.min(e,words.length)-s;
    });
    window._cgpPoolSize=total;
    let panel=document.getElementById('cgp-count-panel');
    let emptyMsg=document.getElementById('cgp-empty-msg');
    if(total===0){panel.style.display='none';emptyMsg.style.display='none';return;}
    emptyMsg.style.display='none';
    panel.style.display='';
    window._cgpAmt=Math.min(window._cgpAmt,total);
    if(window._cgpAmt<1)window._cgpAmt=Math.min(25,total);
    let slider=document.getElementById('cgp-slider');
    let display=document.getElementById('cgp-amt-display');
    let poolLabel=document.getElementById('cgp-pool-label');
    let sliderMax=document.getElementById('cgp-slider-max');
    slider.max=total;
    slider.value=window._cgpAmt;
    sliderMax.textContent=total;
    display.textContent=window._cgpAmt;
    poolLabel.textContent='('+(isJP?'ãƒ—ãƒ¼ãƒ«:':'pool:')+' '+total+' '+(isJP?'èªž':'words')+ ')';
    // Build quick-pick toggles (multiples of 25 up to pool size)
    let toggleRow=document.getElementById('cgp-toggle-row');
    let toggles='';
    let steps=[25,50,75,100,125,150,200];
    steps.forEach(s=>{
      if(s<=total){
        let active=(window._cgpAmt===s);
        toggles+=`<button onclick="cgpSetAmt(${s})" style="flex:0 0 auto;padding:5px 10px;font-size:11px;width:auto;letter-spacing:1px;border-color:${active?'var(--blue)':'var(--border)'};color:${active?'var(--blue)':'var(--text-dim)'};background:${active?'rgba(58,114,176,0.15)':'transparent'};">${s}</button>`;
      }
    });
    // also add ALL option
    let allActive=(window._cgpAmt===total);
    toggles+=`<button onclick="cgpSetAmt(${total})" style="flex:0 0 auto;padding:5px 10px;font-size:11px;width:auto;letter-spacing:1px;border-color:${allActive?'var(--blue)':'var(--border)'};color:${allActive?'var(--blue)':'var(--text-dim)'};background:${allActive?'rgba(58,114,176,0.15)':'transparent'};">ALL</button>`;
    toggleRow.innerHTML=toggles;
  }

  window.cgpSetAmt=function(n){
    window._cgpAmt=Math.max(1,Math.min(window._cgpPoolSize,n));
    let slider=document.getElementById('cgp-slider');
    let display=document.getElementById('cgp-amt-display');
    if(slider)slider.value=window._cgpAmt;
    if(display)display.textContent=window._cgpAmt;
    cgpRefreshCountPanel();
  };

  window.cgpToggle=function(gid,s,e){
    let key=s+'-'+e;
    let card=document.getElementById(gid);
    let chk=document.getElementById('chk-'+gid);
    if(window._cgpSelected.has(key)){
      window._cgpSelected.delete(key);
      card.style.borderColor='var(--border)';
      card.style.background='var(--bg-card)';
      card.style.boxShadow='';
      if(chk){chk.style.borderColor='var(--border)';chk.style.background='';chk.style.color='';chk.textContent='';}
    } else {
      window._cgpSelected.add(key);
      card.style.borderColor='var(--blue)';
      card.style.background='rgba(58,114,176,0.08)';
      card.style.boxShadow='0 0 12px rgba(58,114,176,0.15)';
      if(chk){chk.style.borderColor='var(--blue)';chk.style.background='var(--blue)';chk.style.color='#fff';chk.textContent='âœ“';}
    }
    cgpRefreshCountPanel();
  };

  window.cgpSelectAll=function(){
    document.querySelectorAll('.cgp-card').forEach(card=>{
      let s=parseInt(card.dataset.start),e=parseInt(card.dataset.end);
      let key=s+'-'+e,gid=card.id;
      window._cgpSelected.add(key);
      card.style.borderColor='var(--blue)';
      card.style.background='rgba(58,114,176,0.08)';
      card.style.boxShadow='0 0 12px rgba(58,114,176,0.15)';
      let chk=document.getElementById('chk-'+gid);
      if(chk){chk.style.borderColor='var(--blue)';chk.style.background='var(--blue)';chk.style.color='#fff';chk.textContent='âœ“';}
    });
    cgpRefreshCountPanel();
  };

  window.cgpClearAll=function(){
    document.querySelectorAll('.cgp-card').forEach(card=>{
      let s=parseInt(card.dataset.start),e=parseInt(card.dataset.end);
      let key=s+'-'+e,gid=card.id;
      window._cgpSelected.delete(key);
      card.style.borderColor='var(--border)';
      card.style.background='var(--bg-card)';
      card.style.boxShadow='';
      let chk=document.getElementById('chk-'+gid);
      if(chk){chk.style.borderColor='var(--border)';chk.style.background='';chk.style.color='';chk.textContent='';}
    });
    cgpRefreshCountPanel();
  };

  // Slider + button listeners
  document.getElementById('cgp-slider').addEventListener('input',function(){
    window._cgpAmt=parseInt(this.value);
    document.getElementById('cgp-amt-display').textContent=window._cgpAmt;
    cgpRefreshCountPanel();
  });
  document.getElementById('cgp-minus10').addEventListener('click',()=>{window.cgpSetAmt(window._cgpAmt-10);});
  document.getElementById('cgp-minus1').addEventListener('click',()=>{window.cgpSetAmt(window._cgpAmt-1);});
  document.getElementById('cgp-plus1').addEventListener('click',()=>{window.cgpSetAmt(window._cgpAmt+1);});
  document.getElementById('cgp-plus10').addEventListener('click',()=>{window.cgpSetAmt(window._cgpAmt+10);});
}

function startCustomGroupPick(){
  let isJP=appLang==='jp';
  if(!window._cgpSelected||window._cgpSelected.size===0){
    let msg=document.getElementById('cgp-empty-msg');
    if(msg)msg.style.display='';
    return;
  }
  isCustomMode=true;
  customPool=[];
  // Build pool from selected groups in order
  let keys=[...window._cgpSelected].sort((a,b)=>parseInt(a)-parseInt(b));
  keys.forEach(key=>{
    let [s,e]=key.split('-').map(Number);
    customPool.push(...words.slice(s,e));
  });
  // Shuffle then slice to requested amount
  let shuffled=shuffle([...customPool]);
  let amt=window._cgpAmt||shuffled.length;
  sessionWords=shuffled.slice(0,amt);
  currentStepAmount=sessionWords.length;
  renderMode();
}

/* â”€â”€ MODE / TYPE â”€â”€ */
function renderMode(){
  let isJP=appLang==='jp';
  let maxWords=sessionWords.length||100;
  let limitDisplay=sessionWordLimit>0?sessionWordLimit:appLang==='jp'?'åˆ¶é™ãªã—':'No limit';

  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderGroup">${t('back')}</button><div class="ark-title">${isJP?'ã‚²ãƒ¼ãƒ  <span>è¨­å®š</span>':'Combat <span>Config</span>'}</div></div>

    <div class="ark-section">${isJP?'ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰':'ENGAGEMENT MODE'}</div>
    <button data-action="selectMode:choice">â—ˆ &nbsp;${isJP?'å››æŠžã‚¯ã‚¤ã‚º':'Multi-Choice Protocol'}</button>
    <button data-action="selectMode:typing">âœŽ &nbsp;${isJP?'æ‰‹å‹•å…¥åŠ›':'Manual Input Protocol'}</button>
    <button data-action="selectMode:sort" style="border-color:var(--blue);color:var(--blue);background:rgba(58,114,176,0.05);">ðŸ”¤ &nbsp;${isJP?'æ–‡å­—ä¸¦ã³æ›¿ãˆ':'Word Sort Protocol'}</button>
    <button data-action="renderCurrentStepKotoba">â–£ &nbsp;${isJP?'å˜èªžãƒªã‚¹ãƒˆç¢ºèª':'Intelligence Briefing'}</button>

    <div class="ark-section">${isJP?'ã‚«ã‚¹ã‚¿ãƒ è¨­å®š':'CUSTOM SELECTION'}</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-top:2px solid var(--accent-dim);padding:16px;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%);margin-bottom:8px;">

      <div style="margin-bottom:16px;">
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text-dim);margin-bottom:10px;">${isJP?'é¸æŠžè‚¢ã®æ•°ï¼ˆå››æŠžã‚¯ã‚¤ã‚ºç”¨ï¼‰':'ANSWER CHOICES (Multi-Choice only)'}</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <button id="choice-minus" style="width:40px;min-width:40px;padding:8px 0;justify-content:center;font-size:16px;">âˆ’</button>
          <div style="flex:1;text-align:center;">
            <div id="choice-display" style="font-family:'Rajdhani',sans-serif;font-size:40px;font-weight:700;color:var(--accent);line-height:1;text-shadow:0 0 16px rgba(232,168,56,0.35);">${choiceCount}</div>
            <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:2px;margin-top:2px;">${isJP?'é¸æŠžè‚¢':'CHOICES'}</div>
          </div>
          <button id="choice-plus" style="width:40px;min-width:40px;padding:8px 0;justify-content:center;font-size:16px;">+</button>
        </div>
        <input id="choice-slider" type="range" min="4" max="8" value="${choiceCount}" style="margin-top:10px;">
      </div>

      <hr style="border-color:var(--border);margin:0 0 16px;">

      <div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text-dim);margin-bottom:10px;">${isJP?'1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‡ºé¡Œæ•°':'WORDS PER SESSION'} <span style="color:var(--accent);">(${isJP?'æœ€å¤§':'max'}: ${maxWords})</span></div>
        <div style="display:flex;align-items:center;gap:8px;">
          <button id="limit-minus" style="width:40px;min-width:40px;padding:8px 0;justify-content:center;font-size:16px;">âˆ’</button>
          <div style="flex:1;text-align:center;">
            <div id="limit-display" style="font-family:'Rajdhani',sans-serif;font-size:40px;font-weight:700;color:${sessionWordLimit>0?'var(--accent)':'var(--text-dim)'};line-height:1;text-shadow:0 0 16px rgba(232,168,56,0.2);">${limitDisplay}</div>
            <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:2px;margin-top:2px;">${isJP?'å˜èªž':'WORDS'}</div>
          </div>
          <button id="limit-plus" style="width:40px;min-width:40px;padding:8px 0;justify-content:center;font-size:16px;">+</button>
        </div>
        <input id="limit-slider" type="range" min="0" max="${Math.min(maxWords,100)}" value="${Math.min(sessionWordLimit,100)}" style="margin-top:10px;">
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:6px;letter-spacing:1px;">${isJP?'0 = åˆ¶é™ãªã—ï¼ˆå…¨å˜èªžï¼‰':'0 = No limit (all words in block)'}</div>
      </div>
    </div>

    <div class="ark-section">${isJP?'ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼':'PARAMETERS'}</div>
    <label style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--text-dim);display:block;margin-bottom:4px;">${isJP?'å›žç­”é…å»¶ï¼ˆç§’ï¼‰':'RESPONSE DELAY (SEC)'}</label>
    <input type="number" min="0.5" step="0.5" value="${answerDelay/1000}" id="inp-delay" style="max-width:160px;">
    <hr>

    <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--purple);margin:10px 0 6px;">ðŸŽ² ${isJP?'ãƒ©ãƒ³ãƒ€ãƒ é¸æŠžè‚¢ãƒ¢ãƒ¼ãƒ‰':'RANDOM OPTION ANSWER'}</div>
    <label style="background:${randomOptions?'rgba(156,85,208,0.1)':'var(--bg-card)'};border:1px solid ${randomOptions?'rgba(156,85,208,0.5)':'var(--border)'};border-left:3px solid ${randomOptions?'var(--purple)':'var(--border)'};padding:12px 14px;cursor:pointer;transition:all 0.2s;display:flex;align-items:flex-start;gap:10px;" id="lbl-random">
      <input type="checkbox" id="inp-random" ${randomOptions?'checked':''} style="margin-top:2px;">
      <div>
        <div style="font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;letter-spacing:2px;color:${randomOptions?'var(--purple)':'var(--text)'};">${isJP?'ãƒ©ãƒ³ãƒ€ãƒ é¸æŠžè‚¢ ðŸŽ²':'Random Distractors ðŸŽ²'}</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:4px;line-height:1.6;">${isJP?'ã‚°ãƒ«ãƒ¼ãƒ—å¤–ã®å˜èªžã‹ã‚‰é¸æŠžè‚¢ã‚’ç”Ÿæˆã€‚æ­£è§£æ™‚ã®XP +10%':'Wrong options pulled from outside the current group. Correct answers give +10% XP'}</div>
      </div>
    </label>

    <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--accent);margin:10px 0 6px;">ðŸŒ€ ${isJP?'ãƒãƒ³ãƒ–ãƒ¼ã‚ºãƒ«ãƒ¢ãƒ¼ãƒ‰':'BAMBOOZLE MODE'}</div>
    <label style="background:${bamboozleMode?'rgba(232,100,56,0.12)':'var(--bg-card)'};border:1px solid ${bamboozleMode?'rgba(232,100,56,0.5)':'var(--border)'};border-left:3px solid ${bamboozleMode?'#e86438':'var(--border)'};padding:12px 14px;cursor:pointer;transition:all 0.2s;display:flex;align-items:flex-start;gap:10px;" id="lbl-bamboozle">
      <input type="checkbox" id="inp-bamboozle" ${bamboozleMode?'checked':''} style="margin-top:2px;">
      <div>
        <div style="font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;letter-spacing:2px;color:${bamboozleMode?'#e86438':'var(--text)'};">${isJP?'ãƒãƒ³ãƒ–ãƒ¼ã‚ºãƒ« ðŸŒ€':'Bamboozle ðŸŒ€'}</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:4px;line-height:1.6;">${isJP?'å…¨é¸æŠžè‚¢ãŒæ­£è§£ã¨é…·ä¼¼ã—ãŸå½ç‰©ã«ã€‚æ–‡å­—ã‚’å¾®å¦™ã«å¤‰åŒ–ã•ã›ã¦ç½ ã‚’ä½œã‚‹ã€‚æ­£è§£æ™‚XP +20%<br><span style="color:var(--accent);">ä¾‹: ã¹ã‚“ãã‚‡ã†ã™ã‚‹ â†’ ã¹ã‚“ãã‚‡ãŠã™ã‚‹ã€ã¹ã‚“ãã‚‡ã™ã‚‹</span>':'All choices are mutated fakes of the correct answer â€” subtle character swaps to trick you. +20% XP<br><span style="color:var(--accent);">e.g. ã¹ã‚“ãã‚‡ã†ã™ã‚‹ â†’ ã¹ã‚“ãã‚‡ãŠã™ã‚‹ã€ã¹ã‚“ãã‚‡ã™ã‚‹</span>'}</div>
      </div>
    </label>
    <hr>

    <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--green);margin:10px 0 6px;">ðŸ”„ ${isJP?'ã‚»ã‚«ãƒ³ãƒ‰ãƒãƒ£ãƒ³ã‚¹':'SECOND CHANCE'}</div>
    <label style="background:${secondChance>0?'rgba(58,154,92,0.1)':'var(--bg-card)'};border:1px solid ${secondChance>0?'rgba(58,154,92,0.5)':'var(--border)'};border-left:3px solid ${secondChance>0?'var(--green)':'var(--border)'};padding:12px 14px;cursor:pointer;transition:all 0.2s;display:flex;align-items:flex-start;gap:10px;" id="lbl-secondchance">
      <input type="checkbox" id="inp-secondchance" ${secondChance>0?'checked':''} style="margin-top:2px;">
      <div style="flex:1;">
        <div style="font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;letter-spacing:2px;color:${secondChance>0?'var(--green)':'var(--text)'};" id="sc-title">${isJP?'ã‚»ã‚«ãƒ³ãƒ‰ãƒãƒ£ãƒ³ã‚¹ ðŸ”„':'Second Chance ðŸ”„'}${secondChance>0?` <span style="font-size:13px;color:var(--accent);">${secondChance}%</span>`:''}</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:4px;line-height:1.6;">${isJP?`ä¸æ­£è§£ã®å˜èªžãŒ${secondChance||50}%ã®ç¢ºçŽ‡ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾ŒåŠã«å†å‡ºé¡Œã•ã‚Œã‚‹`:`Wrong answers have a ${secondChance||50}% chance to be re-queued later in the session`}</div>
        <div id="sc-slider-wrap" style="margin-top:10px;${secondChance>0?'':'display:none;'}">
          <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);min-width:28px;">0%</span>
            <input id="sc-slider" type="range" min="0" max="100" step="5" value="${secondChance}" style="flex:1;margin:0;">
            <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);min-width:32px;">100%</span>
          </div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--green);text-align:center;margin-top:4px;letter-spacing:2px;" id="sc-pct-display">${secondChance}%</div>
        </div>
      </div>
    </label>
    <hr>

    <label><input type="checkbox" id="inp-hardcore" ${hardcoreMode?'checked':''}><span style="color:var(--red);font-family:'Rajdhani',sans-serif;font-size:15px;letter-spacing:2px;">${isJP?'ãƒãƒ¼ãƒ‰ã‚³ã‚¢ãƒ¢ãƒ¼ãƒ‰ â˜ ':'HARDCORE MODE â˜ '}</span></label>
    <div style="margin-top:8px;">
      <label style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--text-dim);display:block;margin-bottom:4px;">${isJP?'ã‚¿ã‚¤ãƒžãƒ¼åˆ¶é™ï¼ˆ0.1ã€œ4ç§’ï¼‰':'TIMER LIMIT (0.1â€“4 SEC)'}</label>
      <input type="number" min="0.1" max="4" step="0.1" value="${hardcoreTimer/1000}" id="inp-hctimer" style="max-width:160px;">
    </div>
  </div>`;

  // â”€â”€ Choice count controls â”€â”€
  const choiceDisp=document.getElementById("choice-display");
  const choiceSlider=document.getElementById("choice-slider");
  function updateChoiceDisplay(){
    choiceDisp.textContent=choiceCount;
    choiceSlider.value=choiceCount;
    saveAll();
  }
  document.getElementById("choice-minus").addEventListener("click",()=>{if(choiceCount>4){choiceCount--;updateChoiceDisplay();}});
  document.getElementById("choice-plus").addEventListener("click",()=>{if(choiceCount<8){choiceCount++;updateChoiceDisplay();}});
  choiceSlider.addEventListener("input",function(){choiceCount=parseInt(this.value);updateChoiceDisplay();});

  // â”€â”€ Word limit controls â”€â”€
  const limitDisp=document.getElementById("limit-display");
  const limitSlider=document.getElementById("limit-slider");
  function updateLimitDisplay(){
    let isJP=appLang==='jp';
    if(sessionWordLimit===0){
      limitDisp.textContent=isJP?'åˆ¶é™ãªã—':'No limit';
      limitDisp.style.color='var(--text-dim)';
    } else {
      limitDisp.textContent=sessionWordLimit;
      limitDisp.style.color='var(--accent)';
    }
    limitSlider.value=Math.min(sessionWordLimit,100);
    saveAll();
  }
  document.getElementById("limit-minus").addEventListener("click",()=>{
    if(sessionWordLimit===0) return;
    if(sessionWordLimit<=10){sessionWordLimit=0;}
    else{sessionWordLimit=Math.max(10,sessionWordLimit-10);}
    updateLimitDisplay();
  });
  document.getElementById("limit-plus").addEventListener("click",()=>{
    if(sessionWordLimit===0){sessionWordLimit=10;}
    else{sessionWordLimit=Math.min(Math.min(maxWords,100),sessionWordLimit+10);}
    updateLimitDisplay();
  });
  limitSlider.addEventListener("input",function(){
    let v=parseInt(this.value);
    sessionWordLimit=(v<10)?0:v;
    updateLimitDisplay();
  });

  document.getElementById("inp-delay").addEventListener("change",function(){answerDelay=this.value*1000;});
  document.getElementById("inp-hardcore").addEventListener("change",function(){hardcoreMode=this.checked;});
  document.getElementById("inp-hctimer").addEventListener("change",function(){hardcoreTimer=this.value*1000;});

  // â”€â”€ Second Chance controls â”€â”€
  function applySecondChanceStyle(on){
    let lbl=document.getElementById("lbl-secondchance");
    let nameEl=document.getElementById("sc-title");
    let sliderWrap=document.getElementById("sc-slider-wrap");
    let pctDisplay=document.getElementById("sc-pct-display");
    lbl.style.background=on?'rgba(58,154,92,0.1)':'var(--bg-card)';
    lbl.style.border=`1px solid ${on?'rgba(58,154,92,0.5)':'var(--border)'}`;
    lbl.style.borderLeft=`3px solid ${on?'var(--green)':'var(--border)'}`;
    if(nameEl) nameEl.style.color=on?'var(--green)':'var(--text)';
    if(sliderWrap) sliderWrap.style.display=on?'':'none';
    document.getElementById("inp-secondchance").checked=on;
    if(pctDisplay) pctDisplay.textContent=secondChance+'%';
    // Update name to show pct
    if(nameEl){
      let isJP=appLang==='jp';
      nameEl.innerHTML=(isJP?'ã‚»ã‚«ãƒ³ãƒ‰ãƒãƒ£ãƒ³ã‚¹ ðŸ”„':'Second Chance ðŸ”„')+(on?` <span style="font-size:13px;color:var(--accent);">${secondChance}%</span>`:'');
    }
    saveAll();
  }
  document.getElementById("inp-secondchance").addEventListener("change",function(){
    if(this.checked){if(secondChance===0)secondChance=50;}else{secondChance=0;}
    let slider=document.getElementById("sc-slider");
    if(slider) slider.value=secondChance;
    applySecondChanceStyle(this.checked);
  });
  let scSlider=document.getElementById("sc-slider");
  if(scSlider) scSlider.addEventListener("input",function(){
    secondChance=parseInt(this.value);
    if(secondChance===0){document.getElementById("inp-secondchance").checked=false;applySecondChanceStyle(false);}
    else{applySecondChanceStyle(true);}
  });
  function applyRandomStyle(on){
    let lbl=document.getElementById("lbl-random");
    let nameEl=lbl.querySelector('div > div:first-child');
    lbl.style.background=on?'rgba(156,85,208,0.1)':'var(--bg-card)';
    lbl.style.border=`1px solid ${on?'rgba(156,85,208,0.5)':'var(--border)'}`;
    lbl.style.borderLeft=`3px solid ${on?'var(--purple)':'var(--border)'}`;
    if(nameEl) nameEl.style.color=on?'var(--purple)':'var(--text)';
    document.getElementById("inp-random").checked=on;
  }
  function applyBamboozleStyle(on){
    let lbl=document.getElementById("lbl-bamboozle");
    let nameEl=lbl.querySelector('div > div:first-child');
    lbl.style.background=on?'rgba(232,100,56,0.12)':'var(--bg-card)';
    lbl.style.border=`1px solid ${on?'rgba(232,100,56,0.5)':'var(--border)'}`;
    lbl.style.borderLeft=`3px solid ${on?'#e86438':'var(--border)'}`;
    if(nameEl) nameEl.style.color=on?'#e86438':'var(--text)';
    document.getElementById("inp-bamboozle").checked=on;
  }
  document.getElementById("inp-random").addEventListener("change",function(){
    randomOptions=this.checked;
    if(randomOptions && bamboozleMode){ bamboozleMode=false; applyBamboozleStyle(false); }
    applyRandomStyle(randomOptions);
    saveAll();
  });
  document.getElementById("inp-bamboozle").addEventListener("change",function(){
    bamboozleMode=this.checked;
    if(bamboozleMode && randomOptions){ randomOptions=false; applyRandomStyle(false); }
    applyBamboozleStyle(bamboozleMode);
    saveAll();
  });
}
function selectMode(mode){gameMode=mode;renderType();}
function renderType(){
  let isSort=gameMode==="sort";
  let drills=globalMode
    ? `<button data-action="startGame:kanji-arti">ðŸ“– &nbsp;${appLang==='jp'?'å˜èªž â†’ æ„å‘³':'Vocabulary â†’ Meaning'}</button>
       <button data-action="startGame:arti-kanji">ðŸ’¬ &nbsp;${appLang==='jp'?'æ„å‘³ â†’ å˜èªž':'Meaning â†’ Vocabulary'}</button>`
    : `<button data-action="startGame:kanji-hira">æ¼¢ &nbsp;${appLang==='jp'?'æ¼¢å­— â†’ ã²ã‚‰ãŒãª':'Kanji â†’ Hiragana'}</button>
       <button data-action="startGame:kanji-arti">ðŸ“– &nbsp;${appLang==='jp'?'æ¼¢å­— â†’ æ„å‘³':'Kanji â†’ Meaning'}</button>
       <button data-action="startGame:hira-kanji">ã² &nbsp;${appLang==='jp'?'ã²ã‚‰ãŒãª â†’ æ¼¢å­—':'Hiragana â†’ Kanji'}</button>
       <button data-action="startGame:arti-kanji">ðŸ’¬ &nbsp;${appLang==='jp'?'æ„å‘³ â†’ æ¼¢å­—':'Meaning â†’ Kanji'}</button>`;
  let modeTag=globalMode?`<div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--blue);letter-spacing:2px;margin-bottom:8px;">ðŸŒ ${appLang==='jp'?'ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ â€” ã²ã‚‰ãŒãªç„¡åŠ¹':'GLOBAL MODE â€” HIRAGANA DISABLED'}</div>`:'';
  let sortInfo=isSort?`<div style="background:rgba(58,114,176,0.08);border:1px solid rgba(58,114,176,0.3);border-left:3px solid var(--blue);padding:10px 14px;margin-bottom:10px;font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--blue);line-height:1.7;">ðŸ”¤ ${appLang==='jp'?'æ–‡å­—ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ â€” ãƒ’ãƒ³ãƒˆã‚’è¦‹ã¦æ–‡å­—ã‚’æ­£ã—ã„é †ã«ä¸¦ã¹ã‚‹':'WORD SORT MODE â€” See the hint, arrange shuffled characters in correct order'}</div>`:'';
  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderMode">${t('back')}</button><div class="ark-title">${isSort?(appLang==='jp'?'ã‚½ãƒ¼ãƒˆ <span>ã‚¿ã‚¤ãƒ—</span>':'Sort <span>Type</span>'):(appLang==='jp'?'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° <span>ã‚¿ã‚¤ãƒ—</span>':'Training <span>Type</span>')}</div></div>
    <div class="ark-section">${appLang==='jp'?'ãƒ‰ãƒªãƒ«ã‚’é¸æŠž':'SELECT DRILL'}</div>
    ${sortInfo}${modeTag}${drills}
  </div>`;
}
function renderCurrentStepKotoba(){
  let pool=isCustomMode?customPool:words.slice(currentBlockStart,currentBlockEnd);
  let title=isCustomMode?"Custom Block":`${currentBlockStart+1}â€“${currentBlockEnd}`;
  let isJP=appLang==='jp';

  function buildList(editIdx=-1){
    return pool.map((w,i)=>{
      let mastered=(w.correct||0)>=5;
      let borderColor=mastered?'var(--green)':'var(--border)';
      if(i===editIdx){
        // Editable row
        return `<li id="brief-item-${i}" style="padding:10px 12px;border-left:3px solid var(--accent);margin:4px 0;font-family:'Share Tech Mono',monospace;font-size:11px;background:rgba(232,168,56,0.07);list-style:none;border:1px solid var(--accent-dim);border-left:3px solid var(--accent);">
          <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
            <input id="edit-kanji-${i}" type="text" value="${w.kanji.replace(/"/g,'&quot;')}" placeholder="${isJP?'æ¼¢å­—':'Kanji'}" style="width:120px;font-size:18px;font-family:'Rajdhani',sans-serif;font-weight:700;padding:4px 8px;margin:2px 0;">
            <input id="edit-hira-${i}" type="text" value="${w.hira.replace(/"/g,'&quot;')}" placeholder="${isJP?'ã²ã‚‰ãŒãª':'Hiragana'}" style="width:130px;color:var(--accent);padding:4px 8px;margin:2px 0;">
            <input id="edit-arti-${i}" type="text" value="${w.arti.replace(/"/g,'&quot;')}" placeholder="${isJP?'æ„å‘³':'Meaning'}" style="flex:1;min-width:100px;color:var(--text-dim);padding:4px 8px;margin:2px 0;">
          </div>
          <div style="display:flex;gap:6px;margin-top:8px;">
            <button id="edit-save-${i}" style="width:auto;padding:5px 14px;font-size:11px;letter-spacing:1px;justify-content:center;border-color:var(--green);color:var(--green);background:rgba(58,154,92,0.08);">âœ“ ${isJP?'ä¿å­˜':'SAVE'}</button>
            <button id="edit-cancel-${i}" style="width:auto;padding:5px 14px;font-size:11px;letter-spacing:1px;justify-content:center;border-color:var(--border);color:var(--text-dim);">âœ• ${isJP?'ã‚­ãƒ£ãƒ³ã‚»ãƒ«':'CANCEL'}</button>
          </div>
        </li>`;
      }
      // Normal row
      return `<li id="brief-item-${i}" style="padding:8px 12px;border-left:2px solid ${borderColor};margin:3px 0;font-family:'Share Tech Mono',monospace;font-size:11px;background:var(--bg-card);list-style:none;display:flex;align-items:center;gap:8px;">
        <div style="flex:1;min-width:0;">
          ${mastered?'<span style="color:var(--green);font-size:10px;">âœ“ </span>':''}<b style="font-size:15px;font-family:\'Rajdhani\',sans-serif;color:var(--text-bright);">${w.kanji}</b> <span style="color:var(--accent);">${w.hira}</span> <span style="color:var(--text-dim);">â€” ${w.arti}</span>
        </div>
        <button id="edit-btn-${i}" style="width:auto;min-width:36px;padding:4px 10px;font-size:10px;letter-spacing:1px;justify-content:center;border-color:var(--accent-dim);color:var(--accent-dim);flex-shrink:0;" title="${isJP?'ç·¨é›†':'Edit'}">âœŽ</button>
      </li>`;
    }).join('');
  }

  function render(editIdx=-1){
    let listHtml=buildList(editIdx);
    let container=document.getElementById('brief-list');
    if(container){container.innerHTML=listHtml;}
    else{
      app.innerHTML=`<div class="container">
        <div class="ark-header"><button class="back" data-action="renderMode">BACK</button><div class="ark-title">Intel <span>Briefing</span></div><div class="ark-badge" style="margin-left:auto;">${pool.length} ${isJP?'èªž':'ENTRIES'}</div></div>
        <div class="ark-section">ZONE: ${title}</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-bottom:8px;letter-spacing:1px;">${isJP?'// âœŽ ãƒœã‚¿ãƒ³ã§å˜èªžã‚’ç·¨é›†ã§ãã¾ã™ //':'// TAP âœŽ TO EDIT ANY WORD IN THIS BRIEFING //'}</div>
        <ul id="brief-list" style="padding:0;">${listHtml}</ul>
      </div>`;
    }
    wireEvents(editIdx);
  }

  function wireEvents(editIdx){
    pool.forEach((w,i)=>{
      if(i===editIdx){
        let saveBtn=document.getElementById(`edit-save-${i}`);
        let cancelBtn=document.getElementById(`edit-cancel-${i}`);
        if(saveBtn) saveBtn.addEventListener("click",()=>{
          let newKanji=(document.getElementById(`edit-kanji-${i}`).value||'').trim();
          let newHira=(document.getElementById(`edit-hira-${i}`).value||'').trim();
          let newArti=(document.getElementById(`edit-arti-${i}`).value||'').trim();
          if(!newKanji){alert(isJP?'æ¼¢å­—ã¯å¿…é ˆã§ã™':'Kanji/Word field is required');return;}
          // Update in pool (which is a reference to words slice or customPool)
          w.kanji=newKanji; w.hira=newHira; w.arti=newArti;
          // Also update in profiles if currentProfile exists
          if(currentProfile&&profiles[currentProfile]){
            let pw=profiles[currentProfile].words.find(x=>x.kanji===pool[i].kanji||x===w);
            if(pw){pw.kanji=newKanji;pw.hira=newHira;pw.arti=newArti;}
          }
          saveAll();
          render(-1);
        });
        if(cancelBtn) cancelBtn.addEventListener("click",()=>render(-1));
      } else {
        let editBtn=document.getElementById(`edit-btn-${i}`);
        if(editBtn) editBtn.addEventListener("click",()=>render(i));
      }
    });
  }

  render(-1);
}

/* â”€â”€ GAME â”€â”€ */
function startGame(type){
  gameType=type;sessionCorrect=0;sessionWrong=0;combo=0;sessionComboMax=0;
  if(!sessionWords.length){alert(appLang==='jp'?'å˜èªžãŒã‚ã‚Šã¾ã›ã‚“ï¼':'No words available!');renderGroup();return;}
  // Apply word limit if set
  if(sessionWordLimit>0 && sessionWords.length>sessionWordLimit){
    sessionWords=shuffle([...sessionWords]).slice(0,sessionWordLimit);
  }
  sessionTotal=sessionWords.length;
  if(hardcoreMode){
    lives=4;
    // Scale hardcore timer down (harder = less time)
    let hm=getHardnessMult();
    hardcoreTimer=Math.max(500,Math.round((2000/hm)));
  }
  sessionXpStart=globalStats.xp;sessionLevelStart=globalStats.level;sessionXpGain=0;
  nextWord();
}
function nextWord(){clearTimeout(timerInterval);if(!sessionWords||!sessionWords.length){renderSummary();return;}currentWord=sessionWords.pop();renderGame();}

function checkTyping(correct){
  if(isLocked)return;isLocked=true;
  if(hardcoreMode)clearTimeout(timerInterval);
  let input=document.getElementById("ans"),val=input.value.trim(),info=document.getElementById("info");
  // Case-insensitive comparison: only wrong if letters actually differ
  let isCorrect=val.toLowerCase()===correct.toLowerCase();
  if(isCorrect){input.style.borderColor="#3a9a5c";info.innerHTML=`<span style="color:#5ecf8a;">âœ… CORRECT</span>`;}
  else{input.style.borderColor="#c94040";info.innerHTML=`<span style="color:#e86060;">âœ— WRONG â€” ANSWER: <b>${correct}</b></span>`;}
  processAnswer(isCorrect);
}
function checkChoice(sel,correct,options){
  if(isLocked)return;isLocked=true;
  document.querySelectorAll(".choiceBtn").forEach(b=>{
    b.disabled=true;
    let idx=parseInt(b.getAttribute("data-idx"));
    let val=options[idx];
    if(val===correct)b.classList.add("correct");
    else if(val===sel&&sel!==correct)b.classList.add("wrong");
  });
  processAnswer(sel===correct);
}
function handleHardcoreFail(){
  if(isLocked)return;isLocked=true;combo=0;sessionWrong++;lives--;
  globalStats.xp=Math.max(0,globalStats.xp-15);
  if(lives<=0){showGameOver();return;}
  nextWord();
}
function showGameOver(){
  app.innerHTML=`<div class="container" style="text-align:center;padding-top:60px;">
    <div class="ark-header"><div class="ark-title">Game <span>Over</span></div></div>
    <div style="font-size:60px;margin:20px 0;">â˜ </div>
    <div style="font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700;color:var(--red);letter-spacing:4px;">OPERATOR DOWN</div>
    <div class="ark-stat-row" style="margin-top:24px;">
      <div class="ark-stat"><div class="ark-stat-label">Correct</div><div class="ark-stat-value" style="color:var(--green);">${sessionCorrect}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Max Combo</div><div class="ark-stat-value">${sessionComboMax}</div></div>
    </div>
    <button data-action="renderGroup" style="justify-content:center;margin-top:16px;">â†© RETURN TO BASE</button>
  </div>`;
}

/* â”€â”€ SLASH EFFECT ON CORRECT ANSWER â”€â”€ */
function showSlashEffect(){
  let themeId=shopData.activeUI||"arknight";
  // Theme-specific slash configs
  const slashCfg={
    arknight:  {color:"#e8a838",glow:"rgba(232,168,56,0.6)",char:"â„",blur:3},
    dmc:       {color:"#ff0020",glow:"rgba(255,0,32,0.8)",char:"â•±",blur:4},
    bnw:       {color:"#ffffff",glow:"rgba(255,255,255,0.4)",char:"â•±",blur:2},
    rpg:       {color:"#d4a017",glow:"rgba(212,160,23,0.6)",char:"âœ¦",blur:3},
    csm:       {color:"#cc0000",glow:"rgba(204,0,0,0.5)",char:"â•²â•±",blur:2},
    cyberpunk: {color:"#00ffff",glow:"rgba(0,255,255,0.8)",char:"â•±",blur:5},
    hacker:    {color:"#00ff41",glow:"rgba(0,255,65,0.7)",char:"/",blur:4},
    ultrakill: {color:"#f090a8",glow:"rgba(240,144,168,0.6)",char:"âœ¿",blur:3},
    void:      {color:"#44ffcc",glow:"rgba(68,255,204,0.7)",char:"âŸ‹",blur:5},
    metaphor:  {color:"#c8b050",glow:"rgba(200,176,80,0.6)",char:"â—†",blur:3},
    picayune:  {color:"#3a7bd5",glow:"rgba(58,123,213,0.9)",char:"âŠ¹",blur:6},
  };
  let cfg=slashCfg[themeId]||slashCfg.arknight;

  // Create multiple slash lines for dramatic effect
  let slashCount=themeId==="picayune"?5:themeId==="dmc"?3:2;
  for(let i=0;i<slashCount;i++){
    let el=document.createElement("div");
    let vw=window.innerWidth,vh=window.innerHeight;
    let startX=Math.random()*vw*0.6+vw*0.1;
    let startY=Math.random()*vh*0.5+vh*0.1;
    let len=120+Math.random()*180;
    let angle=-45+Math.random()*30;
    el.style.cssText=`
      position:fixed;
      left:${startX}px;top:${startY}px;
      width:${len}px;height:${3+i}px;
      background:linear-gradient(90deg,transparent,${cfg.color},transparent);
      transform:rotate(${angle}deg);transform-origin:left center;
      box-shadow:0 0 ${cfg.blur*2}px ${cfg.glow},0 0 ${cfg.blur*4}px ${cfg.glow};
      pointer-events:none;z-index:19999;
      opacity:1;
      animation:slashFade ${0.35+i*0.05}s ease-out ${i*0.04}s forwards;
    `;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),600+i*60);
  }

  // Text pop (theme character)
  let pop=document.createElement("div");
  let cx=window.innerWidth*0.5,cy=window.innerHeight*0.35;
  pop.style.cssText=`
    position:fixed;left:${cx}px;top:${cy}px;
    font-family:'Rajdhani','VT323','Bangers',sans-serif;
    font-size:${themeId==="picayune"?52:themeId==="dmc"?56:44}px;
    font-weight:900;color:${cfg.color};
    text-shadow:0 0 ${cfg.blur*3}px ${cfg.glow};
    pointer-events:none;z-index:20000;
    transform:translate(-50%,-50%) scale(0.6) rotate(-8deg);
    animation:slashPop 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards;
  `;
  pop.textContent=cfg.char;
  if(!document.getElementById("slash-keyframes")){
    let ks=document.createElement("style");
    ks.id="slash-keyframes";
    ks.textContent=`
      @keyframes slashFade{0%{opacity:1;transform:rotate(var(--r,${-45}deg)) scaleX(0);}30%{opacity:1;transform:rotate(var(--r,${-45}deg)) scaleX(1);}100%{opacity:0;transform:rotate(var(--r,${-45}deg)) scaleX(1.2);}}
      @keyframes slashPop{0%{opacity:0;transform:translate(-50%,-50%) scale(0.5) rotate(-15deg);}60%{opacity:1;transform:translate(-50%,-50%) scale(1.2) rotate(5deg);}100%{opacity:0;transform:translate(-50%,-70%) scale(0.8) rotate(-5deg);}}
    `;
    document.head.appendChild(ks);
  }
  document.body.appendChild(pop);
  setTimeout(()=>pop.remove(),600);
}

function processAnswer(isCorrect){
  let prof=profiles[currentProfile];
  if(!prof){renderMenu();return;}
  let word=prof.words.find(w=>w.kanji===currentWord.kanji);
  if(!word){word={kanji:currentWord.kanji,hira:currentWord.hira||'',arti:currentWord.arti||'',correct:0,wrong:0};prof.words.push(word);}
  if(hardcoreMode)clearTimeout(timerInterval);
  let xpBase=10,flags={};

  if(isCorrect){
    showSlashEffect();
    combo++;if(combo>sessionComboMax)sessionComboMax=combo;
    let mult=comboMultiplier(combo);
    let randomBonus=bamboozleMode?1.2:randomOptions?1.1:1.0;
    let xpGained=Math.round(xpBase*mult*(hardcoreMode?1.5:1)*randomBonus);
    word.correct++;sessionCorrect++;
    prof.xp=(prof.xp||0)+xpGained;
    globalStats.xp+=xpGained;sessionXpGain+=xpGained;
    grantShopCoins(xpGained);
    globalStats.totalCorrect=(globalStats.totalCorrect||0)+1;
    flags._combo=sessionComboMax;
    if(sessionWrong===0&&sessionCorrect>=10)flags._perfect=true;
    updateDailyProgress("correct",1);
    if(combo>(dailyProgress.combo||0)){updateDailyProgress("combo",combo-(dailyProgress.combo||0));}
    if(sessionWrong===0)updateDailyProgress("noerror",1);
  } else {
    combo=0;sessionWrong++;word.wrong++;
    // Second Chance: re-queue this word later in the session
    if(secondChance>0 && Math.random()*100 < secondChance){
      // Insert a fresh copy of currentWord at a random position in remaining sessionWords (not at the very end to avoid immediate repeat)
      let insertPos=sessionWords.length>1?Math.floor(Math.random()*(sessionWords.length-1)+1):0;
      let requeueWord={...currentWord,_requeued:true};
      sessionWords.splice(insertPos,0,requeueWord);
      // Show a brief re-queue toast indicator
      let badge=document.createElement("div");
      badge.style.cssText="position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:rgba(58,154,92,0.18);border:1px solid var(--green);padding:6px 16px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--green);letter-spacing:2px;z-index:10002;pointer-events:none;";
      badge.textContent="ðŸ”„ "+(appLang==='jp'?'å†å‡ºé¡Œã‚­ãƒ¥ãƒ¼':'RE-QUEUED');
      document.body.appendChild(badge);
      setTimeout(()=>{badge.style.transition="opacity 0.4s";badge.style.opacity="0";setTimeout(()=>badge.remove(),400);},1200);
    }
    if(hardcoreMode){
      lives--;
      globalStats.xp=Math.max(0,globalStats.xp-10);
      prof.xp=Math.max(0,(prof.xp||0)-10);
      if(lives<=0){updateSRS(word,false);globalStats.level=calcLevel(globalStats.xp);saveAll();showGameOver();return;}
    }
  }

  updateSRS(word,isCorrect);
  let oldLevel=globalStats.level;
  globalStats.level=calcLevel(globalStats.xp);
  saveAll();

  let newAchs=checkAchievements(flags);
  newAchs.forEach((a,i)=>setTimeout(()=>showAchievementToast(a),i*3300));

  if(globalStats.level>oldLevel){
    setTimeout(()=>showLevelUp(globalStats.level,()=>setTimeout(()=>nextWord(),200)),answerDelay);
  } else {
    setTimeout(()=>nextWord(),answerDelay);
  }
}

function exitGame(){
  if(hardcoreMode){globalStats.xp=Math.max(0,globalStats.xp-30);saveAll();}
  renderType();
}

/* â”€â”€ SUMMARY â”€â”€ */
function renderSummary(){
  // â”€â”€ Autosave session history â”€â”€
  let accuracy=sessionTotal>0?Math.floor((sessionCorrect/sessionTotal)*100):0;
  let grade=accuracy>=90?"S":accuracy>=75?"A":accuracy>=55?"B":accuracy>=35?"C":"D";
  let histEntry={
    ts:Date.now(),
    profile:currentProfile,
    gameType:gameType,
    gameMode:gameMode,
    correct:sessionCorrect,
    total:sessionTotal,
    wrong:sessionWrong,
    combo:sessionComboMax,
    xpGain:sessionXpGain,
    grade:grade,
    accuracy:accuracy,
    hardcore:hardcoreMode,
    isCustom:isCustomMode
  };
  sessionHistory.unshift(histEntry);
  if(sessionHistory.length>200)sessionHistory=sessionHistory.slice(0,200);
  globalStats.totalSessions=(globalStats.totalSessions||0)+1;
  globalStats.level=calcLevel(globalStats.xp);saveAll();
  updateDailyProgress("sessions",1);
  let flags={_combo:sessionComboMax};
  if(sessionWrong===0&&sessionCorrect>=10)flags._perfect=true;
  if(hardcoreMode&&sessionCorrect===sessionTotal)flags._hardcoreWin=true;
  if(gameMode==="sort")flags._sortWin=true;
  let newAchs=checkAchievements(flags);
  setTimeout(()=>newAchs.forEach((a,i)=>setTimeout(()=>showAchievementToast(a),i*3300)),800);

  let gradeColor=grade==="S"?"#e8a838":grade==="A"?"#3a9a5c":grade==="B"?"#3a72b0":grade==="C"?"#c9a030":"#c94040";
  let levelUpText=globalStats.level>sessionLevelStart?`<div style="color:var(--accent);font-family:'Rajdhani',sans-serif;font-size:18px;letter-spacing:3px;margin:10px 0;text-align:center;">â¬¡ LEVEL UP: ${sessionLevelStart} â†’ ${globalStats.level}</div>`:"";

  app.innerHTML=`<div class="container">
    <div class="ark-header"><div class="ark-title">${appLang==='jp'?'ãƒŸãƒƒã‚·ãƒ§ãƒ³ <span>ãƒ¬ãƒãƒ¼ãƒˆ</span>':'Mission <span>Report</span>'}</div></div>
    <div style="text-align:center;padding:16px 0;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--text-dim);">${t('grade')}</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:90px;font-weight:700;color:${gradeColor};line-height:1;text-shadow:0 0 40px ${gradeColor}88;">${grade}</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);letter-spacing:2px;">${accuracy}% ${t('accuracy')}</div>
    </div>
    ${renderXpBar()}
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'æ­£è§£':'Correct'}</div><div class="ark-stat-value" style="color:var(--green);">${sessionCorrect}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'åˆè¨ˆ':'Total'}</div><div class="ark-stat-value">${sessionTotal}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${t('xpGained')}</div><div class="ark-stat-value">+${sessionXpGain}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'æœ€å¤§ã‚³ãƒ³ãƒœ':'Max Combo'}</div><div class="ark-stat-value" style="color:var(--accent2);">${sessionComboMax}</div></div>
    </div>
    ${levelUpText}
    <button id="backBtn" disabled style="justify-content:center;margin-top:16px;">â¬¡ ${t('backMenu')}</button>
  </div>`;
  setTimeout(()=>document.getElementById("backBtn").disabled=false,500);
  document.getElementById("backBtn").addEventListener("click",()=>renderGroup());
  setTimeout(renderGroup,6000);
}

/* â”€â”€ STATS â”€â”€ */
function renderStats(){
  let cp=currentProfile&&profiles[currentProfile]?profiles[currentProfile]:null;
  let pXP=cp?(cp.xp||0):0;
  let pLv=calcLevel(pXP),totalWords=cp?(cp.words||[]).length:0;
  let mastered=0,correct=0,wrong=0;
  if(cp)(cp.words||[]).forEach(w=>{correct+=(w.correct||0);wrong+=(w.wrong||0);if((w.correct||0)>=5)mastered++;});
  let mastPct=totalWords>0?Math.floor((mastered/totalWords)*100):0;
  let unlocked=getAchievements().filter(a=>achievements[a.id]).length;
  let pRank=getRankTitle(pLv);
  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderMenu">${t('back')}</button><div class="ark-title">${appLang==='jp'?'æˆ¦é—˜ <span>è¨˜éŒ²</span>':'Combat <span>Records</span>'}</div></div>
    ${renderXpBar()}
    <div class="ark-section">${appLang==='jp'?'ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹':'GLOBAL STATS'}</div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'ã‚°ãƒ­ãƒ¼ãƒãƒ«LV':'Global LV'}</div><div class="ark-stat-value">${globalStats.level}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${t('totalXp')}</div><div class="ark-stat-value">${globalStats.xp}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'å®Ÿç¸¾':'Achievements'}</div><div class="ark-stat-value">${unlocked}/${getAchievements().length}</div></div>
    </div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'åˆè¨ˆæ­£è§£':'Total Correct'}</div><div class="ark-stat-value" style="color:var(--green);">${globalStats.totalCorrect||0}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${t('sessions')}</div><div class="ark-stat-value">${globalStats.totalSessions||0}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${t('streak')}</div><div class="ark-stat-value">${globalStats.grindDays||0}d</div></div>
    </div>
    <div class="ark-section">${appLang==='jp'?'ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼: ':'OPERATOR: '}${currentProfile||'NONE'}</div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'ã‚ªãƒšLV':'Op. Level'}</div><div class="ark-stat-value" style="color:${pRank.color};">${pLv}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'ãƒ©ãƒ³ã‚¯':'Rank'}</div><div class="ark-stat-value" style="font-size:11px;color:${pRank.color};">${pRank.title}</div></div>
    </div>
    <div class="ark-section">${appLang==='jp'?'èªžå½™ãƒ‡ãƒ¼ã‚¿':'VOCABULARY INTEL'}</div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'ç·æ•°':'Total'}</div><div class="ark-stat-value">${totalWords}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'æ­£è§£æ•°':'Correct'}</div><div class="ark-stat-value" style="color:var(--green);">${correct}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${appLang==='jp'?'ä¸æ­£è§£æ•°':'Wrong'}</div><div class="ark-stat-value" style="color:var(--red);">${wrong}</div></div>
    </div>
    <div style="margin:12px 0 6px;"><div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text-dim);margin-bottom:6px;">${appLang==='jp'?'ç¿’å¾—çŽ‡':'MASTERY'} â€” ${mastered}/${totalWords} (${mastPct}%)</div><div class="ark-progress"><div class="ark-progress-fill" style="width:${mastPct}%;"></div></div></div>
    <button data-action="renderAchievements" style="margin-top:12px;border-color:var(--accent-dim);color:var(--accent);">ðŸ† ${t('achiev')}</button>
  </div>`;
}

/* â”€â”€ KOTOBA â”€â”€ */
function renderKotoba(){
  if(!currentProfile){alert("Select a profile first!");return;}
  let cp=profiles[currentProfile];
  if(!cp||!Array.isArray(cp.words)){alert("Operator data missing. Please re-import.");return;}
  let list=cp.words.map(w=>{let done=(w.correct||0)>=5;return `<li style="padding:8px 12px;border-left:2px solid ${done?'var(--green)':'var(--border)'};margin:3px 0;font-family:'Share Tech Mono',monospace;font-size:11px;background:var(--bg-card);color:${done?'var(--green)':'var(--text)'};list-style:none;">${done?'âœ“ ':'  '}<b style="font-size:15px;font-family:'Rajdhani',sans-serif;">${w.kanji}</b> <span style="color:var(--accent);">${w.hira}</span> <span style="color:var(--text-dim);">â€” ${w.arti}</span></li>`;}).join('');
  app.innerHTML=`<div class="container"><div class="ark-header"><button class="back" data-action="renderMenu">${t('back')}</button><div class="ark-title">${appLang==='jp'?'å˜èªž <span>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</span>':'Vocab <span>Database</span>'}</div></div><div class="ark-section">${appLang==='jp'?'ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«':'INTELLIGENCE FILE'} â€” ${cp.words.length} ${appLang==='jp'?'èªž':'ENTRIES'}</div><ul style="padding:0;">${list}</ul></div>`;
}

/* â”€â”€ SHARE â”€â”€ */
function renderShare(){
  if(!currentProfile)return alert("Select a profile first!");
  let p=profiles[currentProfile];
  if(!p||!Array.isArray(p.words)){alert("Operator data missing. Please re-import.");return;}
  let mastered=p.words.filter(w=>(w.correct||0)>=5),learning=p.words.filter(w=>(w.correct||0)>0&&(w.correct||0)<5);
  let pct=p.words.length>0?Math.floor((mastered.length/p.words.length)*100):0,rank=getRankTitle(globalStats.level);
  let unlocked=getAchievements().filter(a=>achievements[a.id]).length;

  // Static info panels
  let gRank=getRankTitle(globalStats.level);
  let profLv=calcLevel(p.xp||0),profRank=getRankTitle(profLv);
  let mastPct=p.words.length>0?Math.floor((mastered.length/p.words.length)*100):0;
  let resetMult=1.0;let ra=RESET_ACHIEVEMENTS.filter(r=>resetCount>=r.resets);if(ra.length>0)resetMult=ra[ra.length-1].mult;

  // Encode the full save data for export
  let savePayload={profiles,globalStats,playedGroups,achievements,dailyMissions,sessionHistory,resetCount};
  let encodedReport=_encodeData(savePayload)||"// ENCODE ERROR //";

  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderMenu">${t('back')}</button><div class="ark-title">${appLang==='jp'?'é€²æ— <span>é€ä¿¡</span>':'Transmit <span>Progress</span>'}</div></div>

    <div class="ark-section">â¬¡ GLOBAL STATS</div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">Global LV</div><div class="ark-stat-value" style="color:${gRank.color};">${globalStats.level}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Global XP</div><div class="ark-stat-value">${globalStats.xp}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Streak</div><div class="ark-stat-value">${globalStats.grindDays}d</div></div>
    </div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">Achievements</div><div class="ark-stat-value">${unlocked}/${getAchievements().length+FIXED_ACHIEVEMENTS.length}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Resets</div><div class="ark-stat-value" style="color:var(--purple);">${resetCount}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Hardness</div><div class="ark-stat-value" style="color:var(--red);">${resetMult}Ã—</div></div>
    </div>

    <div class="ark-section">ðŸ‘¤ PROFILE: ${currentProfile}</div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">Op. LV</div><div class="ark-stat-value" style="color:${profRank.color};">${profLv}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Rank</div><div class="ark-stat-value" style="font-size:10px;color:${profRank.color};">${profRank.title}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Words</div><div class="ark-stat-value">${p.words.length}</div></div>
    </div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">Mastered</div><div class="ark-stat-value" style="color:var(--green);">${mastered.length}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Learning</div><div class="ark-stat-value" style="color:var(--accent);">${learning.length}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">Mastery%</div><div class="ark-stat-value">${mastPct}%</div></div>
    </div>

    <div class="ark-section">ðŸ”’ ENCODED SAVE DATA</div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--accent-dim);padding:10px 14px;margin-bottom:8px;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;margin-bottom:6px;">${appLang==='jp'?'// ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯KotobaTrainerå°‚ç”¨ã§ã™ â€” ç›´æŽ¥ç·¨é›†ä¸å¯ //':'// THIS DATA IS KOTOBA-TRAINER SPECIFIC â€” NOT HUMAN READABLE //'}</div>
      <div id="encodedBlock" style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent-dim);word-break:break-all;max-height:80px;overflow-y:auto;user-select:none;pointer-events:none;letter-spacing:0;line-height:1.4;background:var(--bg-deep);padding:8px;border:1px solid var(--border);">${encodedReport.substring(0,200)}...</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
      <button id="btn-export-savedata" style="justify-content:center;border-color:var(--accent);color:var(--accent);">ðŸ’¾ &nbsp;${appLang==='jp'?'ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ':'EXPORT DATA'}</button>
      <button id="btn-import-savedata" style="justify-content:center;border-color:var(--blue);color:var(--blue);">ðŸ“¥ &nbsp;${appLang==='jp'?'ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ':'IMPORT DATA'}</button>
    </div>
    <input type="file" id="importFile" accept=".ktb" style="display:none;">

    <hr style="margin:16px 0;">
    <div class="ark-section" style="color:var(--red);">âš  DANGER ZONE</div>
    <button id="btn-reset-all" style="justify-content:center;border-color:rgba(201,64,64,0.5);color:var(--red);background:rgba(201,64,64,0.05);">â˜  &nbsp;${appLang==='jp'?'å…¨é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤':'RESET ALL PROGRESS DATA'}</button>
  </div>`;

  document.getElementById("btn-export-savedata").addEventListener("click",()=>{
    let blob=new Blob([encodedReport],{type:"application/octet-stream"});
    let a=document.createElement("a");a.href=URL.createObjectURL(blob);
    a.download=`kotoba_save_${new Date().toISOString().slice(0,10)}.ktb`;a.click();
  });

  document.getElementById("btn-import-savedata").addEventListener("click",()=>{
    document.getElementById("importFile").value="";
    document.getElementById("importFile").click();
  });

  document.getElementById("importFile").addEventListener("change",function(){
    let file=this.files[0];if(!file)return;
    let r=new FileReader();
    r.onload=e=>{
      let decoded=_decodeData(e.target.result.trim());
      if(!decoded||typeof decoded!=='object'){
        alert(appLang==='jp'?'ç„¡åŠ¹ãªã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚Kotoba Trainerã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«(.ktb)ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚':'Invalid save data. Only .ktb files exported from Kotoba Trainer are supported.');
        return;
      }
      if(!confirm(appLang==='jp'?'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ':'This will overwrite your current data with the imported save. Continue?'))return;
      if(decoded.profiles)profiles=decoded.profiles;
      if(decoded.globalStats)globalStats=Object.assign({xp:0,level:0,totalCorrect:0,totalSessions:0,grindDays:0,lastDay:''},decoded.globalStats);
      if(decoded.playedGroups)playedGroups=decoded.playedGroups;
      if(decoded.achievements)achievements=decoded.achievements;
      if(decoded.sessionHistory)sessionHistory=Array.isArray(decoded.sessionHistory)?decoded.sessionHistory:[];
      if(typeof decoded.resetCount==='number')resetCount=decoded.resetCount;
      saveAll();
      alert(appLang==='jp'?'ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼':'Import successful!');
      renderMenu();
    };
    r.readAsText(file);
  });

  document.getElementById("btn-reset-all").addEventListener("click", resetAllProgress);
}

/* â”€â”€ UTIL â”€â”€ */
function updateSRS(word,isCorrect){
  if(!word.ease)word.ease=2.5;if(!word.interval)word.interval=1;
  if(isCorrect){word.ease=Math.min(3,word.ease+0.1);word.interval=Math.round(word.interval*word.ease);}
  else{word.ease=Math.max(1.3,word.ease-0.2);word.interval=1;}
  word.nextReview=Date.now()+(word.interval*24*60*60*1000);
}
function getBlockProgress(start,end){
  let bw=words.slice(start,end);if(!bw.length)return 0;
  let cp=currentProfile&&profiles[currentProfile]?profiles[currentProfile]:null;
  if(!cp||!Array.isArray(cp.words))return 0;
  let m=bw.filter(w=>{let o=cp.words.find(p=>p.kanji===w.kanji);return o&&(o.correct||0)>=5;}).length;
  return Math.floor((m/bw.length)*100);
}
function getRankStyle(percent){
  if(percent===100)return{color:"#9c27b0",emoji:" ðŸ‘‘",glow:"0 0 12px rgba(156,39,176,0.6)"};
  if(percent>=70)return{color:"#2196F3",emoji:"",glow:"none"};
  if(percent>=30)return{color:"#FFC107",emoji:"",glow:"none"};
  return{color:"#e74c3c",emoji:"",glow:"none"};
}
/* â”€â”€ BAMBOOZLE: mutate a string into a convincing fake â”€â”€ */
// Hiragana/Katakana confusion maps â€” visually/phonetically similar pairs
const HIRA_CONFUSABLES={
  'ã‚':['ã','ã‰'], 'ã„':['ãƒ','ãˆ'], 'ã†':['ã…','ã¬'], 'ãˆ':['ã„','ã‡'], 'ãŠ':['ã‚','ã‰','ã‚’'],
  'ã‹':['ãŒ','ãª'], 'ã':['ãŽ','ã•'], 'ã':['ã','ã¤'], 'ã‘':['ã’','ã¯'], 'ã“':['ã”','ã•'],
  'ã•':['ã–','ã'], 'ã—':['ã˜','ã¡'], 'ã™':['ãš','ã¤'], 'ã›':['ãœ','ã•'], 'ã':['ãž','ãŠ'],
  'ãŸ':['ã ','ãª'], 'ã¡':['ã˜','ã—'], 'ã¤':['ã¥','ã™','ã£'], 'ã¦':['ã§','ã«'], 'ã¨':['ã©','ã“'],
  'ãª':['ãŸ','ã¯'], 'ã«':['ã¦','ã‚Š'], 'ã¬':['ã‚','ã‚€'], 'ã­':['ã‚Œ','ã‚'], 'ã®':['ã‚','ã¬'],
  'ã¯':['ã°','ã±','ã‘'], 'ã²':['ã³','ã´','ã‚Š'], 'ãµ':['ã¶','ã·'], 'ã¸':['ã¹','ãº'], 'ã»':['ã¼','ã½'],
  'ã¾':['ã‚‚','ãª'], 'ã¿':['ã«','ã‚Š'], 'ã‚€':['ã‚‚','ã‚'], 'ã‚':['ã¬','ã­'], 'ã‚‚':['ã‚€','ã¾'],
  'ã‚„':['ã‚ƒ','ã‚†'], 'ã‚†':['ã‚…','ã‚ˆ'], 'ã‚ˆ':['ã‚‡','ã‚†'],
  'ã‚‰':['ã‚‰','ãŸ'], 'ã‚Š':['ã«','ã²'], 'ã‚‹':['ã‚','ã‚'], 'ã‚Œ':['ã­','ã‚'], 'ã‚':['ã‚‹','ã‚Œ'],
  'ã‚':['ã¯','ã°'], 'ã‚’':['ãŠ','ã‚’'],
  'ãŒ':['ã‹','ã–'], 'ãŽ':['ã','ã˜'], 'ã':['ã','ãš'], 'ã’':['ã‘','ã¹'], 'ã”':['ã“','ãž'],
  'ã–':['ã•','ãŒ'], 'ã˜':['ã—','ã¡'], 'ãš':['ã™','ã¥'], 'ãœ':['ã›','ã§'], 'ãž':['ã','ã”'],
  'ã ':['ãŸ','ã°'], 'ã¢':['ã˜','ã¡'], 'ã¥':['ãš','ã¤'], 'ã§':['ã¦','ã¹'], 'ã©':['ã¨','ãž'],
  'ã°':['ã¯','ã±','ã '], 'ã³':['ã²','ã´'], 'ã¶':['ãµ','ã·'], 'ã¹':['ã¸','ã§'], 'ã¼':['ã»','ã©'],
  'ã±':['ã¯','ã°'], 'ã´':['ã²','ã³'], 'ã·':['ãµ','ã¶'], 'ãº':['ã¸','ã¹'], 'ã½':['ã»','ã¼'],
  'ã£':['ã¤','ã£'], 'ã‚“':['ã‚“','ã‚€'],
  'ã†ã‚›':['ã¶','ã·'],
};
// Small kana elongation tricks
const SMALL_TO_BIG={'ã':'ã‚','ãƒ':'ã„','ã…':'ã†','ã‡':'ãˆ','ã‰':'ãŠ','ã£':'ã¤','ã‚ƒ':'ã‚„','ã‚…':'ã‚†','ã‚‡':'ã‚ˆ','ã‚Ž':'ã‚'};
const BIG_TO_SMALL={'ã‚':'ã','ã„':'ãƒ','ã†':'ã…','ãˆ':'ã‡','ãŠ':'ã‰','ã¤':'ã£','ã‚„':'ã‚ƒ','ã‚†':'ã‚…','ã‚ˆ':'ã‚‡'};

function mutateBamboozle(str, seed){
  // Different mutation strategies â€” chosen based on seed to get variety
  let chars=[...str]; // split properly for multi-byte
  let mutations=[...chars];
  let len=chars.length;
  if(len===0) return str;

  // Pick 1-3 positions to mutate, weighted towards middle chars (not position 0)
  let positions=[];
  for(let i=1;i<len;i++) positions.push(i); // skip first char so start looks right
  shuffle(positions);
  let mutCount=Math.min(len<=3?1:len<=6?2:3, positions.length);
  let toMutate=positions.slice(0,mutCount);

  toMutate.forEach(i=>{
    let c=chars[i];
    let roll=(seed+i)%5; // deterministic-ish per position+seed

    if(roll===0 && HIRA_CONFUSABLES[c]){
      // Swap with visually similar char
      let opts=HIRA_CONFUSABLES[c];
      mutations[i]=opts[(seed+i)%opts.length];
    } else if(roll===1 && BIG_TO_SMALL[c]){
      // Shrink a normal kana to small version (e.g. ã†â†’ã…)
      mutations[i]=BIG_TO_SMALL[c];
    } else if(roll===2 && SMALL_TO_BIG[c]){
      // Grow a small kana to big (e.g. ã£â†’ã¤)
      mutations[i]=SMALL_TO_BIG[c];
    } else if(roll===3 && i<len-1){
      // Delete one character (shorter word)
      mutations.splice(i,1);
    } else if(roll===4 && i<len){
      // Duplicate a character (longer word)
      mutations.splice(i,0,c);
    } else if(HIRA_CONFUSABLES[c]){
      let opts=HIRA_CONFUSABLES[c];
      mutations[i]=opts[0];
    }
    // If no mutation matched, leave char as-is (still counts as a mutation attempt)
  });

  return mutations.join('');
}

function getBamboozleOptions(correct, needed){
  let results=new Set();
  let attempts=0;
  // Try different seeds to get needed unique mutations
  while(results.size<needed && attempts<needed*20){
    let fake=mutateBamboozle(correct, attempts);
    if(fake && fake!==correct && ![...results].includes(fake)) results.add(fake);
    attempts++;
  }
  // If we couldn't get enough unique mutations (e.g. very short word), pad with confusable swaps
  let arr=[...results];
  if(arr.length<needed){
    // Last resort: append/prepend small kana or repeat last char
    let extras=[correct+'ãƒ¼', correct.slice(0,-1), correct+'ã£', 'ãŠ'+correct.slice(1)];
    extras.forEach(e=>{if(e!==correct&&!arr.includes(e)&&arr.length<needed)arr.push(e);});
  }
  return arr.slice(0,needed);
}


function similarityScore(a, b){
  if(!a||!b) return 0;
  a=a.toLowerCase(); b=b.toLowerCase();
  // Shared starting characters (prefix match)
  let prefix=0;
  for(let i=0;i<Math.min(a.length,b.length);i++){if(a[i]===b[i])prefix++;else break;}
  // Shared ending characters (suffix match)
  let suffix=0;
  for(let i=1;i<=Math.min(a.length,b.length);i++){if(a[a.length-i]===b[b.length-i])suffix++;else break;}
  // Character overlap (unordered shared chars)
  let setA=new Set(a.split('')), setB=new Set(b.split(''));
  let shared=[...setA].filter(c=>setB.has(c)).length;
  let union=new Set([...setA,...setB]).size;
  let jaccardChar=union>0?shared/union:0;
  // Length similarity (penalise very different lengths)
  let lenSim=1-Math.abs(a.length-b.length)/Math.max(a.length,b.length,1);
  // Shared word tokens (for meaning/arti strings like "to eat")
  let tokA=a.split(/\s+/), tokB=b.split(/\s+/);
  let tokShared=tokA.filter(t=>t.length>1&&tokB.includes(t)).length;
  let tokMax=Math.max(tokA.length,tokB.length,1);
  let tokenSim=tokShared/tokMax;
  // Weighted total
  return (prefix*1.5 + suffix*1.0 + jaccardChar*2.0 + lenSim*1.0 + tokenSim*3.0);
}

function getOptions(correct){
  let needed=choiceCount-1;

  // BAMBOOZLE MODE: all distractors are mutations of the correct answer
  if(bamboozleMode){
    return getBamboozleOptions(correct, needed);
  }

  // Distractor pool: full vocab when randomOptions ON, else current group only
  let groupPool=isCustomMode?customPool:words.slice(currentBlockStart,currentBlockEnd);
  let basePool=randomOptions?words:groupPool;
  if(basePool.length<choiceCount) basePool=words;

  // Extract the answer string for each word in the pool
  function getAns(w){
    if(gameType==="kanji-hira") return w.hira;
    if(gameType==="kanji-arti") return w.arti;
    return w.kanji;
  }

  // Build candidate list (unique, not the correct answer)
  let candidates=[...new Set(basePool.map(getAns))].filter(x=>x&&x!==correct);

  if(randomOptions && candidates.length>=needed){
    // Score each candidate by similarity to the correct answer
    let scored=candidates.map(ans=>({ans, score:similarityScore(correct, ans)}));
    scored.sort((a,b)=>b.score-a.score);

    let similarCount=Math.ceil(needed*0.6);
    let randomCount=needed-similarCount;
    let similar=scored.slice(0,Math.min(similarCount*3,scored.length));
    let rest=scored.slice(similarCount*3);
    let chosenSimilar=shuffle(similar).slice(0,similarCount).map(x=>x.ans);
    let chosenRandom=shuffle(rest.length>=randomCount?rest:scored).slice(0,randomCount).map(x=>x.ans);
    let merged=[...new Set([...chosenSimilar,...chosenRandom])];
    if(merged.length<needed){
      let extra=shuffle(candidates.filter(x=>!merged.includes(x)));
      merged=[...merged,...extra].slice(0,needed);
    }
    return merged.slice(0,needed);
  }

  // Default: shuffle and slice
  return shuffle(candidates).slice(0,needed);
}

function renderGame(){
  if(gameMode==="sort"){renderSortGame();return;}
  isLocked=false;
  let q="",c="";
  if(gameType==="kanji-hira"){q=currentWord.kanji;c=currentWord.hira;}
  if(gameType==="kanji-arti"){q=currentWord.kanji;c=currentWord.arti;}
  if(gameType==="hira-kanji"){q=currentWord.hira; c=currentWord.kanji;}
  if(gameType==="arti-kanji"){q=currentWord.arti; c=currentWord.kanji;}

  // Reveal hint buttons
  let furiganaButton="",furiganaDisplay="";
  if(gameType==="kanji-hira"){
    // Kanji â†’ Hiragana: reveal the meaning (arti) as a hint
    furiganaButton=`<button id="btn-reveal-hira" style="width:auto;padding:6px 16px;font-size:11px;justify-content:center;border-color:var(--accent-dim);color:var(--accent-dim);">ðŸ“– ${appLang==='jp'?'æ„å‘³ã‚’è¡¨ç¤º':'REVEAL MEANING'}</button>`;
    furiganaDisplay=`<div id="furigana" style="display:none;">${currentWord.arti}</div>`;
  } else if(gameType==="hira-kanji" && !globalMode){
    // Hiragana â†’ Kanji: reveal the meaning (arti) instead of hiragana
    furiganaButton=`<button id="btn-reveal-hira" style="width:auto;padding:6px 16px;font-size:11px;justify-content:center;border-color:var(--accent-dim);color:var(--accent-dim);">ðŸ“– ${appLang==='jp'?'æ„å‘³ã‚’è¡¨ç¤º':'REVEAL MEANING'}</button>`;
    furiganaDisplay=`<div id="furigana" style="display:none;">${currentWord.arti}</div>`;
  } else if(gameType!=="kanji-hira" && !globalMode){
    furiganaButton=`<button id="btn-reveal-hira" style="width:auto;padding:6px 16px;font-size:11px;justify-content:center;border-color:var(--accent-dim);color:var(--accent-dim);">â—ˆ ${appLang==='jp'?'ã²ã‚‰ãŒãªã‚’è¡¨ç¤º':'REVEAL HIRAGANA'}</button>`;
    furiganaDisplay=`<div id="furigana" style="display:none;">${currentWord.hira}</div>`;
  }

  let mult=comboMultiplier(combo);
  let comboHtml=combo>=3?`<div class="combo-display">${appLang==='jp'?'ã‚³ãƒ³ãƒœ':'COMBO'} Ã—${combo} <span style="font-size:14px;color:var(--text-dim);">[${mult}Ã—XP]</span></div>`:"";

  let inputHtml="";
  if(gameMode==="typing"){
    inputHtml=`<input id="ans" type="text" style="width:100%;font-size:20px;text-align:center;letter-spacing:3px;" placeholder="${appLang==='jp'?'// å›žç­”ã‚’å…¥åŠ› //':'// INPUT ANSWER //'}"><button id="btnTyping" style="margin-top:6px;justify-content:center;">â¬› ${appLang==='jp'?'ç¢ºèª':'CONFIRM'}</button><div id="info"></div>`;
  }
  let choiceButtons="";
  let _choiceOptions=[];
  if(gameMode==="choice"){
    _choiceOptions=shuffle([c,...getOptions(c)]);
    let cols=_choiceOptions.length>4?2:1;
    let gridStyle=cols===2?`display:grid;grid-template-columns:1fr 1fr;gap:6px;`:``;
    let btns=_choiceOptions.map((opt,i)=>`<button class="choiceBtn" data-idx="${i}" style="text-align:center;justify-content:center;font-size:${opt.length>12?'12px':'14px'};padding:11px 8px;">${opt}</button>`).join('');
    choiceButtons=`<div style="${gridStyle}margin-top:4px;">${btns}</div>`;
  }
  let timerBar="";
  if(hardcoreMode){
    timerBar=`<div class="ark-progress"><div id="timerFill" class="ark-progress-fill" style="width:100%;transition:width linear ${hardcoreTimer}ms;background:linear-gradient(90deg,#c94040,#e87070);"></div></div>`;
  }
  let progress=sessionTotal>0?Math.floor(((sessionTotal-sessionWords.length)/sessionTotal)*100):0;
  let hmLabel=getHardnessMult()>1?`<span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--purple);margin-left:6px;">Ã—${getHardnessMult()} HARD</span>`:'';
  let randLabel=randomOptions&&!bamboozleMode?`<span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--purple);margin-left:6px;">ðŸŽ² +10%</span>`:'';
  let bamboozLabel=bamboozleMode?`<span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:#e86438;margin-left:6px;">ðŸŒ€ +20%</span>`:'';

  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="exitGame">${appLang==='jp'?'é€€å‡º':'EXIT'}</button><div class="ark-title">Field <span>Op</span></div><div class="ark-badge" style="margin-left:auto;">${sessionWords.length} ${appLang==='jp'?'æ®‹ã‚Š':'LEFT'}</div>${hmLabel}${randLabel}${bamboozLabel}</div>
    <div class="ark-progress"><div class="ark-progress-fill" style="width:${progress}%;"></div></div>
    ${hardcoreMode?`<div class="ark-lives">â¤ ${appLang==='jp'?'ãƒ©ã‚¤ãƒ•':'LIVES'}: ${lives}</div>`:""}
    ${comboHtml}
    <div class="card">${q}</div>
    ${furiganaButton}${timerBar}${furiganaDisplay}
    <div>${inputHtml}${choiceButtons}</div>
  </div>`;

  if(hardcoreMode){
    setTimeout(()=>{let f=document.getElementById("timerFill");if(f)f.style.width="0%";},50);
    timerInterval=setTimeout(handleHardcoreFail,hardcoreTimer);
  }
  let revealBtn=document.getElementById("btn-reveal-hira");
  if(revealBtn) revealBtn.addEventListener("click",()=>{let fg=document.getElementById("furigana");if(fg)fg.style.display="block";});
  if(gameMode==="choice"){
    document.querySelectorAll(".choiceBtn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        let idx=parseInt(btn.getAttribute("data-idx"));
        let sel=_choiceOptions[idx];
        checkChoice(sel,c,_choiceOptions);
      });
    });
  }
  if(gameMode==="typing"){
    document.getElementById("btnTyping").addEventListener("click",()=>checkTyping(c));
    document.getElementById("ans").addEventListener("keydown",e=>{if(e.key==="Enter")checkTyping(c);});
  }
}


/* â”€â”€ SORT TILE CHUNKING â”€â”€ */
function isKanaOrCJK(str){
  // Returns true if the string is primarily CJK / kana (should stay as individual chars)
  let cjkCount=0,total=[...str].length;
  for(let ch of str){
    let cp=ch.codePointAt(0);
    // Hiragana, Katakana, CJK Unified, CJK Extension ranges
    if((cp>=0x3040&&cp<=0x30FF)||(cp>=0x4E00&&cp<=0x9FFF)||(cp>=0x3400&&cp<=0x4DBF)||(cp>=0xF900&&cp<=0xFAFF)){cjkCount++;}
  }
  return total>0&&(cjkCount/total)>=0.5;
}

function splitSortTiles(word, mode){
  // mode: "chars" = individual letters, "chunks" = syllable groups (default)
  // For CJK/kana: always individual characters regardless of mode
  if(isKanaOrCJK(word)) return [...word];

  // "chars" mode: every letter is its own tile
  if(mode==="chars") return [...word];

  // "chunks" mode: syllable-like groups
  let chars=[...word];
  let len=chars.length;
  if(len<=3) return [word];
  if(len<=5) return splitEvenly(chars,2);

  function isVowel(c){return /[aeiouÃ¡Ã©Ã­Ã³ÃºÃ Ã¨Ã¬Ã²Ã¹Ã¤Ã«Ã¯Ã¶Ã¼Ã¢ÃªÃ®Ã´Ã»Ã£Ãµ]/i.test(c);}

  let chunks=[];
  let i=0;
  while(i<len){
    let chunkSize=2;
    if(i+2<len){
      let c2=chars[i+1];
      let c3=i+2<len?chars[i+2]:null;
      if(!isVowel(c2)&&c3&&!isVowel(c3)){chunkSize=3;}
      else{chunkSize=2;}
    }
    let remaining=len-i;
    if(remaining-chunkSize===1) chunkSize++;
    if(chunkSize>remaining) chunkSize=remaining;
    chunks.push(chars.slice(i,i+chunkSize).join(''));
    i+=chunkSize;
  }
  return chunks.length>=2?chunks:[word];
}

function splitEvenly(chars,n){
  let len=chars.length,chunks=[];
  let base=Math.floor(len/n),rem=len%n,i=0;
  for(let j=0;j<n;j++){let sz=base+(j<rem?1:0);chunks.push(chars.slice(i,i+sz).join(''));i+=sz;}
  return chunks;
}

/* â”€â”€ SORT MODE GAME â”€â”€ */
let _sortAnswer="";
let _sortTiles=[];
let _sortPlaced=[];
let _sortChunks=[]; // The original ordered chunks (for comparison)
let _sortSplitMode="syllable"; // "letter" or "syllable" â€” toggled during game

function renderSortGame(){
  isLocked=false;
  _sortPlaced=[];

  // Determine the word to sort and the hint based on gameType
  let sortWord="", hint="";
  if(gameType==="kanji-hira"){
    sortWord=currentWord.kanji; hint=currentWord.hira;
  } else if(gameType==="kanji-arti"){
    sortWord=currentWord.kanji; hint=currentWord.arti;
  } else if(gameType==="hira-kanji"){
    sortWord=currentWord.hira; hint=currentWord.kanji;
  } else if(gameType==="arti-kanji"){
    sortWord=currentWord.arti; hint=currentWord.kanji;
  } else {
    sortWord=currentWord.kanji; hint=currentWord.hira||currentWord.arti;
  }

  // Fallback if field is empty
  if(!sortWord||sortWord==='-') sortWord=currentWord.kanji||currentWord.hira||currentWord.arti||"?";

  _sortAnswer=sortWord;
  let isCJK=isKanaOrCJK(sortWord);

  // For CJK: always single chars, no split toggle
  if(isCJK) _sortSplitMode="letter";

  function getChunksForMode(mode){
    if(isCJK||mode==="letter") return [...sortWord];
    return splitSortTiles(sortWord); // syllable chunks
  }

  function buildTiles(mode){
    let chunks=getChunksForMode(mode);
    // Shuffle but don't give away answer
    let shuffled=[...chunks];
    let attempts=0;
    do{shuffled=shuffle([...chunks]);attempts++;}
    while(attempts<20&&shuffled.join('')===_sortAnswer&&chunks.length>1);
    return{chunks,tiles:shuffled};
  }

  let {chunks,tiles}=buildTiles(_sortSplitMode);
  _sortChunks=chunks;
  _sortTiles=tiles;

  let progress=sessionTotal>0?Math.floor(((sessionTotal-sessionWords.length)/sessionTotal)*100):0;
  let hmLabel=getHardnessMult()>1?`<span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--purple);margin-left:6px;">Ã—${getHardnessMult()} HARD</span>`:'';
  let comboHtml=combo>=3?`<div class="combo-display">${appLang==='jp'?'ã‚³ãƒ³ãƒœ':'COMBO'} Ã—${combo} <span style="font-size:14px;color:var(--text-dim);">[${comboMultiplier(combo)}Ã—XP]</span></div>`:'';
  let timerBar="";
  if(hardcoreMode){timerBar=`<div class="ark-progress"><div id="timerFill" class="ark-progress-fill" style="width:100%;transition:width linear ${hardcoreTimer}ms;background:linear-gradient(90deg,#c94040,#e87070);"></div></div>`;}

  function tileFontSize(chunks){return isCJK?'24px':(chunks.some(c=>c.length>2)?'18px':'22px');}
  function tileMinW(chunks){return isCJK?'44px':(chunks.some(c=>c.length>2)?'44px':'40px');}

  let qLabel=appLang==='jp'?'ãƒ’ãƒ³ãƒˆ':'HINT';
  let hintLabel=appLang==='jp'?'ä¸¦ã³æ›¿ãˆã‚‹å˜èªžã‚’ä½œã‚‹':'Arrange the tiles to form the word';

  // Split toggle â€” only show for Latin words
  let splitToggleHtml=!isCJK?`
    <div style="display:flex;justify-content:center;gap:8px;margin-bottom:8px;">
      <button id="split-letter-btn" style="width:auto;padding:5px 16px;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;justify-content:center;${_sortSplitMode==='letter'?'border-color:var(--accent);color:var(--accent);background:rgba(232,168,56,0.1);':'border-color:var(--border);color:var(--text-dim);background:var(--bg-card);'}">A-B-C</button>
      <button id="split-syllable-btn" style="width:auto;padding:5px 16px;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;justify-content:center;${_sortSplitMode==='syllable'?'border-color:var(--accent);color:var(--accent);background:rgba(232,168,56,0.1);':'border-color:var(--border);color:var(--text-dim);background:var(--bg-card);'}">AB-CD</button>
    </div>`:'';

  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="exitGame">${appLang==='jp'?'é€€å‡º':'EXIT'}</button><div class="ark-title">Sort <span>Op</span></div><div class="ark-badge" style="margin-left:auto;">${sessionWords.length} ${appLang==='jp'?'æ®‹ã‚Š':'LEFT'}</div>${hmLabel}</div>
    <div class="ark-progress"><div class="ark-progress-fill" style="width:${progress}%;"></div></div>
    ${hardcoreMode?`<div class="ark-lives">â¤ ${appLang==='jp'?'ãƒ©ã‚¤ãƒ•':'LIVES'}: ${lives}</div>`:""}
    ${comboHtml}
    <div style="text-align:center;padding:10px 0 4px;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase;">${qLabel}</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:26px;font-weight:700;color:var(--accent);letter-spacing:2px;margin-top:4px;word-break:break-all;">${hint}</div>
    </div>
    ${timerBar}
    <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text-dim);text-align:center;margin:10px 0 6px;">${hintLabel}</div>
    ${splitToggleHtml}

    <div id="sort-answer-area" style="min-height:64px;background:var(--bg-card);border:2px dashed var(--border);border-radius:0;padding:10px;display:flex;flex-wrap:wrap;gap:6px;justify-content:center;align-items:center;margin-bottom:12px;transition:border-color 0.2s;">
      <div id="sort-placeholder" style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);letter-spacing:2px;">${appLang==='jp'?'// ã“ã“ã«ä¸¦ã¹ã‚‹ //':'// ARRANGE HERE //'}</div>
    </div>

    <div id="sort-tile-area" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:12px;background:var(--bg-panel);border:1px solid var(--border);">
    </div>

    <button id="sort-submit-btn" style="justify-content:center;margin-top:10px;border-color:var(--green);color:var(--green);" disabled>â¬› ${appLang==='jp'?'ç¢ºèª':'CONFIRM'}</button>
    <button id="sort-clear-btn" style="justify-content:center;margin-top:4px;border-color:var(--border);color:var(--text-dim);">âœ• ${appLang==='jp'?'ã‚¯ãƒªã‚¢':'CLEAR'}</button>
    <div id="sort-info" style="font-family:'Share Tech Mono',monospace;font-size:13px;text-align:center;padding:8px;margin-top:4px;"></div>
  </div>`;

  if(hardcoreMode){
    setTimeout(()=>{let f=document.getElementById("timerFill");if(f)f.style.width="0%";},50);
    timerInterval=setTimeout(handleHardcoreFail,hardcoreTimer);
  }

  function renderTileArea(){
    let area=document.getElementById("sort-tile-area");
    if(!area)return;
    let fs=tileFontSize(_sortChunks);
    let mw=tileMinW(_sortChunks);
    area.innerHTML=_sortTiles.map((ch,i)=>`<button class="sort-tile" data-tile-idx="${i}" style="width:auto;min-width:${mw};padding:10px 14px;font-family:'Rajdhani',sans-serif;font-size:${fs};font-weight:700;letter-spacing:1px;justify-content:center;border-color:var(--accent-dim);color:var(--text-bright);background:var(--bg-card2);">${ch}</button>`).join('');
    // Re-wire tile click handlers
    area.querySelectorAll(".sort-tile").forEach(btn=>{
      btn.addEventListener("click",()=>{
        if(isLocked)return;
        let idx=parseInt(btn.getAttribute("data-tile-idx"));
        let ch=_sortTiles[idx];
        _sortPlaced.push({idx,ch});
        btn.style.display="none";
        renderPlaced();
        updateSubmit();
      });
    });
  }

  function renderPlaced(){
    let area=document.getElementById("sort-answer-area");
    let ph=document.getElementById("sort-placeholder");
    if(!area)return;
    let fs=tileFontSize(_sortChunks);
    let mw=tileMinW(_sortChunks);
    area.querySelectorAll(".sort-placed").forEach(e=>e.remove());
    if(_sortPlaced.length>0){
      if(ph)ph.style.display="none";
      _sortPlaced.forEach((item,p)=>{
        let btn=document.createElement("button");
        btn.className="sort-placed";
        btn.style.cssText=`width:auto;min-width:${mw};padding:10px 14px;font-family:'Rajdhani',sans-serif;font-size:${fs};font-weight:700;letter-spacing:1px;justify-content:center;border-color:var(--accent);color:var(--accent);background:rgba(232,168,56,0.1);margin:3px;`;
        btn.textContent=item.ch;
        btn.addEventListener("click",()=>{
          _sortPlaced.splice(p,1);
          let srcTile=document.querySelector(`.sort-tile[data-tile-idx="${item.idx}"]`);
          if(srcTile)srcTile.style.display="";
          renderPlaced();
          updateSubmit();
        });
        area.appendChild(btn);
      });
    } else {
      if(ph)ph.style.display="";
    }
  }

  function updateSubmit(){
    let btn=document.getElementById("sort-submit-btn");
    if(btn) btn.disabled=_sortPlaced.length<_sortChunks.length;
  }

  function applyMode(mode){
    if(_sortSplitMode===mode)return;
    _sortSplitMode=mode;
    // Reset placement and regenerate tiles with new split
    _sortPlaced=[];
    // Reset answer area
    let area=document.getElementById("sort-answer-area");
    if(area){area.style.borderColor="var(--border)";area.querySelectorAll(".sort-placed").forEach(e=>e.remove());}
    let ph=document.getElementById("sort-placeholder");
    if(ph)ph.style.display="";
    // Rebuild chunks & tiles
    let built=buildTiles(mode);
    _sortChunks=built.chunks;
    _sortTiles=built.tiles;
    // Update toggle button styles
    let lb=document.getElementById("split-letter-btn");
    let sb=document.getElementById("split-syllable-btn");
    if(lb){lb.style.borderColor=mode==='letter'?'var(--accent)':'var(--border)';lb.style.color=mode==='letter'?'var(--accent)':'var(--text-dim)';lb.style.background=mode==='letter'?'rgba(232,168,56,0.1)':'var(--bg-card)';}
    if(sb){sb.style.borderColor=mode==='syllable'?'var(--accent)':'var(--border)';sb.style.color=mode==='syllable'?'var(--accent)':'var(--text-dim)';sb.style.background=mode==='syllable'?'rgba(232,168,56,0.1)':'var(--bg-card)';}
    renderTileArea();
    updateSubmit();
  }

  // Wire split toggle buttons
  let lBtn=document.getElementById("split-letter-btn");
  let sBtn=document.getElementById("split-syllable-btn");
  if(lBtn) lBtn.addEventListener("click",()=>applyMode("letter"));
  if(sBtn) sBtn.addEventListener("click",()=>applyMode("syllable"));

  // Wire clear & submit
  document.getElementById("sort-clear-btn").addEventListener("click",()=>{
    if(isLocked)return;
    _sortPlaced=[];
    document.querySelectorAll(".sort-tile").forEach(b=>b.style.display="");
    renderPlaced();
    updateSubmit();
  });

  document.getElementById("sort-submit-btn").addEventListener("click",()=>{
    if(isLocked)return;
    let answer=_sortPlaced.map(x=>x.ch).join('');
    checkSortAnswer(answer,_sortAnswer);
  });

  // Initial render
  renderTileArea();
  updateSubmit();
}

function checkSortAnswer(userAnswer, correct){
  if(isLocked)return;isLocked=true;
  if(hardcoreMode)clearTimeout(timerInterval);
  let info=document.getElementById("sort-info");
  let answerArea=document.getElementById("sort-answer-area");
  // Case-insensitive for Latin text; exact for CJK/kana
  let isCorrect=isKanaOrCJK(correct)?(userAnswer===correct):(userAnswer.toLowerCase()===correct.toLowerCase());
  if(isCorrect){
    if(answerArea)answerArea.style.borderColor="var(--green)";
    if(info)info.innerHTML=`<span style="color:#5ecf8a;">âœ… ${appLang==='jp'?'æ­£è§£ï¼':'CORRECT!'} â€” ${correct}</span>`;
  } else {
    if(answerArea)answerArea.style.borderColor="var(--red)";
    if(info)info.innerHTML=`<span style="color:#e86060;">âœ— ${appLang==='jp'?'ä¸æ­£è§£':'WRONG'} â€” ${appLang==='jp'?'æ­£è§£:':'ANSWER:'} <b>${correct}</b></span>`;
  }
  document.querySelectorAll(".sort-tile,.sort-placed").forEach(b=>b.disabled=true);
  let submitBtn=document.getElementById("sort-submit-btn");
  if(submitBtn)submitBtn.disabled=true;
  processAnswer(isCorrect);
}

/* â”€â”€ HISTORY â”€â”€ */
function renderHistory(){
  let hist=sessionHistory;
  if(!hist.length){
    app.innerHTML=`<div class="container"><div class="ark-header"><button class="back" data-action="renderMenu">${t('back')}</button><div class="ark-title">${appLang==='jp'?'ã‚»ãƒƒã‚·ãƒ§ãƒ³ <span>å±¥æ­´</span>':'Session <span>History</span>'}</div></div><div class="ark-section">${appLang==='jp'?'ãƒ‡ãƒ¼ã‚¿ãªã—':'NO DATA'}</div><div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);padding:20px 0;text-align:center;">${appLang==='jp'?'// ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ //':'// NO SESSIONS RECORDED YET //'}</div></div>`;
    return;
  }
  let typeLabels={"kanji-hira":"Kâ†’H","kanji-arti":"Kâ†’M","hira-kanji":"Hâ†’K","arti-kanji":"Mâ†’K"};
  let modeLabelMap={"choice":"MC","typing":"TYPE","sort":"SORT"};
  let gradeColor=g=>g==="S"?"#e8a838":g==="A"?"#3a9a5c":g==="B"?"#3a72b0":g==="C"?"#c9a030":"#c94040";
  let cards=hist.slice(0,50).map((h,i)=>{
    let d=new Date(h.ts);
    let dateStr=d.toLocaleDateString('ja-JP',{month:'2-digit',day:'2-digit'})+" "+d.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'});
    let mode=modeLabelMap[h.gameMode]||h.gameMode||"?";
    let type=typeLabels[h.gameType]||h.gameType||"?";
    let gc=gradeColor(h.grade||"D");
    return `<div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid ${gc};padding:10px 14px;margin:5px 0;display:flex;align-items:center;gap:12px;clip-path:polygon(8px 0%,100% 0%,100% calc(100% - 8px),calc(100% - 8px) 100%,0% 100%,0% 8px);">
      <div style="font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700;color:${gc};min-width:28px;text-align:center;text-shadow:0 0 12px ${gc}88;">${h.grade||"?"}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:var(--text-bright);letter-spacing:1px;">${h.profile||'?'} <span style="font-size:10px;color:var(--accent);font-family:'Share Tech Mono',monospace;">${type} Â· ${mode}${h.hardcore?" Â· HC":""}</span></div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:2px;">${dateStr}</div>
        <div style="display:flex;gap:10px;margin-top:4px;">
          <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:#3a9a5c;">âœ“ ${h.correct}</span>
          <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:#c94040;">âœ— ${h.wrong||0}</span>
          <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);">+${h.xpGain||0}XP</span>
          <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent2);">Ã—${h.combo||0}</span>
        </div>
      </div>
      <div style="text-align:right;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);">${h.accuracy||0}%</div>
    </div>`;
  }).join('');
  let totalSess=hist.length,avgAcc=hist.length?Math.floor(hist.reduce((s,h)=>s+(h.accuracy||0),0)/hist.length):0;
  let bestGrade=["S","A","B","C","D"].find(g=>hist.some(h=>h.grade===g))||"â€”";
  let totalXpEarned=hist.reduce((s,h)=>s+(h.xpGain||0),0);
  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderMenu">${t('back')}</button><div class="ark-title">${appLang==='jp'?'ã‚»ãƒƒã‚·ãƒ§ãƒ³ <span>å±¥æ­´</span>':'Session <span>History</span>'}</div><div class="ark-badge" style="margin-left:auto;">${totalSess} ${t('runs')}</div></div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">${t('sessions')}</div><div class="ark-stat-value">${totalSess}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${t('avgAcc')}</div><div class="ark-stat-value">${avgAcc}%</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${t('best')}</div><div class="ark-stat-value" style="color:${gradeColor(bestGrade)};">${bestGrade}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">${t('totalXp')}</div><div class="ark-stat-value">+${totalXpEarned}</div></div>
    </div>
    <div class="ark-section">${t('recentOps')} ${Math.min(50,hist.length)}</div>
    ${cards}
    ${hist.length>0?`<button data-action="clearHistory" style="margin-top:12px;border-color:rgba(201,64,64,0.4);color:var(--text-dim);justify-content:center;">${t('clearHist')}</button>`:''}
  </div>`;
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   âš”ï¸  ADVENTURE MODE â€” TURN-BASED RPG QUEST SYSTEM v2
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ SPRITE ANIMATION CSS â”€â”€ */
const ADV_SPRITE_CSS=`
@keyframes spriteIdle{0%,100%{transform:translateY(0);}50%{transform:translateY(-4px);}}
@keyframes spriteAttack{0%{transform:translateX(0) scaleX(1);}30%{transform:translateX(18px) scaleX(1.1);}60%{transform:translateX(-4px) scaleX(0.95);}100%{transform:translateX(0) scaleX(1);}}
@keyframes spriteHurt{0%,100%{transform:translateX(0) scale(1);filter:drop-shadow(0 0 4px rgba(255,0,0,0.2));}20%,60%{transform:translateX(-8px) scale(0.96);filter:drop-shadow(0 0 20px rgba(255,0,0,1)) brightness(2.5);}40%,80%{transform:translateX(8px) scale(1.02);filter:drop-shadow(0 0 10px rgba(255,80,80,0.8));}}
@keyframes spriteEnemyAttack{0%{transform:translateX(0);}30%{transform:translateX(-20px) scaleX(1.15);}60%{transform:translateX(6px);}100%{transform:translateX(0);}}
@keyframes spriteEnemyHurt{0%,100%{transform:translateX(0) scale(1);filter:brightness(1);}20%,60%{transform:translateX(8px) scale(0.95);filter:brightness(3) sepia(1) hue-rotate(0deg);}40%,80%{transform:translateX(-6px) scale(1.04);filter:brightness(2);}}
@keyframes spriteDie{0%{opacity:1;transform:translateY(0) rotate(0);}100%{opacity:0;transform:translateY(30px) rotate(-30deg);}}
@keyframes critFlash{0%,100%{text-shadow:none;}50%{text-shadow:0 0 20px #fff700,0 0 40px #ff8800;}}
@keyframes chargeGlowAnim{0%,100%{box-shadow:0 0 4px rgba(200,60,255,0.3);}50%{box-shadow:0 0 18px rgba(200,60,255,0.9);}}
@keyframes playerHitFlash{0%{outline:none;}30%{outline:3px solid rgba(255,0,0,0.7);background:rgba(255,0,0,0.08);}100%{outline:none;background:transparent;}}
@keyframes enemyHitFlash{0%{outline:none;}30%{outline:3px solid rgba(255,255,0,0.5);background:rgba(255,200,0,0.06);}100%{outline:none;background:transparent;}}
.sprite-idle{animation:spriteIdle 2s ease-in-out infinite;}
.sprite-attack{animation:spriteAttack 0.55s ease-in-out;}
.sprite-hurt{animation:spriteHurt 0.5s ease-in-out;}
.sprite-enemy-attack{animation:spriteEnemyAttack 0.55s ease-in-out;}
.sprite-enemy-hurt{animation:spriteEnemyHurt 0.5s ease-in-out;}
.sprite-die{animation:spriteDie 0.8s ease-in forwards;}
.crit-text{animation:critFlash 0.4s;}
.player-hit-flash{animation:playerHitFlash 0.5s ease-out;}
.enemy-hit-flash{animation:enemyHitFlash 0.4s ease-out;}
`;
(function injectSpriteCss(){let s=document.createElement("style");s.textContent=ADV_SPRITE_CSS;document.head.appendChild(s);})();

/* â”€â”€ CHARACTER DEFINITIONS â”€â”€ */
const ADV_CHARS={
  hiro:{
    id:"hiro", name:"HIRO", jp:"ãƒ’ãƒ­", class:"Knight", price:0, free:true,
    art:`<svg width="80" height="90" viewBox="0 0 80 90" style="display:block;margin:auto;">
      <rect x="22" y="40" width="36" height="32" rx="2" fill="#3a4a6a" stroke="#6888cc" stroke-width="1.5"/>
      <rect x="26" y="43" width="28" height="22" rx="1" fill="#4a5a80" stroke="#88aaee" stroke-width="1"/>
      <rect x="38" y="46" width="4" height="12" fill="#e8a838"/><rect x="33" y="50" width="14" height="4" fill="#e8a838"/>
      <rect x="26" y="16" width="28" height="26" rx="3" fill="#3a4a6a" stroke="#6888cc" stroke-width="1.5"/>
      <rect x="28" y="24" width="24" height="8" rx="2" fill="#1a2a3a" stroke="#4488cc" stroke-width="1"/>
      <rect x="30" y="25.5" width="20" height="5" rx="1" fill="#4488ee" opacity="0.8"/>
      <rect x="36" y="10" width="8" height="8" rx="1" fill="#e8a838"/>
      <rect x="12" y="38" width="14" height="12" rx="2" fill="#3a4a6a" stroke="#6888cc" stroke-width="1.5"/>
      <rect x="54" y="38" width="14" height="12" rx="2" fill="#3a4a6a" stroke="#6888cc" stroke-width="1.5"/>
      <rect x="12" y="50" width="11" height="18" rx="2" fill="#4a5a80"/>
      <rect x="57" y="50" width="11" height="18" rx="2" fill="#4a5a80"/>
      <rect x="11" y="66" width="13" height="10" rx="1" fill="#3a4a6a" stroke="#6888cc" stroke-width="1"/>
      <rect x="56" y="66" width="13" height="10" rx="1" fill="#3a4a6a" stroke="#6888cc" stroke-width="1"/>
      <rect x="24" y="72" width="13" height="16" rx="1" fill="#3a4a6a" stroke="#6888cc" stroke-width="1"/>
      <rect x="43" y="72" width="13" height="16" rx="1" fill="#3a4a6a" stroke="#6888cc" stroke-width="1"/>
      <rect x="67" y="20" width="4" height="40" rx="1" fill="#c8d8f0" stroke="#8899cc" stroke-width="1"/>
      <rect x="63" y="36" width="12" height="4" rx="1" fill="#e8a838"/>
      <rect x="66" y="16" width="6" height="6" rx="1" fill="#e8a838"/>
      <ellipse cx="9" cy="60" rx="8" ry="12" fill="#3a4a6a" stroke="#6888cc" stroke-width="1.5"/>
      <rect x="4" y="53" width="10" height="2" fill="#e8a838"/><rect x="4" y="65" width="10" height="2" fill="#e8a838"/>
      <rect x="8" y="51" width="2" height="18" fill="#e8a838"/>
    </svg>`,
    baseStats:{hp:120,maxHp:120,atk:20,def:14,spd:8,level:1,xp:0},
    elementAtk:{fire:10,thunder:8}, // Hiro: fire/thunder affinity
    elementRes:{fire:8,ice:5,thunder:5,poison:5,dragon:0},
    skills:[
      {id:"slash",name:"Power Slash",jp:"ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒ©ãƒƒã‚·ãƒ¥",cost:2,dmgMult:2.2,effect:"dmg",icon:"âš”ï¸",desc:"Heavy sword strike"},
      {id:"shield_bash",name:"Shield Bash",jp:"ã‚·ãƒ¼ãƒ«ãƒ‰ãƒãƒƒã‚·ãƒ¥",cost:3,dmgMult:1.5,effect:"stun",icon:"ðŸ›¡ï¸",desc:"Stun enemy 1 turn"},
      {id:"holy_light",name:"Holy Light",jp:"ãƒ›ãƒ¼ãƒªãƒ¼ãƒ©ã‚¤ãƒˆ",cost:4,dmgMult:1.8,effect:"heal",icon:"âœ¨",desc:"Damage + heal 20HP"},
    ]
  },
  roku:{
    id:"roku", name:"67", jp:"ãƒ­ã‚¯ãƒŠãƒŠ", class:"Assassin", price:1200, free:false,
    art:`<svg width="80" height="90" viewBox="0 0 80 90" style="display:block;margin:auto;">
      <path d="M 18 40 Q 16 72 20 88 L 60 88 Q 64 72 62 40 Z" fill="#1a1a28" stroke="#4a3a6a" stroke-width="1"/>
      <rect x="26" y="40" width="28" height="30" rx="1" fill="#1e1e30" stroke="#3a2a5a" stroke-width="1"/>
      <line x1="26" y1="43" x2="54" y2="60" stroke="#8855cc" stroke-width="2"/>
      <line x1="54" y1="43" x2="26" y2="60" stroke="#8855cc" stroke-width="2"/>
      <rect x="25" y="14" width="30" height="28" rx="4" fill="#1a1a28" stroke="#4a3a6a" stroke-width="1.5"/>
      <rect x="28" y="23" width="8" height="4" rx="1" fill="#cc44ff" opacity="0.9"/>
      <rect x="44" y="23" width="8" height="4" rx="1" fill="#cc44ff" opacity="0.9"/>
      <path d="M 32 14 Q 34 6 40 8 Q 46 6 48 14" fill="none" stroke="#5a3a7a" stroke-width="2"/>
      <path d="M 14 38 Q 10 44 14 50 L 26 46 L 24 38 Z" fill="#2a1a3a" stroke="#4a3a6a" stroke-width="1"/>
      <path d="M 66 38 Q 70 44 66 50 L 54 46 L 56 38 Z" fill="#2a1a3a" stroke="#4a3a6a" stroke-width="1"/>
      <rect x="13" y="48" width="12" height="20" rx="2" fill="#1a1a28" stroke="#3a2a5a" stroke-width="1"/>
      <rect x="55" y="48" width="12" height="20" rx="2" fill="#1a1a28" stroke="#3a2a5a" stroke-width="1"/>
      <rect x="6" y="50" width="3" height="26" rx="1" fill="#a0a8c0" stroke="#7080a0" stroke-width="0.5"/>
      <rect x="4" y="56" width="7" height="3" rx="0.5" fill="#5a3a7a"/>
      <rect x="69" y="50" width="3" height="26" rx="1" fill="#a0a8c0" stroke="#7080a0" stroke-width="0.5"/>
      <rect x="67" y="56" width="7" height="3" rx="0.5" fill="#5a3a7a"/>
      <rect x="24" y="70" width="12" height="18" rx="1" fill="#1a1a28" stroke="#3a2a5a" stroke-width="1"/>
      <rect x="44" y="70" width="12" height="18" rx="1" fill="#1a1a28" stroke="#3a2a5a" stroke-width="1"/>
      <rect x="26" y="40" width="28" height="3" fill="#6622aa" opacity="0.6"/>
    </svg>`,
    baseStats:{hp:85,maxHp:85,atk:32,def:7,spd:18,level:1,xp:0},
    elementAtk:{poison:15,ice:8}, // Roku: poison/ice affinity (assassin)
    elementRes:{poison:10,ice:8,fire:0,thunder:0,dragon:0},
    skills:[
      {id:"backstab",name:"Backstab",jp:"ãƒãƒƒã‚¯ã‚¹ã‚¿ãƒ–",cost:2,dmgMult:3.0,effect:"dmg",icon:"ðŸ—¡ï¸",desc:"Critical strike 3Ã—"},
      {id:"shadowstep",name:"Shadow Step",jp:"ã‚·ãƒ£ãƒ‰ã‚¦ã‚¹ãƒ†ãƒƒãƒ—",cost:3,dmgMult:2.0,effect:"evade",icon:"ðŸŒ‘",desc:"Attack + 1-turn dodge"},
      {id:"poison_blade",name:"Poison Blade",jp:"ãƒã‚¤ã‚ºãƒ³ãƒ–ãƒ¬ãƒ¼ãƒ‰",cost:4,dmgMult:2.0,effect:"poison",icon:"â˜ ï¸",desc:"Poison 3 turns"},
    ]
  },
  kisaragi:{
    id:"kisaragi", name:"KISARAGI", jp:"ã‚­ã‚µãƒ©ã‚®", class:"Fighter", price:1500, free:false,
    art:`<svg width="80" height="90" viewBox="0 0 80 90" style="display:block;margin:auto;">
      <rect x="18" y="38" width="44" height="36" rx="3" fill="#4a2a18" stroke="#c87840" stroke-width="1.5"/>
      <path d="M 40 42 L 34 52 L 46 52 Z" fill="none" stroke="#ff6020" stroke-width="2" opacity="0.8"/>
      <circle cx="40" cy="56" r="4" fill="none" stroke="#ff6020" stroke-width="1.5" opacity="0.8"/>
      <rect x="24" y="12" width="32" height="28" rx="4" fill="#5a3828" stroke="#c87840" stroke-width="1.5"/>
      <rect x="27" y="21" width="9" height="5" rx="1" fill="#ff4400" opacity="0.9"/>
      <rect x="44" y="21" width="9" height="5" rx="1" fill="#ff4400" opacity="0.9"/>
      <line x1="26" y1="19" x2="37" y2="22" stroke="#3a1808" stroke-width="2"/>
      <line x1="43" y1="22" x2="54" y2="19" stroke="#3a1808" stroke-width="2"/>
      <rect x="22" y="15" width="36" height="5" rx="0" fill="#cc2200" opacity="0.8"/>
      <path d="M 28 12 L 24 2 L 32 10" fill="#2a1808"/>
      <path d="M 40 10 L 38 0 L 44 8" fill="#2a1808"/>
      <path d="M 52 12 L 56 2 L 48 10" fill="#2a1808"/>
      <rect x="6" y="34" width="16" height="16" rx="3" fill="#4a2a18" stroke="#c87840" stroke-width="2"/>
      <rect x="58" y="34" width="16" height="16" rx="3" fill="#4a2a18" stroke="#c87840" stroke-width="2"/>
      <rect x="6" y="50" width="14" height="22" rx="2" fill="#5a3828" stroke="#c87840" stroke-width="1"/>
      <rect x="60" y="50" width="14" height="22" rx="2" fill="#5a3828" stroke="#c87840" stroke-width="1"/>
      <rect x="5" y="70" width="16" height="12" rx="2" fill="#3a1808" stroke="#c87840" stroke-width="1.5"/>
      <rect x="59" y="70" width="16" height="12" rx="2" fill="#3a1808" stroke="#c87840" stroke-width="1.5"/>
      <rect x="22" y="74" width="14" height="14" rx="1" fill="#3a1808" stroke="#c87840" stroke-width="1"/>
      <rect x="44" y="74" width="14" height="14" rx="1" fill="#3a1808" stroke="#c87840" stroke-width="1"/>
    </svg>`,
    baseStats:{hp:160,maxHp:160,atk:24,def:18,spd:5,level:1,xp:0},
    elementAtk:{fire:18,dragon:10}, // Kisaragi: fire/dragon affinity (berserker)
    elementRes:{fire:12,poison:8,ice:0,thunder:5,dragon:8},
    skills:[
      {id:"heavy_strike",name:"Heavy Strike",jp:"ãƒ˜ãƒ“ãƒ¼ã‚¹ãƒˆãƒ©ã‚¤ã‚¯",cost:2,dmgMult:2.5,effect:"dmg",icon:"ðŸ’¢",desc:"Massive blow 2.5Ã—"},
      {id:"iron_body",name:"Iron Body",jp:"ã‚¢ã‚¤ã‚¢ãƒ³ãƒœãƒ‡ã‚£",cost:3,dmgMult:0,effect:"fortify",icon:"ðŸª¨",desc:"DEF+12 for 3 turns"},
      {id:"berserker",name:"Berserker",jp:"ãƒãƒ¼ã‚µãƒ¼ã‚«ãƒ¼",cost:4,dmgMult:3.5,effect:"berserk",icon:"ðŸ”¥",desc:"-12HP self, massive dmg"},
    ]
  }
};

/* â”€â”€ ENEMY FIGHT STYLES â€” role passives + active skills â”€â”€ */
const ENEMY_FIGHT_STYLES={
  // â”€â”€ MINI-BOSS FIGHT STYLES â”€â”€
  mb_golem_king:{
    chargeMax:4,specialName:"Iron Fortress",specialIcon:"ðŸ°",
    specialDesc:"DEF doubles for 2 turns",flavor:"Steel never yields.",
    onSpecial:(a)=>{a.enemyStatus=a.enemyStatus.filter(s=>s.type!=="iron_fortress");a.enemyStatus.push({type:"iron_fortress",turns:2,defMult:2});advAddLog(`ðŸ° Iron Fortress! Enemy DEFÃ—2 for 2 turns!`);}
  },
  mb_necro:{
    chargeMax:3,specialName:"Death Bolt",specialIcon:"ðŸ’€",
    specialDesc:"28 true dmg, bypasses armor",flavor:"The dead obey...",
    onSpecial:(a)=>{a.hp=Math.max(0,a.hp-28);advAddLog(`ðŸ’€ Death Bolt! 28 true damage (bypasses armor)!`);showDmgPop("-28 TRUE","#cc44ff",44,38);}
  },
  mb_banshee:{
    chargeMax:2,specialName:"Soul Wail",specialIcon:"ðŸŒ€",
    specialDesc:"Drains 2 SP",flavor:"Her cry weakens the soul...",
    onSpecial:(a)=>{a.sp=Math.max(0,a.sp-2);advAddLog(`ðŸŒ€ Soul Wail! -2 SP drained!`);}
  },
  mb_wyvern:{
    chargeMax:3,specialName:"Fire Breath",specialIcon:"ðŸ”¥",
    specialDesc:"Burns 8 dmg/turn x3",flavor:"Fire scorches the spirit...",
    onSpecial:(a)=>{a.statusEffects=a.statusEffects.filter(s=>s.type!=="burning");a.statusEffects.push({type:"burning",turns:3,dot:8});advAddLog(`ðŸ”¥ Fire Breath! Burning 8/turn x3!`);}
  },
  mb_demon_lord:{
    chargeMax:3,specialName:"Hellfire Surge",specialIcon:"ðŸ”¥",
    specialDesc:"25 dmg + ATK+5",flavor:"Rage fuels the darkness.",
    onSpecial:(a)=>{a.hp=Math.max(0,a.hp-25);a.enemy.atk+=5;advAddLog(`ðŸ”¥ Hellfire Surge! 25 dmg + enemy ATK+5!`);showDmgPop("-25 SURGE","#ff6600",44,38);}
  },
  mb_shadow_knight:{
    chargeMax:3,specialName:"Mirror Slash",specialIcon:"ðŸƒ",
    specialDesc:"Copies player ATK as damage",flavor:"I know your every move.",
    onSpecial:(a)=>{let eff=getCharEffectiveStats(a.charId);let d=Math.max(5,eff.atk);a.hp=Math.max(0,a.hp-d);advAddLog(`ðŸƒ Mirror Slash! ${d} dmg (copied your ATK)!`);showDmgPop(`-${d} MIRROR`,"#8888ff",44,38);}
  },
  // â”€â”€ FINAL BOSS â”€â”€
  boss_demon_king:{
    chargeMax:4,specialName:"Void Annihilation",specialIcon:"ðŸ‘‘",
    specialDesc:"50% max HP true damage â€” defend!",flavor:"YOUR WORDS MEAN NOTHING.",
    onSpecial:(a)=>{let d=Math.round(a.maxHp*0.5);a.hp=Math.max(0,a.hp-d);showDmgPop(`ANNIHILATION -${d}!`,"#ff0000",44,30);advAddLog(`ðŸ‘‘ VOID ANNIHILATION! ${d} true damage!`);}
  },
  // â”€â”€ HIDDEN BOSS â”€â”€
  hidden_chronovore:{
    chargeMax:3,specialName:"Time Crush",specialIcon:"â°",
    specialDesc:"35% max HP true damage + SP drain",flavor:"TIME IS MINE TO CONSUME.",
    onSpecial:(a)=>{let d=Math.round(a.maxHp*0.35);a.hp=Math.max(0,a.hp-d);a.sp=Math.max(0,a.sp-3);showDmgPop(`TIME CRUSH -${d}!`,"#9900ff",44,30);advAddLog(`â° TIME CRUSH! ${d} true dmg + SP -3!`);}
  }
};

/* â”€â”€ APPLY ENEMY ROLE PASSIVE on attack â”€â”€ */
function applyEnemyRolePassive(enemy, rawAtk){
  // Berserker: +20% ATK if HP < 50%
  if(enemy.role==="Berserker" && adv.enemyHp < adv.enemyMaxHp*0.5){
    return Math.round(rawAtk*1.20);
  }
  return rawAtk;
}

/* â”€â”€ APPLY ENEMY ACTIVE SKILL â”€â”€ */
function tryEnemyActiveSkill(enemy){
  if(!enemy.activeName||!enemy.activeCD)return false;
  if(!adv._enemySkillCooldown)adv._enemySkillCooldown={};
  let cd=adv._enemySkillCooldown[enemy.id]||0;
  if(cd>0){adv._enemySkillCooldown[enemy.id]=cd-1;return false;}
  // 35% chance per turn to use skill when cooldown is ready
  if(Math.random()>0.35)return false;
  adv._enemySkillCooldown[enemy.id]=enemy.activeCD;
  let effStats=getCharEffectiveStats(adv.charId);
  let effect=enemy.activeEffect;
  advAddLog(`âš¡ ${enemy.name}: ${enemy.activeName}!`);

  if(effect==="dmg"||effect==="guaranteed_crit"){
    let mult=enemy.activeMult||1.5;
    let isCrit=effect==="guaranteed_crit"||enemy.role==="Assassin";
    // Mage: ignore 30% DEF
    let defMod=enemy.role==="Mage"?(1-Math.min(0.30,enemy.ignoreDefPct||0)):1.0;
    let trueDmgBonus=enemy.role==="Anti-Tank"?(enemy.trueDmgPct||0):0;
    let def=Math.max(0,effStats.def*defMod);
    let dmg=advCalcDamage(applyEnemyRolePassive(enemy,enemy.atk),def,mult,isCrit);
    let truePart=Math.round(adv.maxHp*trueDmgBonus);
    adv.hp=Math.max(0,adv.hp-dmg-truePart);
    if(truePart>0)advAddLog(`ðŸ’Ž True dmg: ${truePart}!`);
    advAddLog(`${isCrit?'ðŸ’¥ CRIT! ':''}${mult*100|0}% strike: ${dmg} dmg!`);
    showDmgPop(`-${dmg}${isCrit?'!':''}`,isCrit?"#fff700":"#ff4444",38,50);
  } else if(effect==="shield_wall"){
    let curDef=enemy.def||10;
    adv.enemyStatus=adv.enemyStatus.filter(s=>s.type!=="shield_wall_buff");
    adv.enemyStatus.push({type:"shield_wall_buff",turns:2,defBonus:Math.round(curDef*0.4)});
    advAddLog(`ðŸ›¡ï¸ Shield Wall! DEF +${Math.round(curDef*0.4)} for 2 turns!`);
  } else if(effect==="armor_break"){
    let debuffAmt=Math.round(effStats.def*0.3);
    adv.statusEffects=adv.statusEffects.filter(s=>s.type!=="armor_broken");
    adv.statusEffects.push({type:"armor_broken",turns:3,defPenalty:debuffAmt});
    advAddLog(`ðŸ”¨ Armor Break! Your DEF -${debuffAmt} for 3 turns!`);
    showDmgPop(`DEF -${debuffAmt}`,"#ff8800",38,50);
  } else if(effect==="toxic_cloud"){
    // Double poison â€” 5% max HP per turn for 3 turns, twice
    let dotAmt=Math.round(adv.maxHp*0.05);
    adv.statusEffects=adv.statusEffects.filter(s=>s.type!=="poisoned"&&s.type!=="poisoned2");
    adv.statusEffects.push({type:"poisoned",turns:3,dot:dotAmt});
    adv.statusEffects.push({type:"poisoned2",turns:3,dot:dotAmt});
    advAddLog(`â˜ ï¸ Toxic Cloud! Double poison ${dotAmt}/turn Ã—3!`);
    showDmgPop(`â˜ ï¸Ã—2 TOXIC`,"#44ff80",38,50);
  } else if(effect==="aoe_dmg"){
    let mult=enemy.activeMult||1.2;
    let defMod=enemy.role==="Mage"?(1-(enemy.ignoreDefPct||0.3)):1.0;
    let def=Math.max(0,effStats.def*defMod);
    let dmg=advCalcDamage(enemy.atk,def,mult);
    adv.hp=Math.max(0,adv.hp-dmg);
    // Also reduce SP
    adv.sp=Math.max(0,adv.sp-1);
    advAddLog(`ðŸ”® Arcane Burst! ${dmg} AoE dmg! -1 SP!`);
    showDmgPop(`-${dmg} AoE`,"#cc44ff",38,50);
  } else if(effect==="sp_drain"){
    adv.sp=Math.max(0,adv.sp-2);
    advAddLog(`ðŸ’€ Soul Wail! -2 SP!`);
  } else if(effect==="burning"){
    let dotAmt=enemy.activeDot||8;
    adv.statusEffects.push({type:"burning",turns:3,dot:dotAmt});
    advAddLog(`ðŸ”¥ Fire Breath! Burning ${dotAmt}/turn Ã—3!`);
  } else if(effect==="freeze"){
    let def=Math.max(0,effStats.def);
    let mult=enemy.activeMult||1.8;
    let dmg=advCalcDamage(enemy.atk,def,mult);
    adv.hp=Math.max(0,adv.hp-dmg);
    adv.statusEffects.push({type:"stunned_p",turns:1});
    advAddLog(`â„ï¸ Frost Nova! ${dmg} dmg + Frozen 1 turn!`);
    showDmgPop(`-${dmg} â„ï¸`,"#60d0ff",38,50);
  } else if(effect==="mirror_atk"){
    let eff=getCharEffectiveStats(adv.charId);
    let d=Math.max(5,eff.atk);
    adv.hp=Math.max(0,adv.hp-d);
    advAddLog(`ðŸƒ Mirror Slash! ${d} dmg (reflects your ATK)!`);
    showDmgPop(`-${d} MIRROR`,"#8888ff",38,50);
  } else if(effect==="def_bypass"){
    let d=28+(adv.enemyMaxHp>200?10:0);
    adv.hp=Math.max(0,adv.hp-d);
    advAddLog(`ðŸ’€ Death Bolt! ${d} TRUE dmg!`);
    showDmgPop(`-${d} TRUE`,"#cc44ff",38,50);
  } else if(effect==="dmg_and_atk_up"){
    adv.hp=Math.max(0,adv.hp-25);
    adv.enemy.atk+=5;
    advAddLog(`ðŸ”¥ Hellfire Surge! 25 dmg + ATK+5!`);
  } else if(effect==="true_dmg_pct"){
    let d=Math.round(adv.maxHp*(enemy.id==="hidden_chronovore"?0.35:0.50));
    adv.hp=Math.max(0,adv.hp-d);
    advAddLog(`ðŸ’¥ ${enemy.activeName}! ${d} true dmg!`);
    showDmgPop(`-${d} TRUE`,"#ff0000",44,30);
  } else if(effect==="lifesteal"){
    let d=Math.round(adv.maxHp*0.15);
    adv.hp=Math.max(0,adv.hp-d);
    adv.enemyHp=Math.min(adv.enemyMaxHp,adv.enemyHp+d);
    advAddLog(`ðŸ©¸ Soul Drain! Stole ${d} HP!`);
    showDmgPop(`-${d} DRAIN`,"#cc0044",38,50);
  } else if(effect==="aura_buff"){
    adv.enemyStatus.push({type:"aura_buff",turns:3});
    adv.enemy.atk=Math.round(adv.enemy.atk*1.2);
    advAddLog(`âœ¨ Dragon Aura! All effects amplified 3 turns!`);
  } else if(effect==="time_reverse"){
    let heal=Math.round(adv.enemyMaxHp*0.15);
    adv.enemyHp=Math.min(adv.enemyMaxHp,adv.enemyHp+heal);
    advAddLog(`âª Temporal Reversal! Enemy heals ${heal} HP!`);
    showDmgPop(`+${heal}â¤ï¸ REVERSE`,"#9900ff",52,22);
  }
  return true;
}

/* â”€â”€ ELEMENT SYSTEM â”€â”€ */
// Elements: poison(DoT), fire(dmg+%), ice(slow/spd-), thunder(stun), dragon(amplify all)
// Each enemy/character has elementAtk (chance%) and elementRes (reduce effect %)
// Max element effect cap: 40%
const ELEMENT_COLORS={poison:"#44ff80",fire:"#ff6020",ice:"#60d0ff",thunder:"#ffe040",dragon:"#d080ff"};
const ELEMENT_ICONS={poison:"â˜ ï¸",fire:"ðŸ”¥",ice:"â„ï¸",thunder:"âš¡",dragon:"ðŸ‰"};

function applyElementEffect(element,chance,target,log,isDragonAmplified){
  // target: "enemy" or "player"
  // Armor elemental resistance handled in advEnemyTurn/advCombatAction
  let roll=Math.random()*100;
  let effectChance=Math.min(40,chance*(isDragonAmplified?1.5:1));
  if(roll>effectChance)return false;
  let icon=ELEMENT_ICONS[element]||'';
  if(target==="enemy"){
    if(element==="poison"){let dot=Math.max(3,Math.round(adv.enemy.atk*0.18));adv.enemyStatus=adv.enemyStatus.filter(s=>s.type!=="poison");adv.enemyStatus.push({type:"poison",turns:3,dot});log(`${icon} POISON! ${dot}/turn x3`);}
    if(element==="fire"){adv.enemyStatus.push({type:"fire_amp",turns:2,pct:0.25});log(`${icon} FIRE! +25% dmg taken x2 turns`);}
    if(element==="ice"){adv.enemyStatus.push({type:"ice_slow",turns:2});log(`${icon} ICE! Enemy slowed (-40% atk) x2 turns`);}
    if(element==="thunder"){let hasstun=adv.enemyStatus.find(s=>s.type==="stunned");if(!hasstun){adv.enemyStatus.push({type:"stunned",turns:1});log(`${icon} THUNDER! Enemy STUNNED 1 turn!`);}}
    if(element==="dragon"){// amplifies all effects on enemy
      adv.enemyStatus.forEach(s=>{s.turns=Math.min(s.turns+1,(s.turns||1)+1);if(s.dot)s.dot=Math.round(s.dot*1.3);});
      log(`${icon} DRAGON! All effects amplified!`);
    }
  } else {
    if(element==="poison"){let dot=Math.max(2,Math.round(adv.enemy.atk*0.12));adv.statusEffects=adv.statusEffects.filter(s=>s.type!=="poisoned");adv.statusEffects.push({type:"poisoned",turns:3,dot});log(`${icon} POISONED! ${dot}/turn x3`);}
    if(element==="fire"){adv.statusEffects.push({type:"burning",turns:2,dot:Math.max(4,Math.round(adv.enemy.atk*0.15))});log(`${icon} BURNING!`);}
    if(element==="ice"){adv.statusEffects.push({type:"ice_slow",turns:2});log(`${icon} ICE! Player slowed next turn`);}
    if(element==="thunder"){adv.statusEffects.push({type:"stunned_p",turns:1});log(`${icon} THUNDER! Stunned â€” action points halved next turn!`);}
    if(element==="dragon"){adv.statusEffects.forEach(s=>{s.turns=Math.min(s.turns+1,(s.turns||1)+1);if(s.dot)s.dot=Math.round(s.dot*1.3);});log(`${icon} DRAGON! All effects amplified!`);}
  }
  return true;
}

/* â”€â”€ ENEMY POOL â€” 30 normal enemies + 6 mini-bosses + 1 final boss + 1 hidden boss â”€â”€ */
/* Scaling: HP=baseHP*(1+stage*0.25), ATK=baseATK*(1+stage*0.15), DEF=baseDEF*(1+stage*0.15), SPD=baseSPD*(1+stage*0.10) */
/* Each enemy has: role, passive, activeName/activeCD/activeEffect */

/* â”€â”€ SPECIAL BOSS ART â”€â”€ */
const BOSS_ART={
  // Mini-Boss 1: Iron Golem King â€” massive mechanical warrior
  mb_golem_king:`<svg width="80" height="90" viewBox="0 0 80 90" style="display:block;margin:auto;">
    <rect x="20" y="35" width="40" height="38" rx="2" fill="#2a3a4a" stroke="#6688aa" stroke-width="2"/>
    <rect x="24" y="39" width="32" height="28" rx="1" fill="#1a2a3a" stroke="#4466aa" stroke-width="1"/>
    <rect x="30" y="45" width="8" height="4" fill="#ff4400"/><rect x="42" y="45" width="8" height="4" fill="#ff4400"/>
    <rect x="32" y="55" width="16" height="3" fill="#4466aa"/>
    <rect x="22" y="10" width="36" height="27" rx="3" fill="#2a3a4a" stroke="#6688aa" stroke-width="2"/>
    <rect x="10" y="33" width="16" height="14" rx="2" fill="#2a3a4a" stroke="#5577aa" stroke-width="1.5"/>
    <rect x="54" y="33" width="16" height="14" rx="2" fill="#2a3a4a" stroke="#5577aa" stroke-width="1.5"/>
    <rect x="8" y="47" width="14" height="20" rx="1" fill="#1e2e3e" stroke="#4466aa" stroke-width="1"/>
    <rect x="58" y="47" width="14" height="20" rx="1" fill="#1e2e3e" stroke="#4466aa" stroke-width="1"/>
    <rect x="7" y="65" width="16" height="14" rx="1" fill="#2a3a4a" stroke="#4466aa" stroke-width="1.5"/>
    <rect x="57" y="65" width="16" height="14" rx="1" fill="#2a3a4a" stroke="#4466aa" stroke-width="1.5"/>
    <rect x="22" y="73" width="14" height="16" rx="1" fill="#1e2e3e" stroke="#4466aa" stroke-width="1"/>
    <rect x="44" y="73" width="14" height="16" rx="1" fill="#1e2e3e" stroke="#4466aa" stroke-width="1"/>
    <rect x="26" y="17" width="28" height="8" rx="1" fill="#ff4400" opacity="0.8"/>
    <circle cx="30" cy="21" r="3" fill="#ffaa00"/><circle cx="50" cy="21" r="3" fill="#ffaa00"/>
    <rect x="34" y="6" width="12" height="6" rx="1" fill="#4466aa"/>
    <rect x="36" y="2" width="8" height="5" rx="1" fill="#2a3a4a" stroke="#6688aa" stroke-width="1"/>
    <rect x="14" y="47" width="3" height="18" rx="1" fill="#ffaa00" opacity="0.7"/>
    <rect x="63" y="47" width="3" height="18" rx="1" fill="#ffaa00" opacity="0.7"/>
  </svg>`,

  // Mini-Boss 2: Void Necromancer â€” skeletal mage draped in shadow
  mb_necro:`<svg width="80" height="90" viewBox="0 0 80 90" style="display:block;margin:auto;">
    <path d="M 26 38 Q 22 70 24 88 L 56 88 Q 58 70 54 38 Z" fill="#100018" stroke="#6600aa" stroke-width="1"/>
    <rect x="24" y="38" width="32" height="32" rx="1" fill="#140020" stroke="#5500aa" stroke-width="1"/>
    <path d="M 24 50 Q 40 44 56 50" fill="none" stroke="#cc00ff" stroke-width="1.5" opacity="0.7"/>
    <path d="M 24 58 Q 40 52 56 58" fill="none" stroke="#cc00ff" stroke-width="1" opacity="0.5"/>
    <rect x="24" y="12" width="32" height="28" rx="10" fill="#100018" stroke="#6600aa" stroke-width="1.5"/>
    <rect x="28" y="21" width="10" height="6" rx="2" fill="#cc00ff" opacity="0.9"/>
    <rect x="42" y="21" width="10" height="6" rx="2" fill="#cc00ff" opacity="0.9"/>
    <path d="M 33 14 Q 40 8 47 14" fill="none" stroke="#6600aa" stroke-width="2"/>
    <path d="M 30 34 Q 40 30 50 34" fill="#300040" stroke="#6600aa" stroke-width="1"/>
    <rect x="8" y="36" width="18" height="12" rx="2" fill="#100018" stroke="#5500aa" stroke-width="1"/>
    <rect x="54" y="36" width="18" height="12" rx="2" fill="#100018" stroke="#5500aa" stroke-width="1"/>
    <rect x="7" y="48" width="14" height="22" rx="2" fill="#0c0018" stroke="#4400aa" stroke-width="1"/>
    <rect x="59" y="48" width="14" height="22" rx="2" fill="#0c0018" stroke="#4400aa" stroke-width="1"/>
    <rect x="22" y="70" width="12" height="18" rx="1" fill="#100018" stroke="#4400aa" stroke-width="1"/>
    <rect x="46" y="70" width="12" height="18" rx="1" fill="#100018" stroke="#4400aa" stroke-width="1"/>
    <circle cx="40" cy="62" r="6" fill="none" stroke="#cc00ff" stroke-width="1.5" opacity="0.8"/>
    <circle cx="40" cy="62" r="3" fill="#cc00ff" opacity="0.6"/>
    <line x1="4" y1="52" x2="22" y2="46" stroke="#cc00ff" stroke-width="1.5" opacity="0.6"/>
    <circle cx="4" cy="52" r="4" fill="#330044" stroke="#cc00ff" stroke-width="1"/>
  </svg>`,

  // Mini-Boss 3: Crystal Banshee Queen â€” ethereal ice specter
  mb_banshee:`<svg width="80" height="90" viewBox="0 0 80 90" style="display:block;margin:auto;">
    <path d="M 30 42 Q 12 55 14 80 Q 24 90 40 88 Q 56 90 66 80 Q 68 55 50 42 Z" fill="#0a1a2a" stroke="#60d0ff" stroke-width="1.5"/>
    <path d="M 30 42 Q 20 50 22 65 Q 30 70 40 68 Q 50 70 58 65 Q 60 50 50 42" fill="#102030" stroke="#40b0ee" stroke-width="1" opacity="0.7"/>
    <ellipse cx="40" cy="22" rx="18" ry="22" fill="#0a1a2a" stroke="#60d0ff" stroke-width="1.5"/>
    <ellipse cx="32" cy="19" rx="5" ry="3" fill="#60d0ff" opacity="0.9"/>
    <ellipse cx="48" cy="19" rx="5" ry="3" fill="#60d0ff" opacity="0.9"/>
    <path d="M 34 30 Q 40 27 46 30" fill="none" stroke="#60d0ff" stroke-width="1.5" opacity="0.7"/>
    <path d="M 26 8 L 22 0 L 28 6 L 32 0 L 34 8" fill="none" stroke="#60d0ff" stroke-width="1.5"/>
    <path d="M 54 8 L 58 0 L 52 6 L 48 0 L 46 8" fill="none" stroke="#60d0ff" stroke-width="1.5"/>
    <path d="M 14 60 Q 8 50 4 62 Q 8 74 16 68 Z" fill="#0a1a2a" stroke="#60d0ff" stroke-width="1"/>
    <path d="M 66 60 Q 72 50 76 62 Q 72 74 64 68 Z" fill="#0a1a2a" stroke="#60d0ff" stroke-width="1"/>
    <circle cx="40" cy="55" r="8" fill="none" stroke="#60d0ff" stroke-width="1" opacity="0.5"/>
    <circle cx="40" cy="55" r="3" fill="#60d0ff" opacity="0.4"/>
    <path d="M 30 78 Q 40 85 50 78 Q 50 90 40 92 Q 30 90 30 78" fill="#0a1a2a" stroke="#60d0ff" stroke-width="1" opacity="0.6"/>
  </svg>`,

  // Mini-Boss 4: Mech-Dragon Wyvern â€” cybernetic dragon
  mb_wyvern:`<svg width="80" height="90" viewBox="0 0 80 90" style="display:block;margin:auto;">
    <ellipse cx="40" cy="52" rx="22" ry="14" fill="#1a0808" stroke="#cc2200" stroke-width="1.5"/>
    <path d="M 18 50 Q 4 40 2 52 Q 4 64 18 58 Z" fill="#200808" stroke="#cc2200" stroke-width="1.5"/>
    <path d="M 62 50 Q 76 40 78 52 Q 76 64 62 58 Z" fill="#200808" stroke="#cc2200" stroke-width="1.5"/>
    <path d="M 24 40 Q 20 20 14 10 Q 18 8 24 14 Q 26 24 28 38 Z" fill="#300a0a" stroke="#ff4400" stroke-width="1"/>
    <path d="M 56 40 Q 60 20 66 10 Q 62 8 56 14 Q 54 24 52 38 Z" fill="#300a0a" stroke="#ff4400" stroke-width="1"/>
    <ellipse cx="40" cy="38" rx="14" ry="16" fill="#200808" stroke="#ff4400" stroke-width="1.5"/>
    <rect x="30" y="28" width="20" height="6" rx="3" fill="#1a0000" stroke="#ff6600" stroke-width="1"/>
    <rect x="32" y="30" width="16" height="2" fill="#ff4400" opacity="0.8"/>
    <circle cx="34" cy="34" rx="4" ry="3" fill="#ff2200" opacity="0.9"/>
    <circle cx="46" cy="34" rx="4" ry="3" fill="#ff2200" opacity="0.9"/>
    <path d="M 36 42 Q 40 40 44 42 Q 42 45 40 44 Q 38 45 36 42" fill="#ff4400" opacity="0.7"/>
    <rect x="26" y="54" width="10" height="18" rx="2" fill="#200808" stroke="#cc2200" stroke-width="1"/>
    <rect x="44" y="54" width="10" height="18" rx="2" fill="#200808" stroke="#cc2200" stroke-width="1"/>
    <path d="M 30 72 Q 28 80 26 88 L 34 88 Q 34 80 32 72 Z" fill="#1a0808" stroke="#cc2200" stroke-width="1"/>
    <path d="M 50 72 Q 52 80 54 88 L 46 88 Q 46 80 48 72 Z" fill="#1a0808" stroke="#cc2200" stroke-width="1"/>
    <rect x="36" y="58" width="8" height="4" rx="1" fill="#ff6600" opacity="0.8"/>
    <rect x="34" y="62" width="12" height="3" rx="1" fill="#ff4400" opacity="0.6"/>
  </svg>`,

  // Mini-Boss 5: Shadow Specter Knight â€” dark armored phantom
  mb_shadow_knight:`<svg width="80" height="90" viewBox="0 0 80 90" style="display:block;margin:auto;">
    <rect x="20" y="38" width="40" height="34" rx="2" fill="#0a0a18" stroke="#4444cc" stroke-width="1.5"/>
    <rect x="24" y="42" width="32" height="24" rx="1" fill="#080814" stroke="#2222aa" stroke-width="1"/>
    <rect x="34" y="46" width="12" height="2" fill="#4444cc" opacity="0.8"/>
    <rect x="34" y="50" width="12" height="2" fill="#4444cc" opacity="0.6"/>
    <rect x="34" y="54" width="12" height="2" fill="#4444cc" opacity="0.4"/>
    <rect x="22" y="12" width="36" height="28" rx="3" fill="#0a0a18" stroke="#4444cc" stroke-width="1.5"/>
    <rect x="26" y="22" width="28" height="8" rx="1" fill="#080814" stroke="#2244aa" stroke-width="1"/>
    <rect x="28" y="23" width="10" height="6" rx="1" fill="#2244cc" opacity="0.9"/>
    <rect x="42" y="23" width="10" height="6" rx="1" fill="#2244cc" opacity="0.9"/>
    <path d="M 34 12 Q 40 6 46 12" fill="none" stroke="#2233aa" stroke-width="2"/>
    <rect x="36" y="4" width="8" height="9" rx="1" fill="#0a0a18" stroke="#4444cc" stroke-width="1"/>
    <rect x="8" y="36" width="16" height="14" rx="2" fill="#0a0a18" stroke="#3333aa" stroke-width="1.5"/>
    <rect x="56" y="36" width="16" height="14" rx="2" fill="#0a0a18" stroke="#3333aa" stroke-width="1.5"/>
    <rect x="7" y="50" width="13" height="22" rx="2" fill="#080814" stroke="#2222aa" stroke-width="1"/>
    <rect x="60" y="50" width="13" height="22" rx="2" fill="#080814" stroke="#2222aa" stroke-width="1"/>
    <rect x="22" y="72" width="13" height="16" rx="1" fill="#0a0a18" stroke="#2222aa" stroke-width="1"/>
    <rect x="45" y="72" width="13" height="16" rx="1" fill="#0a0a18" stroke="#2222aa" stroke-width="1"/>
    <rect x="62" y="20" width="4" height="44" rx="1" fill="#6666ee" stroke="#2222aa" stroke-width="0.5"/>
    <rect x="58" y="34" width="12" height="4" rx="1" fill="#4444cc"/>
    <rect x="61" y="16" width="6" height="6" rx="1" fill="#4444cc"/>
    <path d="M 4 44 Q 8 30 12 38 Q 8 52 4 46 Z" fill="#0a0a18" stroke="#4444cc" stroke-width="1"/>
  </svg>`,

  // Mini-Boss 6: Hellfire Demon Lord â€” demonic commander
  mb_demon_lord:`<svg width="80" height="90" viewBox="0 0 80 90" style="display:block;margin:auto;">
    <rect x="18" y="36" width="44" height="36" rx="3" fill="#200808" stroke="#cc2200" stroke-width="2"/>
    <path d="M 22 40 Q 40 36 58 40 Q 58 60 40 64 Q 22 60 22 40" fill="#280a0a" stroke="#ff4400" stroke-width="1"/>
    <path d="M 32 48 L 36 54 L 44 54 L 48 48 L 40 44 Z" fill="#ff4400" opacity="0.7"/>
    <circle cx="33" cy="48" r="4" fill="#ff2200" opacity="0.9"/>
    <circle cx="47" cy="48" r="4" fill="#ff2200" opacity="0.9"/>
    <rect x="18" y="10" width="44" height="28" rx="4" fill="#200808" stroke="#cc2200" stroke-width="2"/>
    <rect x="22" y="19" width="12" height="7" rx="1" fill="#ff4400" opacity="0.9"/>
    <rect x="46" y="19" width="12" height="7" rx="1" fill="#ff4400" opacity="0.9"/>
    <path d="M 28 10 L 24 0 L 32 8 Q 40 4 48 8 L 56 0 L 52 10" fill="#300a0a" stroke="#ff4400" stroke-width="1.5"/>
    <path d="M 30 32 Q 40 28 50 32" fill="#300a0a" stroke="#cc2200" stroke-width="1"/>
    <rect x="4" y="32" width="18" height="16" rx="3" fill="#200808" stroke="#cc2200" stroke-width="1.5"/>
    <rect x="58" y="32" width="18" height="16" rx="3" fill="#200808" stroke="#cc2200" stroke-width="1.5"/>
    <rect x="3" y="48" width="16" height="24" rx="2" fill="#1a0808" stroke="#aa2200" stroke-width="1"/>
    <rect x="61" y="48" width="16" height="24" rx="2" fill="#1a0808" stroke="#aa2200" stroke-width="1"/>
    <rect x="4" y="68" width="18" height="12" rx="2" fill="#200808" stroke="#cc2200" stroke-width="1.5"/>
    <rect x="58" y="68" width="18" height="12" rx="2" fill="#200808" stroke="#cc2200" stroke-width="1.5"/>
    <rect x="20" y="72" width="14" height="18" rx="1" fill="#1a0808" stroke="#aa2200" stroke-width="1"/>
    <rect x="46" y="72" width="14" height="18" rx="1" fill="#1a0808" stroke="#aa2200" stroke-width="1"/>
    <rect x="74" y="16" width="4" height="48" rx="1" fill="#cc2200" stroke="#ff4400" stroke-width="0.5"/>
    <rect x="70" y="30" width="12" height="4" rx="1" fill="#ff4400"/>
    <path d="M 72 12 L 74 4 L 78 14 Z" fill="#ff4400"/>
  </svg>`,

  // FINAL BOSS: Demon King Malachar â€” armored demon overlord
  boss_demon_king:`<svg width="90" height="100" viewBox="0 0 90 100" style="display:block;margin:auto;">
    <rect x="14" y="42" width="62" height="42" rx="3" fill="#1a0008" stroke="#cc0044" stroke-width="2.5"/>
    <rect x="20" y="48" width="50" height="30" rx="2" fill="#220010" stroke="#aa0033" stroke-width="1.5"/>
    <path d="M 25 55 Q 45 50 65 55 Q 65 72 45 76 Q 25 72 25 55" fill="#280012" stroke="#ff0055" stroke-width="1"/>
    <rect x="34" y="58" width="10" height="5" rx="1" fill="#ff0055" opacity="0.9"/>
    <rect x="46" y="58" width="10" height="5" rx="1" fill="#ff0055" opacity="0.9"/>
    <rect x="38" y="65" width="14" height="4" rx="1" fill="#cc0044" opacity="0.7"/>
    <rect x="14" y="10" width="62" height="34" rx="4" fill="#1a0008" stroke="#cc0044" stroke-width="2.5"/>
    <rect x="20" y="20" width="50" height="16" rx="2" fill="#220010" stroke="#aa0033" stroke-width="1.5"/>
    <rect x="22" y="21" width="16" height="10" rx="2" fill="#ff0055" opacity="0.95"/>
    <rect x="52" y="21" width="16" height="10" rx="2" fill="#ff0055" opacity="0.95"/>
    <path d="M 30 10 L 24 0 L 32 6 L 36 0 L 40 4 L 44 0 L 48 6 L 54 0 L 60 10" fill="#1a0008" stroke="#cc0044" stroke-width="2"/>
    <rect x="34" y="36" width="22" height="6" rx="1" fill="#cc0044" opacity="0.8"/>
    <rect x="0" y="38" width="20" height="18" rx="3" fill="#1a0008" stroke="#cc0044" stroke-width="2"/>
    <rect x="70" y="38" width="20" height="18" rx="3" fill="#1a0008" stroke="#cc0044" stroke-width="2"/>
    <rect x="0" y="56" width="18" height="28" rx="2" fill="#150006" stroke="#aa0033" stroke-width="1.5"/>
    <rect x="72" y="56" width="18" height="28" rx="2" fill="#150006" stroke="#aa0033" stroke-width="1.5"/>
    <rect x="0" y="80" width="20" height="14" rx="2" fill="#1a0008" stroke="#cc0044" stroke-width="1.5"/>
    <rect x="70" y="80" width="20" height="14" rx="2" fill="#1a0008" stroke="#cc0044" stroke-width="1.5"/>
    <rect x="14" y="84" width="18" height="16" rx="1" fill="#150006" stroke="#aa0033" stroke-width="1.5"/>
    <rect x="58" y="84" width="18" height="16" rx="1" fill="#150006" stroke="#aa0033" stroke-width="1.5"/>
    <rect x="80" y="22" width="6" height="56" rx="2" fill="#cc0044" stroke="#ff0055" stroke-width="0.5"/>
    <rect x="76" y="36" width="14" height="5" rx="1" fill="#ff0055"/>
    <path d="M 82 18 L 80 6 L 86 20 Z" fill="#ff0055"/>
    <circle cx="45" cy="30" r="6" fill="none" stroke="#ff0055" stroke-width="2" opacity="0.8"/>
    <circle cx="45" cy="30" r="3" fill="#ff0055" opacity="0.6"/>
  </svg>`,

  // HIDDEN BOSS: CHRONOVORE â€” time-devouring entity
  hidden_boss:`<svg width="90" height="100" viewBox="0 0 90 100" style="display:block;margin:auto;">
    <ellipse cx="45" cy="50" rx="30" ry="35" fill="#040010" stroke="#9900ff" stroke-width="2"/>
    <ellipse cx="45" cy="50" rx="22" ry="27" fill="#060018" stroke="#6600cc" stroke-width="1"/>
    <ellipse cx="45" cy="50" rx="14" ry="18" fill="#080020" stroke="#4400aa" stroke-width="1"/>
    <ellipse cx="35" cy="44" rx="7" ry="5" fill="#9900ff" opacity="0.9"/>
    <ellipse cx="55" cy="44" rx="7" ry="5" fill="#9900ff" opacity="0.9"/>
    <ellipse cx="35" cy="44" rx="4" ry="3" fill="#ffffff" opacity="0.95"/>
    <ellipse cx="55" cy="44" rx="4" ry="3" fill="#ffffff" opacity="0.95"/>
    <ellipse cx="35" cy="44" rx="2" ry="2" fill="#000000"/>
    <ellipse cx="55" cy="44" rx="2" ry="2" fill="#000000"/>
    <path d="M 36 55 Q 45 52 54 55 Q 50 62 45 60 Q 40 62 36 55" fill="#9900ff" opacity="0.6"/>
    <path d="M 15 50 Q 0 40 4 55 Q 0 70 16 62 Z" fill="#040010" stroke="#9900ff" stroke-width="1.5"/>
    <path d="M 75 50 Q 90 40 86 55 Q 90 70 74 62 Z" fill="#040010" stroke="#9900ff" stroke-width="1.5"/>
    <path d="M 20 20 Q 10 8 16 4 Q 22 0 26 14 Q 28 22 24 28 Z" fill="#040010" stroke="#cc44ff" stroke-width="1.5"/>
    <path d="M 70 20 Q 80 8 74 4 Q 68 0 64 14 Q 62 22 66 28 Z" fill="#040010" stroke="#cc44ff" stroke-width="1.5"/>
    <path d="M 32 18 Q 28 8 32 4 Q 36 0 38 14 Z" fill="#040010" stroke="#cc44ff" stroke-width="1"/>
    <path d="M 58 18 Q 62 8 58 4 Q 54 0 52 14 Z" fill="#040010" stroke="#cc44ff" stroke-width="1"/>
    <circle cx="45" cy="50" r="6" fill="none" stroke="#9900ff" stroke-width="1" opacity="0.5"/>
    <line x1="45" y1="44" x2="45" y2="50" stroke="#cc44ff" stroke-width="1.5"/>
    <line x1="45" y1="50" x2="50" y2="53" stroke="#cc44ff" stroke-width="1.5"/>
    <path d="M 18 80 Q 14 90 18 94 Q 26 98 30 90 Q 28 82 22 80 Z" fill="#040010" stroke="#9900ff" stroke-width="1"/>
    <path d="M 72 80 Q 76 90 72 94 Q 64 98 60 90 Q 62 82 68 80 Z" fill="#040010" stroke="#9900ff" stroke-width="1"/>
  </svg>`
};

function buildEnemyPool(wordCount){
  let enemies=[
    // â•â•â• TIER 1: Stage 1-3 â€” HP~38-45, ATK~8-10, DEF~3-5 (winrate 95%) â•â•â•
    {id:"goblin",name:"Goblin Scout",jp:"ã‚´ãƒ–ãƒªãƒ³",art:"ðŸ‘º",role:"Berserker",
     hp:38,atk:9,def:3,spd:6,xp:15,gold:8,type:"normal",tier:1,
     passive:"lowHpAtk",passiveDesc:"+20% ATK if HP<50%",
     activeName:"Rage Slash",activeCD:3,activeMult:1.5,activeEffect:"dmg",activeDesc:"150% damage",
     elementAtk:{poison:8},elementRes:{fire:0,ice:0,thunder:0,poison:0,dragon:0}},
    {id:"slime",name:"Blue Slime",jp:"ã‚¹ãƒ©ã‚¤ãƒ ",art:"ðŸŸ¦",role:"Tank",
     hp:42,atk:7,def:5,spd:4,xp:12,gold:6,type:"normal",tier:1,
     passive:"dmgRedPct",dmgReduce:0.2,passiveDesc:"Reduce dmg 20%",
     activeName:"Shield Wall",activeCD:3,activeMult:0,activeEffect:"shield_wall",activeDesc:"DEF +40% 2 turns",
     elementAtk:{ice:10},elementRes:{fire:5,ice:20,thunder:0,poison:0,dragon:0}},
    {id:"skeleton",name:"Skeleton",jp:"ã‚¹ã‚±ãƒ«ãƒˆãƒ³",art:"ðŸ’€",role:"Anti-Tank",
     hp:40,atk:9,def:3,spd:7,xp:18,gold:9,type:"normal",tier:1,
     passive:"trueDmgPct",trueDmgPct:0.10,passiveDesc:"10% true damage",
     activeName:"Armor Break",activeCD:2,activeMult:1.0,activeEffect:"armor_break",activeDesc:"Reduce DEF 30%",
     elementAtk:{},elementRes:{poison:30,ice:10,fire:0,thunder:0,dragon:0}},

    // â•â•â• TIER 2: Stage 4-6 â€” HP~55-70, ATK~13-16, DEF~6-9 (winrate 85%) â•â•â•
    {id:"orc",name:"Orc Warrior",jp:"ã‚ªãƒ¼ã‚¯",art:"ðŸ‘¹",role:"Tank",
     hp:65,atk:13,def:8,spd:5,xp:25,gold:13,type:"normal",tier:2,
     passive:"dmgRedPct",dmgReduce:0.2,passiveDesc:"Reduce dmg 20%",
     activeName:"Shield Wall",activeCD:3,activeMult:0,activeEffect:"shield_wall",activeDesc:"DEF +40% 2 turns",
     elementAtk:{fire:10},elementRes:{poison:5,ice:0,fire:10,thunder:0,dragon:0}},
    {id:"wolf",name:"Dark Wolf",jp:"ãƒ€ãƒ¼ã‚¯ã‚¦ãƒ«ãƒ•",art:"ðŸº",role:"Assassin",
     hp:55,atk:15,def:5,spd:14,xp:22,gold:11,type:"normal",tier:2,
     passive:"critChance",critChance:25,passiveDesc:"25% crit chance",
     activeName:"Shadow Strike",activeCD:3,activeMult:2.2,activeEffect:"guaranteed_crit",activeDesc:"Guaranteed crit strike",
     elementAtk:{},elementRes:{ice:0,fire:0,thunder:5,poison:0,dragon:0}},
    {id:"bandit",name:"Bandit",jp:"ç›—è³Š",art:"ðŸ—¡ï¸",role:"Poisoner",
     hp:58,atk:14,def:6,spd:10,xp:24,gold:12,type:"normal",tier:2,
     passive:"poisonBasicAtk",passiveDesc:"Basic attack applies poison (5% max HP/turn 3t)",
     activeName:"Toxic Cloud",activeCD:4,activeMult:0,activeEffect:"toxic_cloud",activeDesc:"Double poison stack",
     elementAtk:{poison:15},elementRes:{poison:10,fire:0,ice:0,thunder:0,dragon:0}},

    // â•â•â• TIER 3: Stage 7-9 â€” HP~80-100, ATK~17-22, DEF~9-13 (winrate 75%) â•â•â•
    {id:"troll",name:"Cave Troll",jp:"ã‚±ã‚¤ãƒ–ãƒˆãƒ­ãƒ¼ãƒ«",art:"ðŸ§Œ",role:"Tank",
     hp:94,atk:17,def:14,spd:5,xp:35,gold:18,type:"normal",tier:3,
     passive:"dmgRedPct",dmgReduce:0.2,passiveDesc:"Reduce dmg 20%",
     activeName:"Shield Wall",activeCD:3,activeMult:0,activeEffect:"shield_wall",activeDesc:"DEF +40% 2 turns",
     elementAtk:{},elementRes:{fire:5,poison:15,ice:0,thunder:0,dragon:0}},
    {id:"wraith",name:"Wraith",jp:"ãƒ¬ã‚¤ã‚¹",art:"ðŸ‘»",role:"Mage",
     hp:78,atk:20,def:8,spd:14,xp:32,gold:16,type:"normal",tier:3,
     passive:"ignoreDef",ignoreDefPct:0.30,passiveDesc:"Ignore 30% DEF",
     activeName:"Arcane Burst",activeCD:3,activeMult:1.2,activeEffect:"aoe_dmg",activeDesc:"120% AoE damage",
     elementAtk:{ice:15},elementRes:{poison:20,fire:0,ice:15,thunder:5,dragon:0}},
    {id:"dark_knight",name:"Dark Knight",jp:"ãƒ€ãƒ¼ã‚¯ãƒŠã‚¤ãƒˆ",art:"â™ž",role:"Anti-Tank",
     hp:96,atk:19,def:11,spd:8,xp:38,gold:20,type:"normal",tier:3,
     passive:"trueDmgPct",trueDmgPct:0.10,passiveDesc:"10% true damage",
     activeName:"Armor Break",activeCD:2,activeMult:1.2,activeEffect:"armor_break",activeDesc:"Reduce DEF 30%",
     elementAtk:{thunder:12},elementRes:{fire:0,ice:0,thunder:10,poison:0,dragon:5}},

    // â•â•â• TIER 4: Stage 10-12 â€” HP~105-130, ATK~22-27, DEF~10-16 â•â•â•
    {id:"witch",name:"Cursed Witch",jp:"ã‚«ãƒ¼ã‚¹ãƒ‰ã‚¦ã‚£ãƒƒãƒ",art:"ðŸ§™",role:"Mage",
     hp:112,atk:23,def:10,spd:11,xp:42,gold:22,type:"normal",tier:4,
     passive:"ignoreDef",ignoreDefPct:0.30,passiveDesc:"Ignore 30% DEF",
     activeName:"Arcane Burst",activeCD:3,activeMult:1.2,activeEffect:"aoe_dmg",activeDesc:"120% AoE damage",
     elementAtk:{poison:18,fire:14},elementRes:{fire:10,ice:0,thunder:0,poison:15,dragon:0}},
    {id:"gargoyle",name:"Gargoyle",jp:"ã‚¬ãƒ¼ã‚´ã‚¤ãƒ«",art:"ðŸ—¿",role:"Tank",
     hp:128,atk:21,def:16,spd:7,xp:45,gold:24,type:"normal",tier:4,
     passive:"dmgRedPct",dmgReduce:0.2,passiveDesc:"Reduce dmg 20%",
     activeName:"Shield Wall",activeCD:3,activeMult:0,activeEffect:"shield_wall",activeDesc:"DEF +40% 2 turns",
     elementAtk:{thunder:14},elementRes:{fire:5,ice:10,thunder:15,poison:5,dragon:0}},
    {id:"dragon_spawn",name:"Dragon Spawn",jp:"ãƒ‰ãƒ©ã‚´ãƒ³ã‚¹ãƒãƒ¼ãƒ³",art:"ðŸ²",role:"Berserker",
     hp:115,atk:26,def:10,spd:9,xp:48,gold:26,type:"normal",tier:4,
     passive:"lowHpAtk",passiveDesc:"+20% ATK if HP<50%",
     activeName:"Rage Slash",activeCD:3,activeMult:1.5,activeEffect:"dmg",activeDesc:"150% damage",
     elementAtk:{fire:15,dragon:10},elementRes:{fire:25,ice:0,thunder:0,poison:5,dragon:20}},
    {id:"cursed_armor",name:"Cursed Armor",jp:"ã‚«ãƒ¼ã‚¹ãƒ‰ã‚¢ãƒ¼ãƒžãƒ¼",art:"âš”ï¸",role:"Anti-Tank",
     hp:132,atk:23,def:18,spd:5,xp:52,gold:28,type:"normal",tier:4,
     passive:"trueDmgPct",trueDmgPct:0.10,passiveDesc:"10% true damage",
     activeName:"Armor Break",activeCD:2,activeMult:1.0,activeEffect:"armor_break",activeDesc:"Reduce DEF 30%",
     elementAtk:{},elementRes:{fire:0,ice:20,thunder:10,poison:10,dragon:0}},
    {id:"demon_imp",name:"Demon Imp",jp:"ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚¤ãƒ³ãƒ—",art:"ðŸ˜ˆ",role:"Poisoner",
     hp:106,atk:26,def:10,spd:13,xp:46,gold:25,type:"normal",tier:4,
     passive:"poisonBasicAtk",passiveDesc:"Basic attack applies poison",
     activeName:"Toxic Cloud",activeCD:4,activeMult:0,activeEffect:"toxic_cloud",activeDesc:"Double poison stack",
     elementAtk:{fire:16,poison:12},elementRes:{fire:15,ice:0,thunder:0,poison:5,dragon:10}},
    {id:"shadow_mage",name:"Shadow Mage",jp:"ã‚·ãƒ£ãƒ‰ã‚¦ãƒ¡ã‚¤ã‚¸",art:"ðŸŒ‘",role:"Mage",
     hp:100,atk:24,def:9,spd:12,xp:44,gold:23,type:"normal",tier:4,
     passive:"ignoreDef",ignoreDefPct:0.30,passiveDesc:"Ignore 30% DEF",
     activeName:"Arcane Burst",activeCD:3,activeMult:1.2,activeEffect:"aoe_dmg",activeDesc:"120% AoE damage",
     elementAtk:{dragon:12,thunder:14},elementRes:{fire:5,ice:5,thunder:10,poison:5,dragon:15}},

    // â•â•â• TIER 5: Stage 13+ â€” HP~140-165, ATK~28-34, DEF~14-20 â•â•â•
    {id:"void_knight",name:"Void Knight",jp:"ãƒ´ã‚©ã‚¤ãƒ‰ãƒŠã‚¤ãƒˆ",art:"â¬›",role:"Berserker",
     hp:145,atk:30,def:13,spd:8,xp:56,gold:30,type:"normal",tier:5,
     passive:"lowHpAtk",passiveDesc:"+20% ATK if HP<50%",
     activeName:"Rage Slash",activeCD:3,activeMult:1.5,activeEffect:"dmg",activeDesc:"150% damage",
     elementAtk:{dragon:15},elementRes:{fire:5,ice:5,thunder:10,poison:5,dragon:25}},
    {id:"blood_assassin",name:"Blood Assassin",jp:"ãƒ–ãƒ©ãƒƒãƒ‰ã‚¢ã‚µã‚·ãƒ³",art:"ðŸ—¡ï¸",role:"Assassin",
     hp:120,atk:32,def:10,spd:16,xp:54,gold:29,type:"normal",tier:5,
     passive:"critChance",critChance:25,passiveDesc:"25% crit chance",
     activeName:"Shadow Strike",activeCD:3,activeMult:2.2,activeEffect:"guaranteed_crit",activeDesc:"Guaranteed crit strike",
     elementAtk:{poison:16},elementRes:{poison:15,fire:0,ice:10,thunder:0,dragon:0}},
    {id:"elder_lich",name:"Elder Lich",jp:"ã‚¨ãƒ«ãƒ€ãƒ¼ãƒªãƒƒãƒ",art:"ðŸ’€",role:"Mage",
     hp:138,atk:28,def:14,spd:10,xp:58,gold:32,type:"normal",tier:5,
     passive:"ignoreDef",ignoreDefPct:0.30,passiveDesc:"Ignore 30% DEF",
     activeName:"Arcane Burst",activeCD:3,activeMult:1.2,activeEffect:"aoe_dmg",activeDesc:"120% AoE damage",
     elementAtk:{poison:20,ice:15},elementRes:{poison:25,fire:5,ice:15,thunder:5,dragon:5}},
    {id:"titan_guard",name:"Titan Guard",jp:"ã‚¿ã‚¤ã‚¿ãƒ³ã‚¬ãƒ¼ãƒ‰",art:"ðŸª¨",role:"Tank",
     hp:165,atk:26,def:20,spd:4,xp:60,gold:33,type:"normal",tier:5,
     passive:"dmgRedPct",dmgReduce:0.2,passiveDesc:"Reduce dmg 20%",
     activeName:"Shield Wall",activeCD:3,activeMult:0,activeEffect:"shield_wall",activeDesc:"DEF +40% 2 turns",
     elementAtk:{thunder:12},elementRes:{fire:10,ice:15,thunder:20,poison:10,dragon:5}},
    {id:"plague_lord",name:"Plague Lord",jp:"ãƒšã‚¹ãƒˆãƒ­ãƒ¼ãƒ‰",art:"ðŸ§«",role:"Poisoner",
     hp:130,atk:28,def:12,spd:11,xp:55,gold:31,type:"normal",tier:5,
     passive:"poisonBasicAtk",passiveDesc:"Basic attack applies poison",
     activeName:"Toxic Cloud",activeCD:4,activeMult:0,activeEffect:"toxic_cloud",activeDesc:"Double poison stack",
     elementAtk:{poison:22},elementRes:{poison:30,fire:0,ice:0,thunder:5,dragon:0}},
    {id:"chain_breaker",name:"Chain Breaker",jp:"ãƒã‚§ã‚¤ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼",art:"â›“ï¸",role:"Anti-Tank",
     hp:142,atk:30,def:14,spd:9,xp:57,gold:31,type:"normal",tier:5,
     passive:"trueDmgPct",trueDmgPct:0.10,passiveDesc:"10% true damage",
     activeName:"Armor Break",activeCD:2,activeMult:1.2,activeEffect:"armor_break",activeDesc:"Reduce DEF 30%",
     elementAtk:{thunder:16},elementRes:{fire:5,ice:5,thunder:15,poison:5,dragon:5}},

    // â•â•â• TIER 6: Late stages â€” HP~170-200, ATK~33-40, DEF~16-24 â•â•â•
    {id:"chaos_berserker",name:"Chaos Berserker",jp:"ã‚«ã‚ªã‚¹ãƒãƒ¼ã‚µãƒ¼ã‚«ãƒ¼",art:"ðŸ”¥",role:"Berserker",
     hp:170,atk:36,def:14,spd:10,xp:65,gold:36,type:"normal",tier:6,
     passive:"lowHpAtk",passiveDesc:"+20% ATK if HP<50%",
     activeName:"Rage Slash",activeCD:3,activeMult:1.5,activeEffect:"dmg",activeDesc:"150% damage",
     elementAtk:{fire:20,dragon:10},elementRes:{fire:20,ice:0,thunder:0,poison:5,dragon:10}},
    {id:"demon_spawn",name:"Demon Spawn",jp:"ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚¹ãƒãƒ¼ãƒ³",art:"ðŸ‘¿",role:"Poisoner",
     hp:160,atk:34,def:16,spd:12,xp:62,gold:35,type:"normal",tier:6,
     passive:"poisonBasicAtk",passiveDesc:"Basic attack applies poison",
     activeName:"Toxic Cloud",activeCD:4,activeMult:0,activeEffect:"toxic_cloud",activeDesc:"Double poison stack",
     elementAtk:{fire:18,poison:18},elementRes:{fire:20,ice:0,thunder:0,poison:15,dragon:10}},
    {id:"specter_assassin",name:"Specter Assassin",jp:"ã‚¹ãƒšã‚¯ã‚¿ãƒ¼ã‚¢ã‚µã‚·ãƒ³",art:"ðŸŒ€",role:"Assassin",
     hp:148,atk:38,def:12,spd:18,xp:63,gold:36,type:"normal",tier:6,
     passive:"critChance",critChance:25,passiveDesc:"25% crit chance",
     activeName:"Shadow Strike",activeCD:3,activeMult:2.2,activeEffect:"guaranteed_crit",activeDesc:"Guaranteed crit strike",
     elementAtk:{dragon:14,thunder:12},elementRes:{poison:10,ice:10,thunder:10,fire:5,dragon:15}},
    {id:"arcane_colossus",name:"Arcane Colossus",jp:"ã‚¢ãƒ¼ã‚±ã‚¤ãƒ³ã‚³ãƒ­ãƒƒã‚µã‚¹",art:"ðŸ”®",role:"Mage",
     hp:175,atk:33,def:18,spd:8,xp:66,gold:37,type:"normal",tier:6,
     passive:"ignoreDef",ignoreDefPct:0.30,passiveDesc:"Ignore 30% DEF",
     activeName:"Arcane Burst",activeCD:3,activeMult:1.2,activeEffect:"aoe_dmg",activeDesc:"120% AoE damage",
     elementAtk:{dragon:18,fire:14,thunder:14},elementRes:{fire:15,ice:10,thunder:20,poison:10,dragon:25}},
    {id:"iron_warden",name:"Iron Warden",jp:"ã‚¢ã‚¤ã‚¢ãƒ³ã‚¦ã‚©ãƒ¼ãƒ‡ãƒ³",art:"ðŸ°",role:"Anti-Tank",
     hp:190,atk:32,def:22,spd:6,xp:68,gold:38,type:"normal",tier:6,
     passive:"trueDmgPct",trueDmgPct:0.10,passiveDesc:"10% true damage",
     activeName:"Armor Break",activeCD:2,activeMult:1.2,activeEffect:"armor_break",activeDesc:"Reduce DEF 30%",
     elementAtk:{thunder:15},elementRes:{fire:10,ice:20,thunder:20,poison:10,dragon:5}},
    {id:"void_titan",name:"Void Titan",jp:"ãƒ´ã‚©ã‚¤ãƒ‰ã‚¿ã‚¤ã‚¿ãƒ³",art:"ðŸŒ‘",role:"Tank",
     hp:200,atk:30,def:24,spd:5,xp:70,gold:40,type:"normal",tier:6,
     passive:"dmgRedPct",dmgReduce:0.2,passiveDesc:"Reduce dmg 20%",
     activeName:"Shield Wall",activeCD:3,activeMult:0,activeEffect:"shield_wall",activeDesc:"DEF +40% 2 turns",
     elementAtk:{dragon:20},elementRes:{fire:15,ice:15,thunder:15,poison:15,dragon:30}},

    // â•â•â• MINI-BOSSES â€” 2 skills, phase change at 50% HP (winrate 65-70%) â•â•â•
    {id:"mb_golem_king",name:"Iron Golem King",jp:"ã‚¢ã‚¤ã‚¢ãƒ³ã‚´ãƒ¼ãƒ¬ãƒ ã‚­ãƒ³ã‚°",art:BOSS_ART.mb_golem_king,
     hp:200,atk:23,def:24,spd:4,xp:100,gold:65,type:"miniboss",
     role:"Tank",passive:"dmgRedPct",dmgReduce:0.2,passiveDesc:"Reduce dmg 20%",
     activeName:"Iron Fortress",activeCD:4,activeEffect:"shield_wall",activeDesc:"DEF doubles for 2 turns",
     activeName2:"Piston Slam",activeCD2:2,activeMult2:1.6,activeEffect2:"armor_break",activeDesc2:"150% dmg + Armor Break",
     phaseAtk:8,phaseDef:4,phaseAura:"Overcharge: all attacks now deal extra thunder damage",
     special:"Iron Fortress DEFÃ—2",elementAtk:{thunder:15},elementRes:{fire:0,ice:15,thunder:15,poison:0,dragon:0}},
    {id:"mb_necro",name:"Void Necromancer",jp:"ãƒ´ã‚©ã‚¤ãƒ‰ãƒã‚¯ãƒ­ãƒžãƒ³ã‚µãƒ¼",art:BOSS_ART.mb_necro,
     hp:148,atk:30,def:10,spd:9,xp:90,gold:55,type:"miniboss",
     role:"Mage",passive:"ignoreDef",ignoreDefPct:0.30,passiveDesc:"Ignore 30% DEF",
     activeName:"Death Bolt",activeCD:3,activeEffect:"def_bypass",activeDesc:"28 true dmg (ignores armor)",
     activeName2:"Soul Drain",activeCD2:4,activeEffect2:"lifesteal",activeDesc2:"Steal 15% of player max HP",
     phaseAtk:10,phaseDef:0,phaseAura:"Undead Surge: summons phantom minions â€” SP drain 1/turn",
     special:"Death Bolt (armor bypass)",elementAtk:{poison:20},elementRes:{poison:25,fire:5,ice:5,thunder:0,dragon:0}},
    {id:"mb_banshee",name:"Crystal Banshee",jp:"ã‚¯ãƒªã‚¹ã‚¿ãƒ«ãƒãƒ³ã‚·ãƒ¼",art:BOSS_ART.mb_banshee,
     hp:158,atk:27,def:9,spd:14,xp:85,gold:52,type:"miniboss",
     role:"Assassin",passive:"critChance",critChance:25,passiveDesc:"25% crit chance",
     activeName:"Soul Wail",activeCD:2,activeEffect:"sp_drain",activeDesc:"Reduces player SP by 2",
     activeName2:"Frost Nova",activeCD2:4,activeMult2:1.8,activeEffect2:"freeze",activeDesc2:"1.8Ã— dmg + freeze 1 turn",
     phaseAtk:7,phaseDef:0,phaseAura:"Ethereal Form: 30% chance to dodge all attacks",
     special:"Soul Wail reduces SP",elementAtk:{ice:20},elementRes:{ice:20,fire:0,thunder:10,poison:10,dragon:0}},
    {id:"mb_wyvern",name:"Mech-Dragon Wyvern",jp:"ãƒ¡ã‚«ãƒ‰ãƒ©ã‚´ãƒ³ãƒ¯ã‚¤ãƒãƒ¼ãƒ³",art:BOSS_ART.mb_wyvern,
     hp:182,atk:27,def:14,spd:10,xp:95,gold:60,type:"miniboss",
     role:"Berserker",passive:"lowHpAtk",passiveDesc:"+20% ATK if HP<50%",
     activeName:"Fire Breath",activeCD:3,activeEffect:"burning",activeDesc:"Burns player 8 dmg/turn x3",
     activeName2:"Rocket Charge",activeCD2:4,activeMult2:2.0,activeEffect2:"dmg",activeDesc2:"200% damage ramming attack",
     phaseAtk:12,phaseDef:4,phaseAura:"Overclock: fires missiles each turn dealing 6 bonus damage",
     special:"Fire Breath burn DoT",elementAtk:{fire:22,dragon:12},elementRes:{fire:30,ice:0,thunder:0,poison:5,dragon:20}},
    {id:"mb_demon_lord",name:"Hellfire Demon Lord",jp:"ãƒ˜ãƒ«ãƒ•ã‚¡ã‚¤ã‚¢ãƒ‡ãƒ¼ãƒ¢ãƒ³ãƒ­ãƒ¼ãƒ‰",art:BOSS_ART.mb_demon_lord,
     hp:192,atk:33,def:12,spd:11,xp:110,gold:70,type:"miniboss",
     role:"Poisoner",passive:"poisonBasicAtk",passiveDesc:"Basic attacks apply poison",
     activeName:"Hellfire Surge",activeCD:3,activeEffect:"dmg_and_atk_up",activeDesc:"25 dmg + self ATK+5",
     activeName2:"Toxic Hellfire",activeCD2:4,activeEffect2:"toxic_cloud",activeDesc2:"Double poison + burn 2t",
     phaseAtk:10,phaseDef:0,phaseAura:"Infernal Rage: +25% ATK, all hits burn player 4 dmg",
     special:"Hellfire Surge",elementAtk:{fire:18,dragon:14},elementRes:{fire:20,ice:0,thunder:0,poison:5,dragon:15}},
    {id:"mb_shadow_knight",name:"Shadow Specter Knight",jp:"ã‚·ãƒ£ãƒ‰ã‚¦ã‚¹ãƒšã‚¯ã‚¿ãƒ¼ãƒŠã‚¤ãƒˆ",art:BOSS_ART.mb_shadow_knight,
     hp:165,atk:28,def:17,spd:13,xp:88,gold:58,type:"miniboss",
     role:"Anti-Tank",passive:"trueDmgPct",trueDmgPct:0.10,passiveDesc:"10% true damage",
     activeName:"Mirror Slash",activeCD:3,activeEffect:"mirror_atk",activeDesc:"Copies player ATK and deals as dmg",
     activeName2:"Armor Shatter",activeCD2:2,activeEffect2:"armor_break",activeDesc2:"Reduce player DEF 30% for 3 turns",
     phaseAtk:6,phaseDef:5,phaseAura:"Mirror Veil: 20% of damage reflected to player",
     special:"Mirrors your ATK",elementAtk:{thunder:16},elementRes:{fire:5,ice:10,thunder:20,poison:5,dragon:0}},

    // â•â•â• FINAL BOSS â€” 3 skills, 2 phases, Phase 2 +25% ATK + new mechanic (winrate 45-60%) â•â•â•
    {id:"boss_demon_king",name:"DEMON KING MALACHAR",jp:"é­”çŽ‹ãƒžãƒ©ãƒãƒ£ãƒ¼",art:BOSS_ART.boss_demon_king,
     hp:480,atk:38,def:22,spd:10,xp:500,gold:300,type:"boss",
     role:"Berserker",passive:"lowHpAtk",passiveDesc:"+25% ATK if HP<50%",
     activeName:"Void Annihilation",activeCD:4,activeEffect:"true_dmg_pct",activeDesc:"50% max HP true damage",
     activeName2:"Dragon Aura",activeCD2:5,activeEffect2:"aura_buff",activeDesc2:"All effects amplified for 3 turns",
     activeName3:"Hellfire Rain",activeCD3:3,activeMult3:1.8,activeEffect3:"burning",activeDesc3:"1.8Ã— + burn 8/turn x3",
     special:"Phase 2: +25% ATK, Dark Curse mechanic at 50% HP",
     elementAtk:{fire:25,dragon:20,thunder:20},
     elementRes:{fire:25,ice:15,thunder:20,poison:20,dragon:30}},

    // â•â•â• HIDDEN BOSS â€” unlocked after 100 stage wins â•â•â•
    {id:"hidden_chronovore",name:"CHRONOVORE",jp:"ã‚¯ãƒ­ãƒŽãƒ´ã‚©ã‚¢",art:BOSS_ART.hidden_boss,
     hp:700,atk:50,def:30,spd:15,xp:1000,gold:500,type:"boss",isHidden:true,
     role:"Mage",passive:"ignoreDef",ignoreDefPct:0.50,passiveDesc:"Ignore 50% DEF",
     activeName:"Time Crush",activeCD:3,activeEffect:"true_dmg_pct",activeDesc:"35% max HP true damage",
     activeName2:"Temporal Reversal",activeCD2:5,activeEffect2:"time_reverse",activeDesc2:"Restores 15% of max HP",
     activeName3:"Void Collapse",activeCD3:4,activeMult3:2.5,activeEffect3:"dmg",activeDesc3:"250% damage + drain SP",
     special:"Phase 2: time stops â€” answer must be correct within 6 sec or take 40 damage",
     elementAtk:{dragon:30,thunder:25,fire:20},
     elementRes:{fire:30,ice:20,thunder:30,poison:30,dragon:40}}
  ];
  return enemies;
}

/* â”€â”€ WEAPON DEFINITIONS (7 per character) â”€â”€ */
const ADV_WEAPONS={
  // HIRO weapons â€” sword tree (prices scale heavily)
  hiro_sword1:{id:"hiro_sword1",name:"Iron Longsword",char:"hiro",price:0,icon:"âš”ï¸",atk:6,crit:5,skillId:"power_cleave",skillName:"Power Cleave",skillDesc:"2.0Ã— dmg, knocks back",skillCost:2,skillDmg:2.0,skillEffect:"dmg",playstyle:"Balanced offense"},
  hiro_sword2:{id:"hiro_sword2",name:"Knight's Blade",char:"hiro",price:200,icon:"ðŸ—¡ï¸",atk:10,crit:8,skillId:"holy_thrust",skillName:"Holy Thrust",skillDesc:"Pierce 2.2Ã— + heal 10",skillCost:3,skillDmg:2.2,skillEffect:"heal",playstyle:"Sustain fighter"},
  hiro_sword3:{id:"hiro_sword3",name:"Crusader Sword",char:"hiro",price:450,icon:"âœï¸",atk:15,crit:10,skillId:"divine_wrath",skillName:"Divine Wrath",skillDesc:"3.0Ã— holy dmg",skillCost:4,skillDmg:3.0,skillEffect:"dmg",playstyle:"High burst"},
  hiro_sword4:{id:"hiro_sword4",name:"Mithril Blade",char:"hiro",price:800,icon:"ðŸŒŸ",atk:20,crit:14,skillId:"mithril_slash",skillName:"Mithril Slash",skillDesc:"2.5Ã— + stun 1 turn",skillCost:3,skillDmg:2.5,skillEffect:"stun",playstyle:"Crowd control"},
  hiro_sword5:{id:"hiro_sword5",name:"Dragon Fang",char:"hiro",price:1400,icon:"ðŸ²",atk:26,crit:18,skillId:"dragon_bite",skillName:"Dragon Bite",skillDesc:"3.5Ã— + burn 2 turns",skillCost:4,skillDmg:3.5,skillEffect:"burn",playstyle:"DoT burst"},
  hiro_sword6:{id:"hiro_sword6",name:"Void Sword",char:"hiro",price:2200,icon:"ðŸŒ‘",atk:32,crit:22,skillId:"void_strike",skillName:"Void Strike",skillDesc:"4.0Ã— true dmg",skillCost:5,skillDmg:4.0,skillEffect:"dmg",playstyle:"Ultimate offense"},
  hiro_sword7:{id:"hiro_sword7",name:"Demon King Edge",char:"hiro",price:3500,icon:"ðŸ‘‘",atk:40,crit:30,skillId:"kings_judgment",skillName:"King's Judgment",skillDesc:"4.5Ã— + heals 30",skillCost:5,skillDmg:4.5,skillEffect:"heal",playstyle:"God mode"},
  // ROKU weapons â€” dagger tree
  roku_dagger1:{id:"roku_dagger1",name:"Steel Daggers",char:"roku",price:0,icon:"ðŸ—¡ï¸",atk:8,crit:15,skillId:"quick_stab",skillName:"Quick Stab",skillDesc:"1.8Ã— rapid strike",skillCost:2,skillDmg:1.8,skillEffect:"dmg",playstyle:"Speed crit"},
  roku_dagger2:{id:"roku_dagger2",name:"Shadow Fangs",char:"roku",price:200,icon:"ðŸŒ‘",atk:14,crit:20,skillId:"shadow_flurry",skillName:"Shadow Flurry",skillDesc:"2.5Ã— + evade",skillCost:3,skillDmg:2.5,skillEffect:"evade",playstyle:"Hit and run"},
  roku_dagger3:{id:"roku_dagger3",name:"Viper Blades",char:"roku",price:450,icon:"ðŸ",atk:18,crit:24,skillId:"viper_venom",skillName:"Viper Venom",skillDesc:"2.0Ã— + poison 4t",skillCost:3,skillDmg:2.0,skillEffect:"poison",playstyle:"Poison build"},
  roku_dagger4:{id:"roku_dagger4",name:"Night Reaper",char:"roku",price:850,icon:"ðŸŒ™",atk:24,crit:28,skillId:"death_mark",skillName:"Death Mark",skillDesc:"3.2Ã— crit strike",skillCost:4,skillDmg:3.2,skillEffect:"dmg",playstyle:"Crit master"},
  roku_dagger5:{id:"roku_dagger5",name:"Twin Curses",char:"roku",price:1500,icon:"ðŸ’€",atk:30,crit:32,skillId:"curse_strike",skillName:"Curse Strike",skillDesc:"3.0Ã— + poison+stun",skillCost:5,skillDmg:3.0,skillEffect:"poison",playstyle:"Status king"},
  roku_dagger6:{id:"roku_dagger6",name:"Phantom Blades",char:"roku",price:2400,icon:"ðŸ‘»",atk:36,crit:36,skillId:"phantom_edge",skillName:"Phantom Edge",skillDesc:"4.5Ã— (guaranteed crit)",skillCost:5,skillDmg:4.5,skillEffect:"dmg",playstyle:"Crit assassin"},
  roku_dagger7:{id:"roku_dagger7",name:"Chaos Knives",char:"roku",price:3800,icon:"ðŸƒ",atk:44,crit:40,skillId:"chaos_flurry",skillName:"Chaos Flurry",skillDesc:"5.0Ã— + full evade",skillCost:6,skillDmg:5.0,skillEffect:"evade",playstyle:"Glass cannon"},
  // KISARAGI weapons â€” fist tree
  kisa_fist1:{id:"kisa_fist1",name:"Iron Knuckles",char:"kisaragi",price:0,icon:"ðŸ‘Š",atk:9,crit:6,skillId:"gut_punch",skillName:"Gut Punch",skillDesc:"2.2Ã— + def down",skillCost:2,skillDmg:2.2,skillEffect:"dmg",playstyle:"Brawler"},
  kisa_fist2:{id:"kisa_fist2",name:"Stone Gauntlets",char:"kisaragi",price:200,icon:"ðŸª¨",atk:15,crit:8,skillId:"earth_smash",skillName:"Earth Smash",skillDesc:"2.8Ã— + fortify",skillCost:3,skillDmg:2.8,skillEffect:"fortify",playstyle:"Tank breaker"},
  kisa_fist3:{id:"kisa_fist3",name:"Flame Wraps",char:"kisaragi",price:450,icon:"ðŸ”¥",atk:21,crit:10,skillId:"flame_punch",skillName:"Flame Punch",skillDesc:"3.0Ã— + burn 3t",skillCost:3,skillDmg:3.0,skillEffect:"burn",playstyle:"Burn brawler"},
  kisa_fist4:{id:"kisa_fist4",name:"War Hammers",char:"kisaragi",price:900,icon:"ðŸ”¨",atk:28,crit:12,skillId:"war_slam",skillName:"War Slam",skillDesc:"3.5Ã— stun 1 turn",skillCost:4,skillDmg:3.5,skillEffect:"stun",playstyle:"Stun fighter"},
  kisa_fist5:{id:"kisa_fist5",name:"Thunder Fists",char:"kisaragi",price:1600,icon:"âš¡",atk:34,crit:15,skillId:"thunder_combo",skillName:"Thunder Combo",skillDesc:"4.0Ã— 3-hit combo",skillCost:5,skillDmg:4.0,skillEffect:"dmg",playstyle:"Combo machine"},
  kisa_fist6:{id:"kisa_fist6",name:"Dragon Claws",char:"kisaragi",price:2500,icon:"ðŸ‰",atk:40,crit:18,skillId:"dragon_fist",skillName:"Dragon Fist",skillDesc:"4.5Ã— + self-heal",skillCost:5,skillDmg:4.5,skillEffect:"heal",playstyle:"Sustain bruiser"},
  kisa_fist7:{id:"kisa_fist7",name:"Titan Gauntlets",char:"kisaragi",price:4000,icon:"ðŸ’ª",atk:50,crit:22,skillId:"titan_smash",skillName:"Titan Smash",skillDesc:"5.0Ã— + massive fortify",skillCost:6,skillDmg:5.0,skillEffect:"fortify",playstyle:"Unstoppable"},
};

/* â”€â”€ ARMOR DEFINITIONS (7 per character) â”€â”€ */
/* â”€â”€ ARMOR DEFINITIONS (7 per character) â”€â”€ */
const ADV_ARMORS={
  // HIRO armors â€” shield tree
  hiro_armor1:{id:"hiro_armor1",name:"Chain Mail",char:"hiro",price:0,icon:"ðŸ›¡ï¸",def:6,hp:15,dodge:3,bonus:"none",bonusDesc:"Solid starter",elemRes:{fire:3,ice:3,thunder:3,poison:3,dragon:0}},
  hiro_armor2:{id:"hiro_armor2",name:"Plate Vest",char:"hiro",price:150,icon:"âšœï¸",def:10,hp:25,dodge:2,bonus:"thorns",bonusDesc:"Reflect 3 dmg on hit",elemRes:{fire:5,ice:5,thunder:5,poison:5,dragon:0}},
  hiro_armor3:{id:"hiro_armor3",name:"Knight Armor",char:"hiro",price:350,icon:"ðŸ°",def:16,hp:35,dodge:4,bonus:"regen",bonusDesc:"Regen 4HP/turn",elemRes:{fire:8,ice:5,thunder:8,poison:5,dragon:0}},
  hiro_armor4:{id:"hiro_armor4",name:"Holy Plate",char:"hiro",price:700,icon:"âœï¸",def:22,hp:50,dodge:5,bonus:"holy_shield",bonusDesc:"First hit blocked free",elemRes:{fire:10,ice:8,thunder:10,poison:8,dragon:5}},
  hiro_armor5:{id:"hiro_armor5",name:"Crusader Mail",char:"hiro",price:1200,icon:"ðŸŒŸ",def:28,hp:65,dodge:6,bonus:"regen",bonusDesc:"Regen 8HP/turn",elemRes:{fire:15,ice:10,thunder:15,poison:10,dragon:8}},
  hiro_armor6:{id:"hiro_armor6",name:"Dragon Plate",char:"hiro",price:2000,icon:"ðŸ²",def:36,hp:80,dodge:8,bonus:"thorns",bonusDesc:"Reflect 12 dmg on hit",elemRes:{fire:20,ice:15,thunder:20,poison:15,dragon:15}},
  hiro_armor7:{id:"hiro_armor7",name:"Celestial Guard",char:"hiro",price:3200,icon:"ðŸ‘‘",def:46,hp:100,dodge:10,bonus:"holy_shield",bonusDesc:"Block 1 hit every 3 turns",elemRes:{fire:30,ice:25,thunder:30,poison:25,dragon:25}},
  // ROKU armors â€” evasion tree
  roku_armor1:{id:"roku_armor1",name:"Leather Wrap",char:"roku",price:0,icon:"ðŸŒ‘",def:3,hp:10,dodge:12,bonus:"none",bonusDesc:"Light & nimble",elemRes:{fire:0,ice:5,thunder:0,poison:5,dragon:0}},
  roku_armor2:{id:"roku_armor2",name:"Shadow Vest",char:"roku",price:150,icon:"ðŸ‘¤",def:6,hp:18,dodge:18,bonus:"poison_coat",bonusDesc:"Attacks poison enemy",elemRes:{fire:0,ice:8,thunder:0,poison:10,dragon:0}},
  roku_armor3:{id:"roku_armor3",name:"Night Cloak",char:"roku",price:350,icon:"ðŸŒ™",def:9,hp:25,dodge:24,bonus:"evade_bonus",bonusDesc:"+1 free evade turn/battle",elemRes:{fire:5,ice:12,thunder:5,poison:15,dragon:0}},
  roku_armor4:{id:"roku_armor4",name:"Phantom Suit",char:"roku",price:700,icon:"ðŸ‘»",def:13,hp:32,dodge:30,bonus:"poison_coat",bonusDesc:"Poison on every attack",elemRes:{fire:5,ice:15,thunder:10,poison:20,dragon:5}},
  roku_armor5:{id:"roku_armor5",name:"Void Cloak",char:"roku",price:1200,icon:"â¬›",def:18,hp:40,dodge:36,bonus:"evade_bonus",bonusDesc:"+2 free evade turns",elemRes:{fire:8,ice:20,thunder:15,poison:25,dragon:8}},
  roku_armor6:{id:"roku_armor6",name:"Chaos Mantle",char:"roku",price:2000,icon:"ðŸŽ­",def:22,hp:50,dodge:40,bonus:"crit_boost",bonusDesc:"All crits deal +20%",elemRes:{fire:10,ice:25,thunder:20,poison:30,dragon:10}},
  roku_armor7:{id:"roku_armor7",name:"Shadow God Wrap",char:"roku",price:3200,icon:"ðŸƒ",def:30,hp:65,dodge:48,bonus:"crit_boost",bonusDesc:"Crits deal +40% bonus",elemRes:{fire:15,ice:30,thunder:25,poison:35,dragon:15}},
  // KISARAGI armors â€” tank tree
  kisa_armor1:{id:"kisa_armor1",name:"Battle Wraps",char:"kisaragi",price:0,icon:"ðŸ©º",def:8,hp:30,dodge:4,bonus:"none",bonusDesc:"Tank starter",elemRes:{fire:5,ice:0,thunder:5,poison:0,dragon:0}},
  kisa_armor2:{id:"kisa_armor2",name:"Iron Skin",char:"kisaragi",price:150,icon:"ðŸª¨",def:14,hp:50,dodge:3,bonus:"thorns",bonusDesc:"Reflect 5 dmg on hit",elemRes:{fire:8,ice:5,thunder:8,poison:5,dragon:0}},
  kisa_armor3:{id:"kisa_armor3",name:"Berserker Plate",char:"kisaragi",price:350,icon:"ðŸ”¥",def:18,hp:70,dodge:4,bonus:"rage_gain",bonusDesc:"Gain 2SP on being hit",elemRes:{fire:15,ice:5,thunder:10,poison:5,dragon:5}},
  kisa_armor4:{id:"kisa_armor4",name:"Fortress Body",char:"kisaragi",price:700,icon:"ðŸ¯",def:26,hp:90,dodge:4,bonus:"regen",bonusDesc:"Regen 6HP/turn",elemRes:{fire:20,ice:10,thunder:15,poison:10,dragon:8}},
  kisa_armor5:{id:"kisa_armor5",name:"War Titan Plate",char:"kisaragi",price:1200,icon:"âš”ï¸",def:34,hp:110,dodge:5,bonus:"thorns",bonusDesc:"Reflect 15 dmg on hit",elemRes:{fire:25,ice:15,thunder:20,poison:15,dragon:12}},
  kisa_armor6:{id:"kisa_armor6",name:"Dragon Skin",char:"kisaragi",price:2000,icon:"ðŸ‰",def:42,hp:130,dodge:5,bonus:"rage_gain",bonusDesc:"Gain 3SP on being hit",elemRes:{fire:30,ice:20,thunder:25,poison:20,dragon:20}},
  kisa_armor7:{id:"kisa_armor7",name:"Ancient Titan Mail",char:"kisaragi",price:3200,icon:"ðŸ‘‘",def:52,hp:160,dodge:6,bonus:"regen",bonusDesc:"Regen 14HP/turn + thorns",elemRes:{fire:35,ice:25,thunder:30,poison:25,dragon:30}},
};

/* â”€â”€ CONSUMABLE SHOP ITEMS â€” 4 types only â”€â”€ */
const ADV_CONSUMABLES=[
  {id:"heal_potion",name:"Healing Potion",type:"potion",price:35,bonus:{heal_pct:30},icon:"ðŸ§ª",desc:"Restore 30% max HP (max 3 in bag)",consumable:true,maxStack:3},
  {id:"def_boost",name:"DEF Shard",type:"boost",price:20,bonus:{def_boost:8},icon:"ðŸ›¡ï¸",desc:"+8 DEF this battle",consumable:true},
  {id:"atk_boost",name:"ATK Crystal",type:"boost",price:25,bonus:{atk_boost:8},icon:"ðŸ’ ",desc:"+8 ATK this battle",consumable:true},
  {id:"crit_boost",name:"CRIT Lens",type:"boost",price:30,bonus:{crit_boost:12},icon:"ðŸ’¥",desc:"+12% CRIT chance this battle",consumable:true},
  {id:"antidote",name:"Purify Elixir",type:"potion",price:15,bonus:{cure_all:true},icon:"ðŸ©¹",desc:"Remove all element effects (poison/burn/ice/stun)",consumable:true},
];

/* â”€â”€ UPGRADE STAT COSTS (per +1) â”€â”€ */
const STAT_UPGRADE_COSTS={
  hp:1,    // +10 maxHP per point
  atk:1,   // +2 ATK per point
  def:1,   // +2 DEF per point
  skillDmg:2, // +10% skill dmg multiplier per point
};

// Passive skill upgrades for weapons & armors (max 3x each)
const GEAR_PASSIVES={
  // Weapon passives â€” each upgrade adds a passive effect to the weapon skill
  hiro_wpn1:{name:"Battle Focus",desc:["Attack gains +5% CRIT","CRIT hits deal +15% dmg","On CRIT: restore 1 SP"],cost:[80,140,200],icon:"âš”ï¸"},
  hiro_wpn2:{name:"Flame Edge",desc:["Fire proc chance +5%","Fire dmg amplifies by +10%","Sword strike ignites (3t burn)"],cost:[100,160,240],icon:"ðŸ”¥"},
  hiro_wpn3:{name:"Holy Blade",desc:["Skill heals 5% HP on hit","Skill grants Evade 1 turn","Skill cleanses 1 debuff"],cost:[120,200,280],icon:"âœï¸"},
  hiro_wpn4:{name:"Thunder Arc",desc:["Thunder proc chance +8%","Stun lasts +1 turn","Thunder hits chain for 50% splash"],cost:[140,220,300],icon:"âš¡"},
  hiro_wpn5:{name:"Warlord's Will",desc:["Skill costs 1 less SP","Skill dmg +10%","Skill ignores 30% enemy DEF"],cost:[160,250,340],icon:"ðŸ‘‘"},
  hiro_wpn6:{name:"Dragonslayer",desc:["Dragon resist +10%","Dragon procs deal +20% dmg","Skill vs Dragon: x1.5 dmg"],cost:[180,280,380],icon:"ðŸ‰"},
  hiro_wpn7:{name:"Celestial Edge",desc:["All element procs +5%","Skills cost 1 less SP","On kill: +2 SP"],cost:[200,320,420],icon:"âœ¨"},
  roku_wpn1:{name:"Poison Mastery",desc:["Poison DoT +2 dmg","Poison lasts +1 turn","Poison spreads on enemy defeat"],cost:[80,140,200],icon:"â˜ ï¸"},
  roku_wpn2:{name:"Shadow Step",desc:["Evade chance +5%","Dodge restores 1 SP","After dodge: next hit +20% dmg"],cost:[100,160,240],icon:"ðŸ‘»"},
  roku_wpn3:{name:"Ice Mastery",desc:["Ice slow reduces ATK by extra 10%","Ice lasts +1 turn","Ice-slowed enemies take +15% dmg"],cost:[120,200,280],icon:"â„ï¸"},
  roku_wpn4:{name:"Deathmark",desc:["Skill applies poison","Enemies below 30% HP take double skill dmg","On kill: apply poison to next enemy"],cost:[140,220,300],icon:"ðŸ’€"},
  roku_wpn5:{name:"Venom Coat",desc:["Basic attacks have 10% poison chance","Skill adds extra poison stack","Poison DoT +5 dmg"],cost:[160,250,340],icon:"ðŸ"},
  roku_wpn6:{name:"Ghost Blade",desc:["Skill bypasses 25% DEF","Each miss charges +1 SP","Skill has 15% insta-kill vs weakened foes"],cost:[180,280,380],icon:"âš°ï¸"},
  roku_wpn7:{name:"Void Master",desc:["All skill costs -1 SP","Skills deal +15% dmg","On correct answer: 10% bonus ATK"],cost:[200,320,420],icon:"ðŸŒ‘"},
  kisaragi_wpn1:{name:"Flame Art",desc:["Fire proc +5% chance","Fire amp boosts all fire dmg +10%","Skill applies Fire Amp"],cost:[80,140,200],icon:"ðŸ”¥"},
  kisaragi_wpn2:{name:"Dragon Heart",desc:["Dragon proc +5% chance","Dragon amplification +10%","Dragon procs reduce cooldown"],cost:[100,160,240],icon:"ðŸ‰"},
  kisaragi_wpn3:{name:"War Chant",desc:["Berserk heals 5 HP on kill","Berserk gives +2 SP","Berserk dmg bonus +15%"],cost:[120,200,280],icon:"ðŸ’¢"},
  kisaragi_wpn4:{name:"Inferno",desc:["Burn DoT +3 dmg","Burn lasts +1 turn","Enemies on fire take +10% all dmg"],cost:[140,220,300],icon:"ðŸŒ‹"},
  kisaragi_wpn5:{name:"Titan's Grip",desc:["Skill DEF ignore +10%","Skill hits stagger enemy (miss 1 turn)","Skill always crits at full HP"],cost:[160,250,340],icon:"âš’ï¸"},
  kisaragi_wpn6:{name:"Storm Caller",desc:["Thunder proc +8%","All elements +5% proc","Elemental hits reduce skill cooldown"],cost:[180,280,380],icon:"â›ˆï¸"},
  kisaragi_wpn7:{name:"Ancient Legend",desc:["All skills cost 1 less SP","Skills deal +20% dmg","On 3+ consecutive correct: instant skill charge"],cost:[200,320,420],icon:"ðŸ›ï¸"},
  // Armor passives
  hiro_arm1:{name:"Iron Will",desc:["Take 3 less dmg when defending","Regen 2 HP per turn","Defending grants 1 SP"],cost:[60,100,160],icon:"ðŸ›¡ï¸"},
  hiro_arm2:{name:"Guardian's Vow",desc:["DEF+3 permanently","Holy Shield recharges faster","Blocks ignore 50% extra dmg"],cost:[80,130,200],icon:"âœï¸"},
  hiro_arm3:{name:"Fortress",desc:["Thorns reflect +3 dmg","Enemy crits deal 20% less dmg","Thorns proc on wrong answer too"],cost:[100,160,240],icon:"ðŸ°"},
  hiro_arm4:{name:"Resilience",desc:["On low HP (<30%): +5 DEF","HP regen increases by 2","Wrong-answer dmg reduced by 2"],cost:[120,200,280],icon:"ðŸ’ª"},
  hiro_arm5:{name:"Radiant Guard",desc:["Fire resist +8%","Thunder resist +8%","All elements: resist +5%"],cost:[140,220,320],icon:"ðŸŒŸ"},
  hiro_arm6:{name:"Stalwart",desc:["Evade chance +5%","Evade restores 3 HP","After evade: DEF+4 for 2 turns"],cost:[160,250,360],icon:"ðŸ’¨"},
  hiro_arm7:{name:"Celestial Aegis",desc:["All resist +8%","Holy Shield recharges every 3 turns","Negate one hit per battle"],cost:[200,320,440],icon:"âœ¨"},
  roku_arm1:{name:"Shadow Veil",desc:["First hit each stage: EVADE","Dodge chance +3%","Wrong answers: 50% chance no dmg"],cost:[60,100,160],icon:"ðŸŒ‘"},
  roku_arm2:{name:"Poison Skin",desc:["On hit: 10% chance to poison attacker","Poison DoT self +1","Dodge applies weak poison to enemy"],cost:[80,130,200],icon:"â˜ ï¸"},
  roku_arm3:{name:"Ice Shell",desc:["Ice resist +8%","When hit: 15% freeze attacker","Frozen enemies take +10% dmg"],cost:[100,160,240],icon:"â„ï¸"},
  roku_arm4:{name:"Ghost Step",desc:["Dodge +5%","Dodge also grants +1 SP","Dodge 3 times: next attack +25% dmg"],cost:[120,200,280],icon:"ðŸ‘»"},
  roku_arm5:{name:"Venom Body",desc:["Poison coat procs on every attack","Poison DoT +3 dmg","Double poison stacks on boss hits"],cost:[140,220,320],icon:"ðŸ"},
  roku_arm6:{name:"Night's Embrace",desc:["Wrong answer dmg -3","Evasion restores 5 HP","Night stance: +10% dmg bonus"],cost:[160,250,360],icon:"ðŸŒ™"},
  roku_arm7:{name:"Shadow God",desc:["All evasion +5%","Dodge 5 times: DEF+15 for battle","Immune to FIRE and POISON 1 turn"],cost:[200,320,440],icon:"âš°ï¸"},
  kisaragi_arm1:{name:"Warrior's Blood",desc:["Rage gain +1 SP","Wrong answers: +1 SP rage","Rage boosts next attack +10%"],cost:[60,100,160],icon:"ðŸ©¸"},
  kisaragi_arm2:{name:"Battle Roar",desc:["On correct answer: 5% ATK bonus","Every 3 corrects: +1 SP","ATK boost stacks up to 3x"],cost:[80,130,200],icon:"ðŸ’¢"},
  kisaragi_arm3:{name:"Fire Soul",desc:["Burn DoT +2 dmg","Fire resist +8%","Burning enemies' attacks are weaker (-10%)"],cost:[100,160,240],icon:"ðŸ”¥"},
  kisaragi_arm4:{name:"Dragon Blood",desc:["Dragon resist +10%","Dragon procs deal +15% dmg","HP regen +3 vs dragon enemies"],cost:[120,200,280],icon:"ðŸ‰"},
  kisaragi_arm5:{name:"Iron Titan",desc:["DEF+4 permanently","Thorns reflect +5 dmg","Tanking hits charges SP (+1)"],cost:[140,220,320],icon:"âš’ï¸"},
  kisaragi_arm6:{name:"Berserker's Fury",desc:["Berserk: self-dmg halved","Berserk: +2 SP gained","Berserk resets when enemy defeated"],cost:[160,250,360],icon:"ðŸ’€"},
  kisaragi_arm7:{name:"Ancient Titan",desc:["All resist +10%","Damage taken reduced by 5 flat","On death's door (<15% HP): invincible 1 turn"],cost:[200,320,440],icon:"ðŸ›ï¸"},
};

// Passive effects applied in combat (passive level lookup)
function getGearPassiveLevel(gearId){
  if(!advData.gearPassives)advData.gearPassives={};
  return advData.gearPassives[gearId]||0;
}
function getGearPassiveKey(gearId){
  // Derive passive key from gear id â€” map gear ids to passive keys
  let w=ADV_WEAPONS[gearId];let a=ADV_ARMORS[gearId];
  if(!w&&!a)return null;
  let charId=w?w.char:a.char;
  let isWpn=!!w;
  // Find index in char's weapon/armor array
  let arr=isWpn?Object.values(ADV_WEAPONS).filter(x=>x.char===charId):Object.values(ADV_ARMORS).filter(x=>x.char===charId);
  let idx=arr.findIndex(x=>x.id===gearId);
  if(idx<0)return null;
  let prefix=isWpn?`${charId}_wpn`:`${charId}_arm`;
  return `${prefix}${idx+1}`;
}

/* â”€â”€ ADVENTURE RUNTIME STATE â”€â”€ */
let adv={
  active:false,
  char:null,
  charId:null,
  enemy:null,
  hp:0, maxHp:0,
  sp:0, maxSp:6,
  statusEffects:[],
  stageIndex:0,
  stages:[],
  combatLog:[],
  pendingPoints:0,
  combatPhase:"question",
  currentWord:null,
  wordPool:[],
  wordUsed:[],
  correctThisTurn:0,
  enemyHp:0,
  enemyMaxHp:0,
  enemyStatus:[],
  enemyCharge:0,
  sessionGold:0,
  inventory:[],
  sortTiles:[],
  sortAnswer:[],
  questionType:"choice",
  turnCount:0,
  phase2Triggered:false,
  defending:false,
  shopOpen:false,
  answerTimer:null,lateHits:0,
  enemyQueue:[],enemyQueueIdx:0,
  armorPassives:{thorns:0,regen:0,evade_bonus:0,rage_gain:0,crit_boost:0,poison_coat:false,holy_shield_ready:false}
};

/* â”€â”€ STAGE GENERATOR â€” fixed 30 stages, word chunks grow with profile size â”€â”€ */
// Level groupings: 1-6=Lv1, 7-12=Lv2, 13-18=Lv3, 19-24=Lv4, 25-30=Lv5
const LEVEL_GROUPS=[
  {level:1,start:0,end:5,name:"Verdant Wilds",continent:"ðŸŒ¿ CONTINENT I",color:"#3a9a5c",bgColor:"rgba(30,80,50,0.18)",borderColor:"rgba(58,154,92,0.35)"},
  {level:2,start:6,end:11,name:"Ashen Highlands",continent:"ðŸŒ‹ CONTINENT II",color:"#c87030",bgColor:"rgba(80,40,10,0.18)",borderColor:"rgba(200,112,48,0.35)"},
  {level:3,start:12,end:17,name:"Frozen Reaches",continent:"â„ï¸ CONTINENT III",color:"#60b8e0",bgColor:"rgba(20,60,100,0.18)",borderColor:"rgba(96,184,224,0.35)"},
  {level:4,start:18,end:23,name:"Shadow Realm",continent:"ðŸŒ‘ CONTINENT IV",color:"#9c55d0",bgColor:"rgba(60,20,100,0.18)",borderColor:"rgba(156,85,208,0.35)"},
  {level:5,start:24,end:29,name:"Demon Throne",continent:"ðŸ’€ CONTINENT V",color:"#c94040",bgColor:"rgba(100,10,10,0.22)",borderColor:"rgba(201,64,64,0.45)"},
];
function getLevelGroup(stageIdx){
  return LEVEL_GROUPS.find(g=>stageIdx>=g.start&&stageIdx<=g.end)||LEVEL_GROUPS[0];
}
function getLevelStartStage(stageIdx){
  let g=getLevelGroup(stageIdx);return g.start;
}

function buildAdventureStages(allWords){
  const TOTAL_STAGES=30;
  let enemies=buildEnemyPool(allWords.length);
  let normals=enemies.filter(e=>e.type==="normal");
  let minibosses=enemies.filter(e=>e.type==="miniboss");
  let boss=enemies.find(e=>e.type==="boss");

  // â”€â”€ Word chunk assignment: divide words evenly across 30 stages â”€â”€
  // Each stage gets allWords.length/30 words (min 2). Grows gradually.
  let totalWords=allWords.length;
  let baseChunk=Math.max(2,Math.floor(totalWords/TOTAL_STAGES));

  // Build per-stage word pools: stage i gets words[i*baseChunk .. (i+1)*baseChunk]
  // Words are assigned so later stages cover later vocab, ensuring growth from stage 1
  function getStageWords(stageIdx){
    let start=Math.floor((stageIdx/TOTAL_STAGES)*totalWords);
    let end=Math.floor(((stageIdx+1)/TOTAL_STAGES)*totalWords);
    let primary=allWords.slice(start,Math.max(start+2,end));
    // 20% chance: mix in up to 3 words from already-passed stages for review
    let reviewWords=[];
    if(stageIdx>0&&Math.random()<0.20){
      let pastEnd=start;
      let pastPool=allWords.slice(0,pastEnd);
      if(pastPool.length>0){
        let picks=Math.min(3,pastPool.length);
        let shuffled=[...pastPool];shuffle(shuffled);
        reviewWords=shuffled.slice(0,picks);
      }
    }
    // Deduplicate
    let seen=new Set(primary.map(w=>w.kanji));
    let combined=[...primary,...reviewWords.filter(w=>!seen.has(w.kanji))];
    return combined.length?combined:allWords.slice(0,Math.min(5,allWords.length));
  }

  let miniBossPool=[...minibosses];
  shuffle(miniBossPool);
  let mbIdx=0;

  function pickNormal(stageIdx){
    // Tier 1-6 mapped across 30 stages (tier changes every 5 stages)
    let tier=Math.min(6,1+Math.floor(stageIdx/5));
    let tierEnemies=normals.filter(e=>e.tier===tier);
    if(!tierEnemies.length)tierEnemies=normals.filter(e=>e.tier===Math.min(6,tier+1));
    if(!tierEnemies.length)tierEnemies=normals;
    let e={...tierEnemies[Math.floor(Math.random()*tierEnemies.length)]};
    let ngMult=1+((advData.ngPlus||0)*0.15);
    let scaleMult=1+stageIdx*0.12; // gradual scaling over 30 stages
    e.hp=Math.round(e.hp*scaleMult*ngMult);
    e.atk=Math.round(e.atk*scaleMult*ngMult);
    e.def=Math.round(e.def*scaleMult*ngMult);
    e.spd=Math.round((e.spd||6)*(1+stageIdx*0.05));
    e.xp=Math.round(e.xp*(1+stageIdx*0.08));
    e.gold=Math.round(e.gold*(1+stageIdx*0.08));
    if((advData.ngPlus||0)>=1){
      e.dodge=(e.dodge||0)+Math.min(20,(advData.ngPlus||0)*4);
      e.dmgReduce=Math.min(0.25,(advData.ngPlus||0)*0.05);
    }
    return e;
  }
  function pickMiniboss(stageIdx){
    let ngMult=1+((advData.ngPlus||0)*0.15);
    let scaleMult=1+stageIdx*0.14;
    let mb={...miniBossPool[mbIdx%miniBossPool.length]};
    mbIdx++;
    mb.hp=Math.round(mb.hp*scaleMult*ngMult);
    mb.atk=Math.round(mb.atk*scaleMult*ngMult);
    mb.def=Math.round(mb.def*scaleMult*ngMult);
    mb.spd=Math.round((mb.spd||8)*(1+stageIdx*0.05));
    if((advData.ngPlus||0)>=1){
      mb.dodge=(mb.dodge||0)+Math.min(25,(advData.ngPlus||0)*5);
      mb.dmgReduce=Math.min(0.30,(advData.ngPlus||0)*0.07);
    }
    return mb;
  }

  let stages=[];
  for(let i=0;i<TOTAL_STAGES;i++){
    let group=getLevelGroup(i);
    let posInGroup=i-group.start; // 0-5
    let zoneWords=getStageWords(i);

    // Stage layout within each group of 6:
    // pos 0,1,2 = normal | pos 3 = shop | pos 4 = miniboss | pos 5 = boss/final
    let isFinalStage=(i===TOTAL_STAGES-1);
    let isGroupFinal=(posInGroup===5);
    let isMiniboss=(posInGroup===4);
    let isShop=(posInGroup===3);

    if(isFinalStage){
      // Stage 30: final boss gauntlet
      let enemyList=[];
      for(let k=0;k<3;k++) enemyList.push({...pickNormal(i),stageType:"normal"});
      enemyList.push({...pickMiniboss(i),stageType:"miniboss"});
      let bossE={...boss};
      let ngMult=1+((advData.ngPlus||0)*0.15);
      bossE.hp=Math.round(bossE.hp*(1+i*0.14)*ngMult);
      bossE.atk=Math.round(bossE.atk*(1+i*0.12)*ngMult);
      bossE.def=Math.round(bossE.def*(1+i*0.12)*ngMult);
      enemyList.push({...bossE,stageType:"boss",isFinal:true});
      stages.push({stageType:"boss",stageNum:i+1,stageIdx:i,levelGroup:group.level,name:"DEMON KING'S THRONE",art:"ðŸ‘‘",zoneWords:allWords,isFinalZone:true,enemies:enemyList,type:"boss"});

    } else if(isShop){
      stages.push({stageType:"shop",type:"shop",stageNum:i+1,stageIdx:i,levelGroup:group.level,name:"Wandering Merchant",art:"ðŸª",zoneWords,enemies:[]});

    } else if(isGroupFinal && !isFinalStage){
      // Group boss (every 6th stage except the very last)
      let mbE=pickMiniboss(i);
      let enemyList=[];
      for(let k=0;k<2;k++) enemyList.push({...pickNormal(i),stageType:"normal"});
      enemyList.push({...mbE,stageType:"miniboss",isFinal:false});
      stages.push({stageType:"miniboss",stageNum:i+1,stageIdx:i,levelGroup:group.level,name:mbE.name,art:mbE.art,zoneWords,enemies:enemyList});

    } else if(isMiniboss){
      // Mid-group mini challenge
      let mbE=pickMiniboss(i);
      let enemyList=[];
      for(let k=0;k<2;k++) enemyList.push({...pickNormal(i),stageType:"normal"});
      enemyList.push({...mbE,stageType:"miniboss"});
      stages.push({stageType:"miniboss",stageNum:i+1,stageIdx:i,levelGroup:group.level,name:mbE.name,art:mbE.art,zoneWords,enemies:enemyList});

    } else {
      // Normal combat stages (pos 0,1,2 of each group)
      let count=2+Math.floor(Math.random()*2);
      let enemyList=[];
      for(let k=0;k<count;k++) enemyList.push({...pickNormal(i),stageType:"normal"});
      let firstEnemy=enemyList[0];
      stages.push({stageType:"normal",stageNum:i+1,stageIdx:i,levelGroup:group.level,name:firstEnemy.name,art:firstEnemy.art,zoneWords,enemies:enemyList});
    }
  }
  return stages;
}

/* â”€â”€ HELPERS â”€â”€ */
function getEquippedWeapon(charId){
  let wpnId=advData.equip[charId]&&advData.equip[charId].weapon;
  return wpnId?ADV_WEAPONS[wpnId]:null;
}
function getEquippedArmor(charId){
  let armId=advData.equip[charId]&&advData.equip[charId].armor;
  return armId?ADV_ARMORS[armId]:null;
}

function getCharEffectiveStats(charId){
  let base={...ADV_CHARS[charId].baseStats};
  let cs=advData.charStats[charId]||{};
  let upgrades=advData.statUpgrades&&advData.statUpgrades[charId]||{hp:0,atk:0,def:0,skillDmg:0};
  let stats={
    hp:typeof cs.hp==='number'?cs.hp:base.hp,
    maxHp:(typeof cs.maxHp==='number'?cs.maxHp:base.maxHp)+(upgrades.hp||0)*10,
    atk:(typeof cs.atk==='number'?cs.atk:base.atk)+(upgrades.atk||0)*2,
    def:(typeof cs.def==='number'?cs.def:base.def)+(upgrades.def||0)*2,
    spd:typeof cs.spd==='number'?cs.spd:base.spd,
    level:typeof cs.level==='number'?cs.level:1,
    xp:typeof cs.xp==='number'?cs.xp:0,
    skillDmgBonus:(upgrades.skillDmg||0)*0.1
  };
  let wpn=getEquippedWeapon(charId);
  let arm=getEquippedArmor(charId);
  let gu=advData.gearUpgrades||{};
  if(wpn){
    let wpnUpgLvl=gu[wpn.id]||0;
    stats.atk+=wpn.atk+(wpnUpgLvl*2);
    stats.critBonus=(wpn.crit||0);
  }
  if(arm){
    let armUpgLvl=gu[arm.id]||0;
    stats.def+=arm.def+(armUpgLvl*2);
    stats.maxHp+=arm.hp;
    stats.dodgeBonus=Math.min(25,arm.dodge||0);
    // Combine armor elemRes with character base elemRes
    let charBase=ADV_CHARS[charId];
    let baseRes=charBase.elementRes||{};
    let armRes=arm.elemRes||{};
    stats.elemRes={
      fire:Math.min(40,(baseRes.fire||0)+(armRes.fire||0)),
      ice:Math.min(40,(baseRes.ice||0)+(armRes.ice||0)),
      thunder:Math.min(40,(baseRes.thunder||0)+(armRes.thunder||0)),
      poison:Math.min(40,(baseRes.poison||0)+(armRes.poison||0)),
      dragon:Math.min(40,(baseRes.dragon||0)+(armRes.dragon||0))
    };
  } else {
    let charBase=ADV_CHARS[charId];
    let baseRes=charBase.elementRes||{};
    stats.elemRes={
      fire:Math.min(40,baseRes.fire||0),ice:Math.min(40,baseRes.ice||0),
      thunder:Math.min(40,baseRes.thunder||0),poison:Math.min(40,baseRes.poison||0),dragon:Math.min(40,baseRes.dragon||0)
    };
  }
  return stats;
}

// NON-LINEAR DAMAGE: atk*(100/(100+def))*mult â€” tank can't zero dmg, DPS stays lethal
function advCalcDamage(atk,def,mult,isCrit,critBonus){
  let defFactor=100/(100+Math.max(0,def));
  let base=Math.max(1,Math.round(atk*defFactor*(mult||1.0)*(0.9+Math.random()*0.2)));
  if(isCrit)base=Math.round(base*(1.5+(critBonus||0)/100));
  return base;
}

function advAddLog(msg){
  adv.combatLog.unshift(msg);
  if(adv.combatLog.length>12)adv.combatLog.pop();
  let logEl=document.getElementById("adv-log");
  if(logEl)logEl.innerHTML=adv.combatLog.slice(0,5).map(l=>`<div>${l}</div>`).join("");
}

function showDmgPop(text,color,xPct,yPct){
  let el=document.createElement("div");
  el.className="adv-damage-pop";
  el.style.cssText=`left:${xPct||48}%;top:${yPct||40}%;color:${color||"#ff4444"};text-shadow:0 0 8px ${color||"#ff4444"};pointer-events:none;`;
  el.textContent=text;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1200);
}

function advAnimateSprite(id,cls){
  let el=document.getElementById(id);
  if(!el)return;
  el.classList.remove("sprite-idle","sprite-attack","sprite-hurt","sprite-enemy-attack","sprite-enemy-hurt","sprite-die");
  void el.offsetWidth;
  el.classList.add(cls);
  setTimeout(()=>{el.classList.remove(cls);if(cls!=="sprite-die")el.classList.add("sprite-idle");},600);
  // Also flash the containing fighter panel
  let panelId=id==="adv-player-sprite"?"adv-player-panel":"adv-enemy-panel";
  let panelCls=(cls==="sprite-hurt"||cls==="sprite-die")?"player-hit-flash":"enemy-hit-flash";
  if(cls==="sprite-enemy-hurt")panelCls="enemy-hit-flash";
  else if(cls==="sprite-hurt")panelCls="player-hit-flash";
  else return; // only flash on hurt, not on attack
  let panel=document.getElementById(panelId);
  if(panel){panel.classList.remove("player-hit-flash","enemy-hit-flash");void panel.offsetWidth;panel.classList.add(panelCls);setTimeout(()=>panel.classList.remove(panelCls),500);}
}

function advLevelUp(){
  let cs=advData.charStats[adv.charId];
  cs.level++;
  cs.xp=Math.max(0,cs.xp-cs.level*50);
  cs.maxHp+=10; cs.atk+=3; cs.def+=2; cs.spd+=1;
  // Grant upgrade point
  if(!advData.upgradePoints)advData.upgradePoints={};
  advData.upgradePoints[adv.charId]=(advData.upgradePoints[adv.charId]||0)+1;
  adv.maxHp=cs.maxHp+((advData.statUpgrades&&advData.statUpgrades[adv.charId]&&advData.statUpgrades[adv.charId].hp)||0)*10;
  advAddLog(`â¬† LEVEL UP! ${ADV_CHARS[adv.charId].name} â†’ LV.${cs.level}! +1 Upgrade Point!`);
  showDmgPop(`LEVEL UP!`,"#f0c060",44,28);
  saveAll();
}

function advCheckLevelUp(){
  let cs=advData.charStats[adv.charId];
  let need=cs.level*50;
  while(cs.xp>=need){advLevelUp();need=cs.level*50;}
}

/* â”€â”€ WORD POOL â”€â”€ */
function advSetWordPool(zoneWords){
  let profile=profiles[currentProfile];
  let allWords=(profile&&profile.words)||[];
  adv.wordPool=shuffle([...(zoneWords&&zoneWords.length?zoneWords:allWords)]);
  adv.wordUsed=[];
}

/* â”€â”€ ANSWER TIMER (escalating damage if late) â”€â”€ */
// Late 1: -1 HP | Late 2: -5 HP | Late 3: -15 HP | Late 4+: -30 HP + enemy full attack
const ADV_ANSWER_TIME=12000; // 12 seconds to answer
const ADV_LATE_PENALTIES=[1,5,15,30]; // damage per late tier
function advGetLatePenalty(){
  let late=adv.lateHits||0;
  return ADV_LATE_PENALTIES[Math.min(late,ADV_LATE_PENALTIES.length-1)];
}
function advStartAnswerTimer(){
  advClearAnswerTimer();
  let bar=document.getElementById("adv-answer-timer");
  // Color changes based on how many times already late
  let late=adv.lateHits||0;
  let barColor=late===0?'linear-gradient(90deg,#ff4400,#ff8800)':late===1?'linear-gradient(90deg,#cc0000,#ff2200)':'linear-gradient(90deg,#880000,#cc0000)';
  if(bar){
    bar.style.transition="none";bar.style.width="100%";bar.style.background=barColor;
    void bar.offsetWidth;
    bar.style.transition=`width ${ADV_ANSWER_TIME}ms linear`;
    bar.style.width="0%";
  }
  adv.answerTimer=setTimeout(()=>{
    if(!adv.active||!adv.enemy)return;
    if(adv._processing)return; // don't fire while an action is being processed
    let effStats=getCharEffectiveStats(adv.charId);
    let enemy=adv.enemy;
    let latePenalty=advGetLatePenalty();
    adv.lateHits=(adv.lateHits||0)+1;
    let lateNum=adv.lateHits;

    // Base penalty damage (ignores some defense to punish lateness)
    let penaltyDmg=latePenalty;
    adv.hp=Math.max(0,adv.hp-penaltyDmg);

    // On late 4+: enemy also does a FULL attack on top
    let extraMsg='';
    if(lateNum>=4){
      let fullDmg=advCalcDamage(enemy.atk,Math.max(0,effStats.def*0.5),1.2);
      adv.hp=Math.max(0,adv.hp-fullDmg);
      extraMsg=` + ${fullDmg} FULL ATTACK!`;
    }

    let lateLabel=lateNum===1?'1st':lateNum===2?'2nd':lateNum===3?'3rd':`${lateNum}th`;
    advAddLog(`â° ${lateLabel} timeout! -${penaltyDmg}HP${extraMsg} (${enemy.name} strikes!)`);
    showDmgPop(`â°${lateNum>=4?'ðŸ’€':''}-${penaltyDmg}`,lateNum>=3?"#ff0000":lateNum>=2?"#ff4400":"#ff8800",50,35);
    advAnimateSprite("adv-enemy-sprite","sprite-enemy-attack");
    advAnimateSprite("adv-player-sprite","sprite-hurt");

    // Show escalating warning
    if(lateNum<4){
      let nextPenalty=ADV_LATE_PENALTIES[Math.min(lateNum,ADV_LATE_PENALTIES.length-1)];
      advAddLog(`âš  Next timeout: -${nextPenalty}HP${lateNum>=3?' + FULL ATTACK!':''}`);
    }

    if(adv.hp<=0){advDie();return;}
    advPickWord();
    saveAll();
    renderAdventureCombat();
  },ADV_ANSWER_TIME);
}
function advClearAnswerTimer(){
  if(adv.answerTimer){clearTimeout(adv.answerTimer);adv.answerTimer=null;}
  let bar=document.getElementById("adv-answer-timer");
  if(bar){bar.style.transition="none";bar.style.width="100%";}
}

/* â”€â”€ ADVENTURE HUB â€” 3 sections â”€â”€ */
function renderAdventureEntry(){
  let profileNames=Object.keys(profiles||{});
  let hasValidProfile=currentProfile&&profiles[currentProfile]&&(profiles[currentProfile].words||[]).length>0;
  if(!hasValidProfile){
    let profileListHtml='';
    if(profileNames.length===0){
      profileListHtml=`<div class="adv-story-box" style="border-left-color:var(--red);color:var(--text-dim);font-size:12px;">No operators found. Create a profile and import vocabulary first.</div>
      <button data-action="renderProfile" style="color:var(--accent);border-color:var(--accent-dim);">â–¶ Create Operator Profile</button>`;
    } else {
      profileListHtml=profileNames.map(name=>{
        let p=profiles[name];let wc=(p.words||[]).length;let hasWords=wc>0;
        let btnStyle=hasWords?'border-color:rgba(156,85,208,0.45);color:#d0a0ff;':'color:var(--text-dim);';
        let badge=hasWords?'<span style="font-size:8px;color:#9c55d0;letter-spacing:1px;">SELECT â–º</span>':'<span style="font-size:8px;color:var(--text-dim);">NO WORDS</span>';
        return `<button data-action="advPickProfile:${name}" style="${btnStyle}"><span style="font-size:18px;">ðŸ‘¤</span><span style="flex:1;"><span style="font-family:\'Rajdhani\',sans-serif;font-size:17px;font-weight:700;letter-spacing:2px;">${name}</span><span style="font-family:\'Share Tech Mono\',monospace;font-size:9px;color:var(--text-dim);margin-left:8px;">${wc} words</span></span>${badge}</button>`;
      }).join('');
    }
    app.innerHTML=`<div class="container"><div class="ark-header"><button class="back" data-action="renderMenu">â—„ BACK</button><div class="ark-title">âš”ï¸ <span>Adventure</span></div></div><div class="adv-story-box" style="border-left-color:var(--purple);color:#c0a0ff;"><span style="color:var(--accent);font-family:\'Rajdhani\',sans-serif;font-size:15px;font-weight:700;letter-spacing:2px;">â€” CHOOSE YOUR OPERATOR â€”</span><br><br>Select which profile to use for this quest.</div><div class="ark-section">ðŸ‘¤ OPERATOR PROFILES</div>${profileListHtml}<button data-action="renderProfile" style="color:var(--text-dim);border-color:var(--border);margin-top:8px;font-size:11px;">âš™ Manage Profiles</button></div>`;
    return;
  }
  // Main hub â€” 3 big buttons
  let charId=advData.activeChar||"hiro";
  let charDef=ADV_CHARS[charId];
  let cs=advData.charStats[charId]||{level:1};
  let effStats=getCharEffectiveStats(charId);
  let hpPct=Math.max(0,Math.round(((cs.hp||effStats.maxHp)/effStats.maxHp)*100));
  app.innerHTML=`<div class="container">
    <div class="ark-header">
      <button class="back" data-action="renderMenu">â—„ BACK</button>
      <div class="ark-title">âš”ï¸ <span>Adventure</span></div>
      <div class="adv-gold-display" style="margin-left:auto;">ðŸ’° ${advData.totalGold}</div>
    </div>
    <div class="adv-story-box" style="border-left-color:var(--purple);padding:8px 10px;margin-bottom:8px;">
      <div style="display:flex;gap:10px;align-items:center;">
        <div style="width:44px;flex-shrink:0;font-size:36px;line-height:1;text-align:center;">${charDef.art}</div>
        <div style="flex:1;">
          <div style="font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;color:var(--text-bright);">${charDef.name} <span style="font-size:10px;color:var(--accent);">LV.${cs.level}</span></div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);">${charDef.class} Â· ${charDef.jp}</div>
          <div class="adv-hp-bar" style="margin-top:3px;height:5px;"><div class="adv-hp-fill" style="width:${hpPct}%;${hpPct<30?'background:linear-gradient(90deg,#550000,#cc0000);':''}"></div></div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--text-dim);margin-top:2px;">HP ${Math.max(0,cs.hp||effStats.maxHp)}/${effStats.maxHp} Â· âš”ï¸${effStats.atk} ðŸ›¡ï¸${effStats.def}</div>
        </div>
      </div>
    </div>
    <div class="ark-section">ðŸ“‹ ADVENTURE MENU</div>
    <button data-action="advScreenCharSelect" style="border-color:rgba(156,85,208,0.5);color:#d0a0ff;background:rgba(80,30,140,0.08);">
      <span style="font-size:18px;">ðŸ‘¥</span>
      <div style="flex:1;text-align:left;">
        <div style="font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;">CHARACTER SELECT</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);">Choose & unlock warriors</div>
      </div>
      <span style="font-size:9px;color:var(--text-dim);">â–º</span>
    </button>
    <button data-action="advStartRun" style="border-color:rgba(58,154,92,0.6);color:#5ecf8a;background:rgba(20,80,40,0.1);">
      <span style="font-size:18px;">âš”ï¸</span>
      <div style="flex:1;text-align:left;">
        <div style="font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;">ADVENTURE</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);">${advData.savedStageIndex>0?`Continue from Stage ${advData.savedStageIndex+1}`:'Start / continue quest'}</div>
      </div>
      <span style="font-size:9px;color:var(--text-dim);">â–º</span>
    </button>
    <button data-action="advOpenCustomizeMenu" style="border-color:rgba(240,192,96,0.5);color:#f0c060;background:rgba(80,60,10,0.08);">
      <span style="font-size:18px;">ðŸŽ›ï¸</span>
      <div style="flex:1;text-align:left;">
        <div style="font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;">CUSTOMIZE</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);">Gear, weapons, stats upgrades</div>
      </div>
      <span style="font-size:9px;color:var(--text-dim);">â–º</span>
    </button>
    <button data-action="advChangeProfile" style="border-color:rgba(110,122,138,0.35);color:var(--text-dim);">
      <span style="font-size:16px;">ðŸ”„</span>
      <div style="flex:1;text-align:left;">
        <div style="font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;">CHANGE PROFILE</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);">Vocabulary: ${currentProfile||'none'}</div>
      </div>
    </button>
    <button data-action="advAlmanac" style="border-color:rgba(156,85,208,0.35);color:#a070e0;">
      <span style="font-size:16px;">ðŸ“–</span>
      <div style="flex:1;text-align:left;">
        <div style="font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;">ALMANAC</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);">${(advData.seenEnemies||[]).length} enemies discovered</div>
      </div>
    </button>
  </div>`;
}
function advScreenCharSelect(){
  if(!advData.statUpgrades)advData.statUpgrades={hiro:{hp:0,atk:0,def:0,skillDmg:0},roku:{hp:0,atk:0,def:0,skillDmg:0},kisaragi:{hp:0,atk:0,def:0,skillDmg:0}};
  if(!advData.upgradePoints)advData.upgradePoints={hiro:0,roku:0,kisaragi:0};
  let charHtml=Object.values(ADV_CHARS).map(c=>{
    let owned=advData.ownedChars.includes(c.id);
    let active=advData.activeChar===c.id;
    let cs=advData.charStats[c.id]||{level:1,hp:c.baseStats.hp,maxHp:c.baseStats.maxHp};
    let effStats=getCharEffectiveStats(c.id);
    let wpn=getEquippedWeapon(c.id);
    let arm=getEquippedArmor(c.id);
    let safeHp=Math.min(cs.hp||1,effStats.maxHp);
    let hpPct=Math.round((safeHp/effStats.maxHp)*100);
    let upgPts=advData.upgradePoints[c.id]||0;
    let elemHtml=Object.entries(c.elementAtk||{}).filter(([,v])=>v>0).map(([el,v])=>`<span style="color:${ELEMENT_COLORS[el]||'#fff'};font-size:8px;">${ELEMENT_ICONS[el]}${v}%</span>`).join(' ');
    return `<div class="adv-char-select${active?' selected':''}" style="position:relative;">
      <div data-action="${owned?`advSelectChar:${c.id}`:`advBuyChar:${c.id}`}" style="display:flex;gap:12px;align-items:flex-start;cursor:pointer;">
        <div style="width:80px;flex-shrink:0;"><div class="sprite-idle">${c.art}</div></div>
        <div style="flex:1;">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px;">
            <span style="font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;color:var(--text-bright);letter-spacing:2px;">${c.name}</span>
            <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);">${c.jp}</span>
            <span style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);margin-left:auto;border:1px solid var(--border);padding:1px 5px;">${c.class.toUpperCase()}</span>
          </div>
          ${elemHtml?`<div style="margin-bottom:4px;display:flex;gap:4px;flex-wrap:wrap;">${elemHtml}</div>`:''}
          ${owned?`
            <div class="adv-hp-label">HP ${safeHp}/${effStats.maxHp} &nbsp;|&nbsp; LV.${cs.level}${upgPts>0?` &nbsp;<span style="color:var(--accent);">â¬†${upgPts}pts</span>`:''}</div>
            <div class="adv-hp-bar" style="margin-bottom:4px;"><div class="adv-hp-fill" style="width:${hpPct}%;"></div></div>
            <div style="display:flex;flex-wrap:wrap;gap:3px;">
              <span class="adv-stat-pill">âš”ï¸${effStats.atk}</span>
              <span class="adv-stat-pill">ðŸ›¡ï¸${effStats.def}</span>
              <span class="adv-stat-pill">ðŸ’¨${effStats.spd}</span>
              ${wpn?`<span class="adv-stat-pill" style="color:var(--accent);">${wpn.icon}${wpn.name}</span>`:''}
              ${arm?`<span class="adv-stat-pill" style="color:var(--blue);">${arm.icon}${arm.name}</span>`:''}
            </div>
          `:`<div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:#f0c060;margin-top:4px;">ðŸª™ ${c.price} shop coins to unlock</div>`}
          ${active?`<div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--green);margin-top:4px;letter-spacing:2px;">â—ˆ SELECTED â€” TAP TO CONFIRM</div>`:''}
        </div>
      </div>
      <button data-action="advCharDetail:${c.id}" style="position:absolute;top:8px;right:8px;padding:3px 9px;font-size:10px;font-family:'Share Tech Mono',monospace;border:1px solid var(--border);background:rgba(0,0,0,0.4);color:var(--text-dim);letter-spacing:1px;min-width:0;width:auto;">ðŸ“‹ INFO</button>
    </div>`;
  }).join("");
  app.innerHTML=`<div class="container">
    <div class="ark-header">
      <button class="back" data-action="renderAdventureEntry">â—„ BACK</button>
      <div class="ark-title">ðŸ‘¥ <span>Character Select</span></div>
      <div class="adv-gold-display" style="margin-left:auto;font-size:11px;">ðŸª™${shopData.coins}</div>
    </div>
    <div class="ark-section">âš”ï¸ SELECT YOUR WARRIOR</div>
    ${charHtml}
  </div>`;
}

/* â”€â”€ CHARACTER DETAIL SCREEN â”€â”€ */
function advCharDetail(charId){
  let c=ADV_CHARS[charId];if(!c)return;
  let owned=advData.ownedChars.includes(charId);
  let cs=advData.charStats[charId]||{level:1};
  let effStats=getCharEffectiveStats(charId);
  let wpn=getEquippedWeapon(charId);
  let arm=getEquippedArmor(charId);

  // Element affinity rows
  let elemAtkHtml=Object.entries(c.elementAtk||{}).filter(([,v])=>v>0).map(([el,v])=>
    `<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.04);">
      <span style="color:${ELEMENT_COLORS[el]};font-size:11px;">${ELEMENT_ICONS[el]} ${el.toUpperCase()} ATK</span>
      <span style="font-family:'Share Tech Mono',monospace;font-size:10px;color:${ELEMENT_COLORS[el]};">${v}% proc</span>
    </div>`).join('');
  let elemResHtml=Object.entries(c.elementRes||{}).filter(([,v])=>v>0).map(([el,v])=>
    `<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.04);">
      <span style="color:var(--text-dim);font-size:11px;">${ELEMENT_ICONS[el]} ${el.toUpperCase()} RES</span>
      <span style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--blue);">${v}% reduce</span>
    </div>`).join('');

  // Skills
  let skillsHtml=c.skills.map(sk=>`
    <div style="background:rgba(0,0,0,0.3);border:1px solid rgba(156,85,208,0.3);padding:8px 10px;margin:4px 0;border-radius:2px;">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
        <span style="font-size:16px;">${sk.icon}</span>
        <span style="font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;color:#c080ff;">${sk.name}</span>
        <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-left:auto;">${sk.jp}</span>
      </div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-bottom:3px;">${sk.desc}</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--green);">ðŸ’  ${sk.cost}SP</span>
        ${sk.dmgMult>0?`<span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);">âš”ï¸ Ã—${sk.dmgMult}</span>`:''}
        <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:#c080ff;">FX: ${sk.effect.toUpperCase()}</span>
      </div>
    </div>`).join('');

  // Weapons list for this char
  let charWeapons=Object.values(ADV_WEAPONS).filter(w=>w.char===charId);
  let wpnHtml=charWeapons.map(w=>{
    let isOwned=advData.ownedWeapons&&(advData.ownedWeapons.includes(w.id)||w.price===0);
    let isEquipped=wpn&&wpn.id===w.id;
    return `<div style="background:rgba(0,0,0,0.25);border:1px solid ${isEquipped?'rgba(240,192,96,0.5)':isOwned?'rgba(255,255,255,0.1)':'rgba(255,255,255,0.04)'};padding:6px 8px;margin:3px 0;opacity:${isOwned?1:0.5};">
      <div style="display:flex;align-items:center;gap:6px;">
        <span style="font-size:14px;">${w.icon}</span>
        <span style="font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:${isEquipped?'var(--accent)':'var(--text-bright)'};">${w.name}</span>
        ${isEquipped?`<span style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--accent);margin-left:auto;">EQUIPPED</span>`:`<span style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);margin-left:auto;">${isOwned?'OWNED':'ðŸª™'+w.price}</span>`}
      </div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:2px;">ATK+${w.atk} Â· CRIT+${w.crit}% Â· ${w.skillName}: ${w.skillDesc}</div>
    </div>`;
  }).join('');

  // Armors list for this char
  let charArmors=Object.values(ADV_ARMORS).filter(a=>a.char===charId);
  let armHtml=charArmors.map(a=>{
    let isOwned=advData.ownedArmors&&(advData.ownedArmors.includes(a.id)||a.price===0);
    let isEquipped=arm&&arm.id===a.id;
    return `<div style="background:rgba(0,0,0,0.25);border:1px solid ${isEquipped?'rgba(58,114,176,0.5)':isOwned?'rgba(255,255,255,0.1)':'rgba(255,255,255,0.04)'};padding:6px 8px;margin:3px 0;opacity:${isOwned?1:0.5};">
      <div style="display:flex;align-items:center;gap:6px;">
        <span style="font-size:14px;">${a.icon}</span>
        <span style="font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:${isEquipped?'var(--blue)':'var(--text-bright)'};">${a.name}</span>
        ${isEquipped?`<span style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--blue);margin-left:auto;">EQUIPPED</span>`:`<span style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);margin-left:auto;">${isOwned?'OWNED':'ðŸª™'+a.price}</span>`}
      </div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:2px;">DEF+${a.def} Â· HP+${a.hp} Â· DODGE+${a.dodge}% Â· ${a.bonusDesc}</div>
    </div>`;
  }).join('');

  let classColors={Knight:'var(--accent)',Assassin:'#c080ff',Fighter:'#ff6020'};
  let classColor=classColors[c.class]||'var(--accent)';

  app.innerHTML=`<div class="container" style="padding-bottom:80px;">
    <div class="ark-header">
      <button class="back" data-action="advScreenCharSelect">â—„ BACK</button>
      <div class="ark-title">ðŸ“‹ <span>Character Info</span></div>
    </div>
    <!-- Hero card -->
    <div style="background:var(--bg-card2);border:1px solid ${classColor}40;padding:14px;margin-bottom:10px;display:flex;gap:14px;align-items:center;">
      <div style="width:80px;flex-shrink:0;">${c.art}</div>
      <div style="flex:1;">
        <div style="font-family:'Rajdhani',sans-serif;font-size:24px;font-weight:700;color:var(--text-bright);letter-spacing:3px;">${c.name}</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:${classColor};letter-spacing:2px;">${c.class.toUpperCase()} Â· ${c.jp}</div>
        ${owned?`<div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:3px;">LV.${cs.level} Â· XP ${cs.xp||0}</div>`:`<div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:#f0c060;margin-top:3px;">ðŸ”’ LOCKED â€” ðŸª™${c.price}</div>`}
      </div>
    </div>
    <!-- Base stats -->
    <div class="ark-section">ðŸ“Š BASE STATS ${owned?'(WITH UPGRADES)':''}</div>
    <div style="background:var(--bg-card2);border:1px solid var(--border);padding:10px 14px;margin-bottom:8px;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
        <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="font-size:12px;">â¤ï¸ Max HP</span><span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--red);">${effStats.maxHp}</span></div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="font-size:12px;">âš”ï¸ ATK</span><span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--accent);">${effStats.atk}</span></div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="font-size:12px;">ðŸ›¡ï¸ DEF</span><span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--blue);">${effStats.def}</span></div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="font-size:12px;">ðŸ’¨ SPD</span><span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--green);">${effStats.spd}</span></div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="font-size:12px;">ðŸ’¥ CRIT</span><span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:#fff700;">${effStats.critBonus||0}%</span></div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="font-size:12px;">âš¡ Max SP</span><span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--green);">${effStats.maxSp||10}</span></div>
      </div>
    </div>
    <!-- Elements -->
    ${elemAtkHtml||elemResHtml?`<div class="ark-section">ðŸŒŸ ELEMENT AFFINITIES</div>
    <div style="background:var(--bg-card2);border:1px solid var(--border);padding:10px 14px;margin-bottom:8px;">
      ${elemAtkHtml}${elemResHtml}
    </div>`:''}
    <!-- Skills -->
    <div class="ark-section">âœ¨ SKILLS</div>
    ${skillsHtml}
    <!-- Weapons -->
    <div class="ark-section">âš”ï¸ WEAPONS (${Object.values(ADV_WEAPONS).filter(w=>w.char===charId&&(advData.ownedWeapons&&(advData.ownedWeapons.includes(w.id)||w.price===0))).length}/${charWeapons.length} owned)</div>
    ${wpnHtml}
    <!-- Armors -->
    <div class="ark-section">ðŸ›¡ï¸ ARMORS (${Object.values(ADV_ARMORS).filter(a=>a.char===charId&&(advData.ownedArmors&&(advData.ownedArmors.includes(a.id)||a.price===0))).length}/${charArmors.length} owned)</div>
    ${armHtml}
  </div>`;
}

/* â”€â”€ ART RENDER HELPER â”€â”€ */
function renderArt(art, size, extraStyle){
  if(!art) return '';
  let isSvg = art.trim().startsWith('<svg');
  if(isSvg){
    let scale = size/90;
    let w = Math.round(80*scale);
    return `<div style="width:${w}px;height:${size}px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;${extraStyle||''}"><div style="transform:scale(${scale.toFixed(3)});transform-origin:top left;width:80px;height:90px;">${art}</div></div>`;
  }
  return `<div style="font-size:${size}px;line-height:1;display:flex;align-items:center;justify-content:center;flex-shrink:0;${extraStyle||''}">${art}</div>`;
}

/* â”€â”€ ALMANAC â”€â”€ */
function advAlmanac(){
  if(!advData.seenEnemies)advData.seenEnemies=[];
  let allEnemies=buildEnemyPool([]);
  let total=allEnemies.length;
  let seen=advData.seenEnemies.length;
  let typeColors={normal:'var(--text-dim)',miniboss:'#c080ff',boss:'#ff4444'};
  let typeLabels={normal:'NORMAL',miniboss:'MINI BOSS',boss:'FINAL BOSS'};

  let listHtml=allEnemies.map(e=>{
    let isSeen=advData.seenEnemies.includes(e.id);
    let typeColor=typeColors[e.type]||'var(--text-dim)';
    let fstyle=ENEMY_FIGHT_STYLES[e.id];
    let elemAtkHtml=Object.entries(e.elementAtk||{}).filter(([,v])=>v>0).map(([el,v])=>`<span style="color:${ELEMENT_COLORS[el]};font-size:8px;">${ELEMENT_ICONS[el]}${v}%</span>`).join(' ');
    return `<div style="background:var(--bg-card2);border:1px solid ${isSeen?(e.type==='boss'?'rgba(255,68,68,0.4)':e.type==='miniboss'?'rgba(156,85,208,0.35)':'rgba(255,255,255,0.1)'):'rgba(255,255,255,0.04)'};padding:10px 12px;margin:4px 0;opacity:${isSeen?1:0.35};">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="filter:${isSeen?'none':'grayscale(1) brightness(0.3)'};">${renderArt(e.art,32,'width:36px;')}</div>
        <div style="flex:1;">
          <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
            <span style="font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:${isSeen?'var(--text-bright)':'var(--text-dim)'};">${isSeen?e.name:'???'}</span>
            <span style="font-family:'Share Tech Mono',monospace;font-size:8px;color:${typeColor};">${typeLabels[e.type]||'NORMAL'}</span>
            ${isSeen&&e.jp?`<span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);">${e.jp}</span>`:''}
          </div>
          ${isSeen?`<div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:2px;">Tier ${e.tier||'?'} Â· XP ${e.xp} Â· ðŸ’°${e.gold}</div>`:'<div style="font-family:\'Share Tech Mono\',monospace;font-size:9px;color:var(--text-dim);margin-top:2px;">Not yet encountered</div>'}
          ${isSeen&&elemAtkHtml?`<div style="margin-top:3px;display:flex;gap:4px;flex-wrap:wrap;">${elemAtkHtml}</div>`:''}
        </div>
        ${isSeen?`<button data-action="advEnemyDetail:${e.id}" style="padding:3px 9px;font-size:10px;font-family:'Share Tech Mono',monospace;border:1px solid ${typeColor}40;background:rgba(0,0,0,0.4);color:var(--text-dim);letter-spacing:1px;min-width:0;width:auto;flex-shrink:0;">ðŸ“‹</button>`:''}
      </div>
    </div>`;
  }).join('');

  app.innerHTML=`<div class="container" style="padding-bottom:80px;">
    <div class="ark-header">
      <button class="back" data-action="renderAdventureEntry">â—„ BACK</button>
      <div class="ark-title">ðŸ“– <span>Almanac</span></div>
    </div>
    <div style="background:var(--bg-card2);border:1px solid rgba(156,85,208,0.3);padding:10px 14px;margin-bottom:10px;text-align:center;">
      <div style="font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;color:#c080ff;">ENEMY CODEX</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:3px;">${seen} / ${total} encountered</div>
      <div style="background:rgba(0,0,0,0.3);border-radius:2px;height:6px;margin-top:6px;overflow:hidden;"><div style="height:100%;background:linear-gradient(90deg,#9c55d0,#c080ff);width:${Math.round(seen/total*100)}%;transition:width 0.5s;"></div></div>
    </div>
    <div class="ark-section">ðŸ‘¹ NORMAL ENEMIES</div>
    ${allEnemies.filter(e=>e.type==='normal').map(e=>{
      let isSeen=advData.seenEnemies.includes(e.id);
      let elemAtkHtml=Object.entries(e.elementAtk||{}).filter(([,v])=>v>0).map(([el,v])=>`<span style="color:${ELEMENT_COLORS[el]};font-size:8px;">${ELEMENT_ICONS[el]}${v}%</span>`).join(' ');
      return `<div style="background:var(--bg-card2);border:1px solid ${isSeen?'rgba(255,255,255,0.1)':'rgba(255,255,255,0.04)'};padding:10px 12px;margin:4px 0;opacity:${isSeen?1:0.35};">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="filter:${isSeen?'none':'grayscale(1) brightness(0.3)'};">${renderArt(e.art,28,'width:36px;')}</div>
          <div style="flex:1;">
            <div style="font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:${isSeen?'var(--text-bright)':'var(--text-dim)'};">${isSeen?e.name:'???'} ${isSeen&&e.jp?`<span style="font-size:11px;font-weight:400;color:var(--text-dim);">${e.jp}</span>`:''}</div>
            ${isSeen?`<div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);">Tier ${e.tier||'?'} Â· XP ${e.xp} Â· ðŸ’°${e.gold}${elemAtkHtml?' Â· '+elemAtkHtml:''}</div>`:'<div style="font-family:\'Share Tech Mono\',monospace;font-size:9px;color:var(--text-dim);">Not yet encountered</div>'}
          </div>
          ${isSeen?`<button data-action="advEnemyDetail:${e.id}" style="padding:3px 9px;font-size:10px;font-family:'Share Tech Mono',monospace;border:1px solid rgba(255,255,255,0.15);background:rgba(0,0,0,0.4);color:var(--text-dim);min-width:0;width:auto;flex-shrink:0;">ðŸ“‹</button>`:''}
        </div>
      </div>`;
    }).join('')}
    <div class="ark-section">âš¡ MINI BOSSES</div>
    ${allEnemies.filter(e=>e.type==='miniboss').map(e=>{
      let isSeen=advData.seenEnemies.includes(e.id);
      let fstyle=ENEMY_FIGHT_STYLES[e.id];
      return `<div style="background:var(--bg-card2);border:1px solid ${isSeen?'rgba(156,85,208,0.35)':'rgba(255,255,255,0.04)'};padding:10px 12px;margin:4px 0;opacity:${isSeen?1:0.35};">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="filter:${isSeen?'none':'grayscale(1) brightness(0.3)'};">${renderArt(e.art,36,'width:40px;')}</div>
          <div style="flex:1;">
            <div style="font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:${isSeen?'#d090ff':'var(--text-dim)'};">${isSeen?e.name:'???'} ${isSeen&&e.jp?`<span style="font-size:11px;font-weight:400;color:var(--text-dim);">${e.jp}</span>`:''}</div>
            ${isSeen?`<div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);">XP ${e.xp} Â· ðŸ’°${e.gold}${fstyle?' Â· â˜… '+fstyle.specialName:''}</div>`:'<div style="font-family:\'Share Tech Mono\',monospace;font-size:9px;color:var(--text-dim);">Not yet encountered</div>'}
          </div>
          ${isSeen?`<button data-action="advEnemyDetail:${e.id}" style="padding:3px 9px;font-size:10px;font-family:'Share Tech Mono',monospace;border:1px solid rgba(156,85,208,0.4);background:rgba(0,0,0,0.4);color:#c080ff;min-width:0;width:auto;flex-shrink:0;">ðŸ“‹</button>`:''}
        </div>
      </div>`;
    }).join('')}
    <div class="ark-section">ðŸ‘‘ FINAL BOSS</div>
    ${allEnemies.filter(e=>e.type==='boss').map(e=>{
      let isSeen=advData.seenEnemies.includes(e.id);
      return `<div style="background:var(--bg-card2);border:1px solid ${isSeen?'rgba(255,68,68,0.4)':'rgba(255,255,255,0.04)'};padding:10px 12px;margin:4px 0;opacity:${isSeen?1:0.35};">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="filter:${isSeen?'none':'grayscale(1) brightness(0.3)'};">${renderArt(e.art,36,'width:40px;')}</div>
          <div style="flex:1;">
            <div style="font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:${isSeen?'#ff6060':'var(--text-dim)'};">${isSeen?e.name:'???'} ${isSeen&&e.jp?`<span style="font-size:11px;font-weight:400;color:var(--text-dim);">${e.jp}</span>`:''}</div>
            ${isSeen?`<div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);">XP ${e.xp} Â· ðŸ’°${e.gold} Â· ${e.special||''}</div>`:'<div style="font-family:\'Share Tech Mono\',monospace;font-size:9px;color:var(--text-dim);">Not yet encountered</div>'}
          </div>
          ${isSeen?`<button data-action="advEnemyDetail:${e.id}" style="padding:3px 9px;font-size:10px;font-family:'Share Tech Mono',monospace;border:1px solid rgba(255,68,68,0.4);background:rgba(0,0,0,0.4);color:#ff8080;min-width:0;width:auto;flex-shrink:0;">ðŸ“‹</button>`:''}
        </div>
      </div>`;
    }).join('')}
  </div>`;
}

/* â”€â”€ ENEMY DETAIL SCREEN â”€â”€ */
function advEnemyDetail(enemyId){
  let allEnemies=buildEnemyPool([]);
  let e=allEnemies.find(en=>en.id===enemyId);
  if(!e)return;
  let fstyle=ENEMY_FIGHT_STYLES[e.id];
  let typeColors={normal:'var(--text-dim)',miniboss:'#c080ff',boss:'#ff4444'};
  let typeColor=typeColors[e.type]||'var(--text-dim)';

  let elemAtkHtml=Object.entries(e.elementAtk||{}).filter(([,v])=>v>0).map(([el,v])=>
    `<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.04);">
      <span style="color:${ELEMENT_COLORS[el]};font-size:11px;">${ELEMENT_ICONS[el]} ${el.toUpperCase()} ATK</span>
      <span style="font-family:'Share Tech Mono',monospace;font-size:10px;color:${ELEMENT_COLORS[el]};">${v}% proc</span>
    </div>`).join('');
  let elemResHtml=Object.entries(e.elementRes||{}).filter(([,v])=>v>0).map(([el,v])=>
    `<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.04);">
      <span style="color:var(--text-dim);font-size:11px;">${ELEMENT_ICONS[el]} ${el.toUpperCase()} RES</span>
      <span style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--blue);">${v}% reduce</span>
    </div>`).join('');

  let backAction=advData.seenEnemies?'advAlmanac':'renderAdventureEntry';

  app.innerHTML=`<div class="container" style="padding-bottom:80px;">
    <div class="ark-header">
      <button class="back" data-action="advAlmanac">â—„ BACK</button>
      <div class="ark-title">ðŸ“‹ <span>Enemy Info</span></div>
    </div>
    <!-- Enemy card -->
    <div style="background:var(--bg-card2);border:1px solid ${typeColor}40;padding:16px;margin-bottom:10px;text-align:center;">
      <div style="display:flex;justify-content:center;margin-bottom:6px;">${renderArt(e.art,72)}</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:24px;font-weight:700;color:var(--text-bright);letter-spacing:3px;">${e.name}</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:${typeColor};letter-spacing:2px;margin-top:2px;">${(e.type||'normal').toUpperCase()}${e.jp?' Â· '+e.jp:''}</div>
      ${e.special?`<div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:#f0c060;margin-top:6px;padding:4px 8px;background:rgba(240,192,96,0.1);border:1px solid rgba(240,192,96,0.2);">â˜… ${e.special}</div>`:''}
    </div>
    <!-- Stats -->
    <div class="ark-section">ðŸ“Š BASE STATS</div>
    <div style="background:var(--bg-card2);border:1px solid var(--border);padding:10px 14px;margin-bottom:8px;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
        <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="font-size:12px;">â¤ï¸ HP</span><span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--red);">${e.hp}</span></div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="font-size:12px;">âš”ï¸ ATK</span><span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--accent);">${e.atk}</span></div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="font-size:12px;">ðŸ›¡ï¸ DEF</span><span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--blue);">${e.def}</span></div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="font-size:12px;">ðŸ’¨ SPD</span><span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--green);">${e.spd}</span></div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="font-size:12px;">âœ¨ XP</span><span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:#c080ff;">${e.xp}</span></div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="font-size:12px;">ðŸ’° Gold</span><span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:#f0c060;">${e.gold}</span></div>
        ${(e.dodge||0)>0?`<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="font-size:12px;">ðŸ’¨ Dodge</span><span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:#60d0ff;">${e.dodge}%</span></div>`:''}
        ${(e.dmgReduce||0)>0?`<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="font-size:12px;">ðŸ›¡ DMG RDC</span><span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:#aaa;">${Math.round(e.dmgReduce*100)}%</span></div>`:''}
      </div>
    </div>
    <!-- Elements -->
    ${elemAtkHtml||elemResHtml?`<div class="ark-section">ðŸŒŸ ELEMENT DATA</div>
    <div style="background:var(--bg-card2);border:1px solid var(--border);padding:10px 14px;margin-bottom:8px;">
      ${elemAtkHtml||'<div style="font-family:\'Share Tech Mono\',monospace;font-size:10px;color:var(--text-dim);">No elemental attacks</div>'}
      <div style="margin-top:6px;">${elemResHtml||'<div style="font-family:\'Share Tech Mono\',monospace;font-size:10px;color:var(--text-dim);">No resistances</div>'}</div>
    </div>`:''}
    <!-- Special move / fight style -->
    ${fstyle?`<div class="ark-section">âš¡ SPECIAL ABILITY</div>
    <div style="background:rgba(0,0,0,0.3);border:1px solid ${typeColor}40;padding:12px 14px;margin-bottom:8px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
        <span style="font-size:20px;">${fstyle.specialIcon}</span>
        <span style="font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:${typeColor};">${fstyle.specialName}</span>
        <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-left:auto;">charges in ${fstyle.chargeMax} turns</span>
      </div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-bottom:4px;">${fstyle.specialDesc}</div>
      ${fstyle.flavor?`<div style="font-family:'Rajdhani',sans-serif;font-size:12px;color:${typeColor};font-style:italic;margin-top:4px;opacity:0.7;">"${fstyle.flavor}"</div>`:''}
    </div>`:''}
    <!-- Weaknesses hint -->
    <div class="ark-section">ðŸ’¡ STRATEGY</div>
    <div style="background:var(--bg-card2);border:1px solid var(--border);padding:10px 14px;">
      ${Object.entries(e.elementRes||{}).filter(([,v])=>v===0).map(([el])=>`<div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:${ELEMENT_COLORS[el]};margin:2px 0;">${ELEMENT_ICONS[el]} No ${el} resistance â€” exploit it!</div>`).join('')||'<div style="font-family:\'Share Tech Mono\',monospace;font-size:10px;color:var(--text-dim);">No obvious elemental weakness.</div>'}
      ${fstyle?`<div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:#f0c060;margin-top:6px;">âš  Defend before turn ${fstyle.chargeMax} to block special!</div>`:''}
    </div>
  </div>`;
}

/* â”€â”€ CUSTOMIZE MENU â”€â”€ */
function advOpenCustomizeMenu(tab){
  tab=tab||"stats";
  let charId=advData.activeChar||"hiro";
  if(!advData.statUpgrades)advData.statUpgrades={hiro:{hp:0,atk:0,def:0,skillDmg:0},roku:{hp:0,atk:0,def:0,skillDmg:0},kisaragi:{hp:0,atk:0,def:0,skillDmg:0}};
  if(!advData.upgradePoints)advData.upgradePoints={hiro:0,roku:0,kisaragi:0};
  if(!advData.ownedWeapons)advData.ownedWeapons=[];
  if(!advData.ownedArmors)advData.ownedArmors=[];

  let gold=advData.totalGold;
  let tabs=`<div style="display:flex;gap:6px;margin-bottom:12px;">
    <button class="shop-tab${tab==='stats'?' active-tab':''}" onclick="advOpenCustomizeMenu('stats')" style="flex:1;">ðŸ“Š STATS</button>
    <button class="shop-tab${tab==='weapons'?' active-tab':''}" onclick="advOpenCustomizeMenu('weapons')" style="flex:1;">âš”ï¸ WEAPONS</button>
  </div>`;

  let content="";

  if(tab==="stats"){
    let cs=advData.charStats[charId]||{level:1};
    let upgrades=advData.statUpgrades[charId]||{hp:0,atk:0,def:0,skillDmg:0};
    let pts=advData.upgradePoints[charId]||0;
    let effStats=getCharEffectiveStats(charId);
    content=`
    <div style="background:var(--bg-card);border:1px solid var(--border);padding:12px;margin-bottom:10px;">
      <div style="font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;color:var(--text-bright);">${ADV_CHARS[charId].name} â€” LV.${cs.level}</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--accent);margin-top:4px;">Available Upgrade Points: <b style="font-size:16px;color:#f0c060;">${pts}</b></div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-top:2px;">Earn points by leveling up in Adventure Mode</div>
    </div>
    <div class="ark-section">ðŸ“ˆ STAT UPGRADES</div>
    ${[
      {key:"hp",label:"Max HP",icon:"â¤ï¸",desc:"+10 HP per point",cur:upgrades.hp||0,curVal:`${effStats.maxHp} HP`},
      {key:"atk",label:"Attack",icon:"âš”ï¸",desc:"+2 ATK per point",cur:upgrades.atk||0,curVal:`${effStats.atk} ATK`},
      {key:"def",label:"Defense",icon:"ðŸ›¡ï¸",desc:"+2 DEF per point",cur:upgrades.def||0,curVal:`${effStats.def} DEF`},
      {key:"skillDmg",label:"Skill Damage",icon:"âœ¨",desc:"+10% skill multiplier",cur:upgrades.skillDmg||0,curVal:`+${((upgrades.skillDmg||0)*10)}% skill dmg`},
    ].map(stat=>{
      let cost=STAT_UPGRADE_COSTS[stat.key]||1;
      let canUpgrade=pts>=cost&&stat.cur<20;
      return `<div style="background:var(--bg-card);border:1px solid var(--border);padding:12px;margin:6px 0;display:flex;align-items:center;gap:12px;">
        <div style="font-size:22px;">${stat.icon}</div>
        <div style="flex:1;">
          <div style="font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:var(--text-bright);">${stat.label} <span style="color:var(--text-dim);font-size:11px;">${stat.cur}/20</span></div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);">${stat.desc}</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);">Current: ${stat.curVal}</div>
        </div>
        <div style="text-align:right;">
          <button ${canUpgrade?`data-action="advStatUpgrade:${stat.key}"`:''} style="width:auto;padding:6px 12px;font-size:11px;${canUpgrade?'border-color:var(--accent);color:var(--accent);':'opacity:0.4;'}">+1 (${cost}pt)</button>
        </div>
      </div>`;
    }).join("")}`;

  } else if(tab==="weapons"){
    // Weapons & Armors for active character
    let charWeapons=Object.values(ADV_WEAPONS).filter(w=>w.char===charId);
    let charArmors=Object.values(ADV_ARMORS).filter(a=>a.char===charId);
    let equip=advData.equip[charId]||{};
    let ownedWpns=advData.ownedWeapons||[];
    let ownedArms=advData.ownedArmors||[];
    // Upgrade levels (stored per gear id)
    if(!advData.gearUpgrades)advData.gearUpgrades={};
    let gu=advData.gearUpgrades;

    function renderGearUpgradeBtn(gearId,type){
      let lvl=gu[gearId]||0;let maxLvl=5;
      let statsBtn='';
      if(lvl>=maxLvl){
        statsBtn=`<span style="color:var(--accent);font-size:8px;font-family:'Share Tech Mono',monospace;">â˜… STAT MAX</span>`;
      } else {
        let cost=Math.round(100*(lvl+1)*1.6);
        let canAfford=gold>=cost;
        let stat=type==="weapon"?`+${(lvl+1)*2} ATK`:`+${(lvl+1)*2} DEF`;
        statsBtn=`<button ${canAfford?`data-action="advUpgradeGear:${gearId}"`:''} style="width:auto;padding:4px 8px;font-size:9px;${canAfford?'border-color:#44aaff;color:#44aaff;':'opacity:0.4;'}${!canAfford?'cursor:not-allowed;':''}">â¬† ${stat}<br><span style="font-size:8px;">ðŸ’°${cost}</span>${lvl>0?` <span style="font-size:7px;color:#44aaff;">LV${lvl}</span>`:''}</button>`;
      }
      // Passive skill button
      let passiveKey=getGearPassiveKey(gearId);
      let passive=passiveKey?GEAR_PASSIVES[passiveKey]:null;
      let passiveBtn='';
      if(passive){
        let pLvl=advData.gearPassives?advData.gearPassives[gearId]||0:0;
        if(pLvl>=3){
          passiveBtn=`<span style="color:#c080ff;font-size:8px;font-family:'Share Tech Mono',monospace;">${passive.icon} PASS MAX</span>`;
        } else {
          let pCost=passive.cost[pLvl];
          let canAffordP=gold>=pCost;
          passiveBtn=`<button ${canAffordP?`data-action="advUpgradeGearPassive:${gearId}"`:''} style="width:auto;padding:4px 8px;font-size:9px;${canAffordP?'border-color:#c080ff;color:#c080ff;':'opacity:0.4;'}${!canAffordP?'cursor:not-allowed;':''}">âœ¨ PASSIVE<br><span style="font-size:8px;">ðŸ’°${pCost} (${pLvl}/3)</span></button>`;
        }
      }
      return `<div style="display:flex;flex-direction:column;gap:3px;min-width:80px;align-items:flex-end;">${statsBtn}${passiveBtn}</div>`;
    }

    content=`<div class="ark-section">âš”ï¸ WEAPONS â€” ${ADV_CHARS[charId].name}</div>`;
    content+=charWeapons.map((w,i)=>{
      let owned=ownedWpns.includes(w.id)||(i===0&&w.price===0);
      let equipped=equip.weapon===w.id;
      let canBuy=!owned&&gold>=w.price;
      let lvl=gu[w.id]||0;
      let atkBonus=lvl>0?` <span style="color:#44aaff;">+${lvl*2}âœ¦</span>`:'';
      let passiveKey=getGearPassiveKey(w.id);
      let passive=passiveKey?GEAR_PASSIVES[passiveKey]:null;
      let pLvl=(advData.gearPassives&&advData.gearPassives[w.id])||0;
      let passiveDesc=passive&&pLvl>0?`<div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#c080ff;margin-top:2px;">${passive.icon} ${passive.name} LV${pLvl}: ${passive.desc[pLvl-1]}</div>`:'';
      return `<div class="adv-shop-item" style="${equipped?'border-color:var(--accent);':''}${!owned&&!canBuy?'opacity:0.5;':''}">
        <div style="font-size:22px;min-width:30px;">${w.icon}</div>
        <div style="flex:1;">
          <div style="font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:var(--text-bright);">${w.name}${atkBonus}</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);">ATK+${w.atk+(lvl*2)} | CRIT+${w.crit}% | ${w.playstyle}</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#c080ff;">${w.skillName}: ${w.skillDesc} (${w.skillCost}SP)</div>
          ${passive?`<div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:${pLvl>0?'#c080ff':'var(--text-dim)'};margin-top:2px;">âœ¨ ${passive.name} ${pLvl>0?`LV${pLvl}/3`:'(0/3)'}</div>`:''}
          ${passiveDesc}
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
          ${equipped?`<span style="color:var(--accent);font-size:9px;font-family:'Share Tech Mono',monospace;">EQUIPPED</span>`:
            owned?`<button data-action="advEquipWeapon:${w.id}" style="width:auto;padding:5px 10px;font-size:10px;border-color:var(--green);color:var(--green);">EQUIP</button>`:
            canBuy?`<button data-action="advBuyWeapon:${w.id}" style="width:auto;padding:5px 10px;font-size:10px;border-color:#f0c060;color:#f0c060;">ðŸ’°${w.price}</button>`:
            `<span style="color:var(--text-dim);font-size:9px;font-family:'Share Tech Mono',monospace;">ðŸ’°${w.price}</span>`}
          ${owned?renderGearUpgradeBtn(w.id,"weapon"):''}
        </div>
      </div>`;
    }).join("");

    content+=`<div class="ark-section" style="margin-top:12px;">ðŸ›¡ï¸ ARMORS â€” ${ADV_CHARS[charId].name}</div>`;
    content+=charArmors.map((a,i)=>{
      let owned=ownedArms.includes(a.id)||(i===0&&a.price===0);
      let equipped=equip.armor===a.id;
      let canBuy=!owned&&gold>=a.price;
      let lvl=gu[a.id]||0;
      let defBonus=lvl>0?` <span style="color:#44aaff;">+${lvl*2}âœ¦</span>`:'';
      let passiveKey=getGearPassiveKey(a.id);
      let passive=passiveKey?GEAR_PASSIVES[passiveKey]:null;
      let pLvl=(advData.gearPassives&&advData.gearPassives[a.id])||0;
      let passiveDesc=passive&&pLvl>0?`<div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#c080ff;margin-top:2px;">${passive.icon} ${passive.name} LV${pLvl}: ${passive.desc[pLvl-1]}</div>`:'';
      return `<div class="adv-shop-item" style="${equipped?'border-color:var(--blue);':''}${!owned&&!canBuy?'opacity:0.5;':''}">
        <div style="font-size:22px;min-width:30px;">${a.icon}</div>
        <div style="flex:1;">
          <div style="font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:var(--text-bright);">${a.name}${defBonus}</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);">DEF+${a.def+(lvl*2)} | HP+${a.hp} | DODGE+${a.dodge}%</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--blue);">Bonus: ${a.bonusDesc}</div>
          ${passive?`<div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:${pLvl>0?'#c080ff':'var(--text-dim)'};margin-top:2px;">âœ¨ ${passive.name} ${pLvl>0?`LV${pLvl}/3`:'(0/3)'}</div>`:''}
          ${passiveDesc}
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
          ${equipped?`<span style="color:var(--blue);font-size:9px;font-family:'Share Tech Mono',monospace;">EQUIPPED</span>`:
            owned?`<button data-action="advEquipArmor:${a.id}" style="width:auto;padding:5px 10px;font-size:10px;border-color:var(--blue);color:var(--blue);">EQUIP</button>`:
            canBuy?`<button data-action="advBuyArmor:${a.id}" style="width:auto;padding:5px 10px;font-size:10px;border-color:#f0c060;color:#f0c060;">ðŸ’°${a.price}</button>`:
            `<span style="color:var(--text-dim);font-size:9px;font-family:'Share Tech Mono',monospace;">ðŸ’°${a.price}</span>`}
          ${owned?renderGearUpgradeBtn(a.id,"armor"):''}
        </div>
      </div>`;
    }).join("");
  }

  app.innerHTML=`<div class="container">
    <div class="ark-header">
      <button class="back" data-action="renderAdventureEntry">â—„ BACK</button>
      <div class="ark-title">ðŸŽ›ï¸ <span>Customize</span></div>
      <div class="adv-gold-display" style="margin-left:auto;font-size:12px;">ðŸ’°${gold}</div>
    </div>
    <div style="background:var(--bg-card);border:1px solid var(--border);padding:8px 12px;margin-bottom:8px;font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);">
      Active: <b style="color:var(--accent);">${ADV_CHARS[charId].name}</b> Â· Level ${advData.charStats[charId]&&advData.charStats[charId].level||1}
    </div>
    ${tabs}
    ${content}
  </div>`;
}

function advStatUpgrade(key){
  let charId=advData.activeChar||"hiro";
  if(!advData.statUpgrades)advData.statUpgrades={hiro:{hp:0,atk:0,def:0,skillDmg:0},roku:{hp:0,atk:0,def:0,skillDmg:0},kisaragi:{hp:0,atk:0,def:0,skillDmg:0}};
  if(!advData.upgradePoints)advData.upgradePoints={hiro:0,roku:0,kisaragi:0};
  let cost=STAT_UPGRADE_COSTS[key]||1;
  let pts=advData.upgradePoints[charId]||0;
  if(pts<cost){showShopToast("âš  Not enough upgrade points!","#cc4444");return;}
  let cur=advData.statUpgrades[charId][key]||0;
  if(cur>=20){showShopToast("âš  Stat already at max (20)!","#cc4444");return;}
  advData.upgradePoints[charId]-=cost;
  advData.statUpgrades[charId][key]=(cur+1);
  saveAll();
  showShopToast(`âœ“ ${key.toUpperCase()} upgraded to +${cur+1}!`,"var(--green)");
  advOpenCustomizeMenu("stats");
}

function advBuyWeapon(id){
  let w=ADV_WEAPONS[id];
  if(!w)return;
  if(w.price>0&&advData.totalGold<w.price){showShopToast("âš  NOT ENOUGH GOLD","#cc4444");return;}
  if(w.price>0)advData.totalGold-=w.price;
  if(!advData.ownedWeapons)advData.ownedWeapons=[];
  if(!advData.ownedWeapons.includes(id))advData.ownedWeapons.push(id);
  advData.equip[w.char].weapon=id;
  saveAll();showShopToast(`${w.icon} ${w.name} bought & equipped!`,"var(--green)");
  advOpenCustomizeMenu("weapons");
}

function advEquipWeapon(id){
  let w=ADV_WEAPONS[id];
  if(!w)return;
  advData.equip[w.char].weapon=id;
  saveAll();showShopToast(`${w.icon} ${w.name} equipped!`,"var(--accent)");
  advOpenCustomizeMenu("weapons");
}

function advBuyArmor(id){
  let a=ADV_ARMORS[id];
  if(!a)return;
  if(a.price>0&&advData.totalGold<a.price){showShopToast("âš  NOT ENOUGH GOLD","#cc4444");return;}
  if(a.price>0)advData.totalGold-=a.price;
  if(!advData.ownedArmors)advData.ownedArmors=[];
  if(!advData.ownedArmors.includes(id))advData.ownedArmors.push(id);
  advData.equip[a.char].armor=id;
  saveAll();showShopToast(`${a.icon} ${a.name} bought & equipped!`,"var(--green)");
  advOpenCustomizeMenu("weapons");
}

function advEquipArmor(id){
  let a=ADV_ARMORS[id];
  if(!a)return;
  advData.equip[a.char].armor=id;
  saveAll();showShopToast(`${a.icon} ${a.name} equipped!`,"var(--blue)");
  advOpenCustomizeMenu("weapons");
}

/* â”€â”€ GEAR UPGRADE (spend gold to +ATK or +DEF per level) â”€â”€ */
function advUpgradeGear(id){
  if(!advData.gearUpgrades)advData.gearUpgrades={};
  let lvl=advData.gearUpgrades[id]||0;
  let maxLvl=5;
  if(lvl>=maxLvl){showShopToast("âš  Already MAX level!","#cc4444");return;}
  let cost=Math.round(100*(lvl+1)*1.6);
  if(advData.totalGold<cost){showShopToast(`âš  Need ðŸ’°${cost}!`,"#cc4444");return;}
  advData.totalGold-=cost;
  advData.gearUpgrades[id]=(lvl+1);
  let isWeapon=!!ADV_WEAPONS[id];
  let statStr=isWeapon?`+${(lvl+1)*2} ATK`:` +${(lvl+1)*2} DEF`;
  saveAll();showShopToast(`â¬† Upgraded! ${statStr} (LVL ${lvl+1})`, "var(--accent)");
  advOpenCustomizeMenu("weapons");
}

/* â”€â”€ GEAR PASSIVE UPGRADE (up to 3 levels, balanced effects) â”€â”€ */
function advUpgradeGearPassive(id){
  if(!advData.gearPassives)advData.gearPassives={};
  let passiveKey=getGearPassiveKey(id);
  if(!passiveKey){showShopToast("âš  No passive for this gear","#cc4444");return;}
  let passive=GEAR_PASSIVES[passiveKey];
  if(!passive){showShopToast("âš  Passive not found","#cc4444");return;}
  let lvl=advData.gearPassives[id]||0;
  if(lvl>=3){showShopToast("âš  Passive already MAX (3)!","#cc4444");return;}
  let cost=passive.cost[lvl]||300;
  if(advData.totalGold<cost){showShopToast(`âš  Need ðŸ’°${cost}!`,"#cc4444");return;}
  advData.totalGold-=cost;
  advData.gearPassives[id]=(lvl+1);
  saveAll();showShopToast(`${passive.icon} Passive LV${lvl+1}: ${passive.desc[lvl]}!`,"#c080ff");
  advOpenCustomizeMenu("weapons");
}

function advStoreBuy(id){
  let item=ADV_CONSUMABLES.find(i=>i.id===id);
  if(!item)return;
  if(advData.totalGold<item.price){showShopToast("âš  NOT ENOUGH GOLD","#cc4444");return;}
  if(!adv.inventory)adv.inventory=[];
  if(item.maxStack){let count=adv.inventory.filter(x=>x===id).length;if(count>=item.maxStack){showShopToast(`âš  Max ${item.maxStack} in bag!`,"#cc4444");return;}}
  advData.totalGold-=item.price;
  adv.inventory.push(item.id);
  saveAll();showShopToast(`${item.icon} ${item.name} added to inventory!`,"var(--green)");
  advOpenCustomizeMenu("stats");
}

/* â”€â”€ SELECT / BUY CHARACTER â”€â”€ */
function advPickProfile(name){
  if(!profiles[name])return;
  currentProfile=name;words=[...(profiles[name].words||[])];saveAll();renderAdventureEntry();
}

/* â”€â”€ CHANGE PROFILE SCREEN â”€â”€ */
function advChangeProfile(){
  let names=Object.keys(profiles||{});
  if(!names.length){showShopToast("No profiles found. Create one first!","#cc4444");return;}
  let html=names.map(name=>{
    let p=profiles[name];let wc=(p.words||[]).length;let active=name===currentProfile;
    return `<button data-action="advPickProfile:${name}" style="${active?'border-color:var(--accent);color:var(--accent);':'border-color:rgba(156,85,208,0.3);color:#d0a0ff;'}">
      <span style="font-size:18px;">ðŸ‘¤</span>
      <div style="flex:1;">
        <div style="font-family:'Rajdhani',sans-serif;font-size:17px;font-weight:700;">${name}</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);">${wc} words${active?' Â· ACTIVE':''}</div>
      </div>
      ${active?'<span style="color:var(--accent);font-size:10px;">âœ“</span>':'<span style="color:var(--text-dim);font-size:10px;">SELECT â–º</span>'}
    </button>`;
  }).join('');
  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="renderAdventureEntry">â—„ BACK</button><div class="ark-title">ðŸ”„ <span>Change Profile</span></div></div>
    <div class="adv-story-box" style="border-left-color:var(--blue);font-size:11px;color:var(--text-dim);">Select vocabulary profile. Gold, gear, and character progress are saved separately.</div>
    <div class="ark-section">ðŸ‘¤ PROFILES</div>${html}
  </div>`;
}

/* â”€â”€ NEW GAME+ â€” resets quest progress, keeps all upgrades, scales enemies â”€â”€ */
function advNewGame(){
  adv.active=false;
  if(!advData.ngPlus)advData.ngPlus=0;
  advData.ngPlus++;
  advData.savedStageIndex=0; // fresh start for NG+
  // Restore all characters to full HP
  Object.keys(advData.charStats||{}).forEach(cid=>{
    let es=getCharEffectiveStats(cid);
    advData.charStats[cid].hp=es.maxHp;
  });
  saveAll();
  let ng=advData.ngPlus;
  let popup=document.createElement('div');
  popup.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:20001;text-align:center;pointer-events:none;animation:levelupPop 0.5s ease;';
  popup.innerHTML=`<div style="background:#0a0c10;border:2px solid var(--accent);padding:24px 40px;clip-path:polygon(14px 0,100% 0,100% calc(100% - 14px),calc(100% - 14px) 100%,0 100%,0 14px);">
    <div style="font-size:48px;">ðŸ”</div>
    <div style="font-family:'Rajdhani',sans-serif;font-size:24px;font-weight:700;color:var(--accent);letter-spacing:3px;">NEW GAME+${ng}</div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:6px;">All gear & stats kept Â· Enemies +${ng*15}% stronger</div>
  </div>`;
  document.body.appendChild(popup);
  setTimeout(()=>{popup.remove();renderAdventureEntry();},2200);
}

/* â”€â”€ COMBO SPECIAL EFFECTS (Picayune theme) â”€â”€ */
function advTriggerComboSpecial(combo){
  if(!adv.active||!adv.enemy)return;
  let popEffect=(emoji,color)=>{
    let el=document.createElement('div');
    el.style.cssText='position:fixed;top:35%;left:50%;transform:translate(-50%,-50%);font-size:80px;pointer-events:none;z-index:20001;animation:levelupPop 0.6s ease forwards;';
    el.textContent=emoji;document.body.appendChild(el);setTimeout(()=>el.remove(),600);
  };
  if(combo===3){
    // Blackhole â€” pulls 10% enemy HP
    let bh=Math.max(3,Math.round(adv.enemyMaxHp*0.10));
    adv.enemyHp=Math.max(1,adv.enemyHp-bh);
    advAddLog(`ðŸŒ‘ COMBO Ã—3 â€” BLACKHOLE SURGE! ${bh} void dmg!`);
    showDmgPop(`ðŸŒ‘${bh}`,  "#8844ff",52,26);
    popEffect('ðŸŒ‘','#8844ff');
  } else if(combo===5){
    // Random wild effect
    let rng=Math.floor(Math.random()*5);
    if(rng===0){let h=Math.round(adv.maxHp*0.12);adv.hp=Math.min(adv.maxHp,adv.hp+h);advAddLog(`ðŸ’– COMBO Ã—5 â€” LUCKY HEAL! +${h}HP`);showDmgPop(`+${h}â¤ï¸`,"#44ff88",44,26);}
    else if(rng===1){adv.sp=Math.min(adv.maxSp,adv.sp+2);advAddLog(`âš¡ COMBO Ã—5 â€” SURGE! +2 SP`);showDmgPop("+2SP","#c080ff",44,26);}
    else if(rng===2){let dot=Math.round(adv.enemy.atk*0.22);adv.enemyStatus.push({type:"poison",turns:3,dot});advAddLog(`â˜ ï¸ COMBO Ã—5 â€” VENOM! ${dot}/t`);showDmgPop("VENOM","#44ff88",44,26);}
    else if(rng===3){adv.statusEffects.push({type:"fortified",turns:2});advAddLog(`ðŸ›¡ï¸ COMBO Ã—5 â€” IRON WALL! DEF+8 2t`);showDmgPop("ðŸ›¡ï¸IRON","var(--blue)",44,26);}
    else{adv.statusEffects.push({type:"evading",turns:1});advAddLog(`ðŸ‘» COMBO Ã—5 â€” PHANTOM! Evade 1t`);showDmgPop("ðŸ‘»EVADE","#8844ff",44,26);}
    popEffect('âœ¨','#f0c060');
  } else if(combo>=7&&combo%2===1){
    // Dragon Pulse â€” every odd combo â‰¥7
    let dp=Math.max(5,Math.round(adv.enemy.atk*0.45));
    adv.enemyHp=Math.max(0,adv.enemyHp-dp);
    adv.sp=Math.min(adv.maxSp,adv.sp+1);
    advAddLog(`ðŸ‰ COMBO Ã—${combo} â€” DRAGON PULSE! ${dp} void dmg +1SP!`);
    showDmgPop(`ðŸ‰Ã—${combo}!`,"#ff4488",52,22);
    popEffect('ðŸ‰','#ff4488');
  }
}
function advSelectChar(id){
  if(!ADV_CHARS[id])return;advData.activeChar=id;saveAll();renderAdventureEntry();
}
function advBuyChar(id){
  let c=ADV_CHARS[id];if(!c||c.free)return;
  if(shopData.coins<c.price){showShopToast("âš  NOT ENOUGH COINS","#cc4444");return;}
  shopData.coins-=c.price;if(!advData.ownedChars.includes(id))advData.ownedChars.push(id);
  advData.activeChar=id;
  // Auto-equip first weapon and armor for newly bought character
  let firstWpn=Object.values(ADV_WEAPONS).find(w=>w.char===id);
  let firstArm=Object.values(ADV_ARMORS).find(a=>a.char===id);
  if(!advData.equip[id])advData.equip[id]={weapon:null,armor:null};
  if(firstWpn&&!advData.equip[id].weapon)advData.equip[id].weapon=firstWpn.id;
  if(firstArm&&!advData.equip[id].armor)advData.equip[id].armor=firstArm.id;
  saveAll();showShopToast(`âœ“ ${c.name} UNLOCKED!`,"var(--green)");renderAdventureEntry();
}

/* â”€â”€ START RUN â”€â”€ */
function advStartRun(){
  if(!currentProfile||!profiles[currentProfile])return renderAdventureEntry();
  let charId=advData.activeChar||"hiro";
  if(!ADV_CHARS[charId])charId="hiro";
  let charDef=ADV_CHARS[charId];
  let profile=profiles[currentProfile];
  let allWords=(profile.words||[]).filter(w=>w&&w.kanji);
  if(allWords.length<100){
    app.innerHTML=`<div class="container">
      <div class="ark-header"><button class="back" data-action="renderAdventureEntry">â—„ BACK</button><div class="ark-title" style="color:var(--red);">âš  <span>NOT ENOUGH WORDS</span></div></div>
      <div class="adv-story-box" style="border-left-color:var(--red);color:var(--text-dim);">
        <span style="font-family:\'Rajdhani\',sans-serif;font-size:16px;font-weight:700;color:#ff8080;">Adventure mode requires at least 100 words.</span><br><br>
        Profile <span style="color:var(--accent);">"${currentProfile}"</span> has <span style="color:#ff8080;font-weight:700;">${allWords.length} words</span>. Need ${Math.max(0,100-allWords.length)} more.
      </div>
      <div class="ark-stat-row">
        <div class="ark-stat"><div class="ark-stat-label">CURRENT</div><div class="ark-stat-value" style="color:#ff6060;">${allWords.length}</div></div>
        <div class="ark-stat"><div class="ark-stat-label">REQUIRED</div><div class="ark-stat-value" style="color:var(--accent);">100</div></div>
        <div class="ark-stat"><div class="ark-stat-label">NEED</div><div class="ark-stat-value" style="color:#f0c060;">${Math.max(0,100-allWords.length)}</div></div>
      </div>
      <button data-action="renderProfile" style="color:var(--accent);border-color:var(--accent-dim);justify-content:center;margin-top:10px;">â–¶ Manage Profiles</button>
      <button data-action="renderAdventureEntry" style="justify-content:center;color:var(--text-dim);margin-top:4px;">â—„ Back</button>
    </div>`;
    return;
  }

  // Auto-equip first weapon/armor if player has none set
  if(!advData.equip[charId])advData.equip[charId]={weapon:null,armor:null};
  if(!advData.equip[charId].weapon){
    let fw=Object.values(ADV_WEAPONS).find(w=>w.char===charId);
    if(fw)advData.equip[charId].weapon=fw.id;
  }
  if(!advData.equip[charId].armor){
    let fa=Object.values(ADV_ARMORS).find(a=>a.char===charId);
    if(fa)advData.equip[charId].armor=fa.id;
  }

  let stages=buildAdventureStages(allWords);
  let effStats=getCharEffectiveStats(charId);
  let startStage=advData.savedStageIndex||0;
  // Clamp to valid range
  if(startStage>=stages.length)startStage=0;

  // Restore saved HP if resuming mid-run; otherwise start full
  let savedHp=advData.charStats&&advData.charStats[charId]&&advData.charStats[charId].hp;
  let startHp=(startStage>0&&savedHp&&savedHp>0)?Math.min(savedHp,effStats.maxHp):effStats.maxHp;

  adv={
    active:true,charId,char:charDef,
    hp:startHp, maxHp:effStats.maxHp,
    sp:4, maxSp:6,
    statusEffects:[],stageIndex:startStage,stages,
    combatLog:["âš”ï¸ Quest begins! Answer words to charge attacks."],
    pendingPoints:0,currentWord:null,wordPool:[],wordUsed:[],correctThisTurn:0,
    enemyHp:0,enemyMaxHp:0,enemyStatus:[],enemyCharge:0,
    sessionGold:0,inventory:[],
    sortTiles:[],sortAnswer:[],
    questionType:"choice",turnCount:0,phase2Triggered:false,defending:false,shopOpen:false,waitingForAction:false,_processing:false,
    comboCount:0,enemyTurnMeter:0,lastAnswerCorrect:false,
    answerTimer:null,lateHits:0,enemyQueue:[],enemyQueueIdx:0,
    armorPassives:{thorns:0,regen:0,evade_bonus:0,rage_gain:0,crit_boost:0,poison_coat:false,holy_shield_ready:false}
  };
  // Setup armor passives
  advInitArmorPassives();
  renderAdventureMap();
}

function advInitArmorPassives(){
  let arm=getEquippedArmor(adv.charId);
  adv.armorPassives={thorns:0,regen:0,evade_bonus:0,rage_gain:0,crit_boost:0,poison_coat:false,holy_shield_ready:false};
  if(!arm)return;
  // NERF: thorns max 10, regen max 8, evade cap 25%
  if(arm.bonus==="thorns"){let rawThorns=arm.id.includes("7")?10:arm.id.includes("6")?8:arm.id.includes("5")?7:arm.id.includes("2")?3:5;adv.armorPassives.thorns=Math.min(10,rawThorns);}
  if(arm.bonus==="regen"){let rawRegen=arm.id.includes("7")?8:arm.id.includes("5")?7:arm.id.includes("3")?4:5;adv.armorPassives.regen=Math.min(8,rawRegen);}
  if(arm.bonus==="evade_bonus")adv.armorPassives.evade_bonus=arm.id.includes("5")?2:1;
  if(arm.bonus==="rage_gain")adv.armorPassives.rage_gain=arm.id.includes("6")?3:2;
  if(arm.bonus==="crit_boost")adv.armorPassives.crit_boost=arm.id.includes("6")?30:20;
  if(arm.bonus==="poison_coat")adv.armorPassives.poison_coat=true;
  if(arm.bonus==="holy_shield")adv.armorPassives.holy_shield_ready=true;
}
// Evade cap: max 25% dodge from armor stats
function getCapppedDodgeBonus(raw){return Math.min(25,raw||0);}

/* â”€â”€ MAP SCREEN â€” Continent Map â”€â”€ */
function renderAdventureMap(){
  if(!adv.active||!adv.stages||!adv.stages.length){renderAdventureEntry();return;}
  let stages=adv.stages;let cur=adv.stageIndex;
  let curGroup=getLevelGroup(cur);
  let charDef=adv.char;
  let hpPct=Math.max(0,Math.round((adv.hp/adv.maxHp)*100));
  let effStats=getCharEffectiveStats(adv.charId);
  let cs=advData.charStats[adv.charId];
  let curStage=stages[cur];

  // Build continent sections â€” 6 nodes in a 6-col grid, connectors via CSS
  let continentHtml=LEVEL_GROUPS.map(group=>{
    let isActive=cur>=group.start&&cur<=group.end;
    let isComplete=cur>group.end;
    let isLocked=cur<group.start;

    if(isLocked){
      return `<div class="continent-bg" style="background:rgba(10,12,16,0.5);border-color:rgba(42,51,68,0.5);">
        <div class="continent-header" style="color:var(--text-dim);opacity:0.5;">
          <span>ðŸ”’</span>
          <span style="flex:1;font-size:11px;">${group.continent}</span>
          <span style="font-family:'Share Tech Mono',monospace;font-size:8px;">LV.${group.level}</span>
        </div>
      </div>`;
    }

    let normalIcons=[
      ['ðŸ‘º','ðŸº','ðŸŒ¿'],['ðŸ”¥','ðŸ’£','â›ï¸'],
      ['â„ï¸','ðŸŒ¨ï¸','ðŸ¦…'],['ðŸŒ€','ðŸ‘ï¸','ðŸ•·ï¸'],
      ['ðŸ’€','ðŸ©¸','ðŸ‘¿']
    ];

    let stageNodes='';
    for(let i=group.start;i<=group.end;i++){
      let s=stages[i]; if(!s)continue;
      let done=i<cur, isCurrent=i===cur, locked=i>cur;
      let posInGroup=i-group.start;
      let icon;
      if(s.stageType==='boss'||s.type==='boss') icon='ðŸ‘‘';
      else if(s.stageType==='miniboss') icon='âš¡';
      else if(s.stageType==='shop'||s.type==='shop') icon='ðŸª';
      else { let gi=group.level-1,pi=Math.min(posInGroup,2); icon=normalIcons[gi]?normalIcons[gi][pi]||'âš”ï¸':'âš”ï¸'; }

      let iconCls=`adv-map-icon${done?' done':isCurrent?' current':locked?' locked':''}${s.stageType==='boss'||s.type==='boss'?' boss':s.stageType==='miniboss'?' miniboss':s.stageType==='shop'||s.type==='shop'?' shop-node':''}`;
      let action=isCurrent?`data-action="advGoStage:${i}"`:'';
      let lbl=s.stageType==='boss'||s.type==='boss'?'BOSS':s.stageType==='miniboss'?'MINI':s.stageType==='shop'||s.type==='shop'?'SHOP':`${i+1}`;
      let lblColor=isCurrent?group.color:done?'rgba(58,154,92,0.9)':locked?'rgba(60,70,85,0.6)':'var(--text-dim)';
      let nodeStyle=`cursor:${done?'default':isCurrent?'pointer':'not-allowed'};`;

      stageNodes+=`<div class="adv-map-node" ${action} style="${nodeStyle}">
        <div class="${iconCls}">${done?'âœ“':isCurrent?`<span>${icon}</span>`:icon}</div>
        <div class="map-stage-num" style="color:${lblColor};">${lbl}</div>
      </div>`;
    }

    let doneCount=Math.max(0,Math.min(group.end+1,cur)-group.start);
    let pct=isComplete?100:isActive?Math.round((doneCount/6)*100):0;
    let headerIcon=isComplete?'âœ…':isActive?'â–¶':'ðŸ”’';
    let headerColor=isComplete?'var(--green)':isActive?group.color:'var(--text-dim)';
    let borderCol=isComplete?'rgba(58,154,92,0.3)':isActive?group.borderColor:'rgba(42,51,68,0.4)';
    let bgCol=isComplete?'rgba(15,30,20,0.3)':isActive?group.bgColor:'rgba(12,14,18,0.3)';

    return `<div class="continent-bg" style="background:${bgCol};border-color:${borderCol};">
      ${isActive?`<div style="position:absolute;inset:0;background:radial-gradient(ellipse 80% 60% at 50% 0%,${group.color}06 0%,transparent 70%);pointer-events:none;"></div>`:''}
      <div class="continent-header" style="color:${headerColor};">
        <span style="font-size:13px;">${headerIcon}</span>
        <span style="flex:1;">${group.continent} <span style="font-size:9px;font-weight:400;opacity:0.65;letter-spacing:1px;">${group.name}</span></span>
        <span style="font-family:'Share Tech Mono',monospace;font-size:8px;opacity:0.8;">${isComplete?'CLEARED':isActive?pct+'%':'LV.'+group.level}</span>
      </div>
      <div style="padding:2px 8px 0;height:2px;background:rgba(255,255,255,0.04);">
        <div style="height:100%;width:${pct}%;background:${group.color};opacity:0.7;transition:width 0.4s;"></div>
      </div>
      <div class="continent-stages-grid">
        ${stageNodes}
      </div>
    </div>`;
  }).join('');

  let invHtml=adv.inventory.length?adv.inventory.map((itemId,idx)=>{
    let item=ADV_CONSUMABLES.find(i=>i.id===itemId)||{icon:'?',name:itemId};
    return `<button class="adv-skill-btn" style="width:auto;font-size:10px;padding:4px 8px;" data-action="advUseInventory:${idx}">${item.icon} ${item.name}</button>`;
  }).join(''):`<span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);">Empty</span>`;

  app.innerHTML=`<div class="container" style="padding-bottom:40px;">
    <div class="ark-header">
      <button class="back" data-action="renderAdventureEntry">â—„ QUIT</button>
      <div class="ark-title">ðŸ—ºï¸ <span>World Map</span></div>
      <div class="adv-gold-display" style="margin-left:auto;font-size:12px;">ðŸ’° ${advData.totalGold+adv.sessionGold}</div>
    </div>

    <div style="background:var(--bg-card);border:1px solid var(--border);border-left:3px solid ${curGroup.color};padding:8px 10px;margin-bottom:6px;clip-path:polygon(8px 0%,100% 0%,100% calc(100% - 8px),calc(100% - 8px) 100%,0% 100%,0% 8px);">
      <div style="display:flex;gap:8px;align-items:center;">
        <div style="width:40px;flex-shrink:0;font-size:32px;line-height:1;text-align:center;">${charDef.art}</div>
        <div style="flex:1;min-width:0;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;">
            <span style="font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:var(--text-bright);">${charDef.name} <span style="color:var(--accent);font-size:9px;">LV.${cs.level}</span></span>
            <span style="font-family:'Share Tech Mono',monospace;font-size:7px;color:${curGroup.color};">S${cur+1} Â· ${curGroup.name}</span>
          </div>
          <div style="display:flex;gap:2px;margin-bottom:2px;flex-wrap:wrap;">
            <span class="adv-stat-pill">âš”ï¸${effStats.atk}</span>
            <span class="adv-stat-pill">ðŸ›¡ï¸${effStats.def}</span>
            <span class="adv-stat-pill" style="color:#e06060;">â¤ï¸${Math.max(0,adv.hp)}/${adv.maxHp}</span>
            <span class="adv-stat-pill" style="color:var(--green);">âœ¦${adv.sp}SP</span>
          </div>
          <div class="adv-hp-bar" style="height:4px;"><div class="adv-hp-fill" style="width:${hpPct}%;${hpPct<30?'background:linear-gradient(90deg,#880000,#cc2020);':''}"></div></div>
        </div>
      </div>
    </div>

    <div class="continent-map">
      ${continentHtml}
    </div>

    ${adv.inventory.length?`<div class="ark-section" style="margin:6px 0 4px;">ðŸŽ’ INVENTORY</div><div style="display:flex;flex-wrap:wrap;gap:4px;padding:5px 6px;background:var(--bg-card);border:1px solid var(--border);margin-bottom:6px;">${invHtml}</div>`:''}

    <button data-action="advGoStage:${cur}" style="border-color:${curGroup.borderColor};color:${curGroup.color};background:${curGroup.bgColor};justify-content:center;margin-top:4px;font-size:13px;letter-spacing:1px;padding:11px;">
      ${curStage.type==='shop'?'ðŸª ENTER MERCHANT':curStage.stageType==='boss'?'ðŸ‘‘ FINAL BOSS â€” DEMON KING':curStage.stageType==='miniboss'?'âš¡ MINI-BOSS: '+curStage.name:'âš”ï¸ ENTER STAGE '+(cur+1)+' Â· '+curStage.name}
    </button>
  </div>`;
}

/* â”€â”€ ENTER STAGE â”€â”€ */
function advGoStage(idx){
  if(!adv.active)return;
  if(idx!==adv.stageIndex)return;
  let stage=adv.stages[idx];
  if(!stage)return;
  if(stage.type==="shop"||stage.stageType==="shop"){advOpenShop();return;}

  // Build enemy queue from this stage's enemies array
  adv.enemyQueue=[...(stage.enemies||[])];
  adv.enemyQueueIdx=0;
  advSetWordPool(stage.zoneWords);

  // Update maxHp in case stats changed, but carry current HP over between stages
  let effStats=getCharEffectiveStats(adv.charId);
  adv.maxHp=effStats.maxHp;
  adv.hp=Math.min(adv.hp,adv.maxHp); // clamp HP to new maxHp if it changed
  adv.statusEffects=[];
  adv.lateHits=0;
  adv.pendingPoints=0;
  adv.defending=false;
  adv.waitingForAction=false;
  adv.comboCount=0;adv.enemyTurnMeter=0;
  if(adv.armorPassives.evade_bonus>0){
    for(let i=0;i<adv.armorPassives.evade_bonus;i++){
      adv.statusEffects.push({type:"evading",turns:1});
    }
  }

  // Load first enemy
  advLoadNextEnemy();
}

/* â”€â”€ LOAD NEXT ENEMY FROM QUEUE â”€â”€ */
function advLoadNextEnemy(){
  adv._processing=false; // always clear lock when loading new enemy
  if(!adv.enemyQueue||adv.enemyQueueIdx>=adv.enemyQueue.length){
    // No more enemies â€” stage complete
    advStageComplete();
    return;
  }
  let e=adv.enemyQueue[adv.enemyQueueIdx];
  adv.enemy={...e};
  adv.enemyHp=e.hp;
  adv.enemyMaxHp=e.hp;
  adv.enemyStatus=[];
  adv.enemyCharge=0;
  adv.phase2Triggered=false;
  adv.defending=false;
  adv.waitingForAction=false;
  // Track seen enemies for Almanac
  if(!advData.seenEnemies)advData.seenEnemies=[];
  if(e.id&&!advData.seenEnemies.includes(e.id)){advData.seenEnemies.push(e.id);saveAll();}
  advPickWord();
  renderAdventureCombat();
}

/* â”€â”€ PICK WORD â”€â”€ */
function advPickWord(){
  if(!adv.wordPool||adv.wordPool.length===0){
    let profile=profiles[currentProfile];
    adv.wordPool=shuffle([...((profile&&profile.words)||[])]);
    adv.wordUsed=[];
  }
  if(adv.wordPool.length===0){adv.currentWord={kanji:"ãƒ†ã‚¹ãƒˆ",hira:"ã¦ã™ã¨",arti:"test"};return;}
  adv.currentWord=adv.wordPool.shift();
  adv.wordUsed.push(adv.currentWord);
  // Determine question type â€” typing mode forces type input; otherwise choice/sort
  let r=Math.random();
  if(advData.typingMode){
    adv.questionType="typing";
  } else {
    adv.questionType=r<0.55?"choice":"sort";
  }
  if(adv.questionType==="sort"){
    let word=adv.currentWord;
    let hasHira=word.hira&&word.hira!=="-";
    let hasKanji=word.kanji&&word.kanji.length>1;
    // Sort direction: hiragana prompt â†’ arrange KANJI characters
    // If word has both hira and multi-char kanji, use kanji as answer
    // Otherwise fall back to arranging hiragana
    let ans;
    if(hasHira&&hasKanji){
      ans=word.kanji; // player sees hira, arranges kanji
      adv._sortPromptIsHira=true;
    } else if(hasHira){
      ans=word.hira;  // no kanji to sort, arrange hiragana
      adv._sortPromptIsHira=false;
    } else {
      ans=word.kanji;
      adv._sortPromptIsHira=false;
    }
    adv._sortFullAnswer=ans;
    let chars=[...ans];let shuffled=[...chars];
    let attempts=0;
    do{shuffled=shuffle([...chars]);attempts++;}while(attempts<20&&shuffled.join("")===ans&&chars.length>1);
    adv.sortTiles=shuffled;adv.sortAnswer=[];
  }
}

/* â”€â”€ RENDER COMBAT â”€â”€ */
function renderAdventureCombat(){
  if(!adv.active||!adv.enemy){renderAdventureMap();return;}
  let enemy=adv.enemy;let charDef=adv.char;let cs=advData.charStats[adv.charId];
  let effStats=getCharEffectiveStats(adv.charId);
  let hpPct=Math.max(0,Math.round((adv.hp/adv.maxHp)*100));
  let spPct=Math.round((adv.sp/adv.maxSp)*100);
  let eHpPct=Math.max(0,Math.round((adv.enemyHp/adv.enemyMaxHp)*100));
  let isBossEnemy=enemy.stageType==="boss"||enemy.type==="boss";
  let isMiniEnemy=enemy.stageType==="miniboss"||enemy.type==="miniboss";
  let enemyColor=isBossEnemy?"#ff4444":isMiniEnemy?"#9c55d0":"var(--red)";
  let enemyBorderColor=isBossEnemy?"rgba(255,50,50,0.6)":isMiniEnemy?"rgba(156,85,208,0.5)":"rgba(201,64,64,0.4)";
  let zoneInfo=adv.stageIndex!==undefined?` Â· ${getLevelGroup(adv.stageIndex).name}`:'';

  // Queue progress bar
  let stage=adv.stages[adv.stageIndex];
  let queueBar='';
  if(stage&&stage.enemies&&stage.enemies.length>1){
    let total=stage.enemies.length,killed=adv.enemyQueueIdx||0,dots='';
    for(let qi=0;qi<total;qi++){
      let qe=stage.enemies[qi];let done=qi<killed;let cur=qi===killed;
      let c=qe.stageType==="boss"?'var(--accent)':qe.stageType==="miniboss"?'#c080ff':'var(--red)';
      let dim=qe.stageType==="boss"?'rgba(232,168,56,0.2)':qe.stageType==="miniboss"?'rgba(156,85,208,0.2)':'rgba(201,64,64,0.2)';
      let dotArt=done?'âœ“':(qe.art&&qe.art.trim().startsWith('<svg')?'âš¡':qe.art);
      dots+=`<span title="${qe.name}" style="display:inline-block;width:${qe.stageType!=="normal"?14:10}px;height:${qe.stageType!=="normal"?14:10}px;border-radius:${qe.stageType==="boss"?'0':'50%'};margin:1px;background:${done?'rgba(0,0,0,0.5)':cur?c:dim};border:1px solid ${done||cur?c:dim};opacity:${done?0.4:1};font-size:7px;text-align:center;line-height:${qe.stageType!=="normal"?14:10}px;">${dotArt}</span>`;
    }
    queueBar=`<div style="display:flex;align-items:center;gap:2px;flex-wrap:wrap;">${dots}<span style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);margin-left:3px;">${killed}/${total}</span></div>`;
  }

  let statusHtml=adv.statusEffects.map(s=>{
    let colors={fortified:"var(--blue)",evading:"var(--purple)",burning:"#ff6600",poisoned:"var(--green)",ice_slow:"#60d0ff",stunned_p:"#ffe040",atk_boost:"var(--accent)",def_boost_item:"var(--blue)",crit_boost_item:"#c080ff"};
    let icons={fortified:"ðŸ›¡ï¸",evading:"ðŸ‘»",burning:"ðŸ”¥",poisoned:"â˜ ï¸",ice_slow:"â„ï¸",stunned_p:"âš¡",atk_boost:"ðŸ’ ",def_boost_item:"ðŸ›¡ï¸",crit_boost_item:"ðŸ’¥"};
    let label=s.type==="def_boost_item"?`DEF+${s.val}`:s.type==="atk_boost"?`ATK+${s.val}`:s.type==="crit_boost_item"?`CRIT+${s.val}%`:s.type.toUpperCase()+(s.turns<999?` ${s.turns}t`:'');
    return `<span style="font-family:'Share Tech Mono',monospace;font-size:8px;color:${colors[s.type]||'#aaa'};background:rgba(0,0,0,0.3);border:1px solid;padding:1px 4px;margin:1px;">${icons[s.type]||'âš¡'} ${label}</span>`;
  }).join('');
  let eStatusHtml=adv.enemyStatus.map(s=>{
    let colors={poison:"var(--green)",stunned:"var(--purple)",iron_fortress:"var(--blue)",fire_amp:"#ff6600",ice_slow:"#60d0ff"};
    let icons={poison:"â˜ ï¸",stunned:"ðŸ’«",iron_fortress:"ðŸ°",fire_amp:"ðŸ”¥",ice_slow:"â„ï¸"};
    let label=s.type==="fire_amp"?"FIRE AMP":s.type==="ice_slow"?"ICE SLOW":s.type.toUpperCase();
    return `<span style="font-family:'Share Tech Mono',monospace;font-size:8px;color:${colors[s.type]||'#aaa'};padding:1px 4px;border:1px solid;margin:1px;">${icons[s.type]||'âš¡'} ${label} ${s.turns}t</span>`;
  }).join('');
  let logHtml=adv.combatLog.slice(0,5).map(l=>`<div>${l}</div>`).join("");

  // Enemy turn meter â€” 3 player actions = enemy acts
  let ETM_MAX=3;
  let etm=adv.enemyTurnMeter||0;
  let etmDots='';
  for(let i=0;i<ETM_MAX;i++){
    let filled=i<etm;
    let isLast=etm===ETM_MAX-1&&i===ETM_MAX-1;
    etmDots+=`<span style="display:inline-block;width:12px;height:12px;border-radius:3px;margin:1px;background:${filled?(isLast?'#ff2222':'#ff7700'):'rgba(255,255,255,0.08)'};border:1px solid ${filled?(isLast?'#ff2222':'#ff8800'):'rgba(255,255,255,0.12)'};transition:background 0.2s;"></span>`;
  }
  let etmWarn=etm>=ETM_MAX-1?`<span style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#ff2222;animation:pulse 0.5s infinite alternate;margin-left:4px;">âš  ATTACKING NEXT!</span>`:'';
  let enemyTurnBar=`<div style="display:flex;align-items:center;gap:4px;padding:3px 6px;background:rgba(201,64,64,0.08);border:1px solid rgba(201,64,64,0.2);margin:2px 0;">
    <span style="font-family:'Share Tech Mono',monospace;font-size:7px;color:${etm>=ETM_MAX-1?'#ff4444':'#ff8844'};">ðŸ‘¹ TURN IN ${ETM_MAX-etm}</span>
    <div style="display:flex;">${etmDots}</div>${etmWarn}
  </div>`;

  // Combo bar
  let combo=adv.comboCount||0;
  let comboBar=combo>=2?`<div style="display:flex;align-items:center;gap:6px;padding:3px 6px;background:rgba(240,192,96,0.07);border:1px solid rgba(240,192,96,0.25);margin:2px 0;">
    <span style="font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:${combo>=5?'#ff6644':combo>=3?'#f0c060':'var(--accent)'};${combo>=3?'animation:pulse 0.35s infinite alternate;':''}">ðŸ”¥ Ã—${combo}</span>
    <span style="font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--text-dim);">${combo===3?'BLACKHOLE at Ã—3!':combo===4?'RANDOM FX at Ã—5!':combo===5?'BONUS EFFECT!':combo>=7&&combo%2===1?'DRAGON PULSE!':'keep going!'}</span>
  </div>`:'';

  // Enemy charge indicator (for special-move enemies)
  let chargeIndicator='';
  let fstyle=ENEMY_FIGHT_STYLES[enemy.id]||null;
  if(fstyle){
    let charge=adv.enemyCharge||0,max=fstyle.chargeMax,remaining=max-charge;
    let barColor=remaining<=1?'#ff2222':remaining<=2?'#ff8800':'#cc44ff';
    let dots='';
    for(let i=0;i<max;i++){dots+=`<span style="display:inline-block;width:9px;height:9px;border-radius:50%;margin:1px;background:${i<charge?barColor:'rgba(255,255,255,0.1)'};border:1px solid ${i<charge?barColor:'rgba(255,255,255,0.15)'};"></span>`;}
    let warn=remaining===1?`<span style="color:#ff2222;font-size:9px;animation:pulse 0.6s infinite alternate;"> âš  NEXT!</span>`:remaining===2?`<span style="color:#ff8800;font-size:9px;"> SOON</span>`:'';
    chargeIndicator=`<div style="margin-top:5px;padding:4px 6px;background:rgba(0,0,0,0.3);border:1px solid rgba(200,60,255,0.25);">
      <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#cc44ff;margin-bottom:3px;">${fstyle.specialIcon} ${fstyle.specialName}${warn}</div>
      <div style="display:flex;align-items:center;gap:2px;">${dots}</div>
    </div>`;
  }

  // Enemy stats badge (dodge / dmg reduce if they have it)
  let enemyStatBadge='';
  if((enemy.dodge||0)>0||(enemy.dmgReduce||0)>0){
    let parts=[];
    if(enemy.dodge>0)parts.push(`<span style="color:#60d0ff;font-size:8px;">ðŸ’¨ DODGE ${enemy.dodge}%</span>`);
    if(enemy.dmgReduce>0)parts.push(`<span style="color:#aaaaaa;font-size:8px;">ðŸ›¡ DR ${Math.round(enemy.dmgReduce*100)}%</span>`);
    enemyStatBadge=`<div style="display:flex;flex-wrap:wrap;gap:3px;margin-top:2px;">${parts.join('')}</div>`;
  }

  // Action buttons
  let wpn=getEquippedWeapon(adv.charId);
  let hasPoints=adv.pendingPoints>=1;
  let wpnSkillBtn=wpn?(
    hasPoints&&adv.sp>=wpn.skillCost?
      `<button class="adv-skill-btn special" data-action="advCombatAction:wpnskill_${wpn.id}" style="border-color:rgba(240,192,96,0.5);color:#f0c060;">${wpn.icon} ${wpn.skillName} <span style="font-size:8px;opacity:0.7;">[${wpn.skillCost}SP]</span></button>`:
      `<button class="adv-skill-btn disabled" disabled style="opacity:0.35;">${wpn.icon} ${wpn.skillName} <span style="font-size:8px;">[${!hasPoints?'need pts':'need '+wpn.skillCost+'SP'}]</span></button>`
  ):'';
  let skillBtns=charDef.skills.map(sk=>{
    let effMult=sk.dmgMult+(effStats.skillDmgBonus||0);
    let canUse=hasPoints&&adv.sp>=sk.cost;
    return `<button class="adv-skill-btn${canUse?'':' disabled'} special" ${canUse?`data-action="advCombatAction:skill_${sk.id}"`:"disabled"} style="${canUse?'border-color:rgba(156,85,208,0.5);color:#c080ff;':'opacity:0.35;'}">
      ${sk.icon} ${sk.name} <span style="font-family:'Share Tech Mono',monospace;font-size:8px;opacity:0.7;">[${sk.cost}SP | ${effMult.toFixed(1)}Ã—${!hasPoints?' Â· need pts':''}]</span></button>`;
  }).join('');
  let attackBtn=hasPoints?
    `<button class="adv-skill-btn" data-action="advCombatAction:attack" style="border-color:rgba(232,168,56,0.6);color:var(--accent);">âš”ï¸ ATTACK <span style="font-family:'Share Tech Mono',monospace;font-size:8px;opacity:0.7;">[1pt â†’ deal damage${combo>=2?' Â· Ã—'+combo+' COMBO':'' }]</span></button>`:
    `<button class="adv-skill-btn disabled" disabled style="opacity:0.3;">âš”ï¸ ATTACK <span style="font-size:8px;">[need action pts]</span></button>`;
  // Defend & Continue = free action, always available
  let defBtn=`<button class="adv-skill-btn defend-btn" data-action="advCombatAction:defend" style="border-color:rgba(58,114,176,0.55);color:var(--blue);">ðŸ›¡ï¸ DEFEND &amp; CONTINUE <span style="font-family:'Share Tech Mono',monospace;font-size:8px;opacity:0.7;">[reduce dmg Â· no pts needed]</span></button>`;

  // Shared combat panels
  let combatPanels=`
    ${comboBar}
    ${enemyTurnBar}
    <div class="adv-combat-zone">
      <div class="adv-fighter player-side" id="adv-player-panel">
        <div style="font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--blue);letter-spacing:1px;margin-bottom:2px;">${charDef.class.toUpperCase()}</div>
        <div id="adv-player-sprite" class="adv-char-art sprite-idle">${charDef.art}</div>
        <div class="adv-char-name">${charDef.name} <span style="font-size:8px;color:var(--accent);">LV.${cs.level}</span></div>
        <div class="adv-hp-label">HP ${Math.max(0,adv.hp)}/${adv.maxHp}</div>
        <div class="adv-hp-bar"><div class="adv-hp-fill" style="width:${hpPct}%;${hpPct<30?'background:linear-gradient(90deg,#550000,#cc0000);':''}"></div></div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--green);margin-top:2px;">SP ${adv.sp}/${adv.maxSp}</div>
        <div class="adv-sp-bar"><div class="adv-sp-fill" style="width:${spPct}%;"></div></div>
        ${adv.pendingPoints>0?`<div style="font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:var(--accent);margin-top:3px;">âš¡ ${adv.pendingPoints}pt</div>`:`<div style="font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--text-dim);margin-top:3px;">answer â†’ pts</div>`}
        <div style="margin-top:2px;">${statusHtml}</div>
      </div>
      <div class="adv-vs">VS</div>
      <div class="adv-fighter enemy-side" id="adv-enemy-panel" style="border-color:${enemyBorderColor};">
        <div style="font-family:'Share Tech Mono',monospace;font-size:7px;color:${enemyColor};letter-spacing:1px;margin-bottom:2px;">${isBossEnemy?'FINAL BOSS':isMiniEnemy?'MINI BOSS':'ENEMY'}</div>
        <div id="adv-enemy-sprite" class="adv-char-art enemy-art sprite-idle">${enemy.art&&enemy.art.trim().startsWith('<svg')?`<div style="transform:scale(0.89);transform-origin:center center;">${enemy.art}</div>`:enemy.art}</div>
        <div class="adv-char-name" style="color:${enemyColor};">${enemy.name}</div>
        <div class="adv-hp-label" style="color:${enemyColor};">HP ${Math.max(0,adv.enemyHp)}/${adv.enemyMaxHp}</div>
        <div class="adv-hp-bar"><div class="adv-hp-fill enemy" style="width:${eHpPct}%;"></div></div>
        ${enemy.special?`<div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:${enemyColor};margin-top:3px;opacity:0.8;">â˜… ${enemy.special}</div>`:''}
        ${(()=>{let ea=enemy.elementAtk||{};let parts=Object.entries(ea).filter(([,v])=>v>0).map(([e,v])=>`<span style="color:${ELEMENT_COLORS[e]||'#fff'};font-size:8px;">${ELEMENT_ICONS[e]||''}${v}%</span>`);return parts.length?`<div style="margin-top:2px;display:flex;flex-wrap:wrap;gap:3px;">${parts.join('')}</div>`:''})()}
        ${enemyStatBadge}
        ${chargeIndicator}
        <div style="margin-top:3px;">${eStatusHtml}</div>
      </div>
    </div>
    <div id="adv-log" class="adv-combat-log">${logHtml}</div>`;

  let typingToggleBtn=`<button onclick="advData.typingMode=!advData.typingMode;saveAll();advPickWord();renderAdventureCombat();" style="width:auto;padding:2px 7px;font-size:8px;letter-spacing:1px;border:1px solid ${advData.typingMode?'rgba(232,168,56,0.6)':'rgba(60,70,85,0.6)'};color:${advData.typingMode?'var(--accent)':'var(--text-dim)'};background:${advData.typingMode?'rgba(232,168,56,0.08)':'transparent'};white-space:nowrap;flex-shrink:0;">${advData.typingMode?'âœŽ TYPE':'âŠž CHOICE'}</button>`;
  let headerHtml=`<div class="ark-header" style="padding:5px 0 8px;">
    <button class="back" data-action="renderAdventureMap" style="font-size:9px;padding:3px 8px!important;">â—„ MAP</button>
    <div style="flex:1;text-align:center;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);">STAGE ${adv.stageIndex+1}${zoneInfo}</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:13px;color:${enemyColor};letter-spacing:1px;">${enemy.name}${isMiniEnemy?' âš¡':isBossEnemy?' ðŸ‘‘':''}</div>
      ${queueBar}
    </div>
    <div style="display:flex;align-items:center;gap:4px;">
      ${typingToggleBtn}
      <div class="adv-gold-display" style="font-size:10px;padding:2px 6px;">ðŸ’°${advData.totalGold+adv.sessionGold}</div>
      <button class="adv-stats-btn" onclick="advShowCharStats()" style="white-space:nowrap;">ðŸ“Š</button>
    </div>
  </div>`;

  // â”€â”€ ACTION PHASE (player chose to act after answering) â”€â”€
  if(adv.waitingForAction){
    let hasPoints=adv.pendingPoints>=1;
    app.innerHTML=`<div class="container" style="padding-bottom:100px;">
      ${headerHtml}${combatPanels}
      <div style="background:rgba(232,168,56,0.07);border:1px solid rgba(232,168,56,0.28);padding:5px 10px;margin:4px 0 2px;text-align:center;">
        <div style="font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:var(--accent);letter-spacing:2px;">âš”ï¸ CHOOSE ACTION</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);margin-top:1px;">Pts: ${adv.pendingPoints} Â· SP: ${adv.sp}/${adv.maxSp}${!hasPoints?' Â· No pts':''}</div>
      </div>
      ${attackBtn}${wpnSkillBtn}${skillBtns}${defBtn}
    </div>`;
    return;
  }

  // â”€â”€ QUESTION PHASE â”€â”€
  let questionHtml=advBuildQuestion();
  app.innerHTML=`<div class="container" style="padding-bottom:100px;">
    ${headerHtml}${combatPanels}
    <div class="ark-section" style="margin:4px 0 2px;">ðŸ“– WORD CHALLENGE <span style="color:var(--text-dim);font-size:8px;">â€” answer to earn pts</span></div>
    <div style="margin:0 0 3px;display:flex;align-items:center;justify-content:space-between;">
      <span style="font-family:'Share Tech Mono',monospace;font-size:8px;color:${(adv.lateHits||0)===0?'var(--text-dim)':(adv.lateHits||0)===1?'#ff8800':'#ff4400'};">â° TIMER${adv.lateHits>0?` Â· LATE Ã—${adv.lateHits} â†’ -${ADV_LATE_PENALTIES[Math.min(adv.lateHits,ADV_LATE_PENALTIES.length-1)]}HP`:''}</span>
      <button onclick="advSkipWord();" style="width:auto;padding:3px 10px;font-size:9px;letter-spacing:1px;border-color:#cc4444;color:#ff6060;background:rgba(200,40,40,0.1);">â­ SKIP (penalty)</button>
    </div>
    <div style="height:5px;background:var(--border);margin:0 0 6px;overflow:hidden;"><div id="adv-answer-timer" style="height:100%;background:linear-gradient(90deg,#ff4400,#ff8800);width:100%;transition:none;"></div></div>
    ${questionHtml}
  </div>`;

  let typeInp=document.getElementById("adv-type-inp");
  if(typeInp){
    typeInp.addEventListener("keydown",e=>{if(e.key==="Enter"){advClearAnswerTimer();advSubmitAnswer();}});
    // Live typo hint as player types
    typeInp.addEventListener("input",()=>{
      if(!adv.currentWord)return;
      let w=adv.currentWord;
      let isGlobal=!w.hira||w.hira==="-";
      let correct=((isGlobal?w.arti:w.hira)||"").trim().toLowerCase();
      let given=typeInp.value.trim().toLowerCase();
      let hint=document.getElementById("adv-typo-hint");
      if(!hint||!given){if(hint)hint.innerHTML="";return;}
      let result=checkTypoTolerance(given,correct);
      if(result==="correct"){
        hint.innerHTML=`<span style="color:var(--green);">âœ“ looks good!</span>`;
        typeInp.style.borderColor="var(--green)";typeInp.style.borderLeftColor="var(--green)";
      } else if(result==="close1"){
        hint.innerHTML=`<span style="color:#f0c060;">~ 1 typo</span>`;
        typeInp.style.borderColor="#f0c060";typeInp.style.borderLeftColor="#f0c060";
      } else if(result==="close2"){
        hint.innerHTML=`<span style="color:#ff9940;">~ 2 typos</span>`;
        typeInp.style.borderColor="#ff9940";typeInp.style.borderLeftColor="#ff9940";
      } else if(result==="close3"){
        hint.innerHTML=`<span style="color:#ff6644;">~ 3 typos</span>`;
        typeInp.style.borderColor="#ff6644";typeInp.style.borderLeftColor="#ff6644";
      } else {
        hint.innerHTML="";
        typeInp.style.borderColor="var(--border)";typeInp.style.borderLeftColor="var(--accent-dim)";
      }
    });
    typeInp.focus();
  }
  advStartAnswerTimer();
}

/* â”€â”€ BUILD QUESTION â”€â”€ */
function advBuildQuestion(){
  let w=adv.currentWord;
  if(!w)return `<div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);padding:8px;">Loading word...</div>`;
  let isGlobal=!w.hira||w.hira==="-";

  if(adv.questionType==="choice"){
    let prompt=w.kanji;let correctAns=isGlobal?w.arti:w.hira;
    let pool=(adv.wordPool||[]).filter(x=>x&&x.kanji!==w.kanji);
    let wrongs=[];let distPool=shuffle([...pool]);
    for(let x of distPool){let ans=isGlobal?x.arti:x.hira;if(ans&&ans!=="-"&&ans!==correctAns&&!wrongs.includes(ans))wrongs.push(ans);if(wrongs.length>=3)break;}
    while(wrongs.length<3)wrongs.push("???");
    let choices=shuffle([correctAns,...wrongs.slice(0,3)]);
    let choiceHtml=choices.map((c,ci)=>{
      let safeVal=btoa(unescape(encodeURIComponent(c)));
      return `<button class="choiceBtn adv-choice-btn" data-val="${safeVal}" style="margin:3px 0;font-size:${c.length>15?'11':'14'}px;letter-spacing:1px;text-align:center;justify-content:center;">${c}</button>`;
    }).join("");
    return `<div class="card" style="font-size:38px;margin:6px 0;padding:14px 10px;">${prompt}<div style="font-size:11px;color:var(--text-dim);margin-top:4px;font-family:'Share Tech Mono',monospace;letter-spacing:2px;">â†’ ${isGlobal?'MEANING':'READING'}</div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;">${choiceHtml}</div>`;

  } else if(adv.questionType==="sort"){
    let ans=adv._sortFullAnswer||(w.kanji);
    let sortedHtml=adv.sortAnswer.map((ch,i)=>`<div class="adv-skill-btn" style="width:auto;padding:5px 9px;font-size:17px;display:inline-flex;margin:2px;border-color:var(--accent-dim);" data-action="advSortTile:remove:${i}">${ch}</div>`).join("");
    let tileHtml=adv.sortTiles.map((ch,i)=>`<div class="adv-skill-btn" style="width:auto;padding:5px 9px;font-size:17px;display:inline-flex;margin:2px;" data-action="advSortTile:add:${i}">${ch}</div>`).join("");
    let isComplete=adv.sortAnswer.length===[...ans].length;
    // Prompt: show hiragana reading if we're arranging kanji, else show kanji
    let promptText=adv._sortPromptIsHira?w.hira:w.kanji;
    let promptLabel=adv._sortPromptIsHira?"â†’ ARRANGE: KANJI":"â†’ ARRANGE: READING";
    return `<div class="card" style="font-size:38px;margin:6px 0;padding:14px 10px;">${promptText}<div style="font-size:11px;color:var(--text-dim);margin-top:4px;font-family:'Share Tech Mono',monospace;letter-spacing:2px;">${promptLabel}</div></div>
    <div id="adv-sort-area">
      <div style="min-height:38px;background:var(--bg-deep);border:1px solid var(--border);border-left:3px solid var(--accent);padding:4px 6px;margin:4px 0;display:flex;flex-wrap:wrap;align-items:center;gap:2px;">${sortedHtml||`<span style="color:var(--text-dim);font-size:9px;font-family:'Share Tech Mono',monospace;padding:4px;">tap tiles below</span>`}</div>
      <div style="display:flex;flex-wrap:wrap;padding:4px;gap:2px;">${tileHtml}</div>
      ${isComplete?`<button class="adv-skill-btn special" onclick="advClearAnswerTimer();advSortSubmit();" style="border-color:var(--accent);color:var(--accent);justify-content:center;margin-top:4px;">âœ“ CONFIRM</button>`:`<button data-action="advSortSubmit" style="color:var(--text-dim);border-color:var(--border);justify-content:center;margin-top:4px;opacity:0.5;" disabled>âœ“ SUBMIT (fill all tiles)</button>`}
    </div>`;
  } else if(adv.questionType==="typing"){
    let prompt=w.kanji;
    let correctAns=isGlobal?w.arti:w.hira;
    let placeholder=isGlobal?"type meaningâ€¦":"type readingâ€¦";
    return `<div class="card" style="font-size:38px;margin:6px 0;padding:14px 10px;">${prompt}<div style="font-size:11px;color:var(--text-dim);margin-top:4px;font-family:'Share Tech Mono',monospace;letter-spacing:2px;">â†’ ${isGlobal?'MEANING':'READING'}</div></div>
    <div style="position:relative;">
      <input id="adv-type-inp" type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
        placeholder="${placeholder}"
        style="width:100%;padding:10px 12px;background:var(--bg-panel);border:1px solid var(--border);border-left:3px solid var(--accent-dim);color:var(--text-bright);font-family:'Share Tech Mono',monospace;font-size:15px;letter-spacing:2px;outline:none;">
      <div id="adv-typo-hint" style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);padding:3px 4px;min-height:16px;letter-spacing:1px;"></div>
    </div>
    <button onclick="advClearAnswerTimer();advSubmitAnswer();" style="border-color:rgba(232,168,56,0.5);color:var(--accent);justify-content:center;margin-top:4px;padding:8px;">âœ“ SUBMIT</button>`;
  }
  return '';
}

/* â”€â”€ CHOICE ANSWER â”€â”€ */
function advCombatChoice(safeVal){
  if(adv._processing)return;
  advClearAnswerTimer();
  try{let decoded=decodeURIComponent(escape(atob(safeVal)));advCombatChoiceDecoded(decoded);}
  catch(e){advCombatChoiceDecoded(safeVal);}
}
function advCombatChoiceDecoded(answer){
  let w=adv.currentWord;if(!w)return;
  let isGlobal=!w.hira||w.hira==="-";
  let correct=(isGlobal?w.arti:w.hira)||"";
  advProcessAnswer(answer.trim()===correct.trim());
}

/* â”€â”€ SKIP WORD (penalty) â”€â”€ */
function advSkipWord(){
  if(!adv.active||!adv.enemy)return;
  if(adv._processing)return;
  adv._processing=true;
  advClearAnswerTimer();
  let w=adv.currentWord;
  let penaltyDmg=Math.max(3,Math.round(adv.enemy.atk*0.35));
  let dodge=(getCharEffectiveStats(adv.charId).dodgeBonus||0);
  if(adv.armorPassives&&adv.armorPassives.holy_shield_ready){adv.armorPassives.holy_shield_ready=false;penaltyDmg=0;advAddLog("Holy Shield blocked skip penalty!");}
  else if(dodge>0&&Math.random()*100<dodge){penaltyDmg=0;advAddLog("Skip dodged! ("+dodge+"% dodge)");}
  if(penaltyDmg>0){
    adv.hp=Math.max(0,adv.hp-penaltyDmg);
    advAnimateSprite("adv-player-sprite","sprite-hurt");
    let hint=w?"("+w.kanji+" = "+((!w.hira||w.hira==="-")?w.arti:w.hira)+")":"";
    advAddLog("SKIP! "+hint+" penalty "+penaltyDmg+" dmg");
    showDmgPop("SKIP -"+penaltyDmg,"#ff6060",50,42);
    if(adv.armorPassives&&adv.armorPassives.rage_gain>0){adv.sp=Math.min(adv.maxSp,adv.sp+adv.armorPassives.rage_gain);advAddLog("Rage: +"+adv.armorPassives.rage_gain+"SP!");}
  }
  // Grant 1 action point so player can still act (they already paid penalty damage)
  adv.waitingForAction=true;
  adv.pendingPoints=(adv.pendingPoints||0)+1;
  saveAll();
  if(adv.hp<=0){adv._processing=false;advDie();return;}
  adv._processing=false;
  renderAdventureCombat();
}

/* â”€â”€ TYPE ANSWER â”€â”€ */
function advSubmitAnswer(){
  advClearAnswerTimer();
  let inp=document.getElementById("adv-type-inp");if(!inp)return;
  let w=adv.currentWord;if(!w)return;
  let isGlobal=!w.hira||w.hira==="-";
  let correct=((isGlobal?w.arti:w.hira)||"").trim().toLowerCase();
  let given=inp.value.trim().toLowerCase();
  if(!given){inp.focus();return;}

  let result=checkTypoTolerance(given,correct);

  if(result==="correct"){
    advProcessAnswer(true);
  } else if(result==="close1"||result==="close2"||result==="close3"){
    // Typo tolerance â€” show the hint, shake the field, wait for correction or force-accept
    let dist=result==="close1"?1:result==="close2"?2:3;
    let hint=document.getElementById("adv-typo-hint");
    let hintColors=["","#f0c060","#ff9940","#ff6644"];
    let hintMsgs=[
      "",
      `<span style="color:#f0c060;">âš  1 typo â€” almost! check your spelling</span>`,
      `<span style="color:#ff9940;">âš  2 typos â€” close but check again</span>`,
      `<span style="color:#ff6644;">âš  3 typos â€” rough match. <b>accept anyway?</b></span>`
    ];
    if(hint){hint.innerHTML=hintMsgs[dist];}
    // Highlight the input border
    inp.style.borderColor=hintColors[dist];
    inp.style.borderLeftColor=hintColors[dist];
    // Show corrected answer as ghost text in a tooltip style
    let corrEl=document.getElementById("adv-type-correct-ghost");
    if(!corrEl){
      corrEl=document.createElement("div");
      corrEl.id="adv-type-correct-ghost";
      corrEl.style.cssText="font-family:'Share Tech Mono',monospace;font-size:11px;padding:3px 8px;background:rgba(232,168,56,0.08);border:1px solid rgba(232,168,56,0.25);border-left:3px solid var(--accent);color:var(--accent);letter-spacing:1px;margin-top:2px;";
      inp.parentNode.insertBefore(corrEl,inp.nextSibling);
    }
    // Build diff display â€” underline chars that differ
    corrEl.innerHTML=buildDiffHtml(given,correct);

    // For 1-2 typos: let player fix it (re-listen Enter). For 3 typos: offer accept button
    inp.focus();inp.select();
    // Remove any existing accept btn
    let oldAccept=document.getElementById("adv-typo-accept");
    if(oldAccept)oldAccept.remove();
    if(dist===3){
      let acceptBtn=document.createElement("button");
      acceptBtn.id="adv-typo-accept";
      acceptBtn.textContent="âœ“ ACCEPT CLOSE ANSWER (-no pt)";
      acceptBtn.style.cssText="width:100%;padding:7px;margin-top:4px;border:1px solid rgba(255,100,68,0.5);background:rgba(255,80,40,0.08);color:#ff8060;font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:1px;cursor:pointer;";
      acceptBtn.onclick=()=>{advClearAnswerTimer();advProcessAnswerTypo(0.5);};
      inp.closest("div").parentNode.appendChild(acceptBtn);
    } else {
      // Auto-accept after re-submit if still within tolerance
      inp.onkeydown=(e)=>{
        if(e.key==="Enter"){
          let newGiven=inp.value.trim().toLowerCase();
          let newResult=checkTypoTolerance(newGiven,correct);
          advClearAnswerTimer();
          if(newResult==="correct") advProcessAnswer(true);
          else if(newResult==="close1"||newResult==="close2"||newResult==="close3"){
            // Accept but penalise lightly
            advProcessAnswerTypo(newResult==="close1"?0.8:0.5);
          } else {
            advProcessAnswer(false);
          }
        }
      };
    }
  } else {
    advProcessAnswer(false);
  }
}

/* Build diff HTML: show correct answer with mismatched chars highlighted */
function buildDiffHtml(given, correct){
  let gChars=[...given], cChars=[...correct];
  let html='<span style="font-size:9px;color:var(--text-dim);letter-spacing:1px;">CORRECT: </span>';
  let maxLen=Math.max(gChars.length,cChars.length);
  for(let i=0;i<cChars.length;i++){
    let cch=cChars[i], gch=gChars[i];
    if(gch===cch){
      html+=`<span style="color:var(--green);">${cch}</span>`;
    } else {
      html+=`<span style="color:#ff6644;text-decoration:underline;font-weight:700;">${cch}</span>`;
    }
  }
  if(gChars.length>cChars.length){
    // extra chars typed â€” show them as strikethrough
    for(let i=cChars.length;i<gChars.length;i++){
      html+=`<span style="color:#ff4444;text-decoration:line-through;opacity:0.6;">${gChars[i]}</span>`;
    }
  }
  return html;
}

/* Typo-accepted answer â€” partial credit (fraction of a point) */
function advProcessAnswerTypo(fraction){
  if(!adv.active||!adv.enemy)return;
  if(adv._processing)return;
  adv._processing=true;
  advClearAnswerTimer();
  adv.waitingForAction=true;
  // Partial credit: fraction=0.8 â†’ full pt, fraction=0.5 â†’ half pt rounded
  let pts=fraction>=0.8?1:0; // give 1pt for close1/close2, 0 for 3 typo accept
  let spGain=fraction>=0.8?1:0;
  if(pts>0){adv.pendingPoints++;adv.sp=Math.min(adv.maxSp,adv.sp+spGain);}
  let w=adv.currentWord;
  let correct=w?((!w.hira||w.hira==="-")?w.arti:w.hira):"?";
  advAddLog(`ã€° Close! (â†’${correct}) ${pts>0?'+1pt':'no pt'} â€” minor dmg`);
  showDmgPop(pts>0?"~1PT":"CLOSE","#f0c060",28,72);
  // Small penalty damage even on close answers (except close1)
  if(fraction<0.8){
    let eDmg=Math.max(1,Math.round(adv.enemy.atk*0.1));
    adv.hp=Math.max(0,adv.hp-eDmg);
    if(eDmg>0)showDmgPop(`-${eDmg}`,"#ff9940",50,52);
  }
  // Track for profile stats
  let profile=profiles[currentProfile];
  if(profile&&w){let pw=profile.words.find(x=>x.kanji===w.kanji);if(pw)pw.correct=(pw.correct||0)+0.5;}
  globalStats.xp+=2;globalStats.level=calcLevel(globalStats.xp);grantShopCoins(2);
  saveAll();
  if(adv.hp<=0){adv._processing=false;advDie();return;}
  adv._processing=false;
  renderAdventureCombat();
}

/* â”€â”€ SORT TILE â”€â”€ */
function advSortTile(action_idx){
  let colonIdx=action_idx.indexOf(":");let action=action_idx.slice(0,colonIdx);let idx=parseInt(action_idx.slice(colonIdx+1));
  if(isNaN(idx))return;
  if(action==="add"){let ch=adv.sortTiles[idx];if(ch===undefined)return;adv.sortAnswer.push(ch);adv.sortTiles.splice(idx,1);}
  else if(action==="remove"){let ch=adv.sortAnswer[idx];if(ch===undefined)return;adv.sortTiles.push(ch);adv.sortAnswer.splice(idx,1);}
  // Re-render question area only (keep timer running â€” do NOT clear timer)
  let qArea=document.getElementById("adv-sort-area");
  if(qArea){
    // Patch sort area inline without full re-render
    let w=adv.currentWord;
    let ans=adv._sortFullAnswer||(w?w.kanji:"");
    let sortedHtml=adv.sortAnswer.map((ch,i)=>`<div class="adv-skill-btn" style="width:auto;padding:5px 9px;font-size:17px;display:inline-flex;margin:2px;border-color:var(--accent-dim);" data-action="advSortTile:remove:${i}">${ch}</div>`).join("");
    let tilesHtml=adv.sortTiles.map((ch,i)=>`<div class="adv-skill-btn" style="width:auto;padding:5px 9px;font-size:17px;display:inline-flex;margin:2px;" data-action="advSortTile:add:${i}">${ch}</div>`).join("");
    let isComplete=adv.sortAnswer.length===[...ans].length;
    qArea.innerHTML=`<div style="min-height:44px;padding:8px;background:var(--bg-card2);border:1px solid var(--border);display:flex;flex-wrap:wrap;margin-bottom:6px;">${sortedHtml||'<span style="color:var(--text-dim);font-size:10px;font-family:\'Share Tech Mono\',monospace;">Tap tiles below â†’</span>'}</div>
    <div style="display:flex;flex-wrap:wrap;margin-bottom:6px;">${tilesHtml}</div>
    ${isComplete?`<button class="adv-skill-btn special" onclick="advClearAnswerTimer();advSortSubmit();" style="border-color:var(--accent);color:var(--accent);justify-content:center;">âœ“ CONFIRM</button>`:''}`;
  } else {
    renderAdventureCombat();
  }
}
function advSortSubmit(){
  advClearAnswerTimer();
  let w=adv.currentWord;if(!w)return;
  let ans=adv._sortFullAnswer||w.kanji;
  let given=adv.sortAnswer.join("");
  advProcessAnswer(given===ans);
}

/* â”€â”€ PROCESS ANSWER â€” pause after answer for action phase â”€â”€ */
function advProcessAnswer(isRight){
  if(!adv.active||!adv.enemy)return;
  if(adv._processing)return;
  adv._processing=true;
  advClearAnswerTimer();
  adv.waitingForAction=true;
  if(isRight){
    adv.pendingPoints++;adv.sp=Math.min(adv.maxSp,adv.sp+1);
    advAddLog(`âœ… Correct! +1pt (${adv.pendingPoints}pts) +1SP`);
    showDmgPop("+1PT","#44ff60",28,72);
    advAnimateSprite("adv-player-sprite","sprite-idle");
    globalStats.xp+=5;globalStats.totalCorrect=(globalStats.totalCorrect||0)+1;
    globalStats.level=calcLevel(globalStats.xp);grantShopCoins(5);updateDailyProgress("correct",1);
    let profile=profiles[currentProfile];
    if(profile){let pw=profile.words.find(x=>x.kanji===adv.currentWord.kanji);if(pw)pw.correct=(pw.correct||0)+1;}
    if(adv.armorPassives.poison_coat&&adv.enemy){let dot=6;adv.enemyStatus=adv.enemyStatus.filter(s=>s.type!=="poison");adv.enemyStatus.push({type:"poison",turns:2,dot});advAddLog(`ðŸ Poison coat procs!`);}
  } else {
    let eDmg=Math.max(1,Math.round(adv.enemy.atk*0.25));
    if(adv.armorPassives.holy_shield_ready){adv.armorPassives.holy_shield_ready=false;eDmg=0;advAddLog(`âœï¸ Holy Shield blocked!`);}
    let dodge=(getCharEffectiveStats(adv.charId).dodgeBonus||0);
    if(dodge>0&&Math.random()*100<dodge){eDmg=0;advAddLog(`ðŸ’¨ Dodged! (${dodge}% dodge)`);}
    adv.hp=Math.max(0,adv.hp-eDmg);
    if(eDmg>0)advAnimateSprite("adv-player-sprite","sprite-hurt");
    advAddLog(`âŒ Wrong! (${adv.currentWord.kanji} = ${!adv.currentWord.hira||adv.currentWord.hira==='-'?adv.currentWord.arti:adv.currentWord.hira}) â€” ${eDmg} dmg`);
    if(eDmg>0)showDmgPop(`-${eDmg}`,"#ff4444",60,42);
    if(eDmg>0&&adv.armorPassives.rage_gain>0){adv.sp=Math.min(adv.maxSp,adv.sp+adv.armorPassives.rage_gain);advAddLog(`ðŸ”¥ Rage: +${adv.armorPassives.rage_gain}SP!`);}
    let profile=profiles[currentProfile];
    if(profile){let pw=profile.words.find(x=>x.kanji===adv.currentWord.kanji);if(pw)pw.wrong=(pw.wrong||0)+1;}
  }
  saveAll();
  if(adv.hp<=0){adv._processing=false;advDie();return;}
  adv._processing=false;
  renderAdventureCombat();
}

/* â”€â”€ COMBAT ACTION â€” called after answer phase â”€â”€ */
function advCombatAction(action){
  if(!adv.active||!adv.enemy)return;
  if(adv._processing)return; // prevent double-click / race conditions
  adv._processing=true;
  advClearAnswerTimer();
  let effStats=getCharEffectiveStats(adv.charId);
  let enemy=adv.enemy;
  adv.waitingForAction=false;

  // â”€â”€ DEFEND & CONTINUE (no pts needed) â”€â”€
  if(action==="defend"||action==="next_word"){
    if(action==="defend"&&adv.pendingPoints>0){
      adv.defending=true;
      advAddLog(`ðŸ›¡ï¸ ${adv.char.name} braces! Next hit reduced.`);
    } else {
      advAddLog(`â­ ${adv.char.name} passes this turn.`);
    }
    adv.enemyTurnMeter=(adv.enemyTurnMeter||0)+1;
    adv.comboCount=0;adv.lastAnswerCorrect=false;
    if(adv.enemyTurnMeter>=3){adv.enemyTurnMeter=0;advEnemyTurn();if(adv.hp<=0){adv._processing=false;advDie();return;}}
    adv._processing=false;advPickWord();saveAll();renderAdventureCombat();return;
  }

  // â”€â”€ ATTACK â”€â”€
  if(action==="attack"){
    if(adv.pendingPoints<1){advAddLog("âš  No pts! Defend to continue.");adv._processing=false;renderAdventureCombat();return;}
    // Combo tracking
    adv.comboCount=(adv.comboCount||0)+1;
    let combo=adv.comboCount;
    let comboMult=combo>=3?1.0+(combo-2)*0.15:1.0;

    let eDef=enemy.def+(adv.enemyStatus.find(s=>s.type==="fortified")?8:0);
    let fireAmp=adv.enemyStatus.find(s=>s.type==="fire_amp");
    let fireMult=fireAmp?1.25:1.0;
    let critChance=(effStats.critBonus||0);
    let critItem=adv.statusEffects.find(s=>s.type==="crit_boost_item");
    if(critItem)critChance+=critItem.val||0;
    let isCrit=Math.random()*100<critChance;
    let atkItem=adv.statusEffects.find(s=>s.type==="atk_boost");
    let bonusAtk=atkItem?(atkItem.val||0):0;
    let dmg=advCalcDamage(effStats.atk+bonusAtk,eDef,fireMult*comboMult,isCrit,effStats.critBonus+(adv.armorPassives.crit_boost||0));
    if(fireAmp){fireAmp.turns--;if(fireAmp.turns<=0)adv.enemyStatus=adv.enemyStatus.filter(s=>s.type!=="fire_amp");}
    let ifort=adv.enemyStatus.find(s=>s.type==="iron_fortress");
    if(ifort)dmg=Math.max(1,Math.floor(dmg/2));
    let thorns=adv.enemyStatus.find(s=>s.type==="thorns");
    if(thorns){adv.hp=Math.max(0,adv.hp-(thorns.val||0));thorns.turns--;if(thorns.turns<=0)adv.enemyStatus=adv.enemyStatus.filter(s=>s.type!=="thorns");}

    // Enemy dodge check
    let eDodge=enemy.dodge||0;
    if(eDodge>0&&Math.random()*100<eDodge){
      adv.pendingPoints--;
      adv.comboCount=0; // dodge breaks combo
      advAddLog(`ðŸ’¨ ${enemy.name} DODGED! (${eDodge}% dodge)`);
      showDmgPop("DODGE!","#888888",40,32);
    } else {
      // Enemy damage reduction
      let eDR=enemy.dmgReduce||0;
      if(eDR>0){let red=Math.floor(dmg*eDR);dmg=Math.max(1,dmg-red);if(red>0)advAddLog(`ðŸ›¡ ${enemy.name} absorbs ${red} dmg!`);}
      adv.enemyHp=Math.max(0,adv.enemyHp-dmg);adv.pendingPoints--;
      advAnimateSprite("adv-player-sprite","sprite-attack");
      setTimeout(()=>advAnimateSprite("adv-enemy-sprite","sprite-enemy-hurt"),200);
      let comboStr=combo>=3?` ðŸ”¥Ã—${combo}!`:'';
      advAddLog(`âš”ï¸ ${dmg} dmg${isCrit?' ðŸ’¥CRIT!':''}${ifort?' (Ã—Â½ fortress)':''}${comboStr}`);
      showDmgPop(isCrit?`ðŸ’¥${dmg}!`:`-${dmg}`,isCrit?"#fff700":combo>=3?"#f0a030":"#e8a838",60,32);
      if(adv.armorPassives.thorns>0){let t=adv.armorPassives.thorns;adv.enemyHp=Math.max(0,adv.enemyHp-t);advAddLog(`ðŸŒµ Thorns: ${t}!`);}
      // Elemental procs
      let charDef2=ADV_CHARS[adv.charId];let elemAtks=charDef2.elementAtk||{};let isDragon=!!(elemAtks.dragon);
      Object.entries(elemAtks).forEach(([elem,chance])=>{
        if(elem!=="dragon"&&chance>0){let er=(enemy.elementRes&&enemy.elementRes[elem])||0;applyElementEffect(elem,Math.max(0,chance-er*0.5),"enemy",advAddLog,isDragon);}
      });
      // Combo specials
      advTriggerComboSpecial(combo);
    }

    adv.enemyTurnMeter=(adv.enemyTurnMeter||0)+1;
    if(adv.enemyHp<=0){adv._processing=false;advEnemyDefeated();return;}
    advCheckBossPhase2();
    if(adv.enemyTurnMeter>=3){adv.enemyTurnMeter=0;advEnemyTurn();if(adv.hp<=0){adv._processing=false;advDie();return;}}
    if(adv.pendingPoints>=1){adv.waitingForAction=true;adv._processing=false;saveAll();renderAdventureCombat();return;}
    adv._processing=false;advPickWord();saveAll();renderAdventureCombat();return;
  }

  // â”€â”€ WEAPON SKILL â”€â”€
  if(action.startsWith("wpnskill_")){
    let wpnId=action.replace("wpnskill_","");let wpn=ADV_WEAPONS[wpnId];
    if(!wpn){adv._processing=false;renderAdventureCombat();return;}
    if(adv.sp<wpn.skillCost){advAddLog("âš  Not enough SP!");adv._processing=false;renderAdventureCombat();return;}
    if(adv.pendingPoints<1){advAddLog("âš  Need 1 action point!");adv._processing=false;renderAdventureCombat();return;}
    adv.sp-=wpn.skillCost;adv.pendingPoints--;
    adv.comboCount=0; // skills reset combo
    let eDef=enemy.def;let critChance=(effStats.critBonus||0)+15;let isCrit=Math.random()*100<critChance;
    let dmg=advCalcDamage(effStats.atk,eDef,wpn.skillDmg+(effStats.skillDmgBonus||0),isCrit,effStats.critBonus+(adv.armorPassives.crit_boost||0));
    let eDodge=enemy.dodge||0;
    if(eDodge>0&&Math.random()*100<(eDodge*0.5)){// Skills harder to dodge
      advAddLog(`ðŸ’¨ ${enemy.name} partially evaded ${wpn.skillName}!`);dmg=Math.floor(dmg*0.5);
    }
    let eDR=enemy.dmgReduce||0;if(eDR>0){let red=Math.floor(dmg*eDR*0.5);dmg=Math.max(1,dmg-red);} // Skills bypass 50% DR
    adv.enemyHp=Math.max(0,adv.enemyHp-dmg);
    advAnimateSprite("adv-player-sprite","sprite-attack");
    setTimeout(()=>advAnimateSprite("adv-enemy-sprite","sprite-enemy-hurt"),200);
    advAddLog(`${wpn.icon} ${wpn.skillName}! ${dmg} dmg${isCrit?' ðŸ’¥CRIT!':''}`);
    showDmgPop(`${wpn.icon}${dmg}${isCrit?'!':''}`,"#f0c060",60,26);
    if(wpn.skillEffect==="stun"){adv.enemyStatus.push({type:"stunned",turns:1});advAddLog("ðŸ’« Stunned!");}
    if(wpn.skillEffect==="evade"){adv.statusEffects.push({type:"evading",turns:1});advAddLog("ðŸŒ‘ Evade ready!");}
    if(wpn.skillEffect==="poison"){let dot=Math.max(4,Math.round(effStats.atk*0.3));adv.enemyStatus.push({type:"poison",turns:3,dot});advAddLog(`â˜ ï¸ Poison ${dot}/t`);}
    if(wpn.skillEffect==="burn"){adv.statusEffects.push({type:"burning",turns:2,dot:8});advAddLog("ðŸ”¥ Burn! 8/tÃ—2");}
    if(wpn.skillEffect==="fortify"){adv.statusEffects.push({type:"fortified",turns:3});advAddLog("ðŸ”° DEF+8 3t!");}
    if(wpn.skillEffect==="heal"){let h=Math.round(adv.maxHp*0.15);adv.hp=Math.min(adv.maxHp,adv.hp+h);advAddLog(`âœ¨ +${h}HP`);showDmgPop(`+${h}â¤ï¸`,"#44ff88",30,32);}
    adv.enemyTurnMeter=(adv.enemyTurnMeter||0)+1;
    if(adv.enemyHp<=0){adv._processing=false;advEnemyDefeated();return;}
    advCheckBossPhase2();
    if(adv.enemyTurnMeter>=3){adv.enemyTurnMeter=0;advEnemyTurn();if(adv.hp<=0){adv._processing=false;advDie();return;}}
    if(adv.pendingPoints>=1){adv.waitingForAction=true;adv._processing=false;saveAll();renderAdventureCombat();return;}
    adv._processing=false;advPickWord();saveAll();renderAdventureCombat();return;
  }

  // â”€â”€ CHARACTER SKILL â”€â”€
  if(action.startsWith("skill_")){
    let skillId=action.replace("skill_","");
    let skill=(adv.char.skills||[]).find(s=>s.id===skillId);
    if(!skill){adv._processing=false;renderAdventureCombat();return;}
    if(adv.sp<skill.cost){advAddLog("âš  Not enough SP!");adv._processing=false;renderAdventureCombat();return;}
    if(adv.pendingPoints<1){advAddLog("âš  Need 1 action point!");adv._processing=false;renderAdventureCombat();return;}
    adv.sp-=skill.cost;adv.pendingPoints--;
    adv.comboCount=0;
    let effMult=skill.dmgMult+(effStats.skillDmgBonus||0);
    if(effMult>0){
      let eDef=enemy.def+(adv.enemyStatus.find(s=>s.type==="fortified")?8:0);
      let isCrit=Math.random()*100<(effStats.critBonus||0);
      let dmg=advCalcDamage(effStats.atk,eDef,effMult,isCrit,effStats.critBonus+(adv.armorPassives.crit_boost||0));
      let eDodge=enemy.dodge||0;if(eDodge>0&&Math.random()*100<(eDodge*0.5)){dmg=Math.floor(dmg*0.5);advAddLog(`ðŸ’¨ ${enemy.name} partially blocked!`);}
      let eDR=enemy.dmgReduce||0;if(eDR>0){dmg=Math.max(1,dmg-Math.floor(dmg*eDR*0.5));}
      adv.enemyHp=Math.max(0,adv.enemyHp-dmg);
      advAnimateSprite("adv-player-sprite","sprite-attack");
      setTimeout(()=>advAnimateSprite("adv-enemy-sprite","sprite-enemy-hurt"),200);
      advAddLog(`${skill.icon} ${skill.name}! ${dmg} dmg${isCrit?' ðŸ’¥CRIT!':''}`);
      showDmgPop(isCrit?`${skill.icon}ðŸ’¥${dmg}!`:`${skill.icon}-${dmg}`,isCrit?"#fff700":"#f0c060",60,28);
    }
    if(skill.effect==="heal"||skill.id==="holy_light"){let h=Math.round(adv.maxHp*0.18);adv.hp=Math.min(adv.maxHp,adv.hp+h);advAddLog(`âœ¨ +${h}HP`);showDmgPop(`+${h}â¤ï¸`,"#44ff88",30,32);}
    if(skill.effect==="stun"){adv.enemyStatus.push({type:"stunned",turns:1});advAddLog("ðŸ’« Stunned 1t!");}
    if(skill.effect==="poison"){let dot=Math.max(3,Math.round(effStats.atk*0.28));adv.enemyStatus.push({type:"poison",turns:3,dot});advAddLog(`â˜ ï¸ Poison ${dot}/t`);}
    if(skill.effect==="fortify"){adv.statusEffects.push({type:"fortified",turns:3});advAddLog("ðŸ”° DEF+8 3t!");}
    if(skill.effect==="evade"){adv.statusEffects.push({type:"evading",turns:1});advAddLog("ðŸŒ‘ Evade next!");}
    if(skill.effect==="berserk"){adv.hp=Math.max(1,adv.hp-12);advAddLog("ðŸ’¢ Berserk -12HP!");}
    if(skill.effect==="burn"){adv.enemyStatus.push({type:"burning",turns:3,dot:8});advAddLog("ðŸ”¥ Burning 8/t!");}
    adv.enemyTurnMeter=(adv.enemyTurnMeter||0)+1;
    if(adv.enemyHp<=0){adv._processing=false;advEnemyDefeated();return;}
    advCheckBossPhase2();
    if(adv.enemyTurnMeter>=3){adv.enemyTurnMeter=0;advEnemyTurn();if(adv.hp<=0){adv._processing=false;advDie();return;}}
    if(adv.pendingPoints>=1){adv.waitingForAction=true;adv._processing=false;saveAll();renderAdventureCombat();return;}
    adv._processing=false;advPickWord();saveAll();renderAdventureCombat();return;
  }

  // fallback
  adv._processing=false;advPickWord();saveAll();renderAdventureCombat();
}

function advCheckBossPhase2(){
  let enemy=adv.enemy;if(!enemy)return;
  let isBossEnemy=enemy.stageType==="boss"||enemy.type==="boss";
  let isMiniEnemy=enemy.stageType==="miniboss"||enemy.type==="miniboss";
  if((isBossEnemy||isMiniEnemy)&&!adv.phase2Triggered&&adv.enemyHp<=adv.enemyMaxHp*0.5){
    adv.phase2Triggered=true;
    if(isBossEnemy&&enemy.id==="boss_demon_king"){
      // +25% ATK (capped) + Dragon Aura
      enemy.atk=Math.round(enemy.atk*1.25);enemy.def+=8;
      enemy.elementAtk={fire:30,thunder:28,dragon:25};
      advAddLog("ðŸ‘‘ DEMON KING â€” PHASE 2! +25% ATK! DRAGON AURA!");
      showDmgPop("â˜  PHASE 2!","#ff0000",44,20);
    } else if(isBossEnemy&&enemy.id==="hidden_chronovore"){
      enemy.atk=Math.round(enemy.atk*1.3);
      advAddLog("â° CHRONOVORE â€” PHASE 2! TIME DISTORTION! Answer in 6s or die!");
      showDmgPop("â° PHASE 2!","#9900ff",44,20);
      // Shorten answer timer in phase 2
      adv._hiddenBossPhase2=true;
    } else if(isMiniEnemy){
      // Mini-boss phase change
      let atkBonus=enemy.phaseAtk||8;let defBonus=enemy.phaseDef||4;
      enemy.atk+=atkBonus;enemy.def+=defBonus;
      let auraText=enemy.phaseAura||"Phase 2 activated!";
      advAddLog(`âš¡ ${enemy.name} â€” PHASE 2! ATK+${atkBonus} DEF+${defBonus}`);
      advAddLog(`ðŸ”´ ${auraText}`);
      showDmgPop("PHASE 2!","#cc44ff",44,20);
    }
    let ph2=document.createElement('div');
    ph2.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:20001;text-align:center;pointer-events:none;animation:levelupPop 0.4s ease;';
    let p2color=isBossEnemy?"#ff0000":isMiniEnemy?"#cc44ff":"#ff4444";
    ph2.innerHTML=`<div style="background:#0a0000;border:2px solid ${p2color};padding:20px 36px;clip-path:polygon(12px 0,100% 0,100% calc(100% - 12px),calc(100% - 12px) 100%,0 100%,0 12px);"><div style="font-size:44px;">${isBossEnemy?"ðŸ‘‘":"âš¡"}</div><div style="font-family:'Rajdhani',sans-serif;font-size:24px;font-weight:700;color:${p2color};letter-spacing:3px;">PHASE 2</div><div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:#ff8888;">${isBossEnemy&&enemy.id==="hidden_chronovore"?"TIME DISTORTION UNLOCKED":isBossEnemy?"DRAGON AURA UNLEASHED":"ENRAGED MODE ACTIVE"}</div></div>`;
    document.body.appendChild(ph2);setTimeout(()=>ph2.remove(),2000);
  }
}

/* â”€â”€ ENEMY TURN â”€â”€ */
function advEnemyTurn(){
  if(!adv.enemy)return;
  let enemy=adv.enemy;let effStats=getCharEffectiveStats(adv.charId);let fstyle=ENEMY_FIGHT_STYLES[enemy.id]||null;
  // Regen armor passive (capped at 8)
  if(adv.armorPassives.regen>0&&adv.hp<adv.maxHp){let reg=Math.min(8,adv.armorPassives.regen);adv.hp=Math.min(adv.maxHp,adv.hp+reg);advAddLog(`ðŸ’š Regen: +${reg}HP`);}
  // Enemy DoTs
  let ps=adv.enemyStatus.find(s=>s.type==="poison");
  if(ps&&adv.enemyHp>0){adv.enemyHp=Math.max(0,adv.enemyHp-ps.dot);advAddLog(`â˜ ï¸ Poison: ${ps.dot} dmg to ${enemy.name}!`);ps.turns--;if(ps.turns<=0)adv.enemyStatus=adv.enemyStatus.filter(s=>s.type!=="poison");if(adv.enemyHp<=0)return;}
  // Player DoTs
  let burn=adv.statusEffects.find(s=>s.type==="burning");
  if(burn){adv.hp=Math.max(0,adv.hp-burn.dot);advAddLog(`ðŸ”¥ Burning! ${burn.dot} dmg!`);burn.turns--;if(burn.turns<=0)adv.statusEffects=adv.statusEffects.filter(s=>s.type!=="burning");}
  let ppois=adv.statusEffects.find(s=>s.type==="poisoned");
  if(ppois){adv.hp=Math.max(0,adv.hp-ppois.dot);advAddLog(`â˜ ï¸ Poisoned! ${ppois.dot} dmg!`);ppois.turns--;if(ppois.turns<=0)adv.statusEffects=adv.statusEffects.filter(s=>s.type!=="poisoned");}
  let ppois2=adv.statusEffects.find(s=>s.type==="poisoned2");
  if(ppois2){adv.hp=Math.max(0,adv.hp-ppois2.dot);advAddLog(`â˜ ï¸ Toxic! ${ppois2.dot} extra dmg!`);ppois2.turns--;if(ppois2.turns<=0)adv.statusEffects=adv.statusEffects.filter(s=>s.type!=="poisoned2");}
  // Armor broken debuff tick
  let armorBroken=adv.statusEffects.find(s=>s.type==="armor_broken");
  if(armorBroken){armorBroken.turns--;if(armorBroken.turns<=0)adv.statusEffects=adv.statusEffects.filter(s=>s.type!=="armor_broken");}
  // Stun check
  let stun=adv.enemyStatus.find(s=>s.type==="stunned");
  if(stun){advAddLog("ðŸ’« Enemy stunned â€” can't attack!");stun.turns--;if(stun.turns<=0)adv.enemyStatus=adv.enemyStatus.filter(s=>s.type!=="stunned");adv.enemyCharge=Math.max(0,(adv.enemyCharge||0)-1);adv.turnCount++;return;}
  // Evade check
  let evd=adv.statusEffects.find(s=>s.type==="evading");
  if(evd){advAddLog("ðŸŒ‘ Attack missed! (evade)");evd.turns--;if(evd.turns<=0)adv.statusEffects=adv.statusEffects.filter(s=>s.type!=="evading");adv.turnCount++;return;}
  // â”€â”€ Try enemy active skill (role-based) â”€â”€
  if(tryEnemyActiveSkill(enemy)){
    if(adv.hp<=0)return;
    adv.turnCount++;return;
  }
  // Charge / special (mini-boss and boss fight styles)
  if(fstyle){
    adv.enemyCharge=(adv.enemyCharge||0)+1;
    if(adv.enemyCharge>=fstyle.chargeMax){
      adv.enemyCharge=0;advAddLog(`âš¡ ${enemy.name} unleashes ${fstyle.specialIcon} ${fstyle.specialName}!`);
      showDmgPop(`${fstyle.specialIcon}SKILL!`,"#ff88ff",52,20);fstyle.onSpecial(adv);
      let ifort=adv.enemyStatus.find(s=>s.type==="iron_fortress");if(ifort){ifort.turns--;if(ifort.turns<=0)adv.enemyStatus=adv.enemyStatus.filter(s=>s.type!=="iron_fortress");}
      adv.defending=false;adv.statusEffects=adv.statusEffects.filter(s=>{if(s.type==="burning"||s.type==="poisoned"||s.type==="poisoned2"||s.type==="armor_broken")return true;s.turns--;return s.turns>0;});
      adv.turnCount++;return;
    }
  }
  // Normal attack
  let fort=adv.statusEffects.find(s=>s.type==="fortified");
  let extraDef=(fort?8:0);
  let defItem=adv.statusEffects.find(s=>s.type==="def_boost_item");
  let bonusDef=defItem?(defItem.val||0):0;
  // Armor broken debuff
  let brokenPenalty=armorBroken?(armorBroken.defPenalty||0):0;
  let totalDef=Math.max(0,effStats.def+extraDef+bonusDef-brokenPenalty);
  let baseMult=adv.defending?0.35:1.0;
  let pIceSlow=adv.statusEffects.find(s=>s.type==="ice_slow");
  if(pIceSlow){pIceSlow.turns--;if(pIceSlow.turns<=0)adv.statusEffects=adv.statusEffects.filter(s=>s.type!=="ice_slow");}
  let pStun=adv.statusEffects.find(s=>s.type==="stunned_p");
  if(pStun){pStun.turns--;if(pStun.turns<=0)adv.statusEffects=adv.statusEffects.filter(s=>s.type!=="stunned_p");}
  let eIceSlow=adv.enemyStatus.find(s=>s.type==="ice_slow");
  let iceSlowMult=eIceSlow?0.6:1.0;
  if(eIceSlow){eIceSlow.turns--;if(eIceSlow.turns<=0)adv.enemyStatus=adv.enemyStatus.filter(s=>s.type!=="ice_slow");}
  // Shield wall buff on enemy
  let shieldWall=adv.enemyStatus.find(s=>s.type==="shield_wall_buff");
  if(shieldWall){shieldWall.turns--;if(shieldWall.turns<=0)adv.enemyStatus=adv.enemyStatus.filter(s=>s.type!=="shield_wall_buff");}
  // Dodge chance (capped at 25%)
  let dodgeChance=Math.min(25,getCharEffectiveStats(adv.charId).dodgeBonus||0);
  if(dodgeChance>0&&Math.random()*100<dodgeChance){advAddLog(`ðŸ’¨ DODGED the attack! (${dodgeChance}% dodge)`);adv.defending=false;adv.turnCount++;return;}
  // Apply enemy role passive to ATK
  let rawEnemyAtk=Math.round(enemy.atk*iceSlowMult);
  rawEnemyAtk=applyEnemyRolePassive(enemy,rawEnemyAtk);
  // Mage: ignore DEF
  let ignoreDefMult=enemy.role==="Mage"?(1-(Math.min(0.30,enemy.ignoreDefPct||0))):1.0;
  let effectiveDef=Math.max(0,totalDef*ignoreDefMult);
  // Anti-Tank: true damage portion
  let trueDmgPct=enemy.role==="Anti-Tank"?(enemy.trueDmgPct||0.10):0;
  // Tank role: enemy dmgReduce applied to THEIR defense (already in stats)
  let dmg=advCalcDamage(rawEnemyAtk,effectiveDef,baseMult);
  let truePart=Math.round(adv.maxHp*trueDmgPct);
  // Assassin: 25% crit chance
  let enemyCrit=enemy.role==="Assassin"&&Math.random()*100<(enemy.critChance||25);
  if(enemyCrit){dmg=Math.round(dmg*1.5);advAddLog(`ðŸ’¥ Enemy CRIT!`);}
  // Poisoner passive: basic attack applies poison (5% max HP per turn, 3 turns)
  if(enemy.role==="Poisoner"&&!enemy._posionApplied){
    let dotAmt=Math.round(adv.maxHp*0.05);
    adv.statusEffects=adv.statusEffects.filter(s=>s.type!=="poisoned");
    adv.statusEffects.push({type:"poisoned",turns:3,dot:dotAmt});
    advAddLog(`â˜ ï¸ Poisoner: basic attack poisons! ${dotAmt}/turn Ã—3!`);
  }
  // Holy shield block
  if(adv.armorPassives.holy_shield_ready&&!adv.defending){adv.armorPassives.holy_shield_ready=false;advAddLog(`âœï¸ Holy Shield: BLOCKED!`);adv.defending=false;adv.turnCount++;return;}
  adv.hp=Math.max(0,adv.hp-(dmg+truePart));
  if(truePart>0)advAddLog(`ðŸ’Ž True dmg: ${truePart}!`);
  advAnimateSprite("adv-enemy-sprite","sprite-enemy-attack");
  setTimeout(()=>advAnimateSprite("adv-player-sprite","sprite-hurt"),200);
  advAddLog(`ðŸ‘¹ ${enemy.name} strikes for ${dmg}${adv.defending?' (BLOCKED)':''}${enemyCrit?' ðŸ’¥CRIT!':''}!`);
  showDmgPop(`-${dmg+truePart}`,"#ff4444",36,58);
  // Enemy elemental attack proc
  let eElemAtks=enemy.elementAtk||{};let playerRes=effStats.elemRes||{};let hasElemDragon=!!(eElemAtks.dragon);
  Object.entries(eElemAtks).forEach(([elem,chance])=>{
    if(elem!=="dragon"&&chance>0){let res=Math.min(40,playerRes[elem]||0);let effChance=Math.max(0,chance-res);applyElementEffect(elem,effChance,"player",advAddLog,hasElemDragon);}
  });
  adv.defending=false;
  adv.statusEffects=adv.statusEffects.filter(s=>{
    if(s.type==="def_boost_item"||s.type==="crit_boost_item")return true;
    if(s.type==="burning"||s.type==="poisoned"||s.type==="poisoned2"||s.type==="ice_slow"||s.type==="stunned_p"||s.type==="armor_broken")return true;
    s.turns--;return s.turns>0;
  });
  let ifort=adv.enemyStatus.find(s=>s.type==="iron_fortress");if(ifort){ifort.turns--;if(ifort.turns<=0)adv.enemyStatus=adv.enemyStatus.filter(s=>s.type!=="iron_fortress");}
  adv.turnCount++;
}

/* â”€â”€ ENEMY DEFEATED â”€â”€ */
function advEnemyDefeated(){
  advClearAnswerTimer(); // stop timer immediately â€” no more questions during transition
  adv._processing=false;
  let enemy=adv.enemy;
  let xpGained=enemy.xp||20;let goldGained=enemy.gold||10;
  adv.sessionGold+=goldGained;
  let cs=advData.charStats[adv.charId];cs.xp=(cs.xp||0)+xpGained;
  advCheckLevelUp();
  let isBoss=enemy.stageType==="boss"||enemy.type==="boss";
  let isMini=enemy.stageType==="miniboss"||enemy.type==="miniboss";

  if(isBoss&&enemy.isFinal){saveAll();advVictory(true);return;}
  if(isBoss&&enemy.isHiddenFight){saveAll();advHiddenBossVictory();return;}

  // Advance queue â€” still enemies left in this stage?
  adv.enemyQueueIdx=(adv.enemyQueueIdx||0)+1;
  let remaining=(adv.enemyQueue||[]).length - adv.enemyQueueIdx;
  let nextEnemy=remaining>0?adv.enemyQueue[adv.enemyQueueIdx]:null;

  advData.charStats[adv.charId].hp=adv.hp;
  saveAll();

  // Null out enemy and block interaction during flash transition
  adv.enemy=null;
  adv.waitingForAction=false;

  // AUTO-CONTINUE: no confirmation needed â€” load next enemy or go to map
  if(nextEnemy){
    showDmgPop(`+${goldGained}ðŸ’°`,"#f0c060",44,22);
    let typeColor=isBoss?'var(--accent)':isMini?'#c080ff':'var(--green)';
    let flash=document.createElement('div');
    flash.style.cssText=`position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:20000;text-align:center;pointer-events:none;animation:levelupPop 0.3s ease;`;
    flash.innerHTML=`<div style="background:var(--bg-card);border:2px solid ${typeColor};padding:16px 28px;clip-path:polygon(10px 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%,0 10px);">
      <div style="font-size:30px;">${enemy.art&&enemy.art.trim().startsWith('<svg')?'âš¡':enemy.art}</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;color:${typeColor};">DEFEATED!</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);">+${xpGained}XP  +${goldGained}ðŸ’°</div>
    </div>`;
    document.body.appendChild(flash);
    setTimeout(()=>flash.remove(),580);
    setTimeout(()=>{advLoadNextEnemy();},600);
    return;
  }

  // Stage fully cleared â€” show brief clear and auto-continue
  showDmgPop(`CLEAR! +${goldGained}ðŸ’°`,"var(--green)",40,22);
  let typeColor2=isBoss?'var(--accent)':isMini?'#c080ff':'var(--green)';
  let clearFlash=document.createElement('div');
  clearFlash.style.cssText=`position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:20000;text-align:center;pointer-events:none;animation:levelupPop 0.35s ease;`;
  clearFlash.innerHTML=`<div style="background:var(--bg-card);border:2px solid ${typeColor2};padding:18px 32px;clip-path:polygon(12px 0,100% 0,100% calc(100% - 12px),calc(100% - 12px) 100%,0 100%,0 12px);">
    <div style="font-size:36px;">${enemy.art&&enemy.art.trim().startsWith('<svg')?'âš¡':enemy.art}</div>
    <div style="font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;color:${typeColor2};">${isMini?'GENERAL DOWN!':'STAGE CLEAR!'}</div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);">+${xpGained}XP  +${goldGained}ðŸ’°</div>
  </div>`;
  document.body.appendChild(clearFlash);
  setTimeout(()=>clearFlash.remove(),780);
  setTimeout(()=>{advContinueMap();},800);
}

function advContinueMap(){
  // If there are more enemies in the queue, fight the next one
  let remaining=(adv.enemyQueue||[]).length - (adv.enemyQueueIdx||0);
  if(remaining>0 && adv.active){
    advLoadNextEnemy();
    return;
  }
  // Stage fully cleared â€” go to map
  let nextIdx=adv.stageIndex+1;
  if(nextIdx>=adv.stages.length){advVictory(false);return;}
  adv.stageIndex=nextIdx;
  advData.savedStageIndex=nextIdx;
  advData.charStats[adv.charId].hp=adv.hp;
  advData.totalGold+=adv.sessionGold;adv.sessionGold=0;saveAll();renderAdventureMap();
}

/* â”€â”€ STAGE COMPLETE (all enemies cleared) â”€â”€ */
function advStageComplete(){
  let nextIdx=adv.stageIndex+1;
  if(nextIdx>=adv.stages.length){advVictory(false);return;}
  adv.stageIndex=nextIdx;
  advData.savedStageIndex=nextIdx;
  advData.charStats[adv.charId].hp=adv.hp;
  advData.totalGold+=adv.sessionGold;adv.sessionGold=0;saveAll();renderAdventureMap();
}

/* â”€â”€ USE INVENTORY ITEM â”€â”€ */
function advUseInventory(idx){
  if(idx<0||idx>=(adv.inventory||[]).length)return;
  let itemId=adv.inventory[idx];
  let item=ADV_CONSUMABLES.find(i=>i.id===itemId);
  if(!item)return;
  adv.inventory.splice(idx,1);
  if(item.bonus.heal_pct){let healAmt=Math.round(adv.maxHp*(item.bonus.heal_pct/100));adv.hp=Math.min(adv.maxHp,adv.hp+healAmt);showShopToast(`${item.icon} Healed +${healAmt}HP!`,"var(--green)");advAddLog(`${item.icon} ${item.name}: restored ${healAmt}HP!`);showDmgPop(`+${healAmt}HP`,"#44ff88",50,40);}
  if(item.bonus.def_boost){adv.statusEffects.push({type:"def_boost_item",turns:999,val:item.bonus.def_boost});showShopToast(`${item.icon} +${item.bonus.def_boost} DEF`,"var(--blue)");advAddLog(`${item.icon} ${item.name}: +${item.bonus.def_boost} DEF this battle!`);}
  if(item.bonus.atk_boost){adv.statusEffects.push({type:"atk_boost",turns:999,val:item.bonus.atk_boost});showShopToast(`${item.icon} +${item.bonus.atk_boost} ATK`,"var(--accent)");advAddLog(`${item.icon} ${item.name}: +${item.bonus.atk_boost} ATK this battle!`);}
  if(item.bonus.crit_boost){adv.statusEffects.push({type:"crit_boost_item",turns:999,val:item.bonus.crit_boost});showShopToast(`${item.icon} +${item.bonus.crit_boost}% CRIT`,"var(--purple)");advAddLog(`${item.icon} ${item.name}: +${item.bonus.crit_boost}% CRIT this battle!`);}
  if(item.bonus.cure_all){adv.statusEffects=adv.statusEffects.filter(s=>s.type==="fortified"||s.type==="evading"||s.type==="def_boost_item"||s.type==="atk_boost"||s.type==="crit_boost_item");advAddLog(`${item.icon} Purified! All harmful element effects removed!`);showShopToast(`${item.icon} Purified!`,"var(--green)");}
  saveAll();renderAdventureCombat();
}

/* â”€â”€ VICTORY â”€â”€ */
function advVictory(isBoss){
  advClearAnswerTimer();
  advData.charStats[adv.charId].hp=adv.hp;advData.totalGold+=adv.sessionGold;adv.sessionGold=0;adv.active=false;
  advData.savedStageIndex=0;
  // Track total stage wins
  if(!advData.totalStageWins)advData.totalStageWins=0;
  advData.totalStageWins++;
  // Achievement flags
  let advAchFlags={};
  let cs2=advData.charStats[adv.charId];
  if(isBoss){advAchFlags._advFirstClear=true;advAchFlags._advBossKill=true;}
  advAchFlags._advBossKill=advAchFlags._advBossKill||(adv.enemy&&(adv.enemy.stageType==='boss'||adv.enemy.stageType==='miniboss'));
  advAchFlags._advCharLevel=cs2?cs2.level:1;
  advAchFlags._advTotalGold=advData.totalGold||0;
  advAchFlags._advStagesCleared=advData.totalStageWins||0;
  let advNewAchs=checkAchievements(advAchFlags);
  saveAll();
  let cs=advData.charStats[adv.charId];
  let stageWins=advData.totalStageWins||0;
  // Check hidden boss unlock
  let hiddenBossUnlocked=stageWins>=100&&!advData.hiddenBossDefeated;
  let hiddenBossMsg=hiddenBossUnlocked?`<div class="adv-story-box" style="border-left-color:#9900ff;color:#cc44ff;margin-top:12px;">
    <div style="font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;letter-spacing:2px;color:#9900ff;">âš  CHRONOVORE AWAKENS</div><br>
    <span style="color:#cc44ff;">You have won ${stageWins} stages. Something ancient stirs...<br>A hidden presence observes you. <span style="color:#ffffff;font-weight:700;">The CHRONOVORE has appeared.</span></span>
  </div>`:'';
  let story=isBoss?`<div class="adv-story-box" style="border-left-color:var(--accent);">
    <span style="color:var(--accent);font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;letter-spacing:2px;">â€” THE DEMON KING IS DEFEATED â€”</span><br><br>
    The darkness shatters. Demon King <span style="color:#c080ff;">Malachar</span>'s armor of forgotten words crumbles to dust.<br><br>
    <span style="color:var(--green);">The land is free. But the darkness will return... and so will you.</span>
  </div>`:'';
  app.innerHTML=`<div class="container">
    <div class="ark-header"><div class="ark-title">ðŸ‘‘ <span>${isBoss?'QUEST COMPLETE':'STAGE CLEAR'}</span></div></div>
    ${story}
    ${hiddenBossMsg}
    <div style="text-align:center;padding:16px 0;"><div style="font-size:66px;">${isBoss?'ðŸ‘‘':'ðŸ†'}</div>
    <div style="font-family:'Rajdhani',sans-serif;font-size:26px;font-weight:700;color:var(--accent);letter-spacing:4px;margin:8px 0;">${isBoss?'VICTORY!':'CLEARED!'}</div></div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">CHAR LV</div><div class="ark-stat-value">${cs.level}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">TOTAL GOLD</div><div class="ark-stat-value" style="color:#f0c060;">${advData.totalGold}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">STAGE WINS</div><div class="ark-stat-value" style="color:var(--purple);">${stageWins}</div></div>
    </div>
    ${hiddenBossUnlocked?`<button data-action="advStartHiddenBoss" style="border-color:#9900ff;color:#cc44ff;background:rgba(80,0,140,0.12);justify-content:center;margin-top:10px;font-size:15px;letter-spacing:2px;">â° CHALLENGE CHRONOVORE â€” HIDDEN BOSS</button>`:''}
    <button data-action="renderAdventureEntry" style="color:var(--accent);border-color:var(--accent-dim);justify-content:center;margin-top:10px;">âš”ï¸ RETURN TO ADVENTURE</button>
    <button data-action="advNewGame" style="border-color:rgba(240,192,96,0.6);color:#f0c060;justify-content:center;margin-top:6px;font-size:15px;letter-spacing:2px;">ðŸ” NEW GAME+${advData.ngPlus>0?' '+(advData.ngPlus+1):''} <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-left:6px;">keep gear &amp; gold Â· harder enemies</span></button>
    <button data-action="renderMenu" style="justify-content:center;color:var(--text-dim);margin-top:4px;">â—„ MAIN MENU</button>
  </div>`;
}

/* â”€â”€ START HIDDEN BOSS BATTLE â”€â”€ */
function advStartHiddenBoss(){
  if(!currentProfile||!profiles[currentProfile])return renderAdventureEntry();
  let charId=advData.activeChar||"hiro";
  let charDef=ADV_CHARS[charId];
  let profile=profiles[currentProfile];
  let allWords=(profile.words||[]).filter(w=>w&&w.kanji);
  if(!allWords.length){alert("No words in this profile!");return;}
  // Build a single special stage for the hidden boss
  let enemies=buildEnemyPool(allWords.length);
  let hiddenBoss=enemies.find(e=>e.id==="hidden_chronovore");
  if(!hiddenBoss)return alert("Hidden boss not found!");
  // Scale with current total stage wins
  let wins=advData.totalStageWins||100;
  hiddenBoss=Object.assign({},hiddenBoss);
  let scaleMult=1+Math.floor(wins/100)*0.2;
  hiddenBoss.hp=Math.round(hiddenBoss.hp*scaleMult);
  hiddenBoss.atk=Math.round(hiddenBoss.atk*scaleMult);
  hiddenBoss.stageType="boss";hiddenBoss.isFinal=false;hiddenBoss.isHiddenFight=true;
  let fakeStage={stageType:"boss",name:"CHRONOVORE'S VOID",art:BOSS_ART.hidden_boss,
    zoneWords:allWords,stageIdx:29,stageNum:999,isFinalZone:false,
    enemies:[hiddenBoss],type:"boss"};
  let effStats=getCharEffectiveStats(charId);
  adv={
    active:true,charId,char:charDef,
    hp:effStats.maxHp,maxHp:effStats.maxHp,
    sp:4,maxSp:6,
    statusEffects:[],stageIndex:0,stages:[fakeStage],
    combatLog:["â° CHRONOVORE: 'I SHALL CONSUME YOUR KNOWLEDGE!'"],
    pendingPoints:0,currentWord:null,wordPool:[],wordUsed:[],correctThisTurn:0,
    enemyHp:0,enemyMaxHp:0,enemyStatus:[],enemyCharge:0,
    sessionGold:0,inventory:[],
    sortTiles:[],sortAnswer:[],
    questionType:"choice",turnCount:0,phase2Triggered:false,defending:false,shopOpen:false,waitingForAction:false,_processing:false,
    comboCount:0,enemyTurnMeter:0,lastAnswerCorrect:false,
    answerTimer:null,lateHits:0,enemyQueue:[hiddenBoss],enemyQueueIdx:0,
    armorPassives:{thorns:0,regen:0,evade_bonus:0,rage_gain:0,crit_boost:0,poison_coat:false,holy_shield_ready:false},
    _isHiddenBoss:true
  };
  advInitArmorPassives();
  advSetWordPool(allWords);
  advLoadNextEnemy();
}

/* â”€â”€ HIDDEN BOSS VICTORY â”€â”€ */
function advHiddenBossVictory(){
  advClearAnswerTimer();
  advData.hiddenBossDefeated=true;
  advData.charStats[adv.charId].hp=adv.hp;
  advData.totalGold+=adv.sessionGold+500;adv.sessionGold=0;adv.active=false;
  let hbAchFlags={_advHiddenBossKill:true,_advBossKill:true,_advFirstClear:true,_advCharLevel:(advData.charStats[adv.charId]?advData.charStats[adv.charId].level:1),_advTotalGold:advData.totalGold||0,_advStagesCleared:advData.totalStageWins||0};
  checkAchievements(hbAchFlags);
  saveAll();
  app.innerHTML=`<div class="container">
    <div class="ark-header"><div class="ark-title" style="color:#9900ff;">â° <span>CHRONOVORE DEFEATED</span></div></div>
    <div class="adv-story-box" style="border-left-color:#9900ff;color:#cc44ff;">
      <div style="font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;letter-spacing:2px;color:#9900ff;">â€” TIME RESTORED â€”</div><br>
      The Chronovore dissolves into fractured moments. Your mastery of words proved stronger than time itself.<br><br>
      <span style="color:#ffffff;font-weight:700;">+500ðŸ’° LEGEND REWARD</span>
    </div>
    <div style="text-align:center;padding:20px 0;">
      <div style="font-size:80px;">â°</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:30px;font-weight:700;color:#9900ff;letter-spacing:4px;">LEGEND!</div>
    </div>
    <button data-action="renderAdventureEntry" style="color:#9900ff;border-color:#440088;justify-content:center;margin-top:10px;">â—„ RETURN</button>
  </div>`;
}
function advDie(){
  adv._processing=false;
  advClearAnswerTimer();
  let keepGold=Math.round(adv.sessionGold*0.5);
  advData.charStats[adv.charId].hp=Math.max(10,Math.round(adv.maxHp*0.2));
  advData.totalGold+=keepGold;adv.sessionGold=0;

  // Level-group based respawn: die in Lv1(1-6)â†’stage1, Lv2(7-12)â†’stage7, etc.
  let diedAtStage=adv.stageIndex;
  let levelGroup=getLevelGroup(diedAtStage);
  let respawnIdx=levelGroup.start;
  let fell20hp=Math.max(10,Math.round(adv.maxHp*0.2));

  adv.stageIndex=respawnIdx;
  adv.active=false;
  advData.savedStageIndex=respawnIdx;
  saveAll();

  app.innerHTML=`<div class="container">
    <div class="ark-header"><div class="ark-title" style="color:var(--red);">ðŸ’€ <span>FALLEN</span></div></div>
    <div style="text-align:center;padding:16px 0;">
      <div style="font-size:60px;filter:drop-shadow(0 0 20px rgba(200,40,40,0.8));">ðŸ’€</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;color:var(--red);letter-spacing:3px;margin:8px 0;">FALLEN IN BATTLE</div>
    </div>
    <div style="background:rgba(80,10,10,0.25);border:1px solid rgba(201,64,64,0.4);border-left:3px solid var(--red);padding:14px 16px;margin:10px 0;font-family:'Share Tech Mono',monospace;font-size:11px;line-height:1.9;color:var(--text-dim);">
      Fell at <span style="color:#ff8080;font-weight:700;">${levelGroup.continent} â€” Stage ${diedAtStage+1}</span><br>
      Respawn at <span style="color:${levelGroup.color};font-weight:700;">${levelGroup.name} â€” Stage ${respawnIdx+1}</span><br>
      Recovered to <span style="color:#ff8888;">${fell20hp} HP (20%)</span> Â· <span style="color:#f0c060;">+${keepGold}ðŸ’° kept</span>
    </div>
    <div class="ark-stat-row">
      <div class="ark-stat"><div class="ark-stat-label">GOLD KEPT</div><div class="ark-stat-value" style="color:#f0c060;">${advData.totalGold}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">RESPAWN AT</div><div class="ark-stat-value" style="color:${levelGroup.color};">STG ${respawnIdx+1}</div></div>
      <div class="ark-stat"><div class="ark-stat-label">LEVEL</div><div class="ark-stat-value" style="color:${levelGroup.color};">LV ${levelGroup.level}</div></div>
    </div>
    <button data-action="renderAdventureEntry" style="color:var(--accent);border-color:var(--accent-dim);justify-content:center;margin-top:10px;font-size:15px;">âš”ï¸ TRY AGAIN</button>
    <button data-action="renderMenu" style="justify-content:center;color:var(--text-dim);margin-top:4px;">â—„ MAIN MENU</button>
  </div>`;
}

/* â”€â”€ IN-COMBAT SHOP (merchant stages) â”€â”€ */
function advOpenShop(){
  adv.shopOpen=true;if(!adv.charId){renderAdventureEntry();return;}
  let charId=adv.charId;let gold=advData.totalGold+adv.sessionGold;
  let consHtml=ADV_CONSUMABLES.map(item=>{
    let canAfford=gold>=item.price;
    let inBag=(adv.inventory||[]).filter(x=>x===item.id).length;
    let atMax=item.maxStack&&inBag>=item.maxStack;
    return `<div class="adv-shop-item" style="${(canAfford&&!atMax)?'':'opacity:0.5;'}" data-action="${(canAfford&&!atMax)?`advBuyItem:${item.id}`:''}">
      <div style="font-size:22px;min-width:30px;">${item.icon}</div>
      <div style="flex:1;"><div style="font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;color:var(--text-bright);">${item.name}</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);">${item.desc}${item.maxStack?` (max ${item.maxStack})`:''}</div></div>
      <div style="text-align:right;">
        <span style="color:#f0c060;font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;">ðŸ’°${item.price}</span>
        ${inBag>0?`<div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--green);">BAG: ${inBag}${item.maxStack?`/${item.maxStack}`:''}</div>`:''}
        ${atMax?`<div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#ff6060;">FULL</div>`:''}
      </div>
    </div>`;
  }).join("");
  app.innerHTML=`<div class="container">
    <div class="ark-header"><button class="back" data-action="advCloseShop">â—„ LEAVE</button>
    <div class="ark-title">ðŸª <span>Merchant</span></div>
    <div class="adv-gold-display" style="margin-left:auto;">ðŸ’° ${gold}</div></div>
    <div class="adv-story-box" style="border-left-color:#f0c060;color:var(--text-dim);font-style:italic;">"Ah, a weary traveler! Coin for steel, steel for survival."</div>
    <div class="ark-section">ðŸ›’ WARES</div>
    ${consHtml}
    <button data-action="advCloseShop" style="color:var(--accent);border-color:var(--accent-dim);justify-content:center;margin-top:12px;">â–¶ CONTINUE QUEST</button>
  </div>`;
}

function advBuyItem(id){
  let item=ADV_CONSUMABLES.find(i=>i.id===id);if(!item||!adv.charId)return;
  let gold=advData.totalGold+adv.sessionGold;
  if(gold<item.price){showShopToast("âš  NOT ENOUGH GOLD","#cc4444");return;}
  if(item.maxStack){let count=adv.inventory.filter(x=>x===id).length;if(count>=item.maxStack){showShopToast(`âš  Max ${item.maxStack} in bag!`,"#cc4444");return;}}
  if(adv.sessionGold>=item.price){adv.sessionGold-=item.price;}
  else{let rem=item.price-adv.sessionGold;adv.sessionGold=0;advData.totalGold=Math.max(0,advData.totalGold-rem);}
  adv.inventory.push(item.id);
  showShopToast(`${item.icon} ${item.name} added to bag`,"var(--green)");
  saveAll();advOpenShop();
}

function advCloseShop(){
  adv.shopOpen=false;
  if(adv.stages&&adv.stages[adv.stageIndex]&&(adv.stages[adv.stageIndex].type==="shop"||adv.stages[adv.stageIndex].stageType==="shop")){
    adv.stageIndex=Math.min(adv.stages.length-1,adv.stageIndex+1);
  }
  advData.charStats[adv.charId].hp=adv.hp;
  advData.totalGold=Math.max(0,advData.totalGold+adv.sessionGold);adv.sessionGold=0;saveAll();renderAdventureMap();
}

/* â”€â”€ ALSO: wire click for adv-choice-btn â”€â”€ */
app.addEventListener("click",function(e2){
  let cbtn=e2.target.closest(".adv-choice-btn");if(!cbtn)return;
  let safeVal=cbtn.getAttribute("data-val");if(!safeVal)return;
  advClearAnswerTimer();
  try{advCombatChoice(safeVal);}catch(err){}
},true);


/* â”€â”€ CHARACTER STATS MODAL â”€â”€ */
function advShowCharStats(){
  if(!adv||!adv.charId)return;
  let charId=adv.charId;
  let charDef=ADV_CHARS[charId];
  let cs=advData.charStats[charId];
  let effStats=getCharEffectiveStats(charId);
  let wpn=getEquippedWeapon(charId);
  let arm=getEquippedArmor(charId);
  let upgrades=advData.statUpgrades&&advData.statUpgrades[charId]||{hp:0,atk:0,def:0,skillDmg:0};
  let gu=advData.gearUpgrades||{};

  // Crit calculation
  let baseCrit=charId==='roku'?18:charId==='kisaragi'?8:5;
  let wpnCrit=wpn?(wpn.crit||0):0;
  let totalCrit=Math.min(99,baseCrit+wpnCrit);

  // Dodge/SPD
  let totalDodge=effStats.dodgeBonus||0;
  let spd=effStats.spd||cs.spd||charDef.baseStats.spd;

  // Skill damage bonus
  let skillDmgPct=Math.round((effStats.skillDmgBonus||0)*100);

  // Weapon info
  let wpnLine=wpn?`${wpn.icon} ${wpn.name}${gu[wpn.id]?` +${gu[wpn.id]}`:''}`:appLang==='jp'?'ãªã—':'None';
  let armLine=arm?`${arm.icon} ${arm.name}${gu[arm.id]?` +${gu[arm.id]}`:''}`:appLang==='jp'?'ãªã—':'None';

  // HP display
  let hpPct=Math.max(0,Math.round((adv.hp/adv.maxHp)*100));
  let hpColor=hpPct>60?'var(--green)':hpPct>30?'var(--accent)':'var(--red)';

  // Status effects summary
  let statusRows=adv.statusEffects.length>0
    ?adv.statusEffects.map(s=>{
        let icons={fortified:'ðŸ›¡ï¸',evading:'ðŸ‘»',burning:'ðŸ”¥',poisoned:'â˜ ï¸',petrified:'ðŸª¨'};
        return `<span style="font-family:'Share Tech Mono',monospace;font-size:8px;color:#aaa;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);padding:2px 6px;margin:2px;display:inline-block;">${icons[s.type]||'âš¡'} ${s.type.toUpperCase()} (${s.turns}t)</span>`;
      }).join('')
    :`<span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);">${appLang==='jp'?'ãªã—':'None'}</span>`;

  // Armor passive
  let passiveDesc='';
  if(arm){
    let passMap={regen:'Regen HP/turn',thorns:'Thorns dmg on hit',holy_shield:'Block 1 hit periodically',evade_bonus:'Bonus evade turns',poison_coat:'Poison on every attack',crit_boost:'Crits deal +20% dmg',rage_gain:'Gain rage on hit',none:'No passive'};
    passiveDesc=passMap[arm.bonus]||arm.bonusDesc||'';
  }

  let el=document.createElement('div');
  el.className='adv-stats-overlay';
  el.id='adv-stats-overlay';
  el.innerHTML=`
    <div class="adv-stats-panel">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
        <div style="font-size:36px;line-height:1;filter:drop-shadow(0 0 8px rgba(232,168,56,0.4));">${charDef.art}</div>
        <div>
          <div style="font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;color:var(--text-bright);letter-spacing:2px;">${charDef.name.toUpperCase()}</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);letter-spacing:2px;">${charDef.class.toUpperCase()} Â· LV.${cs.level} Â· ${charId==='hiro'?'BALANCED':charId==='roku'?'SPEED/CRIT':'TANK'}</div>
          <div style="margin-top:4px;"><div style="height:4px;width:${hpPct}%;background:${hpColor};box-shadow:0 0 4px ${hpColor};border-radius:0;transition:width 0.4s;max-width:180px;"></div><div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);margin-top:2px;">HP ${Math.max(0,adv.hp)}/${adv.maxHp}</div></div>
        </div>
      </div>

      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);letter-spacing:3px;text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:6px;">â¬¡ COMBAT STATS<div style="flex:1;height:1px;background:linear-gradient(90deg,var(--accent-dim),transparent);"></div></div>

      <div class="adv-stats-grid">
        <div class="adv-stat-block">
          <div class="adv-stat-block-label">âš”ï¸ ATK</div>
          <div class="adv-stat-block-val" style="color:var(--accent);">${effStats.atk}</div>
          <div class="adv-stat-block-sub">base+wpn+upgr</div>
        </div>
        <div class="adv-stat-block">
          <div class="adv-stat-block-label">ðŸ›¡ï¸ DEF</div>
          <div class="adv-stat-block-val" style="color:var(--blue);">${effStats.def}</div>
          <div class="adv-stat-block-sub">base+armor+upgr</div>
        </div>
        <div class="adv-stat-block">
          <div class="adv-stat-block-label">ðŸ’¥ CRIT</div>
          <div class="adv-stat-block-val" style="color:var(--purple);">${totalCrit}%</div>
          <div class="adv-stat-block-sub">chance to crit</div>
        </div>
        <div class="adv-stat-block">
          <div class="adv-stat-block-label">ðŸ’¨ SPD</div>
          <div class="adv-stat-block-val" style="color:var(--green);">${spd}</div>
          <div class="adv-stat-block-sub">turn speed</div>
        </div>
        <div class="adv-stat-block">
          <div class="adv-stat-block-label">ðŸ‘» DODGE</div>
          <div class="adv-stat-block-val" style="color:#c080ff;">${totalDodge}%</div>
          <div class="adv-stat-block-sub">from armor</div>
        </div>
        <div class="adv-stat-block">
          <div class="adv-stat-block-label">âœ¨ SKILL+</div>
          <div class="adv-stat-block-val" style="color:var(--accent2);">${skillDmgPct}%</div>
          <div class="adv-stat-block-sub">skill dmg bonus</div>
        </div>
      </div>

      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);letter-spacing:3px;text-transform:uppercase;margin:12px 0 8px;display:flex;align-items:center;gap:6px;">ðŸŽ½ EQUIPMENT<div style="flex:1;height:1px;background:linear-gradient(90deg,var(--accent-dim),transparent);"></div></div>
      <div style="background:var(--bg-deep);border:1px solid var(--border);padding:10px 14px;margin-bottom:6px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
          <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;">WEAPON</span>
          <span style="font-family:'Rajdhani',sans-serif;font-size:12px;color:var(--accent2);letter-spacing:1px;">${wpnLine}</span>
        </div>
        ${wpn?`<div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);">Skill: ${wpn.skillName} â€” ${wpn.skillDesc} [${wpn.skillCost}SP]</div>`:''}
      </div>
      <div style="background:var(--bg-deep);border:1px solid var(--border);padding:10px 14px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
          <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;">ARMOR</span>
          <span style="font-family:'Rajdhani',sans-serif;font-size:12px;color:var(--blue);letter-spacing:1px;">${armLine}</span>
        </div>
        ${arm&&passiveDesc?`<div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);">Passive: ${passiveDesc}</div>`:''}
      </div>

      ${adv.statusEffects.length>0?`<div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);letter-spacing:3px;margin-top:12px 0 6px;display:flex;align-items:center;gap:6px;margin-top:12px;">âš¡ ACTIVE STATUS<div style="flex:1;height:1px;background:linear-gradient(90deg,var(--accent-dim),transparent);"></div></div><div style="margin-top:8px;">${statusRows}</div>`:''}

      <button class="adv-stats-close" onclick="document.getElementById('adv-stats-overlay').remove()">âœ• CLOSE</button>
    </div>`;

  document.body.appendChild(el);
  el.addEventListener('click',function(e){if(e.target===el)el.remove();});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ BOOT â”€â”€ */
updateDailyStreak();
ensureDailyMissions();
applyTheme();

/* â”€â”€ GLOBAL ACTION DISPATCHER â”€â”€ */
app.addEventListener("click", function(e){
  let btn=e.target.closest("[data-action]");
  if(!btn) return;
  let parts=btn.getAttribute("data-action").split(":");
  let action=parts[0], args=parts.slice(1);
  switch(action){
    case "advStartHiddenBoss":       advStartHiddenBoss(); break;
    case "renderAdventureEntry":   renderAdventureEntry(); break;
    case "advPickProfile":          advPickProfile(args.slice(0).join(":")); break;
    case "advSelectChar":          advSelectChar(args[0]); break;
    case "advChangeProfile":       advChangeProfile(); break;
    case "advNewGame":             advNewGame(); break;
    case "advBuyChar":             advBuyChar(args[0]); break;
    case "advStartRun":            advStartRun(); break;
    case "advGoStage":             advGoStage(parseInt(args[0])); break;
    case "advCombatAction":        advCombatAction(args.join(":")); break;
    case "advSubmitAnswer":        advSubmitAnswer(); break;
    case "advContinueMap":         advContinueMap(); break;
    case "advOpenShop":            advOpenShop(); break;
    case "advBuyItem":             advBuyItem(args[0]); break;
    case "advCloseShop":           advCloseShop(); break;
    case "advCombatChoice":        advCombatChoice(args[0]); break;
    case "advSortSubmit":          advSortSubmit(); break;
    case "advSortTile":            advSortTile(args[0]+":"+args[1]); break;
    case "advUseInventory":        advUseInventory(parseInt(args[0])); break;
    case "renderAdventureMap":     renderAdventureMap(); break;
    case "advOpenCustomizeMenu":   advOpenCustomizeMenu(args[0]||"stats"); break;
    case "advStatUpgrade":         advStatUpgrade(args[0]); break;
    case "advBuyWeapon":           advBuyWeapon(args[0]); break;
    case "advEquipWeapon":         advEquipWeapon(args[0]); break;
    case "advBuyArmor":            advBuyArmor(args[0]); break;
    case "advEquipArmor":          advEquipArmor(args[0]); break;
    case "advStoreBuy":            advStoreBuy(args[0]); break;
    case "advUpgradeGear":         advUpgradeGear(args[0]); break;
    case "advUpgradeGearPassive":  advUpgradeGearPassive(args[0]); break;
    case "advScreenCharSelect":    advScreenCharSelect(); break;
    case "advCharDetail":          advCharDetail(args[0]); break;
    case "advAlmanac":             advAlmanac(); break;
    case "advEnemyDetail":         advEnemyDetail(args[0]); break;
    case "renderShop":         renderShop(args[0]||"ui"); break;
    case "buyUI":              buyUI(args[0]); break;
    case "equipUI":            equipUI(args[0]); break;
    case "buyFont":            buyFont(args[0]); break;
    case "equipFont":          equipFont(args[0]); break;
    case "renderMenu":           renderMenu(); break;
    case "renderProfile":        renderProfile(); break;
    case "renderStats":          renderStats(); break;
    case "renderAchievements":   renderAchievements(); break;
    case "renderDailyMissions":  renderDailyMissions(); break;
    case "renderKotoba":         renderKotoba(); break;
    case "renderHistory":        renderHistory(); break;
    case "renderShare":          renderShare(); break;
    case "renderGroup":          renderGroup(); break;
    case "renderMode":           renderMode(); break;
    case "renderCustomAmount":   renderCustomAmount(); break;
    case "renderCustomGroupPick": renderCustomGroupPick(); break;
    case "renderCustomBlock":    renderCustomBlock(); break;
    case "renderCurrentStepKotoba": renderCurrentStepKotoba(); break;
    case "startAll":             startAll(); break;
    case "startCustomAmount":    startCustomAmount(); break;
    case "startCustomBlock":     startCustomBlock(); break;
    case "exitGame":             exitGame(); break;
    case "deleteProfileMenu":    deleteProfileMenu(); break;
    case "revealFurigana":       {let fg=document.getElementById("furigana");if(fg)fg.style.display="block";} break;
    case "chooseStep":           chooseStep(parseInt(args[0])); break;
    case "chooseStepBack":       chooseStep(stepSize); break;
    case "selectMode":           selectMode(args[0]); break;
    case "startGame":            startGame(args[0]); break;
    case "stepAmt":              stepAmt(parseInt(args[0])); break;
    case "selectBlock":          selectBlock(parseInt(args[0]),parseInt(args[1])); break;
    case "clearHistory":
      if(confirm(t('confirmClearHist'))){sessionHistory=[];saveAll();renderHistory();}
      break;
    case "resetAllProgress": resetAllProgress(); break;
  }
});

renderMenu();

if('serviceWorker' in navigator){
  if(navigator.serviceWorker.controller){
    navigator.serviceWorker.getRegistrations().then(regs=>{
      Promise.all(regs.map(r=>r.unregister())).then(()=>{
        if(!sessionStorage.getItem('sw_cleared')){
          sessionStorage.setItem('sw_cleared','1');
          location.reload();
        }
      });
    }).catch(()=>{});
  } else {
    navigator.serviceWorker.getRegistrations().then(regs=>{
      regs.forEach(r=>r.unregister());
    }).catch(()=>{});
  }
}

(function(){
  try{
    let link=document.createElement('link');
    link.rel='stylesheet';
    link.href='https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700&display=swap';
    document.head.appendChild(link);
  }catch(e){}
})();
</script>
</body>
</html>
